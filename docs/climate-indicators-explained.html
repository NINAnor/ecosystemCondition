<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 13 Climate indicators explained | Vegetation regrowth/encroachment (gjengroing)</title>
<meta name="author" content="Anders L. Kolstad">
<meta name="description" content="Author and date: Anders L. Kolstad March 2023  Ecosystem Økologisk.egenskap ECT.class All Abiotiske egenskaper Physical state characteristics   13.1 Introduction This chapters describes the...">
<meta name="generator" content="bookdown 0.34 with bs4_book()">
<meta property="og:title" content="Chapter 13 Climate indicators explained | Vegetation regrowth/encroachment (gjengroing)">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ninanor.github.io/ecosystemCondition/index.html/climate-indicators-explained.html">
<meta property="og:image" content="https://ninanor.github.io/ecosystemCondition/index.html/images/Picture1.png">
<meta property="og:description" content="Author and date: Anders L. Kolstad March 2023  Ecosystem Økologisk.egenskap ECT.class All Abiotiske egenskaper Physical state characteristics   13.1 Introduction This chapters describes the...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 13 Climate indicators explained | Vegetation regrowth/encroachment (gjengroing)">
<meta name="twitter:description" content="Author and date: Anders L. Kolstad March 2023  Ecosystem Økologisk.egenskap ECT.class All Abiotiske egenskaper Physical state characteristics   13.1 Introduction This chapters describes the...">
<meta name="twitter:image" content="https://ninanor.github.io/ecosystemCondition/index.html/images/Picture1.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.1/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.28/datatables.js"></script><link href="libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Vegetation regrowth/encroachment (gjengroing)</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About </a></li>
<li><a class="" href="overview-of-indicators.html">Overview of indicators</a></li>
<li class="book-part">INDICATORS</li>
<li><a class="" href="slitasje-og-kj%C3%B8respor.html"><span class="header-section-number">1</span> Slitasje og kjørespor</a></li>
<li><a class="" href="median-summer-temp.html"><span class="header-section-number">2</span> Median Summer Temperature</a></li>
<li><a class="" href="alien-species.html"><span class="header-section-number">3</span> Alien species</a></li>
<li><a class="" href="Functional-plant-indicators-wetland.html"><span class="header-section-number">4</span> Functional plant indicators (Moisture, Light, pH, Nitrogen)</a></li>
<li><a class="" href="Functional-plant-indicators-seminat.html"><span class="header-section-number">5</span> Functional plant indicators, semi-natural ecosystems (Light, Moisture, pH, Nitrogen, Phosphorus, Grazing_mowing, Soil disturbance)</a></li>
<li><a class="" href="trophic-level-biomass-ratios.html"><span class="header-section-number">6</span> Trophic level biomass ratios</a></li>
<li class="book-part">INDICATORS FROM THE ALPINE ASSESSMENT</li>
<li><a class="" href="areal-av-isbreer.html"><span class="header-section-number">7</span> Areal av isbreer</a></li>
<li class="book-part">DEPRECATED</li>
<li><a class="" href="areal-uten-d%C3%B8d-eller-skadet-r%C3%B8sslyng-i-kystlynghei.html"><span class="header-section-number">8</span> Areal uten død eller skadet røsslyng i kystlynghei</a></li>
<li class="book-part">GENERAL TOPICS</li>
<li><a class="" href="naturtype.html"><span class="header-section-number">9</span> Nature types</a></li>
<li><a class="" href="scaling-functions.html"><span class="header-section-number">10</span> Scaling functions</a></li>
<li><a class="" href="homogeneous-impact-areas.html"><span class="header-section-number">11</span> Homogeneous Impact Areas</a></li>
<li><a class="" href="master-grid.html"><span class="header-section-number">12</span> Master grid</a></li>
<li><a class="active" href="climate-indicators-explained.html"><span class="header-section-number">13</span> Climate indicators explained</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/NINAnor/ecosystemCondition">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="climate-indicators-explained" class="section level1" number="13">
<h1>
<span class="header-section-number">13</span> Climate indicators explained<a class="anchor" aria-label="anchor" href="#climate-indicators-explained"><i class="fas fa-link"></i></a>
</h1>
<p><br></p>
<p><em>Author and date:</em></p>
<p>Anders L. Kolstad</p>
<p>March 2023</p>
<p><br></p>
<!-- Load all you dependencies here -->
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">Ecosystem</th>
<th align="left">Økologisk.egenskap</th>
<th align="left">ECT.class</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">All</td>
<td align="left">Abiotiske egenskaper</td>
<td align="left">Physical state characteristics</td>
</tr></tbody>
</table></div>
<p><br><br></p>
<hr>
<div id="introduction-10" class="section level2" number="13.1">
<h2>
<span class="header-section-number">13.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-10"><i class="fas fa-link"></i></a>
</h2>
<p>This chapters describes the development of a workflow for generating or preparing indicators based on interpolated climate data from <a href="https://senorge.no/">SeNorge</a>. I describe the process using dummy data and also discuss alternate approaches and dead ends that occured in the development process. For a succinct workflow example for a specific indicator, see <a href="median-summer-temp.html#median-summer-temp">Median summer temperature</a>.</p>
</div>
<div id="about-the-underlying-data-8" class="section level2" number="13.2">
<h2>
<span class="header-section-number">13.2</span> About the underlying data<a class="anchor" aria-label="anchor" href="#about-the-underlying-data-8"><i class="fas fa-link"></i></a>
</h2>
<p>The data is in a raster format and extends back to 1957 in the form of multiple interpolated climate variables. The spatial resolution is 1 x 1 km.</p>
<div id="representativity-in-time-and-space-7" class="section level3" number="13.2.1">
<h3>
<span class="header-section-number">13.2.1</span> Representativity in time and space<a class="anchor" aria-label="anchor" href="#representativity-in-time-and-space-7"><i class="fas fa-link"></i></a>
</h3>
<p>The data includes the last normal period (1961-1990) which defines the reference condition for climate variables. Therefore the temporal resolution is very good. Also considering the daily resolution of the data.</p>
<p>Spatially, a 1x1 km resolution is sufficient for most climate variables, esp. in homogeneous terrain, but this needs to be evaluation for each variable and scenario specifically.</p>
</div>
<div id="original-units-4" class="section level3" number="13.2.2">
<h3>
<span class="header-section-number">13.2.2</span> Original units<a class="anchor" aria-label="anchor" href="#original-units-4"><i class="fas fa-link"></i></a>
</h3>
<p>Varied. Specified below for each parameter.</p>
</div>
<div id="temporal-coverage-6" class="section level3" number="13.2.3">
<h3>
<span class="header-section-number">13.2.3</span> Temporal coverage<a class="anchor" aria-label="anchor" href="#temporal-coverage-6"><i class="fas fa-link"></i></a>
</h3>
<p>1957 - present</p>
</div>
<div id="additional-comments-about-the-data-set-1" class="section level3" number="13.2.4">
<h3>
<span class="header-section-number">13.2.4</span> Additional comments about the data set<a class="anchor" aria-label="anchor" href="#additional-comments-about-the-data-set-1"><i class="fas fa-link"></i></a>
</h3>
<p>The data format has recently changed from .BIL to .nc (netcdf) and now a single file contains all the rasters for one year (365 days), and sometimes for multiple variables also.</p>
</div>
</div>
<div id="ecosystem-characteristic-4" class="section level2" number="13.3">
<h2>
<span class="header-section-number">13.3</span> Ecosystem characteristic<a class="anchor" aria-label="anchor" href="#ecosystem-characteristic-4"><i class="fas fa-link"></i></a>
</h2>
<div id="norwegian-standard-3" class="section level3" number="13.3.1">
<h3>
<span class="header-section-number">13.3.1</span> Norwegian standard<a class="anchor" aria-label="anchor" href="#norwegian-standard-3"><i class="fas fa-link"></i></a>
</h3>
<p>These variables typically will fall under the <em>abiotiske egenskaper</em> class.</p>
</div>
<div id="seea-ea-1" class="section level3" number="13.3.2">
<h3>
<span class="header-section-number">13.3.2</span> SEEA EA<a class="anchor" aria-label="anchor" href="#seea-ea-1"><i class="fas fa-link"></i></a>
</h3>
<p>In SEEA EA, these variables will typically fall under A1 - Physical state characteristics.</p>
</div>
</div>
<div id="collinearities-with-other-indicators-6" class="section level2" number="13.4">
<h2>
<span class="header-section-number">13.4</span> Collinearities with other indicators<a class="anchor" aria-label="anchor" href="#collinearities-with-other-indicators-6"><i class="fas fa-link"></i></a>
</h2>
<p>Climate variables are most likely to be correlated with each other (e.g. temperature and snow). Also, some climate variables are better classed as pressure indicators, and these might have a causal association with several condition indicators.</p>
</div>
<div id="reference-condition-and-values-3" class="section level2" number="13.5">
<h2>
<span class="header-section-number">13.5</span> Reference condition and values<a class="anchor" aria-label="anchor" href="#reference-condition-and-values-3"><i class="fas fa-link"></i></a>
</h2>
<div id="reference-condition-3" class="section level3" number="13.5.1">
<h3>
<span class="header-section-number">13.5.1</span> Reference condition<a class="anchor" aria-label="anchor" href="#reference-condition-3"><i class="fas fa-link"></i></a>
</h3>
<p>The reference condition for climate variables is defined as the normal period 1961-1990.</p>
</div>
<div id="reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values-6" class="section level3" number="13.5.2">
<h3>
<span class="header-section-number">13.5.2</span> Reference values, thresholds for defining <em>good ecological condition</em>, minimum and/or maximum values<a class="anchor" aria-label="anchor" href="#reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values-6"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Un-scaled indicator value = median value over 5 year periods (5 years being a pragmatic choice. It is long enough to smooth out a lot of inter-annual variation, and it’s long enough to enable estimating errors)</p></li>
<li><p>Upper reference level (best possible condition) = median value from the reference period</p></li>
<li><p>Thresholds for good ecosystem condition = 2 standard deviation units away from the upper reference level for the climate variable during the reference period.</p></li>
<li><p>Lower reference values (two-directional) = 5 standard deviation units for the climate variable during the reference period (implies linear scaling).</p></li>
</ul>
<p>The choice to use 2 SD units as the threshold values is a subjective choice in many ways, and not founded in any empirical or known relationship between the indicators and ecosystem integrity. The value comes from the common practice of calling something <em>extreme weather</em> when it is outside 2 SD units of the current running average. So, if the indicator value today is &lt;0.6 it implies that the mean for that variable over the last year would have been referred to as <em>extreme</em> if it had occurred between 1961 and 1990. This is I think a conservative threshold, since one would/could call it <em>extreme</em> if only one year is outside the 2SD range, and having the mean of 5 years being outside this range is <em>really</em> extreme.</p>
</div>
</div>
<div id="uncertainties-6" class="section level2" number="13.6">
<h2>
<span class="header-section-number">13.6</span> Uncertainties<a class="anchor" aria-label="anchor" href="#uncertainties-6"><i class="fas fa-link"></i></a>
</h2>
<p>For the indicator map (1 x 1 km raster) there is no uncertainty associated with the indicator values. For aggregated indicator values (e.g. for regions), the uncertainty in the indicator value is calculated from the spatial variation in the indicator values via bootstrapping. This might, however, be changed later to the temporal variation between the five years of each period.</p>
</div>
<div id="references-7" class="section level2" number="13.7">
<h2>
<span class="header-section-number">13.7</span> References<a class="anchor" aria-label="anchor" href="#references-7"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://senorge.no/" class="uri">https://senorge.no/</a></p>
<p><em>rr and tm are being download from:</em> <a href="https://thredds.met.no/thredds/catalog/senorge/seNorge_2018/Archive/catalog.html" class="uri">https://thredds.met.no/thredds/catalog/senorge/seNorge_2018/Archive/catalog.html</a></p>
<div id="additional-resources-1" class="section level3" number="13.7.1">
<h3>
<span class="header-section-number">13.7.1</span> Additional resources<a class="anchor" aria-label="anchor" href="#additional-resources-1"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://r-spatial.github.io/stars/">Stars package</a></p>
<p><a href="https://tmieno2.github.io/R-as-GIS-for-Economists/stars-basics.html">R as a GIS for economists</a> chapter 7</p>
<p><hl></hl></p>
</div>
</div>
<div id="analyses-9" class="section level2" number="13.8">
<h2>
<span class="header-section-number">13.8</span> Analyses<a class="anchor" aria-label="anchor" href="#analyses-9"><i class="fas fa-link"></i></a>
</h2>
<div id="data-set-1" class="section level3" number="13.8.1">
<h3>
<span class="header-section-number">13.8.1</span> Data set<a class="anchor" aria-label="anchor" href="#data-set-1"><i class="fas fa-link"></i></a>
</h3>
<p>The data is downloaded to a local NINA server, and updated regularly.</p>
<div class="sourceCode" id="cb453"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>, </span>
<span>      <span class="st">"R:/GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original"</span>,</span>
<span>      <span class="st">"/data/R/GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original"</span><span class="op">)</span></span></code></pre></div>
<p>This folder contains folder for the different parameters</p>
<div class="sourceCode" id="cb454"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "age"        "fsw"        "gwb_eva"    "gwb_gwtcl" </span></span>
<span><span class="co">#&gt;  [5] "gwb_q"      "gwb_sssdev" "gwb_sssrel" "lwc"       </span></span>
<span><span class="co">#&gt;  [9] "qsw"        "rr_tm"      "sd"         "sdfsw"     </span></span>
<span><span class="co">#&gt; [13] "swe"</span></span></code></pre></div>
<p>This table explains them in more detail</p>
<div class="sourceCode" id="cb455"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">senorgelayers</span> <span class="op">&lt;-</span> <span class="fu">read_delim</span><span class="op">(</span><span class="st">"data/senorgelayers.txt"</span>, </span>
<span>    delim <span class="op">=</span> <span class="st">"\t"</span>, escape_double <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    trim_ws <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">senorgelayers</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-5"></span>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-9e434b253c8e4bfdf130" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9e434b253c8e4bfdf130">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["sdfsw","fsw","sd","age","swe","#swepr","#swepr","qsw","lwc","gwb_q","gwb_eva","gwb_gwtcl","gwb_sssdev","gwb_sssrel","tm","rr"],["16","8","16","8","16","no longer included","16","8","8","16","8","8","16","16","16","16"],[65535,255,65535,255,65535,null,65535,255,255,65535,255,255,32767,65535,65535,65535],[65534,254,null,254,null,null,null,254,254,null,null,null,null,null,null,null],["fresh snow depth","fresh snow","snow depth","snow age","snow water equivalent",null,"snow water equivalent percentage","snow melt","free water content in snow","runoff","evapotranspiration","ground water condition","water capacity of the soil","current water saturation of the soil","temperature","precipitation"],["mm","mm (water equivalent)","mm","number of days since last snowfall","1/10 mm (water equivalent)",null,"1/10 %","mm (water equivalent)","1/10 % free water in the snow layer","1/10 mm","1/10 mm","24h percentile of the normal period","mm in relation to maximum value of the normal period","% of the maximum value of the normal period","celsius","mm"],["Nysnødybde","Nysnø","Snødybde","Snøens alder","Snømengde",null,"Prosentandel swe","Snøsmelting","Snøtilstand","Avrenning","Fordamping","Grunnvannstilstand","Jordas vannkapasitet","Vannmetting i jord","Temperatur","Nedbør"],["Verdier i fil i 16bit integer verdier som angir mm snødybde.","Verdier angir mm vannekvivalent.","Verdier angir mm snødybde.","Verdiene angir antall dager siden siste snøfall.","Verdiene angir 1/10mm vannekvivalent. Altså en verdi på 102 er 10.2 mm vann.",null,"Veldig uklar beskrivelse gitt av NVE. Må sjekkes!","Verdiene angir mm vannekvivalent.","Verdien angir i prosent hvor mye fritt vann det er i snøpakka. Oppgitt i 1/10 %. En verdi på 45 er altså 4.5%.","Angir avrenning i 1/10mm vann. En verdi på 34 er altså 3.4 mm.","Angir fordampning i 1/10 mm vann.","Verdien angir hvilken døgnpercentilene i normalperioden som verdien tilhører. Verdiene er her 5, 25, 50, 75 og 95.","Verdien angir lagerkapasiteten (i mm) i forhold til maxverdien registrert i 30 årsperioden (1981-2010). Negativ verdi betyr altså at dagens vannlager verdi er over maxverdien.","Dagens vannlager verdi i prosent av den samme maksimale verdien som brukes i gwb_ssdev. En verdi over 100 angir altså at maksverdien er overskredet.","Verdien angir grader i Celsius (re-skalert fra tiendels Kelvin, der en verdi på 2811 er (2811-2731)/10 = 8.0 C.","Verdien angir nedbør i mm (re-skalert fra tiendels mm)."],["gt_Meteorology_Norway_seNorge_FreshSnowDepth_days","gt_Meteorology_Norway_seNorge_FreshSnow_days","gt_Meteorology_Norway_seNorge_SnowDepth_days","gt_Meteorology_Norway_seNorge_SnowAge_days","gt_Meteorology_Norway_seNorge_SnowAmount_days",null,"gt_Meteorology_Norway_seNorge_SnowAmountPercentage_days","gt_Meteorology_Norway_seNorge_SnowMelt_days","gt_Meteorology_Norway_seNorge_SnowFreeWaterContent_days","gt_Meteorology_Norway_seNorge_Runoff_days","gt_Meteorology_Norway_seNorge_Evapotranspiration_days","gt_Meteorology_Norway_seNorge_GroundWaterCondition_days","gt_Meteorology_Norway_seNorge_WaterCapacitySoil_days","gt_Meteorology_Norway_seNorge_WaterSaturationSoil_days","gt_Meteorology_Norway_seNorge_Temperature_days","gt_Meteorology_Norway_seNorge_Precipitation_days"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,"celsius","precipitation_daily"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>abbrev<\/th>\n      <th>bit<\/th>\n      <th>nodata<\/th>\n      <th>bare_ground<\/th>\n      <th>name<\/th>\n      <th>unit<\/th>\n      <th>navn<\/th>\n      <th>beskrivelse<\/th>\n      <th>grass_mapset<\/th>\n      <th>color_table<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p class="caption">
Figure 13.1: Table explaining the available climate parameters in the data set.
</p>
</div>
<p>Here is the content of one of these folders (first 10 entries)</p>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">files_tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/rr_tm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1] "seNorge2018_1957.nc" "seNorge2018_1958.nc"</span></span>
<span><span class="co">#&gt;  [3] "seNorge2018_1959.nc" "seNorge2018_1960.nc"</span></span>
<span><span class="co">#&gt;  [5] "seNorge2018_1961.nc" "seNorge2018_1962.nc"</span></span>
<span><span class="co">#&gt;  [7] "seNorge2018_1963.nc" "seNorge2018_1964.nc"</span></span>
<span><span class="co">#&gt;  [9] "seNorge2018_1965.nc" "seNorge2018_1966.nc"</span></span></code></pre></div>
<p>There are 67 files, i.e. 67 years of data, one file per year.</p>
<p>Importing (proxy) file:</p>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tg_1957</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/rr_tm/seNorge2018_1957.nc"</span><span class="op">)</span>,</span>
<span>                            var<span class="op">=</span><span class="st">"tg"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Large netcdf source found, returning proxy object.</span></span></code></pre></div>
<p>I know the CRS, so setting it manually. Although I cannot rule out 32633, I don’t think it matters.</p>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">tg_1957</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">25833</span></span></code></pre></div>
<p>The data has three dimension</p>
<div class="sourceCode" id="cb459"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">tg_1957</span><span class="op">)</span></span>
<span><span class="co">#&gt;    X    Y time </span></span>
<span><span class="co">#&gt; 1195 1550  365</span></span></code></pre></div>
<p>Initially the data had four attributes, but I subsettet to only include <em>tg</em>.</p>
<div class="sourceCode" id="cb460"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tg_1957</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tg"</span></span></code></pre></div>
<p><code>tg_1957</code> is a stars proxy object and <a href="https://r-spatial.github.io/stars/articles/stars8.html">most commands</a> will not initiate any change until later, typically I write to file and all the lazy operations are done in squeal. Therefore, I will prepare a test data set, which is smaller and which I can import to memory. Then I can perform the operations on that data set and we can see the results.</p>
<div id="dummy-data" class="section level4" number="13.8.1.1">
<h4>
<span class="header-section-number">13.8.1.1</span> Dummy data<a class="anchor" aria-label="anchor" href="#dummy-data"><i class="fas fa-link"></i></a>
</h4>
<p>This test data is included in the {stars} package</p>
<div class="sourceCode" id="cb461"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"1970-05-31"</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu">read_stars</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">tif</span>, <span class="va">tif</span>, <span class="va">tif</span>, <span class="va">tif</span><span class="op">)</span>, along <span class="op">=</span> </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t1</span><span class="op">+</span><span class="fl">1</span>, <span class="va">t1</span><span class="op">+</span><span class="fl">50</span>, <span class="va">t1</span><span class="op">+</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               RasterIO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nXOff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>                               nYOff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>                               nXSize <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                               nYSize <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                               bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A single attribute</p>
<div class="sourceCode" id="cb462"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "L7_ETMs.tif"</span></span></code></pre></div>
<p>I can rename it like this</p>
<div class="sourceCode" id="cb463"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"Attribute_A"</span><span class="op">)</span></span></code></pre></div>
<p>And I can add another dummy attribute.</p>
<div class="sourceCode" id="cb464"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="st">"Attribute_B"</span> <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The dummy data also has four dimensions</p>
<div class="sourceCode" id="cb465"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;    x    y band time </span></span>
<span><span class="co">#&gt;   50   50    6    4</span></span></code></pre></div>
<p>X and y area the coordinates. Band is an integer:</p>
<div class="sourceCode" id="cb466"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"band"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 6</span></span></code></pre></div>
<p>I will remove the <em>band</em> dimension.</p>
<div class="sourceCode" id="cb467"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">band</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Time is four dates covering four months in 1970:</p>
<div class="sourceCode" id="cb468"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">oldTime</span> <span class="op">&lt;-</span> <span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1970-05-31" "1970-06-01" "1970-07-20" "1970-09-08"</span></span></code></pre></div>
<p>I’ll add some extra seasonal variation between to the mix</p>
<div class="sourceCode" id="cb469"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fl">1.2</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fl">1.4</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fl">1.1</span></span></code></pre></div>
<p>Now I create another four copies of this data, adding some random noise and a continuous decreasing trend.</p>
<div class="sourceCode" id="cb470"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to add random noise</span></span>
<span><span class="va">myRandom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">.05</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb471"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span><span class="va">y2</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="va">y3</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.90</span><span class="op">)</span></span>
<span><span class="va">y4</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.85</span><span class="op">)</span></span>
<span><span class="va">y5</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.80</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb472"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We combine the data into one cube for plotting:</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">y2</span>, <span class="va">y3</span>, <span class="va">y4</span>, <span class="va">y5</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">temp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">time</span>, ncol<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="climate_indicators_explained_files/figure-html/unnamed-chunk-22-1.png" width="672"></div>
<p>Saving these to file.</p>
<div class="sourceCode" id="cb473"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="st">"P:/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y1</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y1.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y2</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y2.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y3</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y3.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y4</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y4.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y5</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y5.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="dummy-regions-and-et-map" class="section level5" number="13.8.1.1.1">
<h5>
<span class="header-section-number">13.8.1.1.1</span> Dummy regions and ET map<a class="anchor" aria-label="anchor" href="#dummy-regions-and-et-map"><i class="fas fa-link"></i></a>
</h5>
<p>Here is some dummy data for accounting areas (regions) and ecosystem occurrences as well, in case I need them later.</p>
<div class="sourceCode" id="cb474"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy_aa</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="va">oldTime</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>accountingAreas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">accountingAreas</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">dummy_aa</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span>style<span class="op">=</span><span class="st">"cat"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-24"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-24-1.png" alt="Showing the example account area delineation (raster format)" width="672"><p class="caption">
Figure 9.7: Showing the example account area delineation (raster format)
</p>
</div>
<div class="sourceCode" id="cb475"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy_et</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="va">oldTime</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ecosystemType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="cn">NA</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">ecosystemType</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">dummy_et</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span>style<span class="op">=</span><span class="st">"cat"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-25"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-25-1.png" alt="Showing the example Ecosystem type delineation data." width="672"><p class="caption">
Figure 1.9: Showing the example Ecosystem type delineation data.
</p>
</div>
</div>
</div>
<div id="regions-3" class="section level4" number="13.8.1.2">
<h4>
<span class="header-section-number">13.8.1.2</span> Regions<a class="anchor" aria-label="anchor" href="#regions-3"><i class="fas fa-link"></i></a>
</h4>
<p>Importing a shape file with the regional delineation.</p>
<div class="sourceCode" id="cb476"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/regions.shp"</span>, options <span class="op">=</span> <span class="st">"ENCODING=UTF8"</span><span class="op">)</span></span>
<span><span class="co">#&gt; options:        ENCODING=UTF8 </span></span>
<span><span class="co">#&gt; Reading layer `regions' from data source </span></span>
<span><span class="co">#&gt;   `/data/scratch/Matt_temp/ecosystemCondition/data/regions.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#st_crs(reg)</span></span></code></pre></div>
<p>Outline of Norway</p>
<div class="sourceCode" id="cb477"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nor</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/outlineOfNorway_EPSG25833.shp"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `outlineOfNorway_EPSG25833' from data source </span></span>
<span><span class="co">#&gt;   `/data/scratch/Matt_temp/ecosystemCondition/data/outlineOfNorway_EPSG25833.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -113472.7 ymin: 6448359 xmax: 1114618 ymax: 7939917</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Remove marine areas from regions</p>
<div class="sourceCode" id="cb478"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span><span class="va">reg</span>, <span class="va">nor</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: attribute variables are assumed to be spatially</span></span>
<span><span class="co">#&gt; constant throughout all geometries</span></span></code></pre></div>
<div class="sourceCode" id="cb479"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">reg</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col<span class="op">=</span><span class="st">"region"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-29"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-29-1.png" alt="Five accounting areas (regions) in Norway." width="672"><p class="caption">
Figure 3.9: Five accounting areas (regions) in Norway.
</p>
</div>
</div>
<div id="ecosystem-map-2" class="section level4" number="13.8.1.3">
<h4>
<span class="header-section-number">13.8.1.3</span> Ecosystem map<a class="anchor" aria-label="anchor" href="#ecosystem-map-2"><i class="fas fa-link"></i></a>
</h4>
<p>Coming soon ….</p>
<p>The climate indicators need to be masked with ecosystem type maps. This step is part of this chapter.</p>
</div>
</div>
<div id="conceptual-workflow-1" class="section level3" number="13.8.2">
<h3>
<span class="header-section-number">13.8.2</span> Conceptual workflow<a class="anchor" aria-label="anchor" href="#conceptual-workflow-1"><i class="fas fa-link"></i></a>
</h3>
<p>The general, the conceptual workflow is like this:</p>
<ol style="list-style-type: decimal">
<li>
<p>Collate variable data series</p>
<ul>
<li><p>Import .nc files (loop though year 1961-1990) and subset to the correct attribute</p></li>
<li><p>Filter data by dates (optional) (<code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code>). <em>This means reading all 365 rasters into memory, and it is much quicker to filter out the correct rasters in the importing step above (see examples later in this chapter)</em></p></li>
<li><p>Aggregate across time within a year (<code><a href="https://r-spatial.github.io/stars/reference/st_apply.html">stars::st_apply</a></code>). <em>This is the most time consuming operation in the workflow.</em></p></li>
<li><p>Join all data into one data cube (<code>stars:c</code>)</p></li>
</ul>
</li>
<li>
<p>Calculate reference values</p>
<ul>
<li><p>Aggregate (<code>st_apply)</code> across reference years (<code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code>) to get median and sd values</p></li>
<li><p>Join with existing data cube (<code>stars:c</code>)</p></li>
</ul>
</li>
<li>
<p>Calculate indicator values</p>
<ul>
<li>Normalize climate variable at the individual grid cell level using the three reference values (<code>mutate(across()))</code>
</li>
</ul>
</li>
<li><p>Mask by ecosystem type (<em>This could also be done in step one, but it doesn’t speed things up to set some cells to NA</em>)</p></li>
<li>
<p>Aggregate in space (to accounting areas) (<em>zonal statistics</em>)</p>
<ul>
<li><p>Aggregate across 5 year time steps to smooth out random inter-annual variation and leave climate signal</p></li>
<li><p>Intersect with accounting area polygons <code>exactextrar::exact_extract</code> and get mean/median and (spatial) sd. (<em>Alternatively, get temporal sd at the grid cell level in the step above.</em>)</p></li>
</ul>
</li>
<li><p>Make trend figure and spatially aggregated maps,</p></li>
</ol>
</div>
<div id="collate-variable-data-series" class="section level3" number="13.8.3">
<h3>
<span class="header-section-number">13.8.3</span> Collate variable data series<a class="anchor" aria-label="anchor" href="#collate-variable-data-series"><i class="fas fa-link"></i></a>
</h3>
<p>I include a for loop for importing the .nc files at the end.</p>
</div>
<div id="filter-data-by-dates" class="section level3" number="13.8.4">
<h3>
<span class="header-section-number">13.8.4</span> Filter data by dates<a class="anchor" aria-label="anchor" href="#filter-data-by-dates"><i class="fas fa-link"></i></a>
</h3>
<p>Say we want to calculate the mean summer temperature. We then want to exclude the data for the times that is not withing our definition of summer.</p>
<p>Let’s try it on the dummy data. Remember this data had four time steps.</p>
<div class="sourceCode" id="cb480"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1970-05-31" "1970-06-01" "1970-07-20" "1970-09-08"</span></span></code></pre></div>
<p>Our real data has 365 time steps for each year.</p>
<p>First I define my start and end dates. I want to keep only the summer data, defined as jun - aug.</p>
<div class="sourceCode" id="cb481"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_month</span> <span class="op">&lt;-</span>  <span class="st">"06"</span></span>
<span><span class="va">end_month</span> <span class="op">&lt;-</span> <span class="st">"08"</span></span></code></pre></div>
<p>Then for each iteration I need to get the year as well</p>
<div class="sourceCode" id="cb482"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">year_temp</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1970</span></span></code></pre></div>
<p>Then I can create a time interval object</p>
<div class="sourceCode" id="cb483"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">start_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">end</span> <span class="op">&lt;-</span>  <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">end_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">myInterval</span> <span class="op">&lt;-</span> <span class="fu">interval</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1970-06-01 UTC--1970-08-01 UTC</span></span></code></pre></div>
<p>Then I filter</p>
<div class="sourceCode" id="cb484"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_aug</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">%within%</span> <span class="va">myInterval</span><span class="op">)</span></span>
<span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x_aug</span>, <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1970-06-01" "1970-07-20"</span></span></code></pre></div>
<p><em>Later I discover that `dplyr::filter` work after reading the whole object to file, and therefor it is too slow for our use. I therefore filter data a different way further down.</em></p>
</div>
<div id="aggregate-across-time-within-a-year" class="section level3" number="13.8.5">
<h3>
<span class="header-section-number">13.8.5</span> Aggregate across time within a year<a class="anchor" aria-label="anchor" href="#aggregate-across-time-within-a-year"><i class="fas fa-link"></i></a>
</h3>
<p>For this example I want to calculate the mean temperature over the summer. I therefore need to aggregate over time. Many climate indicators will need this functionality. There are two ways, either using <code>st_apply</code> or using <code>aggregate</code>.</p>
<div class="sourceCode" id="cb485"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_names</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x_aug</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">microOut</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>st_apply <span class="op">=</span>  <span class="va">x_aug</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>,<span class="va">temp_names</span><span class="op">)</span><span class="op">)</span>,</span>
<span>aggregate <span class="op">=</span> <span class="va">x_aug</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"year"</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>times<span class="op">=</span><span class="fl">30</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The time dimension is now gone as we have aggregated across it.</p>
<div class="sourceCode" id="cb486"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">autoplot</span><span class="op">(</span><span class="va">microOut</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate system already present. Adding new coordinate</span></span>
<span><span class="co">#&gt; system, which will replace the existing one.</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-36"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-36-1.png" alt="Comparing computation tome for two spatial aggregation functions." width="672"><p class="caption">
Figure 13.2: Comparing computation tome for two spatial aggregation functions.
</p>
</div>
<p><code>st_apply</code> is slightly faster, but <code>aggregate</code> has the advantage of that it retains the time dimension, whereas for <code>st_apply</code> I need to set the attribute name to be the year. I will try to use <code>st_apply</code>.</p>
<p>But let me see if I can save time by masking to ET before doing this operation.</p>
<div class="sourceCode" id="cb487"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_masked</span> <span class="op">&lt;-</span> <span class="va">x_aug</span></span>
<span><span class="va">x_masked</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dummy_et</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x_masked</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-37"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-37-1.png" alt="Demonstrating the effect of maskig the dummy data using a perfectly aligne raster ET map." width="672"><p class="caption">
Figure 1.12: Demonstrating the effect of maskig the dummy data using a perfectly aligne raster ET map.
</p>
</div>
<div class="sourceCode" id="cb488"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">autoplot</span><span class="op">(</span></span>
<span>  <span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>No_masking <span class="op">=</span>  <span class="va">x_aug</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>,<span class="va">temp_names</span><span class="op">)</span><span class="op">)</span>,</span>
<span>Masking <span class="op">=</span>  <span class="va">x_masked</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>,<span class="va">temp_names</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="op">)</span>, times<span class="op">=</span><span class="fl">30</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate system already present. Adding new coordinate</span></span>
<span><span class="co">#&gt; system, which will replace the existing one.</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:withMasking"></span>
<img src="climate_indicators_explained_files/figure-html/withMasking-1.png" alt="Comparing computation time before and after masking of raster data. There is no performance increase by masking before aggregating." width="672"><p class="caption">
Figure 13.3: Comparing computation time before and after masking of raster data. There is no performance increase by masking before aggregating.
</p>
</div>
<p>Since there is no increase in performance from masking, as we see in Fig. @ref(fig: withMasking) then it basically means we it is slower to mask beforehand, since the masking was not past of the benchmark assessment.</p>
<p>So, this is my solution:</p>
<div class="sourceCode" id="cb489"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setNames dont work on stars proxy obejct, so I use rename instead</span></span>
<span><span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="va">temp_names</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x_summerMean</span> <span class="op">&lt;-</span>   <span class="va">x_aug</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <em>v_</em> follows the naming convention we have developed for ourselves.</p>
<div class="sourceCode" id="cb490"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_aug</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">time</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,  </span>
<span>  </span>
<span>  </span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_summerMean</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#facet_wrap(~time) +</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-39"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-39-1.png" alt="Plotting the dummy data showing Attribute_A for the two dates as small maps, and a larger map showing the mean for year 2018" width="672"><p class="caption">
Figure 13.4: Plotting the dummy data showing Attribute_A for the two dates as small maps, and a larger map showing the mean for year 2018
</p>
</div>
<p>Here’s the whole first step of the conceptual workflow in action, on the dummy data.</p>
<div class="sourceCode" id="cb491"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Setting up the parameters</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>,</span>
<span>       <span class="st">"P:/"</span>, </span>
<span>       <span class="st">"/data/P-Prosjekter2/"</span><span class="op">)</span></span>
<span><span class="va">path2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, </span>
<span>                <span class="st">"41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data"</span><span class="op">)</span></span>
<span><span class="va">start_month</span> <span class="op">&lt;-</span>  <span class="st">"06"</span></span>
<span><span class="va">end_month</span> <span class="op">&lt;-</span> <span class="st">"08"</span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path2</span>, pattern<span class="op">=</span><span class="st">".rds"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">summerTemp_fullSeries</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># Looping though the files in the directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">year_temp</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">start_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">end</span> <span class="op">&lt;-</span>  <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">end_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">myInterval</span> <span class="op">&lt;-</span> <span class="fu">interval</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span></span>
<span>  <span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="va">year_temp</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">%within%</span> <span class="va">myInterval</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">summerTemp_fullSeries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">summerTemp_fullSeries</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span> <span class="co"># same computation time with and without this function, but more tidy this way</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Turn the attributes into a dimension and rename the new attribute</span></span>
<span><span class="va">summerTemp_fullSeries</span> <span class="op">&lt;-</span> <span class="va">summerTemp_fullSeries</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"Attribute_A"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.142   0.000   0.157</span></span></code></pre></div>
<p>And this is the result.</p>
<div class="sourceCode" id="cb492"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">summerTemp_fullSeries</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-41"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-41-1.png" alt="Temporal aggregation on the dummy data set." width="672"><p class="caption">
Figure 13.5: Temporal aggregation on the dummy data set.
</p>
</div>
<p>Now let’s try it on the real data.</p>
<p><em>I initially tried to read stars proxy object and add steps to the call_list and execute these with <code>st_as_stars</code>, but this still returned proxy objects. Therefore I read the whole file in without proxy. To save time I can subset based on Julian dates.</em></p>
<p>I will use <a href="https://tmieno2.github.io/R-as-GIS-for-Economists/EE.html">parallelization</a> to speed things up.</p>
<div class="sourceCode" id="cb493"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>, </span>
<span>      <span class="st">"R:/"</span>,</span>
<span>      <span class="st">"/data/R/"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">path2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original/rr_tm/"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path2</span>, pattern<span class="op">=</span><span class="st">".nc$"</span>,full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co"># The last file (the last year) is incomplete and don't include all julian dates that we select below, so I will not include it:</span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="va">myFiles</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">real_temp_summer</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># set up parallel cluster using 10 cores</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get julian days after defining months</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, var<span class="op">=</span><span class="st">"tg"</span><span class="op">)</span></span>
<span><span class="va">start_month_num</span> <span class="op">&lt;-</span>  <span class="fl">6</span></span>
<span><span class="va">end_month_num</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="va">julian_start</span> <span class="op">&lt;-</span> <span class="fu">yday</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">%m+%</span></span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="op">+</span><span class="va">start_month_num</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">julian_end</span> <span class="op">&lt;-</span> <span class="fu">yday</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">%m+%</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="op">+</span><span class="va">end_month_num</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">step</span> <span class="op">&lt;-</span> <span class="va">julian_end</span><span class="op">-</span><span class="va">julian_start</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu">tic</span><span class="op">(</span><span class="st">"init"</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, var<span class="op">=</span><span class="st">"tg"</span>, proxy<span class="op">=</span><span class="cn">F</span>,</span>
<span>                           ncsub <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">julian_start</span><span class="op">)</span>, </span>
<span>                              count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="va">step</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">year_temp</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">year_temp</span><span class="op">)</span></span>
<span>  <span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="va">year_temp</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="co"># Perhaps leave out the v_ to get a numeric vector instead, </span></span>
<span>    <span class="co"># which is easier to subset</span></span>
<span>  <span class="fu">st_crs</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">25833</span></span>
<span>  <span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">tic</span><span class="op">(</span><span class="st">"filter and st_apply"</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">tic</span><span class="op">(</span><span class="st">"c()"</span><span class="op">)</span></span>
<span>  <span class="va">real_temp_summer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">real_temp_summer</span><span class="op">)</span></span>
<span>  <span class="co">#rm(temp)</span></span>
<span>  <span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Merge"</span><span class="op">)</span></span>
<span><span class="va">real_temp_summer</span> <span class="op">&lt;-</span> <span class="va">real_temp_summer</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"climate_variable"</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>This takes about 20 sec per file/year, or 22 min on total. That is not too bad. About 6000 raster are read into memory. Here’s a test for the effect of splitting over more cores.</p>
<div class="sourceCode" id="cb494"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span>
<span><span class="va">cl2</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">6L</span><span class="op">)</span></span>
<span><span class="va">cl3</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"No cluster"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Two clusters"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Six clusters"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl2</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Ten clusters"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl3</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl3</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span></code></pre></div>
<ul>
<li><p>No cluster: 21.401 sec elapsed</p></li>
<li><p>Two clusters: 21.546 sec elapsed</p></li>
<li><p>Six clusters: 14.548 sec elapsed</p></li>
<li><p>Ten clusters: 15.29 sec elapsed</p></li>
<li><p>Ten clusters (second run): 13.617 sec elapsed</p></li>
</ul>
<p>The RStudio server has 48 cores. More parallel cores is probably on average faster. The NINA guidelines is to use max 10 cores, and to remember to close parallel cluster when done.</p>
<div class="sourceCode" id="cb495"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#saveRDS(real_temp_summer, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/real_temp_summer.rds")</span></span>
<span><span class="co">#write_stars(real_temp_summer, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/real_temp_summer.tiff")</span></span></code></pre></div>
<p>These files are about 500 MB, but the tiff file reads in a lot quicker then the rds file, so from now on I’ll just export as tiff. <em>(This could perhaps have been solved with a <code><a href="https://rdrr.io/r/base/gc.html">gc()</a></code>. Later I tried saving as RData with no speed issues problems, but then I had a problem with RData files seemingly becoming corrupted over time - stars objects saved as RData files would not bind together using <code>c.stars()</code> with other matching stars object and I think this could be related to a time stamp in the RData format. So, stick to tiff).</em></p>
<div class="sourceCode" id="cb496"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp</span> <span class="op">&lt;-</span> <span class="fu">read_stars</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">pData</span>, <span class="st">"climate_indicators/aggregated_climate_time_series/real_temp_summer.tiff"</span><span class="op">)</span>,</span>
<span>                                 proxy<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb497"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">summer_median_temp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "real_temp_summer.tiff"</span></span></code></pre></div>
<div class="sourceCode" id="cb498"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">summer_median_temp</span><span class="op">)</span></span>
<span><span class="co">#&gt;    x    y band </span></span>
<span><span class="co">#&gt; 1195 1550   66</span></span></code></pre></div>
<div class="sourceCode" id="cb499"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp</span>, <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>Note that GTiff automatically renames the third dimension <em>band</em> and also renames the attribute.</p>
<div class="sourceCode" id="cb500"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp</span>, <span class="st">"band"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "v_2022" "v_2021" "v_2020" "v_2019" "v_2018" "v_2017"</span></span>
<span><span class="co">#&gt;  [7] "v_2016" "v_2015" "v_2014" "v_2013" "v_2012" "v_2011"</span></span>
<span><span class="co">#&gt; [13] "v_2010" "v_2009" "v_2008" "v_2007" "v_2006" "v_2005"</span></span>
<span><span class="co">#&gt; [19] "v_2004" "v_2003" "v_2002" "v_2001" "v_2000" "v_1999"</span></span>
<span><span class="co">#&gt; [25] "v_1998" "v_1997" "v_1996" "v_1995" "v_1994" "v_1993"</span></span>
<span><span class="co">#&gt; [31] "v_1992" "v_1991" "v_1990" "v_1989" "v_1988" "v_1987"</span></span>
<span><span class="co">#&gt; [37] "v_1986" "v_1985" "v_1984" "v_1983" "v_1982" "v_1981"</span></span>
<span><span class="co">#&gt; [43] "v_1980" "v_1979" "v_1978" "v_1977" "v_1976" "v_1975"</span></span>
<span><span class="co">#&gt; [49] "v_1974" "v_1973" "v_1972" "v_1971" "v_1970" "v_1969"</span></span>
<span><span class="co">#&gt; [55] "v_1968" "v_1967" "v_1966" "v_1965" "v_1964" "v_1963"</span></span>
<span><span class="co">#&gt; [61] "v_1962" "v_1961" "v_1960" "v_1959" "v_1958" "v_1957"</span></span></code></pre></div>
<p>I can rename them.</p>
<div class="sourceCode" id="cb501"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_set_dimensions</span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"v_YEAR"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"temperature"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">summer_median_temp</span><span class="op">)</span></span>
<span><span class="co">#&gt;      x      y v_YEAR </span></span>
<span><span class="co">#&gt;   1195   1550     66</span></span></code></pre></div>
<div class="sourceCode" id="cb502"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">summer_median_temp</span><span class="op">[</span>,,,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">22</span><span class="op">)</span><span class="op">]</span>, downsample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">v_YEAR</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-51"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-51-1.png" alt="Showing three random slices of the year dimension." width="672"><p class="caption">
Figure 3.15: Showing three random slices of the year dimension.
</p>
</div>
</div>
<div id="calculate-reference-values" class="section level3" number="13.8.6">
<h3>
<span class="header-section-number">13.8.6</span> Calculate reference values<a class="anchor" aria-label="anchor" href="#calculate-reference-values"><i class="fas fa-link"></i></a>
</h3>
<div id="aggregate-across-reference-years" class="section level4" number="13.8.6.1">
<h4>
<span class="header-section-number">13.8.6.1</span> Aggregate across reference years<a class="anchor" aria-label="anchor" href="#aggregate-across-reference-years"><i class="fas fa-link"></i></a>
</h4>
<p>We need to first to define a reference period and then to subset our data <code>summer_median_temp</code>. We can practice on the dummy data <code>y</code>.</p>
<div class="sourceCode" id="cb503"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>,</span>
<span>       <span class="st">"P:/"</span>, </span>
<span>       <span class="st">"/data/P-Prosjekter2/"</span><span class="op">)</span></span>
<span><span class="va">path2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, </span>
<span>                <span class="st">"41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data"</span><span class="op">)</span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path2</span>, pattern<span class="op">=</span><span class="st">".rds"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># Looping though the files in the directory</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb504"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">y</span>, <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "1966-05-31" "1966-06-01" "1966-07-20" "1966-09-08"</span></span>
<span><span class="co">#&gt;  [5] "1967-05-31" "1967-06-01" "1967-07-20" "1967-09-08"</span></span>
<span><span class="co">#&gt;  [9] "1968-05-31" "1968-06-01" "1968-07-20" "1968-09-08"</span></span>
<span><span class="co">#&gt; [13] "1969-05-31" "1969-06-01" "1969-07-20" "1969-09-08"</span></span>
<span><span class="co">#&gt; [17] "1970-05-31" "1970-06-01" "1970-07-20" "1970-09-08"</span></span></code></pre></div>
<div class="sourceCode" id="cb505"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_filtered</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">%within%</span> <span class="fu">interval</span><span class="op">(</span><span class="st">"1961-01-01"</span>, <span class="st">"1990-12-31"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we aggregate across years, again using st_apply.</p>
<div class="sourceCode" id="cb506"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">median_sd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb507"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_ref</span> <span class="op">&lt;-</span> <span class="va">y_filtered</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, FUN <span class="op">=</span>  <span class="va">median_sd</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb508"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">y_ref</span><span class="op">)</span></span>
<span><span class="co">#&gt; median_sd         x         y </span></span>
<span><span class="co">#&gt;         2        50        50</span></span></code></pre></div>
<div class="sourceCode" id="cb509"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">y_ref</span>, <span class="st">"median_sd"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "median" "sd"</span></span></code></pre></div>
<p>It’s perhaps easier if median and sd are unique attributes, rather than levels of a dimension.</p>
<div class="sourceCode" id="cb510"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_ref</span> <span class="op">&lt;-</span> <span class="va">y_ref</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="st">"median_sd"</span><span class="op">)</span></span></code></pre></div>
<p>The attribute name <em>mean</em> we can change this to something more meaningful.</p>
<div class="sourceCode" id="cb511"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">y_ref</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>, <span class="st">"sd"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb512"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tmap_arrange</span><span class="op">(</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">y_ref</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"reference_upper"</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">y_ref</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"sd"</span>,</span>
<span>            palette <span class="op">=</span> <span class="st">"-viridis"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-61"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-61-1.png" alt="Showing the upper reference levels and the standard deviation from the dummy data set." width="672"><p class="caption">
Figure 3.20: Showing the upper reference levels and the standard deviation from the dummy data set.
</p>
</div>
<p>Let’s transfer this over to the real data. First we need to rename our dimension values and turn them back into dates.</p>
<div class="sourceCode" id="cb513"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp</span>, <span class="st">"v_YEAR"</span><span class="op">)</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">summer_median_temp_ref</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"v_YEAR"</span>, values <span class="op">=</span> <span class="va">new_dims</span><span class="op">)</span></span></code></pre></div>
<p>Then I can filter to leave only the reference period.</p>
<div class="sourceCode" id="cb514"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp_ref</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp_ref</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">v_YEAR</span> <span class="op">%within%</span> <span class="fu">interval</span><span class="op">(</span><span class="st">"1961-01-01"</span>, <span class="st">"1990-12-31"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp_ref</span>, <span class="st">"v_YEAR"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "1990-01-01" "1989-01-01" "1988-01-01" "1987-01-01"</span></span>
<span><span class="co">#&gt;  [5] "1986-01-01" "1985-01-01" "1984-01-01" "1983-01-01"</span></span>
<span><span class="co">#&gt;  [9] "1982-01-01" "1981-01-01" "1980-01-01" "1979-01-01"</span></span>
<span><span class="co">#&gt; [13] "1978-01-01" "1977-01-01" "1976-01-01" "1975-01-01"</span></span>
<span><span class="co">#&gt; [17] "1974-01-01" "1973-01-01" "1972-01-01" "1971-01-01"</span></span>
<span><span class="co">#&gt; [21] "1970-01-01" "1969-01-01" "1968-01-01" "1967-01-01"</span></span>
<span><span class="co">#&gt; [25] "1966-01-01" "1965-01-01" "1964-01-01" "1963-01-01"</span></span>
<span><span class="co">#&gt; [29] "1962-01-01" "1961-01-01"</span></span></code></pre></div>
<p>And then we calculate the median and sd like above</p>
<div class="sourceCode" id="cb515"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span><span class="va">summer_median_temp_ref</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp_ref</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, </span>
<span>           FUN <span class="op">=</span>  <span class="va">median_sd</span>,</span>
<span>           CLUSTER <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>user</th>
<th>system</th>
<th>elapsed</th>
</tr></thead>
<tbody><tr class="odd">
<td>9.624</td>
<td>6.069</td>
<td>20.903</td>
</tr></tbody>
</table></div>
<p>This is also something I can export.</p>
<div class="sourceCode" id="cb516"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note that write_stars can only export a single attribute, but we have put the 'attributes' as dimensions, and these will be read in as 'band' when importing tiff.</span></span>
<span><span class="fu">write_stars</span><span class="op">(</span><span class="va">summer_median_temp_ref</span>, <span class="st">"/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_ref.tiff"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># I initially saved as RData, like this, but ran into problems later when trying to bind stars objects using c.stars(). It appears RData becomes corrutpt in a sense, over time, perhaps due to some time stamp. If I recreated the object in the global environment and saved as RDatam I could read it in and work with it, but the next day it would not work again.</span></span>
<span><span class="co">#saveRDS(summer_median_temp_ref, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_ref.RData")</span></span></code></pre></div>
<p>Pivot and turn dimension into attributes:</p>
<div class="sourceCode" id="cb517"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp_ref_long</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp_ref</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="st">"band"</span><span class="op">)</span></span></code></pre></div>
<p>The attribute name is <em>mean</em>. We can change this to something more meaningful.</p>
<div class="sourceCode" id="cb518"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp_ref_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>, <span class="st">"sd"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb519"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tmap_arrange</span><span class="op">(</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu">st_downsample</span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"reference_upper"</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu">st_downsample</span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"sd"</span>,</span>
<span>            palette <span class="op">=</span> <span class="st">"-viridis"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-69"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-69-1.png" alt="Showing the upper reference levels and the standard deviation from actual data of median summer temperatures." width="672"><p class="caption">
Figure 13.6: Showing the upper reference levels and the standard deviation from actual data of median summer temperatures.
</p>
</div>
</div>
<div id="combine" class="section level4" number="13.8.6.2">
<h4>
<span class="header-section-number">13.8.6.2</span> Combine<a class="anchor" aria-label="anchor" href="#combine"><i class="fas fa-link"></i></a>
</h4>
<p>I need to combine the variables and the ref values in one data cube</p>
<div class="sourceCode" id="cb520"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="normalise-variable" class="section level3" number="13.8.7">
<h3>
<span class="header-section-number">13.8.7</span> Normalise variable<a class="anchor" aria-label="anchor" href="#normalise-variable"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb521"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># select the columns to normalise</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>, <span class="st">"sd"</span><span class="op">)</span> <span class="op">]</span></span>
<span><span class="va">cols_new</span> <span class="op">&lt;-</span> <span class="va">cols</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cols_new</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="st">"i_"</span>, <span class="va">cols</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb522"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mutate</span></span>
<span></span>
<span><span class="co"># The break point scaling is actually not needed here, since </span></span>
<span><span class="co"># having the lower ref value to be 5 sd implies that the threshold is</span></span>
<span><span class="co"># 2 sd in a linear scaling.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span><span class="va">y_var_norm</span> <span class="op">&lt;-</span> <span class="va">y_var</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>reference_low <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>reference_low2 <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">+</span> <span class="fl">5</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>threshold_low <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>threshold_high <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, <span class="op">~</span> </span>
<span>                  <span class="fu">if_else</span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="va">reference_upper</span>,</span>
<span>                  <span class="fu">if_else</span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="va">threshold_low</span>, </span>
<span>                                        <span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">reference_low</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">threshold_low</span> <span class="op">-</span> <span class="va">reference_low</span><span class="op">)</span>,</span>
<span>                                        <span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">threshold_low</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">reference_upper</span> <span class="op">-</span> <span class="va">threshold_low</span><span class="op">)</span>,</span>
<span>                                        <span class="op">)</span>,</span>
<span>                  <span class="fu">if_else</span><span class="op">(</span><span class="va">.x</span> <span class="op">&gt;</span> <span class="va">threshold_high</span>, </span>
<span>                                        <span class="op">(</span><span class="va">reference_low2</span> <span class="op">-</span> <span class="va">.x</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">reference_low2</span> <span class="op">-</span> <span class="va">threshold_high</span><span class="op">)</span>,</span>
<span>                                        <span class="op">(</span><span class="va">threshold_high</span> <span class="op">-</span> <span class="va">.x</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">threshold_high</span> <span class="op">-</span> <span class="va">reference_upper</span><span class="op">)</span>,</span>
<span>                                        <span class="op">)</span></span>
<span>                <span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">.x</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">cols_new</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">select</span><span class="op">(</span><span class="va">y_var</span>, <span class="fu">all_of</span><span class="op">(</span><span class="va">cols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>user</th>
<th>system</th>
<th>elapsed</th>
</tr></thead>
<tbody><tr class="odd">
<td>14.803</td>
<td>2.717</td>
<td>17.512</td>
</tr></tbody>
</table></div>
<p>Writing to file, this time as RData (could use rds) because tiff don’t allow multiple attributes, and because we don’t need to use <code>c.stars()</code> in this object.</p>
<div class="sourceCode" id="cb523"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y_var_norm</span>, <span class="st">"/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_normalised.RData"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb524"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">lims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">22</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"v_1970"</span><span class="op">]</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"reference_upper"</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"reference_low"</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"reference_low2"</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"i_1970"</span><span class="op">]</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>, ncol<span class="op">=</span><span class="fl">2</span>, nrow<span class="op">=</span><span class="fl">3</span>, align <span class="op">=</span> <span class="st">"hv"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-75"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-75-1.png" alt="Example showing median summer tempretur in 1970, the upper and lwoer reference temperture, i.e. median and 5 SD units of the temperature between  1961-1990, and finally, the scaled indicator values." width="672"><p class="caption">
Figure 13.7: Example showing median summer tempretur in 1970, the upper and lwoer reference temperture, i.e. median and 5 SD units of the temperature between 1961-1990, and finally, the scaled indicator values.
</p>
</div>
<p>The <em>real</em> indicator values should be means over 5 year periods. Calculating a running mean for all time steps is too time consuming. Therefore, the scaled, regional indicator values will be calculated for distinct time steps. The time series can perhaps best be presented with yearly resolution.</p>
</div>
<div id="plot-time-series-as-line-graphs" class="section level3" number="13.8.8">
<h3>
<span class="header-section-number">13.8.8</span> Plot time series as line graphs<a class="anchor" aria-label="anchor" href="#plot-time-series-as-line-graphs"><i class="fas fa-link"></i></a>
</h3>
<p>We could also plot a time series as a series of maps, but then we need to average over these 5 year time periods first. We can get to that later.</p>
<p>To plot time series I first need to do a spatial aggregation. One option is to spatially aggregate the stars object directly, using the <code>reg</code> data set:</p>
<div class="sourceCode" id="cb525"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">y_var_norm</span><span class="op">[</span><span class="fl">1</span>,,<span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">reg</span>, <span class="va">mean</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span><span class="va">temp2</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="co"># too slow</span></span></code></pre></div>
<p>However, this does no preserve the region name, and a subsequent <code>st_intersection</code> taks a little while and gives some boundary problems.</p>
<p>I can also convert pixels to points and then do the intersection.</p>
<div class="sourceCode" id="cb526"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb526-1"><a href="climate-indicators-explained.html#cb526-1" aria-hidden="true" tabindex="-1"></a>temp_points <span class="ot">&lt;-</span> y_var_norm[<span class="dv">1</span>,,] <span class="sc">%&gt;%</span></span>
<span id="cb526-2"><a href="climate-indicators-explained.html#cb526-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">as_points =</span> <span class="cn">TRUE</span>, <span class="at">merge =</span> <span class="cn">FALSE</span>)</span>
<span id="cb526-3"><a href="climate-indicators-explained.html#cb526-3" aria-hidden="true" tabindex="-1"></a>temp_points2 <span class="ot">&lt;-</span> temp_points <span class="sc">%&gt;%</span></span>
<span id="cb526-4"><a href="climate-indicators-explained.html#cb526-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(reg) <span class="st">" too slow"</span></span></code></pre></div>
<p>But this also took too long.</p>
<p>I can perhaps aggregate, and then turn to points and intersect, but that did not work perfect either.</p>
<p>I can rasterize the regions data set, turn it into a coded dimension and use st_apply, but that is tedious.</p>
<p>Let me try using <code>exact_extract</code>, as an alternative to <code>aggregate</code>. This requires us to turn to the <code>terra</code> package for a bit.</p>
<div class="sourceCode" id="cb527"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span><span class="va">regional_means</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">exact_extract</span><span class="op">(</span><span class="va">reg</span>, fun <span class="op">=</span> <span class="st">'mean'</span>, append_cols <span class="op">=</span> <span class="st">"region"</span>, progress<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"region"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>user; system; elapsed: 7.603; 3.071; 10.697</p>
<p>That was fast!</p>
<p>I should also get the sd:</p>
<div class="sourceCode" id="cb528"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span><span class="va">regional_sd</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">exact_extract</span><span class="op">(</span><span class="va">reg</span>, fun <span class="op">=</span> <span class="st">'stdev'</span>, append_cols <span class="op">=</span> <span class="st">"region"</span>, progress<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"region"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>user; system; elapsed: 7.420; 2.921; 10.355</p>
<div class="sourceCode" id="cb529"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">regional_means</span>, <span class="st">"temp/regional_means.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">regional_sd</span>, <span class="st">"temp/regional_sd.rds"</span><span class="op">)</span></span></code></pre></div>
<p>Reshape and plot</p>
<div class="sourceCode" id="cb530"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">div</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>,</span>
<span>         <span class="st">"reference_low"</span>,</span>
<span>         <span class="st">"reference_low2"</span>,</span>
<span>         <span class="st">"threshold_low"</span>,</span>
<span>         <span class="st">"threshold_high"</span>,</span>
<span>         <span class="st">"sd"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">regional_means</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">region</span>, <span class="va">div</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">regional_means_long</span> <span class="op">&lt;-</span> <span class="va">regional_means</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">!</span><span class="fu">all_of</span><span class="op">(</span><span class="va">div</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">!</span><span class="va">region</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">separate</span><span class="op">(</span><span class="va">name</span>, into<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span><span class="co">#id_cols = region,</span></span>
<span>              names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">temp</span>, by<span class="op">=</span><span class="fu">join_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>diff <span class="op">=</span> <span class="va">v</span><span class="op">-</span><span class="va">reference_upper</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>threshold_low_centered <span class="op">=</span> <span class="va">threshold_low</span><span class="op">-</span><span class="va">reference_upper</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>threshold_high_centered <span class="op">=</span> <span class="va">threshold_high</span><span class="op">-</span><span class="va">reference_upper</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Adding the spatial sd</span></span>
<span><span class="op">(</span></span>
<span><span class="va">regional_means_long</span> <span class="op">&lt;-</span> <span class="va">regional_sd</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">!</span><span class="fu">all_of</span><span class="op">(</span><span class="va">div</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">!</span><span class="va">region</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">separate</span><span class="op">(</span><span class="va">name</span>, into<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>i_sd <span class="op">=</span> <span class="va">i</span>,</span>
<span>         v_sd <span class="op">=</span> <span class="va">v</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">regional_means_long</span>, by<span class="op">=</span><span class="fu">join_by</span><span class="op">(</span><span class="va">region</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 330 × 15</span></span>
<span><span class="co">#&gt;    region     year   i_sd  v_sd     i     v reference_upper</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 Nord-Norge 2022  0.246  1.90 0.523  11.5            10.2</span></span>
<span><span class="co">#&gt;  2 Nord-Norge 2021  0.255  1.65 0.672  10.8            10.2</span></span>
<span><span class="co">#&gt;  3 Nord-Norge 2020  0.143  1.82 0.784  10.3            10.2</span></span>
<span><span class="co">#&gt;  4 Nord-Norge 2019  0.290  1.77 0.623  10.8            10.2</span></span>
<span><span class="co">#&gt;  5 Nord-Norge 2018  0.344  1.64 0.523  12.5            10.2</span></span>
<span><span class="co">#&gt;  6 Nord-Norge 2017  0.145  1.79 0.794  10.1            10.2</span></span>
<span><span class="co">#&gt;  7 Nord-Norge 2016  0.175  1.74 0.705  10.8            10.2</span></span>
<span><span class="co">#&gt;  8 Nord-Norge 2015  0.198  1.61 0.682  10.6            10.2</span></span>
<span><span class="co">#&gt;  9 Nord-Norge 2014  0.297  1.65 0.545  13.1            10.2</span></span>
<span><span class="co">#&gt; 10 Nord-Norge 2013  0.202  1.65 0.479  11.4            10.2</span></span>
<span><span class="co">#&gt; # ℹ 320 more rows</span></span>
<span><span class="co">#&gt; # ℹ 8 more variables: reference_low &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   reference_low2 &lt;dbl&gt;, threshold_low &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   threshold_high &lt;dbl&gt;, sd &lt;dbl&gt;, diff &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   threshold_low_centered &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   threshold_high_centered &lt;dbl&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb531"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regOrder</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Østlandet"</span>,<span class="st">"Sørlandet"</span>,<span class="st">"Vestlandet"</span>,<span class="st">"Midt-Norge"</span>,<span class="st">"Nord-Norge"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regional_means_long</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>col <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">diff</span><span class="op">&gt;</span><span class="fl">0</span>, <span class="st">"1"</span>, <span class="st">"2"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, </span>
<span>           y <span class="op">=</span> <span class="va">diff</span>, fill <span class="op">=</span> <span class="va">col</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">threshold_low_centered</span><span class="op">)</span>,</span>
<span>        linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">threshold_high_centered</span><span class="op">)</span>,</span>
<span>        linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_segment</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1961</span>, xend<span class="op">=</span><span class="fl">1990</span>,</span>
<span>               y <span class="op">=</span> <span class="fl">0</span>, yend <span class="op">=</span> <span class="fl">0</span>,</span>
<span>               linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_hue</span><span class="op">(</span>l<span class="op">=</span><span class="fl">70</span>, c<span class="op">=</span><span class="fl">60</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Sommertempratur\navvik fra 1961-1990"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span> <span class="va">.</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span>, levels <span class="op">=</span> <span class="va">regOrder</span><span class="op">)</span>,</span>
<span>              ncol<span class="op">=</span><span class="fl">3</span>,</span>
<span>              scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-83"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-83-1.png" alt="Times series for median summer temperature centered on the median value during the reference period. The reference period is indicated with a thick horizontal line. Dottet horisontal lines are 2 sd units for the reference period." width="672"><p class="caption">
Figure 13.8: Times series for median summer temperature centered on the median value during the reference period. The reference period is indicated with a thick horizontal line. Dottet horisontal lines are 2 sd units for the reference period.
</p>
</div>
<p>Then we can take the mean over the last 5 years and add to a spatial representation.</p>
<div class="sourceCode" id="cb532"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">i_aggregatedToPeriods</span> <span class="op">&lt;-</span> <span class="va">regional_means_long</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>period <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2018</span>, <span class="fl">2022</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2018-2022"</span>,</span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2013</span>, <span class="fl">2017</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2013-2017"</span>,</span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2008</span>, <span class="fl">2012</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2008-2012"</span>,</span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2003</span>, <span class="fl">2007</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2003-2007"</span>,</span>
<span>    .default <span class="op">=</span> <span class="st">"pre 2003"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>period_rank <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2018-2022"</span> <span class="op">~</span> <span class="fl">5</span>,</span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2013-2017"</span> <span class="op">~</span> <span class="fl">4</span>,</span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2008-2012"</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2003-2007"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>    .default <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span>, <span class="va">period</span>, <span class="va">period_rank</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>indicator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>            spatial_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">i_sd</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">i_sd</span><span class="op">)</span></span>
<span>            <span class="co">#,</span></span>
<span>            <span class="co">#spatial_sd_mean = mean(i_sd),</span></span>
<span>            <span class="co">#spatial_sd2_max = max(i_sd),</span></span>
<span>            <span class="co">#spatial_sd2_length = length(i_sd)</span></span>
<span>            <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'region', 'period'. You</span></span>
<span><span class="co">#&gt; can override using the `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 25 × 5</span></span>
<span><span class="co">#&gt; # Groups:   region, period [25]</span></span>
<span><span class="co">#&gt;    region     period    period_rank indicator spatial_sd</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 Midt-Norge 2003-2007           2     0.427     0.101 </span></span>
<span><span class="co">#&gt;  2 Midt-Norge 2008-2012           3     0.573     0.143 </span></span>
<span><span class="co">#&gt;  3 Midt-Norge 2013-2017           4     0.536     0.0986</span></span>
<span><span class="co">#&gt;  4 Midt-Norge 2018-2022           5     0.607     0.130 </span></span>
<span><span class="co">#&gt;  5 Midt-Norge pre 2003            1     0.642     0.0277</span></span>
<span><span class="co">#&gt;  6 Nord-Norge 2003-2007           2     0.460     0.122 </span></span>
<span><span class="co">#&gt;  7 Nord-Norge 2008-2012           3     0.675     0.109 </span></span>
<span><span class="co">#&gt;  8 Nord-Norge 2013-2017           4     0.641     0.0937</span></span>
<span><span class="co">#&gt;  9 Nord-Norge 2018-2022           5     0.625     0.118 </span></span>
<span><span class="co">#&gt; 10 Nord-Norge pre 2003            1     0.625     0.0266</span></span>
<span><span class="co">#&gt; # ℹ 15 more rows</span></span></code></pre></div>
<div class="sourceCode" id="cb533"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">i_aggregatedToPeriods</span><span class="op">$</span><span class="va">period</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">i_aggregatedToPeriods</span><span class="op">$</span><span class="va">period_rank</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">i_aggregatedToPeriods</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">period_rank</span>, </span>
<span>             y <span class="op">=</span> <span class="va">indicator</span>,</span>
<span>             colour<span class="op">=</span><span class="va">region</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin<span class="op">=</span><span class="va">indicator</span><span class="op">-</span><span class="va">spatial_sd</span>, </span>
<span>                    ymax<span class="op">=</span><span class="va">indicator</span><span class="op">+</span><span class="va">spatial_sd</span><span class="op">)</span>, </span>
<span>                    width<span class="op">=</span><span class="fl">.2</span>,</span>
<span>                 position<span class="op">=</span><span class="fu">position_dodge</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>                     labels <span class="op">=</span> <span class="va">labs</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"indikatorverdi"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-85"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-85-1.png" alt="Scaled indicator values, aggregated over 5 year intervals. Errors represent spatial variation within regions and across years." width="672"><p class="caption">
Figure 13.9: Scaled indicator values, aggregated over 5 year intervals. Errors represent spatial variation within regions and across years.
</p>
</div>
<p>Finally, I can add these values to the sp object.</p>
<div class="sourceCode" id="cb534"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg2</span> <span class="op">&lt;-</span> <span class="va">reg</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">i_aggregatedToPeriods</span><span class="op">[</span><span class="va">i_aggregatedToPeriods</span><span class="op">$</span><span class="va">period_rank</span><span class="op">==</span><span class="fl">5</span>,<span class="op">]</span>, by<span class="op">=</span><span class="fu">join_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">reg2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "id"          "region"      "GID_0"       "NAME_0"     </span></span>
<span><span class="co">#&gt; [5] "period"      "period_rank" "indicator"   "spatial_sd" </span></span>
<span><span class="co">#&gt; [9] "geometry"</span></span></code></pre></div>
<div class="sourceCode" id="cb535"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myCol</span> <span class="op">&lt;-</span> <span class="st">"RdYlGn"</span></span>
<span><span class="va">myCol2</span> <span class="op">&lt;-</span> <span class="st">"-RdYlGn"</span></span>
<span></span>
<span><span class="va">tm_main</span> <span class="op">&lt;-</span> <span class="fu">tm_shape</span><span class="op">(</span><span class="va">reg2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col<span class="op">=</span><span class="st">"indicator"</span>,</span>
<span>              title<span class="op">=</span><span class="st">"Indikator:\nsommertemperatur"</span>,</span>
<span>    palette <span class="op">=</span> <span class="va">myCol</span>,</span>
<span>    style<span class="op">=</span><span class="st">"fixed"</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">.2</span><span class="op">)</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="va">tm_inset</span> <span class="op">&lt;-</span> <span class="fu">tm_shape</span><span class="op">(</span><span class="va">reg2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col<span class="op">=</span><span class="st">"spatial_sd"</span>,</span>
<span>              title<span class="op">=</span><span class="st">"SD"</span>,</span>
<span>              palette <span class="op">=</span> <span class="va">myCol2</span>,</span>
<span>              style<span class="op">=</span><span class="st">"cont"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>legend.format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tmap_arrange</span><span class="op">(</span><span class="va">tm_main</span>, </span>
<span>             <span class="va">tm_inset</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-87"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-87-1.png" alt="Summer tempreature indicator values for five accounting areas in Norway. SD is the spatial variation." width="672"><p class="caption">
Figure 13.10: Summer tempreature indicator values for five accounting areas in Norway. SD is the spatial variation.
</p>
</div>

<p><br></p>
<p><em>Author and date:</em> Zander Venter</p>
<div class="sourceCode" id="cb536"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2023-08-30"</span></span></code></pre></div>
<p><br></p>
<!-- Load all you dependencies here -->
<!-- Fill in which ecosystem the indicator belongs to, as well as the ecosystem characteristic it should be linked to. It's OK to use some Norwegian here -->
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="37%">
<col width="23%">
<col width="39%">
</colgroup>
<thead><tr class="header">
<th align="left">Ecosystem</th>
<th align="left">Økologisk.egenskap</th>
<th align="left">ECT.class</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">Våtmark og Semi-/Naturlig-åpne</td>
<td align="left">Gjengroing</td>
<td align="left">Structural state characteristic</td>
</tr></tbody>
</table></div>
<!-- Don't remove these three html lines --><p><br><br></p>
<hr>
<!-- Document you work below. Try not to change  the headers too much. Data can be stored on NINA server. Since the book is rendered on the R Server this works fine, but note that directory paths are different on the server compared to you local machine. If it is not too big you may store under /data/ on this repository -->
</div>
</div>
<div id="introduction-11" class="section level2" number="13.9">
<h2>
<span class="header-section-number">13.9</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-11"><i class="fas fa-link"></i></a>
</h2>
<p>The Norwegian word “gjengroing” is directly translated to “regrowing” in English. The gjengroing indicator describes the regrowth of woody vegetation (trees and bushes) in open ecosystems (wetland, semi- and naturally open areas) across Norway. We will use a spatial reference approach where reference areas define good or optimal vegetation regrowth heights.</p>
<p>The workflow spans two platforms including RStudio and Google Earth Engine (GEE). To reproduce this workflow you will need a GEE account and access to the NINA RStudio and R/GeoSpatialData servers.</p>
</div>
<div id="about-the-underlying-data-9" class="section level2" number="13.10">
<h2>
<span class="header-section-number">13.10</span> About the underlying data<a class="anchor" aria-label="anchor" href="#about-the-underlying-data-9"><i class="fas fa-link"></i></a>
</h2>
<p>We rely on the following datasets:</p>
<ul>
<li>
<a href="https://kartkatalog.miljodirektoratet.no/dataset/Details/2050">NiN polygons</a> are used to identify reference areas with good ecological condition.</li>
<li>NIBIO’s <a href="https://kartkatalog.geonorge.no/metadata/arealressurskart-fkb-ar5-arealtyper/280bbd7a-5ce9-4c83-9e15-ac162cabd8a6">AR5</a> is used as the population sample for each ecosystem type. The population sample are the areas used to determine ecological condition relative to the reference areas. We also use the AR5 data to identify forest surrounding the population polygons for defining the lower limit of ecological condition index (ie. poor condition),</li>
<li>LiDAR-derived digital elevation model from Kartverket’s <a href="https://hoydedata.no/LaserInnsyn/">høydedata</a>. This includes both a terrain (DTM) and surface mode (DSM). We calculate the canopy height model (DSM - DTM) to get the height of objects above the ground. From this we remove buildings, and what remains is vegetation - mostly trees but also some bushes or smaller woody plants.</li>
<li>Kartverket’s <a href="https://kartkatalog.geonorge.no/metadata/dtm-10-terrengmodell-utm32/fd851873-f363-46f9-9fc6-bb1b403575df">national 10m elevation model</a>. We use this to stratify reference (good condition) and forest (poor condition) heights by elevational band. This is done in combination with bioclimatic zones - see next point.</li>
<li>Moen’s <a href="https://artsdatabanken.no/Pages/181901/Bioklimatiske_soner">bioclimatic zones</a>. We use this to stratify reference (good condition) and forest (poor condition) heights by bioclimatic (also referred to as vegetation/climatic) zones.</li>
<li>
<a href="https://kartkatalog.geonorge.no/metadata/fkb-bygning/8b4304ea-4fb0-479c-a24d-fa225e2c6e97">FKB building footprints</a> are used to isolate vegetation in the LiDAR height data.</li>
<li>A <a href="https://www.nature.com/articles/s41893-020-00609-y">European satellite-based map</a> of forest clear cuts is used for identifying AR5 forest patches in near-climax successional stages.</li>
<li>The <a href="https://kartkatalog.geonorge.no/metadata/statistisk-rutenett-5000m/32ac0653-d95c-446c-8558-bf9b79f4934e">SSB 10km grid</a> is used for visualization purposes.</li>
<li>The regional delineation for Norway (five regions) are used for aggregating and reporting gjengroing condition values.</li>
</ul>
<div id="representativity-in-time-and-space-8" class="section level3" number="13.10.1">
<h3>
<span class="header-section-number">13.10.1</span> Representativity in time and space<a class="anchor" aria-label="anchor" href="#representativity-in-time-and-space-8"><i class="fas fa-link"></i></a>
</h3>
<p>The index will cover the mainland of Norway. The analysis will be stratified by (1) åpne and (2) våtmark ecosystems. The former includes both semi-naturlig mark and naturlig åpne områder under skoggrensa (due to the fact that AR5 does not differentiate these), and the latter includes våtmark only. The LiDAR data cover a range of years and therefore the indicator represents conditions for circa 2010 to 2021.</p>
</div>
<div id="original-units-5" class="section level3" number="13.10.2">
<h3>
<span class="header-section-number">13.10.2</span> Original units<a class="anchor" aria-label="anchor" href="#original-units-5"><i class="fas fa-link"></i></a>
</h3>
<p>The original units for ecological condition are meters. This is the height of the vegetation within referecne, polygon and forest areas.</p>
</div>
<div id="temporal-coverage-7" class="section level3" number="13.10.3">
<h3>
<span class="header-section-number">13.10.3</span> Temporal coverage<a class="anchor" aria-label="anchor" href="#temporal-coverage-7"><i class="fas fa-link"></i></a>
</h3>
<p>Circa 2010 to 2021. This is a single snapshot and not a change analysis. In the future, when LiDAR data has been repeated across the country, it may be possible to do a change assessment. In addition, the use of optical or radar satellite imagery may serve as a proxy for vegetation height using machine learning. This will allow for annual updates, depending on the uncertainty in the satellite-based maps of vegetation height.</p>
</div>
<div id="aditional-comments-about-the-dataset-3" class="section level3" number="13.10.4">
<h3>
<span class="header-section-number">13.10.4</span> Aditional comments about the dataset<a class="anchor" aria-label="anchor" href="#aditional-comments-about-the-dataset-3"><i class="fas fa-link"></i></a>
</h3>
<p>None.</p>
</div>
</div>
<div id="ecosystem-characteristic-5" class="section level2" number="13.11">
<h2>
<span class="header-section-number">13.11</span> Ecosystem characteristic<a class="anchor" aria-label="anchor" href="#ecosystem-characteristic-5"><i class="fas fa-link"></i></a>
</h2>
<div id="norwegain-standard-1" class="section level3" number="13.11.1">
<h3>
<span class="header-section-number">13.11.1</span> Norwegain standard<a class="anchor" aria-label="anchor" href="#norwegain-standard-1"><i class="fas fa-link"></i></a>
</h3>
<p>Not sure what this means??</p>
</div>
</div>
<div id="collinearities-with-other-indicators-7" class="section level2" number="13.12">
<h2>
<span class="header-section-number">13.12</span> Collinearities with other indicators<a class="anchor" aria-label="anchor" href="#collinearities-with-other-indicators-7"><i class="fas fa-link"></i></a>
</h2>
<p>There is possibly a collinearity with the primary production indicator (primærproduksjon). The primary production indicator uses the normalized difference vegetation index (NDVI) as a proxy for vegetation production. NDVI can be correlated with vegetation height and consequently yield similar results to the LiDAR-based gjengroing indicator.</p>
</div>
<div id="reference-state-and-values-3" class="section level2" number="13.13">
<h2>
<span class="header-section-number">13.13</span> Reference state and values<a class="anchor" aria-label="anchor" href="#reference-state-and-values-3"><i class="fas fa-link"></i></a>
</h2>
<p>The methodology used to calculate the gjengroing indicator is outlined in the schematic below. The workflow in the schematic is conducted for all reference and population polygons in Norway and repeated for each ecosystem type (åpne and våtmark), respectively. The indicator values are aggregated to a 50km grid and regional level at the end. The individual steps are discussed in turn in the following subsections.</p>
<div class="sourceCode" id="cb537"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">include_graphics</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/gjengroing_schematic.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="../../../P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/gjengroing_schematic.jpg" width="1096"></div>
<div id="reference-state-3" class="section level3" number="13.13.1">
<h3>
<span class="header-section-number">13.13.1</span> Reference state<a class="anchor" aria-label="anchor" href="#reference-state-3"><i class="fas fa-link"></i></a>
</h3>
<p>The NiN polygons including “Naturlig åpne områder under skoggrensa”, “Semi-naturlig mark”, and “Våtmark” with good ecological condition are used to define a reference gjengroing state. We use the all-encompassing “Tilstand” variable assigned to each NiN polygon. The 50th percentile of LiDAR-derived vegetation heights within these polygons is used to define the upper limit (ie. 1) of the scaled indicator value. We cannot define local reference values based on proximity, because the NiN polygons are spatially biased and not close to all AR5 population polygons. Therefore we calculate regional reference values using elevation (300m bands) and bioclimatic zones as stratification. We calculate the mean reference value for each unique combination of elevation-bioclimatic zone. When calculating the index for each population polygon, the reference value is inhereted from the elecation-bioclimatic zone it falls within.</p>
</div>
<div id="reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values-7" class="section level3" number="13.13.2">
<h3>
<span class="header-section-number">13.13.2</span> Reference values, thresholds for defining <em>good ecological condition</em>, minimum and/or maximum values<a class="anchor" aria-label="anchor" href="#reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values-7"><i class="fas fa-link"></i></a>
</h3>
<p>Once we have the reference vegetation height for a given ecosystem type and elevation-bioclimatic zone, we need to define the minimum (or worst/bad) condition. We use the 50th percentile of LiDAR-derived vegetation heights within AR5 skog polygons to define a climax vegetation successional stage where gjengroing is at its most extreme. In order not to include forest patches that have recently been harvested, we mask out any forest which has been clear-cut since 1986. Here, 1986 is a hard limit defined by the clear-cut dataset which was based on Landsat imagery. Therefore we can be assured that we are measuring forest that is at least 35 years old.</p>
<p>We use both local and regional “reference” approaches to defining poor ecological condition. To do this we calculate the forest heights in AR5 forest patches that fall within 200m of a population polygon (local reference). For population polygons that do not have forest within their proximity, we use the mean forest height within the unique elevation-bioblimatic zone the population falls within (regional reference).</p>
<p>To define the ecological condition of the population polygon, we measure 50th percentile of LiDAR-derived vegetation height. As a reminder, we use AR5 polygons that have types that are approximately compatible with the NiN ecosystem types. For våtmark we use the AR5 polygons defined as “Myr”. For åpne ecosystems we use the AR5 polygons defined as either “Åpent fastmark” or “Innmarksbeite”.</p>
<p>The vegetation height percentiles are then scaled to between 0 and 1 using a sigmoid transformation <a href="https://www.sciencedirect.com/science/article/pii/S1470160X21000066">Oliver at al. (2021)</a>.</p>
</div>
</div>
<div id="uncertainties-7" class="section level2" number="13.14">
<h2>
<span class="header-section-number">13.14</span> Uncertainties<a class="anchor" aria-label="anchor" href="#uncertainties-7"><i class="fas fa-link"></i></a>
</h2>
<p>For the indicator map at the polygon level there is no uncertainty associated with the indicator values. For aggregated indicator values (e.g. for 50km grid and regions), the uncertainty in the indicator value is calculated from the spatial variation in the polygon-level reference height values. We could use the alternative of calculating the spatial variation in the indicator values via bootstrapping using the EAtools package. However, given the extreme number of population polygons, the uncertainty values are extremely small and therefore we choose to use the standard deviation in reference vegetation heights, converted to the indicator scale.</p>
</div>
<div id="references-8" class="section level2" number="13.15">
<h2>
<span class="header-section-number">13.15</span> References<a class="anchor" aria-label="anchor" href="#references-8"><i class="fas fa-link"></i></a>
</h2>
<p>Links to data and resources are provided with hyperlinks in-line.</p>
</div>
<div id="analyses-10" class="section level2" number="13.16">
<h2>
<span class="header-section-number">13.16</span> Analyses<a class="anchor" aria-label="anchor" href="#analyses-10"><i class="fas fa-link"></i></a>
</h2>
<div id="data-sets-4" class="section level3" number="13.16.1">
<h3>
<span class="header-section-number">13.16.1</span> Data sets<a class="anchor" aria-label="anchor" href="#data-sets-4"><i class="fas fa-link"></i></a>
</h3>
<p>There are several datasets which are used in GEE which will not be imported into the R session here. These datasets have been obtained from the source and ingested into GEE by Zander Venter or Vegard Bakkestuen with the help of Miljædata section at NINA. They include</p>
<ul>
<li><a href="https://kartkatalog.geonorge.no/metadata/arealressurskart-fkb-ar5-arealtyper/280bbd7a-5ce9-4c83-9e15-ac162cabd8a6">AR5</a></li>
<li>
<a href="https://hoydedata.no/LaserInnsyn/">LiDAR-derived digital elevation model from høydedata</a>.</li>
<li><a href="https://kartkatalog.geonorge.no/metadata/dtm-10-terrengmodell-utm32/fd851873-f363-46f9-9fc6-bb1b403575df">Kartverket’s national 10m elevation model</a></li>
<li><a href="https://kartkatalog.geonorge.no/metadata/fkb-bygning/8b4304ea-4fb0-479c-a24d-fa225e2c6e97">FKB building footprints</a></li>
<li><a href="https://www.nature.com/articles/s41893-020-00609-y">European forest clear-cut map</a></li>
</ul>
<p>The remaining datasets will be imported into the R session.</p>
<div id="regions-4" class="section level4" number="13.16.1.1">
<h4>
<span class="header-section-number">13.16.1.1</span> Regions<a class="anchor" aria-label="anchor" href="#regions-4"><i class="fas fa-link"></i></a>
</h4>
<p>The regional delineation for Norway (five regions) are used for aggregating and reporting gjengroing condition values.</p>
<div class="sourceCode" id="cb538"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/regions.shp'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `regions' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/regions.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co"># Rename regions with correct Norwegian characters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">regions</span><span class="op">$</span><span class="va">region</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Østlandet"</span>, <span class="st">"Midt-Norge"</span>,<span class="st">"Nord-Norge"</span>,<span class="st">"Sørlandet"</span>,<span class="st">"Vestlandet"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="ssb-10-and-50km-grids" class="section level4" number="13.16.1.2">
<h4>
<span class="header-section-number">13.16.1.2</span> SSB 10 and 50km grids<a class="anchor" aria-label="anchor" href="#ssb-10-and-50km-grids"><i class="fas fa-link"></i></a>
</h4>
<p>The <a href="https://kartkatalog.geonorge.no/metadata/statistisk-rutenett-5000m/32ac0653-d95c-446c-8558-bf9b79f4934e">SSB 10km and 50km grids</a> are used for visualizing the distribution of available data and for aggregating gjengroing index scores.</p>
<div class="sourceCode" id="cb539"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ssb10km</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_10km/ssb10km.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="co"># mutate the id value so that it aligns with the data coming from GEE</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>SSBID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `ssb10km' from data source </span></span>
<span><span class="co">#&gt;   `/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_10km/ssb10km.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 4218 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -80000 ymin: 6440000 xmax: 1120000 ymax: 7940000</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 33N</span></span>
<span><span class="co"># Transform to the correct projection</span></span>
<span><span class="va">ssb10km</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">ssb10km</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ssb50km</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_50km/ssb50km.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="co"># mutate the id value so that it aligns with the data coming from GEE</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>SSBID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `ssb50km' from data source </span></span>
<span><span class="co">#&gt;   `/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_50km/ssb50km.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 273 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -150000 ymin: 6400000 xmax: 1150000 ymax: 8e+06</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 33N</span></span>
<span><span class="co"># Transform to the correct projection</span></span>
<span><span class="va">ssb50km</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">ssb50km</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="bioclimatic-regions" class="section level4" number="13.16.1.3">
<h4>
<span class="header-section-number">13.16.1.3</span> Bioclimatic regions<a class="anchor" aria-label="anchor" href="#bioclimatic-regions"><i class="fas fa-link"></i></a>
</h4>
<p>The Moen’s bioclimatic regions are imported from NINA R/GeoSpatialData/ server.</p>
<div class="sourceCode" id="cb540"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bioclim</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/BiogeographicalRegions/Norway_VegetationZones_Moen/Original/Vector/soner.shp'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>NAVN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">NAVN</span> <span class="op">==</span> <span class="st">'S°rboreal'</span>, <span class="st">'Sørboreal'</span>, <span class="va">NAVN</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `soner' from data source </span></span>
<span><span class="co">#&gt;   `/data/R/GeoSpatialData/BiogeographicalRegions/Norway_VegetationZones_Moen/Original/Vector/soner.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 3050 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -75844 ymin: 6449504 xmax: 1114610 ymax: 7939790</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 33N</span></span>
<span><span class="va">bioclim</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">bioclim</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="nin-polygons" class="section level4" number="13.16.1.4">
<h4>
<span class="header-section-number">13.16.1.4</span> NiN polygons<a class="anchor" aria-label="anchor" href="#nin-polygons"><i class="fas fa-link"></i></a>
</h4>
<p><a href="https://kartkatalog.miljodirektoratet.no/dataset/Details/2050">NiN polygons</a> are imported here from the NINA servers:</p>
<div class="sourceCode" id="cb541"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nin</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/Habitats_biotopes/Norway_Miljodirektoratet_Naturtyper_nin/Original/versjon20221231/Natur_Naturtyper_NiN_norge_med_svalbard_25833/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="co"># Simplify ecosystem names</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>hovedøkosystem <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">hovedøkosystem</span>, </span>
<span>                                 <span class="st">"Våtmark"</span> <span class="op">=</span> <span class="st">'Våtmark'</span>,</span>
<span>                                 <span class="st">"Skog"</span> <span class="op">=</span> <span class="st">"Skog"</span>,</span>
<span>                                 <span class="st">"Ingen"</span> <span class="op">=</span> <span class="st">"Ingen"</span>,</span>
<span>                                 <span class="st">"Fjell"</span> <span class="op">=</span> <span class="st">"Fjell"</span>,</span>
<span>                                 <span class="st">"Semi-naturlig mark"</span> <span class="op">=</span> <span class="st">'Semi-naturlig'</span>,</span>
<span>                                 <span class="st">"Naturlig åpne områder i lavlandet"</span> <span class="op">=</span> <span class="st">'Naturlig åpne'</span>,</span>
<span>                                 <span class="st">"Naturlig åpne områder under skoggrensa"</span> <span class="op">=</span> <span class="st">'Naturlig åpne'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Fix any invalid geometries</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>validGeo <span class="op">=</span> <span class="fu">st_is_valid</span><span class="op">(</span><span class="va">SHAPE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">validGeo</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Filter out the ecosystems we are not interested in</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">hovedøkosystem</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Skog'</span>,<span class="st">'Ingen'</span>,<span class="st">'Fjell'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Get the main ecosystem codes in case we need them later</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>hovedtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">ninkartleggingsenheter</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>         hovedtype <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">hovedtype</span>, <span class="st">'-'</span><span class="op">)</span>,</span>
<span>         id <span class="op">=</span> <span class="va">identifikasjon_lokalid</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Drop polygons with no condition score</span></span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">tilstand</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">hovedøkosystem</span>, <span class="va">hovedtype</span>, <span class="va">naturtypekode</span>, <span class="va">tilstand</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `Naturtyper_NiN_norge_med_svalbard' from data source `/data/R/GeoSpatialData/Habitats_biotopes/Norway_Miljodirektoratet_Naturtyper_nin/Original/versjon20221231/Natur_Naturtyper_NiN_norge_med_svalbard_25833/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb' </span></span>
<span><span class="co">#&gt;   using driver `OpenFileGDB'</span></span>
<span><span class="co">#&gt; Simple feature collection with 95469 features and 35 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -74953.5 ymin: 6448986 xmax: 1075080 ymax: 7921283</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<ul>
<li><strong>Export the cleaned NiN data and upload to GEE before proceeding</strong></li>
</ul>
<div class="sourceCode" id="cb542"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Only run if you are repeating this workflow for the first time</span></span>
<span><span class="co"># nin %&gt;%</span></span>
<span><span class="co">#   dplyr::select(id, hovedøkosystem, tilstand) %&gt;%</span></span>
<span><span class="co">#   st_transform(st_crs(fylker_wgs84)) %&gt;%</span></span>
<span><span class="co">#   st_write('nin_cleaned.shp', append=FALSE)</span></span></code></pre></div>
<ul>
<li>
<strong>Now run the following GEE JavaScript code by clicking on the hyperlink:</strong> <a href="https://code.earthengine.google.com/b2d06ad72c515fbbb3024f157987eedc">GEE script</a> This script is also found in the SCR repository as “GEE_script.js”. When you run the script, then click the Tasks tab in the GEE code editor and run the export tasks. The export files will appear in your Google Drive. Download the files from your Google Drive to the /data/gjengroing/From_GEE directory. This script extracts three CSV files:
<ul>
<li>‘area_cover_grid.csv’ - this gives the area coverage of NiN, AR5 and LiDAR data for each 10x10km SSB grid cell.</li>
<li>‘elevation_stratified.shp’ - this is a 300m elevation band stratification that is simply used for visualizing the strata here in R.</li>
<li>‘vegHeights.zip’ - this is a folder with hundreds of CSV files. These files contain the vegetation heights for reference, population, and forest polygons over Norway. The exports were split by 50km grid to prevent hitting user memory limits in GEE. Unzip the folder before you upload to ./DATA/From_GEE/</li>
</ul>
</li>
</ul>
</div>
<div id="data-from-google-earth-engine" class="section level4" number="13.16.1.5">
<h4>
<span class="header-section-number">13.16.1.5</span> Data from Google Earth Engine<a class="anchor" aria-label="anchor" href="#data-from-google-earth-engine"><i class="fas fa-link"></i></a>
</h4>
<p>Once you have run the GEE script above, and downloaded the data to the /data/gjengroing/From_GEE directory, you can proceed with this R workflow.</p>
<p>Create functions to import vegetation height files and stratify data by elevation band and vegetation/climate zone</p>
<div class="sourceCode" id="cb543"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to read in multiple files resulting from GEE exports</span></span>
<span><span class="va">readVegHeightFiles</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">uniqueString</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dir</span> <span class="op">&lt;-</span> <span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/vegHeights/'</span></span>
<span>  <span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">[</span><span class="fu">str_detect</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, <span class="va">uniqueString</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="co">#print(files)</span></span>
<span>  </span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">files</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>                  <span class="fu">mutate</span><span class="op">(</span>ssbid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu">str_split</span><span class="op">(</span><span class="va">i</span>, <span class="st">'_'</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">1</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Vegetation type lookup</span></span>
<span><span class="va">vegLookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  vegClimZone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span>, </span>
<span>  vegClimZoneLab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Nemoral'</span>,<span class="st">'Boreonemoral'</span>,<span class="st">'Sørboreal'</span>,<span class="st">'Mellomboreal'</span>,<span class="st">'Nordboreal'</span>,<span class="st">'Alpin'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Elevation stratification and vegetation type cleaning function</span></span>
<span><span class="va">cleanElevVegType</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">dataOut</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>e <span class="op">=</span> <span class="va">elevation</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>elevation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&lt;</span> <span class="fl">300</span>, <span class="st">'0-300'</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&gt;</span> <span class="fl">300</span> <span class="op">&amp;</span> <span class="va">e</span> <span class="op">&lt;</span> <span class="fl">600</span>, <span class="st">'300-600'</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&gt;</span> <span class="fl">600</span> <span class="op">&amp;</span> <span class="va">e</span> <span class="op">&lt;</span> <span class="fl">900</span>, <span class="st">'600-900'</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&gt;</span> <span class="fl">900</span> <span class="op">&amp;</span> <span class="va">e</span> <span class="op">&lt;</span> <span class="fl">1200</span>, <span class="st">'900-1200'</span>, <span class="st">'&gt;1200'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>vegClimZone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">vegClimZone</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vegLookup</span>, by <span class="op">=</span> <span class="st">'vegClimZone'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">e</span>, <span class="op">-</span><span class="va">vegClimZone</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">vegClimZoneLab</span>, <span class="va">elevation</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">dataOut</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>Import the CSV files generated in GEE related to area covers and elevation bands:</p>
<div class="sourceCode" id="cb544"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import data coverages per SSB 10km grid cell</span></span>
<span><span class="va">areaCovers</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/area_cover_grid.csv'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="st">'system:index'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate percentage cover relative to the land area in each cell</span></span>
<span><span class="va">areaCoversPerc</span> <span class="op">&lt;-</span> <span class="va">areaCovers</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">gather</span><span class="op">(</span><span class="va">key</span>, <span class="va">val</span>, <span class="va">aapne_ar5</span>, <span class="va">vaatmark_ar5</span>,<span class="va">aapne_nin</span>, <span class="va">vaatmark_nin</span>, <span class="va">lidarCover</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'ar5'</span><span class="op">)</span>, <span class="st">'ar5'</span>, </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'nin'</span><span class="op">)</span>, <span class="st">'nin'</span>, </span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="st">'lidarCover'</span>, <span class="st">'lidar'</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ecosystem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'aapne'</span><span class="op">)</span>, <span class="st">'Semi-/Naturlig åpne'</span>, </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'vaatmark'</span><span class="op">)</span>, <span class="st">'Våtmark'</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="va">val</span><span class="op">/</span><span class="va">land</span><span class="op">*</span><span class="fl">100</span>,</span>
<span>         areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">areaPerc</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">areaPerc</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">SSBID</span>, <span class="va">key</span>, <span class="va">type</span>,<span class="va">ecosystem</span>, <span class="va">areaPerc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">elevStrata</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/elevation_stratified.shp'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>elevBand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">'0-300'</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">2</span>, <span class="st">'300-600'</span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">3</span>, <span class="st">'600-900'</span>,</span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">4</span>, <span class="st">'900-1200'</span>, <span class="st">'&gt;1200'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         elevBand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">elevBand</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'0-300'</span>,<span class="st">'300-600'</span>,<span class="st">'600-900'</span>,<span class="st">'900-1200'</span>,<span class="st">'&gt;1200'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `elevation_stratified' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/elevation_stratified.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 10293 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4.078351 ymin: 57.8515 xmax: 31.78239 ymax: 71.29928</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="va">elevStrata</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">elevStrata</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Import the CSV files generated in GEE of vegetation heights (circa 15 min runtime):</p>
<div class="sourceCode" id="cb545"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Import median LiDAR heights for NiN polygons</span></span>
<span>  <span class="va">refVaatmarkRaw</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'vaatmark_ref'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ref <span class="op">=</span> <span class="va">chm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="st">'system:index'</span>, <span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  <span class="va">refAapneRaw</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'aapne_ref'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ref <span class="op">=</span> <span class="va">chm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="st">'system:index'</span>, <span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add elevation and veg/clim zones and summarise per strata</span></span>
<span>    <span class="co"># this will form the upper limit of the ecological condition score (ie. good condition)</span></span>
<span>  <span class="va">refVaatmark</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">refVaatmarkRaw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">refAapne</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">refAapneRaw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Export to file for reference</span></span>
<span>  <span class="va">refVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refVaatmark.csv'</span><span class="op">)</span></span>
<span>  <span class="va">refAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refAapne.csv'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Import median LiDAR heights for AR5 polygons for population measurement</span></span>
<span>  <span class="va">popVaatmarkHt</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'vaatmark_pop'</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  <span class="va">popAapneHt</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'aapne_pop'</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Turn into spatial objects using the .geo column in the CSV</span></span>
<span>  <span class="va">popVaatmarkHt</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu">bind_cols</span><span class="op">(</span><span class="va">popVaatmarkHt</span>,<span class="fu">geojsonsf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span><span class="op">(</span><span class="va">popVaatmarkHt</span><span class="op">$</span><span class="va">.geo</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">popAapneHt</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu">bind_cols</span><span class="op">(</span><span class="va">popAapneHt</span>,<span class="fu">geojsonsf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span><span class="op">(</span><span class="va">popAapneHt</span><span class="op">$</span><span class="va">.geo</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Import median LiDAR heights for forest (skog) within 200m of population polygons</span></span>
<span>    <span class="co"># this will form the lower limit of the ecological condition score (ie. poor condition)</span></span>
<span>  <span class="va">popVaatmarkSkog</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'vaatmark_skog'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span>, <span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="va">ssbid</span><span class="op">)</span></span>
<span>  <span class="va">popAapneSkog</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'aapne_skog'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span>, <span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="va">ssbid</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Combine the population heights with the forest heights</span></span>
<span>  <span class="va">popVaatmark</span> <span class="op">&lt;-</span> <span class="va">popVaatmarkHt</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popVaatmarkSkog</span>, by <span class="op">=</span> <span class="st">'system:index'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span><span class="op">)</span></span>
<span>  <span class="va">popAapne</span> <span class="op">&lt;-</span> <span class="va">popAapneHt</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popAapneSkog</span>, by <span class="op">=</span> <span class="st">'system:index'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add elevation and veg/clim zones to the combined population and forest heights</span></span>
<span>  <span class="va">popVaatmark</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">popVaatmark</span><span class="op">)</span></span>
<span>  <span class="va">popAapne</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">popAapne</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Get regional reference values for forest height</span></span>
<span>    <span class="co"># this is to fill in for population polygons which did not have any forest within 200m</span></span>
<span>  <span class="va">vaatmarkSkogRegionalRef</span> <span class="op">&lt;-</span> <span class="va">popVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>skogFill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">skogFill</span><span class="op">)</span></span>
<span>  <span class="va">aapneSkogRegionalRef</span> <span class="op">&lt;-</span> <span class="va">popAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>skogFill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">skogFill</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Combine all the above into one data frame</span></span>
<span>  <span class="co">#set.seed(123)</span></span>
<span>  <span class="va">vaatmarkHts</span> <span class="op">&lt;-</span> <span class="va">popVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#sample_n(100000) %&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">refVaatmark</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span>, <span class="va">elevation</span>, <span class="va">vegClimZoneLab</span>, <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>values_from <span class="op">=</span> <span class="va">height</span>, names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># If population height is less than the reference value, then it is automatically "good" condition - ie. it inherits the reference height so that the rescaled value will be 1</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">pop</span> <span class="op">&lt;</span> <span class="va">ref</span>, <span class="va">ref</span>, <span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkSkogRegionalRef</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>, <span class="va">skogFill</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">skogFill</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">skog</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="co">#colSums(is.na(vaatmarkHts))</span></span>
<span>  </span>
<span>  <span class="va">aapneHts</span> <span class="op">&lt;-</span> <span class="va">popAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#sample_n(100000) %&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">refAapne</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span>, <span class="va">elevation</span>, <span class="va">vegClimZoneLab</span>, <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>values_from <span class="op">=</span> <span class="va">height</span>, names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># If population height is less than the reference value, then it is automatically "good" condition - ie. it inherits the reference height so that the rescaled index will be 1</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">pop</span> <span class="op">&lt;</span> <span class="va">ref</span>, <span class="va">ref</span>, <span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneSkogRegionalRef</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>, <span class="va">skogFill</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">skogFill</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">skog</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="co">#colSums(is.na(aapneHts))</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">refVaatmark</span>  <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refVaatmark.csv'</span><span class="op">)</span></span>
<span>  <span class="va">refAapne</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refAapne.csv'</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div id="explore-data-coverages" class="section level3" number="13.16.2">
<h3>
<span class="header-section-number">13.16.2</span> Explore data coverages<a class="anchor" aria-label="anchor" href="#explore-data-coverages"><i class="fas fa-link"></i></a>
</h3>
<p>Here we will make maps of NiN, AR5 and LiDAR coverage over Norway to get a feel for the data distributions. These areas were calculated in GEE and exported to CSV in the GEE script provided above. All we need to do now is join them with the SSB 10km grid and visualize.</p>
<div class="sourceCode" id="cb546"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">c1</span> <span class="op">&lt;-</span> <span class="va">ssb10km</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">areaCoversPerc</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'nin'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">group_by</span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">summarise</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">areaPerc</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">areaPerc</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#e6bf6b'</span>, <span class="st">'#91b5a2'</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'% cover'</span>,</span>
<span>                       limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                       oob<span class="op">=</span><span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'A) NiN polygons with good condition'</span><span class="op">)</span></span>
<span><span class="co">#c1</span></span>
<span><span class="va">c2</span> <span class="op">&lt;-</span> <span class="va">ssb10km</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">areaCoversPerc</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'ar5'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">group_by</span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">summarise</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">areaPerc</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">areaPerc</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#e6bf6b'</span>, <span class="st">'#91b5a2'</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'% cover'</span>,</span>
<span>                       limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>                       oob<span class="op">=</span><span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'B) AR5 polygons'</span><span class="op">)</span></span>
<span><span class="co">#c2</span></span>
<span><span class="va">c3</span> <span class="op">&lt;-</span> <span class="va">ssb10km</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">areaCoversPerc</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'lidar'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">group_by</span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">summarise</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">areaPerc</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">areaPerc</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#e6bf6b'</span>, <span class="st">'#91b5a2'</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'% cover'</span>,</span>
<span>                       limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>                       oob<span class="op">=</span><span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'C) LiDAR canopy height model'</span><span class="op">)</span></span>
<span><span class="co">#c3</span></span>
<span></span>
<span><span class="va">coverageFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">c1</span>, <span class="va">c2</span>, <span class="va">c3</span>, ncol<span class="op">=</span><span class="fl">3</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-13-1.png" width="1440"></div>
</div>
<div id="bioclimatic-zone-and-elevation-strata-for-regional-reference-values" class="section level3" number="13.16.3">
<h3>
<span class="header-section-number">13.16.3</span> Bioclimatic zone and elevation strata for regional reference values<a class="anchor" aria-label="anchor" href="#bioclimatic-zone-and-elevation-strata-for-regional-reference-values"><i class="fas fa-link"></i></a>
</h3>
<p>We will visualize the elevation bands and bioclimatic zones that are used to define regional reference values for poor (forest vegetation height) and good (NiN vegetation height) ecological condition. For each unique spatial combination of these strata (n = 21), we calcualte a mean reference value later on in the analysis. Note that poor ecological condition is preferably calculated using a local reference (forest height within 200m of population polygon), but a regional reference is used where there are no nearby forest patches.</p>
<div class="sourceCode" id="cb547"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">bioclimPlot</span> <span class="op">&lt;-</span> <span class="va">bioclim</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NAVN</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Paired'</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">'Zone'</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'A) Bioclimatic zones'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">elevPlot</span> <span class="op">&lt;-</span> <span class="va">elevStrata</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">elevBand</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.001</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">5</span>, <span class="st">'Pastel1'</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">'HASL (M)'</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'B) Elevation bands'</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">strataPlot</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">bioclimPlot</span>, <span class="va">elevPlot</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-14-1.png" width="672"></div>
<p>We can see that while AR5 polygons are well distributed across the country, the NiN polygons are clustered and biased toward low elevation regions of the country. The LiDAR data covers nearly the entire country with some exceptions in the north. Future iterations of this work will need to attempt to quantify the biases introduced by the relative distributions of reference and population polygons and by the datasets used to quantify gjengroing (in this case LiDAR).</p>
</div>
<div id="scaled-indicator-values-at-polygon-level-circa-120-min-runtime" class="section level3" number="13.16.4">
<h3>
<span class="header-section-number">13.16.4</span> Scaled indicator values at polygon level (circa 120 min runtime)<a class="anchor" aria-label="anchor" href="#scaled-indicator-values-at-polygon-level-circa-120-min-runtime"><i class="fas fa-link"></i></a>
</h3>
<p>We will calculate the gjengroing index for each population polygon over Norway using a Sigmoid scaling function.</p>
<div class="sourceCode" id="cb548"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Define Sigmoid scaling function</span></span>
<span><span class="va">scaleSigmoid</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">refLow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span></span>
<span>  <span class="va">refHigh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span></span>
<span>  <span class="va">thr</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">refHigh</span><span class="op">-</span><span class="va">refLow</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="va">indicator_LowHigh</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">variable</span> <span class="op">-</span> <span class="va">refLow</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">refHigh</span> <span class="op">-</span> <span class="va">refLow</span><span class="op">)</span></span>
<span>  <span class="va">indicator_LowHigh</span><span class="op">[</span><span class="va">indicator_LowHigh</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">indicator_LowHigh</span><span class="op">[</span><span class="va">indicator_LowHigh</span><span class="op">[</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">indicator_sigmoid</span> <span class="op">&lt;-</span> <span class="fl">100.68</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span><span class="op">*</span><span class="op">(</span><span class="va">indicator_LowHigh</span><span class="op">)</span><span class="op">^</span><span class="fl">2.5</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">indicator_sigmoid</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Calcualte gjengroing index values</span></span>
<span>  <span class="va">vaatmarkIndexPoly</span> <span class="op">&lt;-</span> <span class="va">vaatmarkHts</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Gather into long format so taht we can mutate the scaleSigmoid() function</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fu">scaleSigmoid</span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Because short vegetation is good condition, we must invert the scaled indicator</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Get the indicator values for the population polygons only (ref and skog will be 1 and 0)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'pop'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">type</span>, <span class="op">-</span><span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Join with original data to get the actual median vegetaiton heights for each indicator score</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkHts</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popVaatmark</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">ssbid</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># do the same for åpne polygons - will not comment this because same as above</span></span>
<span>  <span class="va">aapneIndexPoly</span> <span class="op">&lt;-</span> <span class="va">aapneHts</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fu">scaleSigmoid</span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'pop'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">type</span>, <span class="op">-</span><span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneHts</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popAapne</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">ssbid</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Make into spatial objects</span></span>
<span>  <span class="va">vaatmarkIndexPolySpat</span> <span class="op">&lt;-</span> <span class="va">popVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkIndexPoly</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">&lt;-</span> <span class="va">popAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneIndexPoly</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Transform to correct projection</span></span>
<span>  <span class="va">vaatmarkIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">vaatmarkIndexPolySpat</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">aapneIndexPolySpat</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>`system:index` <span class="op">=</span> <span class="va">id</span>,</span>
<span>           elevation <span class="op">=</span> <span class="va">elev</span>, </span>
<span>           vegClimZoneLab <span class="op">=</span> <span class="va">vegZn</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">elev</span>, <span class="op">-</span><span class="va">vegZn</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>`system:index` <span class="op">=</span> <span class="va">id</span>,</span>
<span>           elevation <span class="op">=</span> <span class="va">elev</span>, </span>
<span>           vegClimZoneLab <span class="op">=</span> <span class="va">vegZn</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">elev</span>, <span class="op">-</span><span class="va">vegZn</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Reading layer `vaatmark_index' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 1069897 features and 8 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -75794.71 ymin: 6449710 xmax: 1108262 ymax: 7939216</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#&gt; Reading layer `aapne_index' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 1763446 features and 8 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -76208.98 ymin: 6448886 xmax: 1108352 ymax: 7939986</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Here we will visualize the spatial variation in scaled gjengroind indicator values, as well as the vegetation heights for reference (good condition), indicator, and mature forest (poor condition) over the country. We could plot all the polygons, but it is computationally intensive and very difficult to visualize spatial variations over the entire country. Therefore we will calculate the area-weighted mean in values for each bioclimatic-elevation strata (n = 21) over the country.</p>
<div class="sourceCode" id="cb549"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Create intersection of the two strata layers</span></span>
<span><span class="co">#elevStrata &lt;- st_transform(elevStrata, st_crs(regions))</span></span>
<span><span class="va">bioClimElev</span> <span class="op">&lt;-</span> <span class="va">bioclim</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">elevStrata</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>elevation <span class="op">=</span> <span class="va">elevBand</span>,</span>
<span>         vegClimZoneLab <span class="op">=</span> <span class="va">NAVN</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rowid_to_column</span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Get area-weighted mean for reference, forest and population vegetation heights </span></span>
<span>  <span class="co"># for each unique bioclimatic-elevation zone combination</span></span>
<span>  <span class="va">vaatmarkIndexStrata</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="co">#sample_n(10000) %&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">vaatmarkIndexPolySpat</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">st_area</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> ,<span class="va">st_intersects</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise_at</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span>, <span class="va">index</span><span class="op">)</span>, <span class="fu">funs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">.</span>, w<span class="op">=</span><span class="va">area</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span> </span>
<span>                <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">aapneIndexStrata</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="co">#sample_n(10000) %&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">aapneIndexPolySpat</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">st_area</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> ,<span class="va">st_intersects</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise_at</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span>, <span class="va">index</span><span class="op">)</span>, <span class="fu">funs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">.</span>, w<span class="op">=</span><span class="va">area</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span> </span>
<span>                <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Write out for import later</span></span>
<span>  <span class="va">vaatmarkIndexStrata</span> <span class="op">%&gt;%</span> <span class="fu">write_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/vaatmarkIndexStrata.csv'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexStrata</span> <span class="op">%&gt;%</span> <span class="fu">write_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/aapneIndexStrata.csv'</span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexStrata</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/vaatmarkIndexStrata.csv'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexStrata</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/aapneIndexStrata.csv'</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Make plots of indicator heights and scaled condition values for each strata polygon</span></span>
<span></span>
<span><span class="va">theme_legend_1</span> <span class="op">&lt;-</span> <span class="fu">theme</span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>, <span class="co">#change legend key size</span></span>
<span>                        legend.key.height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>, <span class="co">#change legend key height</span></span>
<span>                        legend.key.width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>, <span class="co">#change legend key width</span></span>
<span>                        legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span><span class="op">)</span>, <span class="co">#change legend title font size</span></span>
<span>                        legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="co">#change legend text font size</span></span>
<span></span>
<span><span class="va">makeStrataHeightMap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span>, <span class="va">title</span>, <span class="va">limits</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ID'</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>response <span class="op">=</span> <span class="va">.</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">response</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                           limits <span class="op">=</span> <span class="va">limits</span>,</span>
<span>                           oob <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span>,</span>
<span>                           name <span class="op">=</span> <span class="st">'Veg ht (m)'</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">ggtitle</span><span class="op">(</span><span class="va">title</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">theme_legend_1</span></span>
<span>    </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">makeStrataIndicatorMap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">title</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ID'</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">index</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                           limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                           name <span class="op">=</span> <span class="st">'Index'</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">ggtitle</span><span class="op">(</span><span class="va">title</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">theme_legend_1</span></span>
<span>    </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu">makeStrataIndicatorMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>,  <span class="st">'A) Semi-/Naturlig-åpne scaled indicator'</span><span class="op">)</span></span>
<span><span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>, <span class="st">"ref"</span>, <span class="st">'B) Semi-/Naturlig-åpne reference height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a3</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>, <span class="st">"pop"</span>, <span class="st">'C) Semi-/Naturlig-åpne indicator height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a4</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>, <span class="st">"skog"</span>, <span class="st">'D) Semi-/Naturlig-åpne forest height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">v1</span> <span class="op">&lt;-</span> <span class="fu">makeStrataIndicatorMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>,  <span class="st">'E) Våtmark scaled indicator'</span><span class="op">)</span></span>
<span><span class="va">v2</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>, <span class="st">"ref"</span>, <span class="st">'F) Våtmark reference height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">v3</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>, <span class="st">"pop"</span>, <span class="st">'G) Våtmark indicator height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">v4</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>, <span class="st">"skog"</span>, <span class="st">'H) Mature forest height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">strataHeightPlot</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">a1</span>,<span class="va">a2</span>,<span class="va">a3</span>,<span class="va">a4</span>, <span class="va">v1</span>,<span class="va">v2</span>,<span class="va">v3</span>,<span class="va">v4</span>, ncol<span class="op">=</span><span class="fl">4</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-16-1.png" width="960"></div>
<p>We can see that overall, the condition scores for both ecosystem types are poor along the coastal areas and lower-altitude zones of the country (A and E). At higher altitudes the gjengroing condition scores are higher.</p>
<p>When comparing våtmark to semi-/naturlig-åpne ecosystems, we can see that the reference heights for våtmark are generally higher in terms of good (B and F) and poor (D and H) ecological condition. This makes ecological sense because wetlands can and do naturally occur under forest and therefore våtmark in good condition can have tree cover without necessarily being gjengroing.</p>
</div>
<div id="scaled-indicator-values-at-50km-grid-level-circa-45-min-runtime" class="section level3" number="13.16.5">
<h3>
<span class="header-section-number">13.16.5</span> Scaled indicator values at 50km grid level (circa 45 min runtime)<a class="anchor" aria-label="anchor" href="#scaled-indicator-values-at-50km-grid-level-circa-45-min-runtime"><i class="fas fa-link"></i></a>
</h3>
<p>Using the polygon-level indicator scores, we will aggregate to 50km grid level to explore the spatial variation over Norway. We are doing this as an alternative way of visualizing the broad-scale patterns as presented in the section above where we used bioclimatic-elevation strata.</p>
<p>Here we will use a weighted average, but test out the eaTools::ea_spread function! It takes some time to run so best to do this overnight, or to parallelize in some way.</p>
<div class="sourceCode" id="cb550"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Aggregate polygon index scores to grid level using eaTools ea_spread function</span></span>
<span>  <span class="va">vaatmarkIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">vaatmarkIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">ssb50km</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">SSBID</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, ssbid <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ssbid</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">aapneIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">aapneIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">ssb50km</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">SSBID</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, ssbid <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ssbid</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">'Will import pre-exported data'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_grid.shp'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_grid.shp'</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Will import pre-exported data"</span></span>
<span><span class="co">#&gt; Reading layer `vaatmark_index_grid' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_grid.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 273 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -150000 ymin: 6400000 xmax: 1150000 ymax: 8e+06</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#&gt; Reading layer `aapne_index_grid' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_grid.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 273 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -150000 ymin: 6400000 xmax: 1150000 ymax: 8e+06</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Visualize the spatial distribution of gjengroing indicator scores at grid level.</p>
<div class="sourceCode" id="cb551"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">vGrid1</span> <span class="op">&lt;-</span> <span class="va">aapneIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">index</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'Index'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'A) Semi-/Naturlig gjengroing condition'</span><span class="op">)</span></span>
<span><span class="co">#vGrid1</span></span>
<span></span>
<span><span class="va">vGrid2</span> <span class="op">&lt;-</span> <span class="va">vaatmarkIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">index</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'Index'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'B) Våtmark gjengroing condition'</span><span class="op">)</span></span>
<span><span class="co">#vGrid2</span></span>
<span></span>
<span></span>
<span><span class="va">indexGridFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">vGrid1</span>, <span class="va">vGrid2</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-18-1.png" width="672"></div>
<p>These patterns mirror those in the previous section with higher condition scores at higher elevations and lower scores along the coastal zone and low-lying parts of the country.</p>
<p>We see some very low condition scores for a few coastal 50km grid cells - this may be an artifact of creating an average with very few population polygons and therefore vulnerable to skewed average indicator scores.</p>
</div>
<div id="scaled-indicator-values-at-regional-level-circa-120-min-runtime" class="section level3" number="13.16.6">
<h3>
<span class="header-section-number">13.16.6</span> Scaled indicator values at regional level (circa 120 min runtime)<a class="anchor" aria-label="anchor" href="#scaled-indicator-values-at-regional-level-circa-120-min-runtime"><i class="fas fa-link"></i></a>
</h3>
<p>Now we will aggregate up to the regional level for final reporting. We will use the same method as in the section above, except here we will use a different method to calculate the uncertainty value around the indicator values. The ea_spread function in eaTools uses a bootstrapping method to calculate the standard error in indicator values when aggregating from the polygon to regional level. Because we have hundreds of thousands of polygons per region, the resulting standard errors are extremely small. Therefore we will use the standard deviation in reference values per region. The standard deviation, as a percentage of the average reference value is used to calcualte the uncertainty in the scaled indicator value.</p>
<div class="sourceCode" id="cb552"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Get the mean population, reference and forest heights per region for interpreting index values</span></span>
<span>  <span class="co"># The standard deviation is used later to define uncertainty around the indicator score</span></span>
<span>  <span class="va">vaatmarkHeightsRegion</span> <span class="op">&lt;-</span> <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">vaatmarkIndexPolySpat</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>pop_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>              skog_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>,</span>
<span>              ref_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span>,</span>
<span>              sd_ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">aapneHeightsRegion</span> <span class="op">&lt;-</span> <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">aapneIndexPolySpat</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>pop_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>              skog_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>,</span>
<span>              ref_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span>,</span>
<span>              sd_ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Aggregate polygon index scores to regional level using eaTools</span></span>
<span>  <span class="va">vaatmarkIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">vaatmarkIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">regions</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">region</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, region <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkHeightsRegion</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Only run on first iteration - takes a long time</span></span>
<span>  <span class="va">aapneIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">aapneIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">regions</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">region</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, region <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneHeightsRegion</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">'Will import pre-exported data'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_region.shp'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_region.shp'</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Will import pre-exported data"</span></span>
<span><span class="co">#&gt; Reading layer `vaatmark_index_region' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_region.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#&gt; Reading layer `aapne_index_region' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_region.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Present the indicator values as table, plots, and maps:</p>
<div class="sourceCode" id="cb553"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Join into a table to present values</span></span>
<span><span class="va">aapentTable</span> <span class="op">&lt;-</span> <span class="va">aapneIndexRegion</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">vaatmarkTable</span> <span class="op">&lt;-</span> <span class="va">vaatmarkIndexRegion</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Join ecosystem types and calculate uncertainty</span></span>
<span><span class="va">indicatorTable</span> <span class="op">&lt;-</span> <span class="va">aapentTable</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Ecosystem <span class="op">=</span> <span class="st">'Semi-/Naturlig åpne'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">vaatmarkTable</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Ecosystem <span class="op">=</span> <span class="st">'Våtmark'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Calculate the error based on the standard deviation in reference polygon heights</span></span>
<span>  <span class="co"># as a percentage of the reference height, and multiply by index score</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>sd <span class="op">=</span> <span class="op">(</span><span class="va">sd_ref</span><span class="op">/</span><span class="va">ref_mean</span><span class="op">)</span><span class="op">*</span><span class="va">index</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Format the table for presentation</span></span>
<span><span class="va">indicatorTable_formatted</span> <span class="op">&lt;-</span> <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">indicatorTable</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span> <span class="va">region</span>, <span class="va">Ecosystem</span>, <span class="va">index</span>, <span class="va">sd</span>, <span class="va">pop_mean</span>, <span class="va">ref_mean</span>, <span class="va">skog_mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">indicatorTable_formatted</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"Region"</span>, <span class="st">"Ecosystem"</span>,</span>
<span>                                      <span class="st">"Scaled indicator"</span>,  <span class="st">"Scaled Std.dev"</span>,</span>
<span>                                      <span class="st">"Indicator height"</span>,<span class="st">"Reference height"</span>,</span>
<span>                                      <span class="st">"Mature forest height"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use knitr to visualize</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">indicatorTable_formatted</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="9%">
<col width="16%">
<col width="14%">
<col width="12%">
<col width="14%">
<col width="14%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th align="left">Region</th>
<th align="left">Ecosystem</th>
<th align="right">Scaled indicator</th>
<th align="right">Scaled Std.dev</th>
<th align="right">Indicator height</th>
<th align="right">Reference height</th>
<th align="right">Mature forest height</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Nord-Norge</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.80</td>
<td align="right">0.27</td>
<td align="right">1.42</td>
<td align="right">0.97</td>
<td align="right">2.79</td>
</tr>
<tr class="even">
<td align="left">Nord-Norge</td>
<td align="left">Våtmark</td>
<td align="right">0.80</td>
<td align="right">0.32</td>
<td align="right">0.98</td>
<td align="right">0.81</td>
<td align="right">2.17</td>
</tr>
<tr class="odd">
<td align="left">Midt-Norge</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.89</td>
<td align="right">0.32</td>
<td align="right">1.89</td>
<td align="right">1.23</td>
<td align="right">4.09</td>
</tr>
<tr class="even">
<td align="left">Midt-Norge</td>
<td align="left">Våtmark</td>
<td align="right">0.85</td>
<td align="right">0.44</td>
<td align="right">1.38</td>
<td align="right">1.09</td>
<td align="right">2.80</td>
</tr>
<tr class="odd">
<td align="left">Østlandet</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.96</td>
<td align="right">0.55</td>
<td align="right">2.32</td>
<td align="right">1.48</td>
<td align="right">5.25</td>
</tr>
<tr class="even">
<td align="left">Østlandet</td>
<td align="left">Våtmark</td>
<td align="right">0.87</td>
<td align="right">0.67</td>
<td align="right">1.86</td>
<td align="right">1.27</td>
<td align="right">3.63</td>
</tr>
<tr class="odd">
<td align="left">Vestlandet</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.86</td>
<td align="right">0.38</td>
<td align="right">2.63</td>
<td align="right">1.90</td>
<td align="right">4.88</td>
</tr>
<tr class="even">
<td align="left">Vestlandet</td>
<td align="left">Våtmark</td>
<td align="right">0.75</td>
<td align="right">0.42</td>
<td align="right">2.44</td>
<td align="right">2.09</td>
<td align="right">3.83</td>
</tr>
<tr class="odd">
<td align="left">Sørlandet</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.94</td>
<td align="right">0.40</td>
<td align="right">2.86</td>
<td align="right">2.03</td>
<td align="right">5.62</td>
</tr>
<tr class="even">
<td align="left">Sørlandet</td>
<td align="left">Våtmark</td>
<td align="right">0.78</td>
<td align="right">0.51</td>
<td align="right">2.55</td>
<td align="right">2.28</td>
<td align="right">3.83</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb554"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Make plots of regional index values</span></span>
<span><span class="va">getIndicatorPlot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">indicatorTable</span> <span class="op">%&gt;%</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Ecosystem</span> <span class="op">==</span> <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>lowError <span class="op">=</span> <span class="va">index</span><span class="op">-</span><span class="va">sd</span>, </span>
<span>           upError <span class="op">=</span> <span class="va">index</span><span class="op">+</span><span class="va">sd</span>,</span>
<span>           upError <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">upError</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="va">upError</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="va">region</span>, x<span class="op">=</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_segment</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yend<span class="op">=</span><span class="va">region</span>, x<span class="op">=</span><span class="va">lowError</span>, xend<span class="op">=</span><span class="va">upError</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_cartesian</span><span class="op">(</span>xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Tilstandsverdi'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>axis.title.y<span class="op">=</span><span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="va">label</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span><span class="va">i1</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorPlot</span><span class="op">(</span><span class="st">'Semi-/Naturlig åpne'</span><span class="op">)</span></span>
<span><span class="va">i2</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorPlot</span><span class="op">(</span><span class="st">'Våtmark'</span><span class="op">)</span></span>
<span><span class="va">indicatorGraphFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">i1</span>, <span class="va">i2</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-20-1.png" width="672"></div>
<div class="sourceCode" id="cb555"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># Make maps of regional index values</span></span>
<span><span class="va">getIndicatorMap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">label</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                         limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorMap</span><span class="op">(</span><span class="va">aapentTable</span>, <span class="st">'A) Semi-/Naturlig åpne'</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorMap</span><span class="op">(</span><span class="va">vaatmarkTable</span>, <span class="st">'B) Våtmark'</span><span class="op">)</span></span>
<span><span class="va">indicatorGMapFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-20-2.png" width="672"></div>
<p>From these tables, figures and maps we can see that the gjengroing condition indicator scores are on average above 0.8 and therefore indicate a good overall condition in Norway. Østlandet comes out best for våtmark and semi-naturlig åpne ecosystems. Nord-Norge has poorest condition for semi-naturlig åpne ecosystems, while vestlandet has the poorest scores for våtmark.</p>
</div>
<div id="uncertainty-and-validation" class="section level3" number="13.16.7">
<h3>
<span class="header-section-number">13.16.7</span> Uncertainty and validation<a class="anchor" aria-label="anchor" href="#uncertainty-and-validation"><i class="fas fa-link"></i></a>
</h3>
<p>The calculation of the indicator involves many small decisions which can have significant effects on the resulting conditions cores. Therefore in the future it would be good to perform sensitivity analyses with each decision to test the effect on the outcome. The decisions which would benefit from further exploration include:</p>
<ul>
<li><p><strong>Selection of the reference and population areas.</strong> Here we were limited to using NiN and AR5 because these are arguably the best datasets currently available for this exercise. However, both NiN and AR5 are spatially and thematically biased in some ways. Therefore, it may be worth exploring alternative datasets in the future. NiN polygons are biased towards low lying areas which are generally warmer and more productive. For a given bioclimatic-elevation strata, this could lead to higher reference values for vegetation height than one would expect with a representative reference sample. This could consequently result in high elevation population polygons appearing to have very good condition ebcause they are being compared with (relatively) high productivity polygons in the same bioclimatic-elevation strata. This is a possible explanation for why the high elevation parts of norway appear to be in very good ecological condition.</p></li>
<li><p><strong>Definition of good condition states in NiN data.</strong> Here we used the overall “tilstand” score for each NiN reference polygon. However, the overall score is a combination of several sub-scores that may or may not be relevant for ecological condition. For instance, ditches or wheel marks in wetlands is a common condition score in NiN, however it is debatable as to whether this should be considered a part of ecological condition. Therefore it may be beneficial to attempt repeating the indicator calculation using sub-categories of “tilstand” in the NiN data.</p></li>
<li><p><strong>Definition of climax successional stage for tree regrowth.</strong> Here we use the 50th percentile of LiDAR-derived tree heights in AR5 forest polygons that have not been harvested since 1986. This defines the zero on the scaled indicator score. The resulting indicator scores will vary widely depending on how you define this zero-point. Therefore, testing different definitions (i.e. tree height percentiles) may be important.</p></li>
<li><p><strong>Quantifying regional vs local references for poor and good condition.</strong> For good condition, we used NiN polygons and were restricted to these due to lack of better data. However, for poor condition we use climax successional stage for trees (as explained above) within 200m of each population polygon. For polygons with no surrounding forest, we impute with regional reference values (mean of forest height in elevation-bioclamic zone). The choice of 200m buffer zone was largely based on computational limitations. Calculating the average LiDAR vegetation height within 200m of nearly 2 million complex plygons takes time, even in GEE. It may make more ecological sense to define a larger buffer zone to use for defining reference for poor condition. However, longer processing times need to be expected.</p></li>
<li><p><strong>Quantification of uncertainty around indicator scores.</strong> Here we used the standard deviation in the vegetation heights for reference (NiN) polygons within each region to quantify the uncertainty around scaled indicator scores. We did this because the method used in eaTools::ea_spread() function is a bootstrapping approach which resulted in extremely small uncertainty estimates due to the large number of polygons included in our analysis. In the future, a better method for quantifying uncertainty is needed. Perhaps by running sensitivity analyses that test several variations of the points mentioned above can form the basis for quantifying an error margin around indicator values.</p></li>
</ul>
<div id="validation-of-random-polygons" class="section level4" number="13.16.7.1">
<h4>
<span class="header-section-number">13.16.7.1</span> Validation of random polygons<a class="anchor" aria-label="anchor" href="#validation-of-random-polygons"><i class="fas fa-link"></i></a>
</h4>
<p>After exporting the final polygon-level indicator scores, we imported to QGIS and explored how they look at the landscape scale. We chose random locations spread across the 5 regions in Norway. The figures below show våtmark and åpne (semi- and naturlig-åpne) ecosysystem polygons from AR5. The polygons have jaggered edges because we chose a low resolution geometry export from GEE to save computing time and minimize storage space. Each polygon is colored based on the final scaled gjengroing indicator score (0 to 1). The polygons are also labelled with the median LiDAR-derived forest height. An orthophoto from Norgeibilder is displayed in the background for reference.</p>
<p>In the first example from midt-norge, we see a våtmark polygon colored red (ie. in poor condition) due to the growth of a forest in the northern section. It looks like a plantation forest and possibly occured after the wetland was drained. The height of the forest vegetation equates to a median of 2.4m which is higher than the reference value for this region (1.09m) and almost as high as the mature forest height reference of 2.8m. Therefore it gets a scaped indicator score of 0.1. In contrast the wetland plygon in the middle of the image is in good condition because it has a median vegetation height of 1.1m which is only fractionally higher than the regional reference for good ecological condition.</p>
<div class="sourceCode" id="cb556"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">include_graphics</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_1.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="../../../P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_1.jpg" width="1754"></div>
<p>The second example from Sørlandet shows three AR5 semi-naturlig åpne polygons with different indicator values. The lower polygon has poor ecological condition because its median vegetation height is 6.2m which is close to the local reference value for mature forest (7.9m). Although the centeral polygon appears to have greater coverage of forest in the orthophoto, the LiDAR data tells us that it is mostly covered by short trees and results in a median vegetation height of 2.8 - therefore good condition.</p>
<div class="sourceCode" id="cb557"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">include_graphics</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_2.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="../../../P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_2.jpg" width="1754"></div>
<p>The third example from Østlandet shows a range of indicator values for våtmark polygons. Although many of the polygons are partly covered by trees, their indicator values show good condition because the local reference for mature forest (zero on the indicator scale) is very high in this landscape of productive forest.</p>
<div class="sourceCode" id="cb558"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">include_graphics</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_3.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="../../../P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_3.jpg" width="1754"></div>
<p>The fourth example from Nord-norge shows AR5 semi-naturlig åpne polygons with low and high condition scores. The large polygon with poor condition score has a median vegetation height of 2.7 which is nearly as high as the local reference for mature forest (3.8m).</p>
<div class="sourceCode" id="cb559"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">include_graphics</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_4.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="../../../P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_4.jpg" width="1754"></div>
<p>The fifth and final example from further north in Nord-norge shows two våtmark polygons with contrasting condition scores, yet exactly the same median vegetation heights of 0.6m. The difference in the scaled iindicator value is due to different local reference values for surrounding forest. The polygon on the left has surrounding forest (within 200m buffer zone) with median height 0.5m, while the polygon on the right has surrounding forest of 0.7m. This creates a contrast in the final indicator valye and illustrates the effect that a local reference value can have on defining good and poor ecological condition.</p>
<div class="sourceCode" id="cb560"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">include_graphics</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_5.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="../../../P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/images/val_5.jpg" width="1754"></div>
</div>
</div>
<div id="eksport-file-final-product-3" class="section level3" number="13.16.8">
<h3>
<span class="header-section-number">13.16.8</span> Eksport file (final product)<a class="anchor" aria-label="anchor" href="#eksport-file-final-product-3"><i class="fas fa-link"></i></a>
</h3>
<p>We will export gjengroing indicator values at three levels: - polygon level - 50km grid level - regional level</p>
<div class="sourceCode" id="cb561"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Polygon level</span></span>
<span>  <span class="va">vaatmarkIndexPolySpat</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="co">#mutate(area = as.numeric(st_area(geometry)))%&gt;% </span></span>
<span>    <span class="co">#filter(area &gt; 7500) %&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="va">`system:index`</span>,</span>
<span>           elev <span class="op">=</span> <span class="va">elevation</span>, </span>
<span>           vegZn <span class="op">=</span> <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">"system:index"</span>, <span class="op">-</span><span class="va">vegClimZoneLab</span>, <span class="op">-</span><span class="va">elevation</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index.shp'</span>, append<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="co">#mutate(area = as.numeric(st_area(geometry)))%&gt;% </span></span>
<span>    <span class="co">#filter(area &gt; 7500) %&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="va">`system:index`</span>,</span>
<span>           elev <span class="op">=</span> <span class="va">elevation</span>, </span>
<span>           vegZn <span class="op">=</span> <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">"system:index"</span>, <span class="op">-</span><span class="va">vegClimZoneLab</span>, <span class="op">-</span><span class="va">elevation</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index.shp'</span>, append<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Grid level</span></span>
<span>  <span class="va">vaatmarkIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_grid.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_grid.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Region level</span></span>
<span>  <span class="va">vaatmarkIndexRegion</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_region.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexRegion</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_region.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="master-grid.html"><span class="header-section-number">12</span> Master grid</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#climate-indicators-explained"><span class="header-section-number">13</span> Climate indicators explained</a></li>
<li><a class="nav-link" href="#introduction-10"><span class="header-section-number">13.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#about-the-underlying-data-8"><span class="header-section-number">13.2</span> About the underlying data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#representativity-in-time-and-space-7"><span class="header-section-number">13.2.1</span> Representativity in time and space</a></li>
<li><a class="nav-link" href="#original-units-4"><span class="header-section-number">13.2.2</span> Original units</a></li>
<li><a class="nav-link" href="#temporal-coverage-6"><span class="header-section-number">13.2.3</span> Temporal coverage</a></li>
<li><a class="nav-link" href="#additional-comments-about-the-data-set-1"><span class="header-section-number">13.2.4</span> Additional comments about the data set</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ecosystem-characteristic-4"><span class="header-section-number">13.3</span> Ecosystem characteristic</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#norwegian-standard-3"><span class="header-section-number">13.3.1</span> Norwegian standard</a></li>
<li><a class="nav-link" href="#seea-ea-1"><span class="header-section-number">13.3.2</span> SEEA EA</a></li>
</ul>
</li>
<li><a class="nav-link" href="#collinearities-with-other-indicators-6"><span class="header-section-number">13.4</span> Collinearities with other indicators</a></li>
<li>
<a class="nav-link" href="#reference-condition-and-values-3"><span class="header-section-number">13.5</span> Reference condition and values</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#reference-condition-3"><span class="header-section-number">13.5.1</span> Reference condition</a></li>
<li><a class="nav-link" href="#reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values-6"><span class="header-section-number">13.5.2</span> Reference values, thresholds for defining good ecological condition, minimum and/or maximum values</a></li>
</ul>
</li>
<li><a class="nav-link" href="#uncertainties-6"><span class="header-section-number">13.6</span> Uncertainties</a></li>
<li>
<a class="nav-link" href="#references-7"><span class="header-section-number">13.7</span> References</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#additional-resources-1"><span class="header-section-number">13.7.1</span> Additional resources</a></li></ul>
</li>
<li>
<a class="nav-link" href="#analyses-9"><span class="header-section-number">13.8</span> Analyses</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-set-1"><span class="header-section-number">13.8.1</span> Data set</a></li>
<li><a class="nav-link" href="#conceptual-workflow-1"><span class="header-section-number">13.8.2</span> Conceptual workflow</a></li>
<li><a class="nav-link" href="#collate-variable-data-series"><span class="header-section-number">13.8.3</span> Collate variable data series</a></li>
<li><a class="nav-link" href="#filter-data-by-dates"><span class="header-section-number">13.8.4</span> Filter data by dates</a></li>
<li><a class="nav-link" href="#aggregate-across-time-within-a-year"><span class="header-section-number">13.8.5</span> Aggregate across time within a year</a></li>
<li><a class="nav-link" href="#calculate-reference-values"><span class="header-section-number">13.8.6</span> Calculate reference values</a></li>
<li><a class="nav-link" href="#normalise-variable"><span class="header-section-number">13.8.7</span> Normalise variable</a></li>
<li><a class="nav-link" href="#plot-time-series-as-line-graphs"><span class="header-section-number">13.8.8</span> Plot time series as line graphs</a></li>
</ul>
</li>
<li><a class="nav-link" href="#introduction-11"><span class="header-section-number">13.9</span> Introduction</a></li>
<li>
<a class="nav-link" href="#about-the-underlying-data-9"><span class="header-section-number">13.10</span> About the underlying data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#representativity-in-time-and-space-8"><span class="header-section-number">13.10.1</span> Representativity in time and space</a></li>
<li><a class="nav-link" href="#original-units-5"><span class="header-section-number">13.10.2</span> Original units</a></li>
<li><a class="nav-link" href="#temporal-coverage-7"><span class="header-section-number">13.10.3</span> Temporal coverage</a></li>
<li><a class="nav-link" href="#aditional-comments-about-the-dataset-3"><span class="header-section-number">13.10.4</span> Aditional comments about the dataset</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ecosystem-characteristic-5"><span class="header-section-number">13.11</span> Ecosystem characteristic</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#norwegain-standard-1"><span class="header-section-number">13.11.1</span> Norwegain standard</a></li></ul>
</li>
<li><a class="nav-link" href="#collinearities-with-other-indicators-7"><span class="header-section-number">13.12</span> Collinearities with other indicators</a></li>
<li>
<a class="nav-link" href="#reference-state-and-values-3"><span class="header-section-number">13.13</span> Reference state and values</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#reference-state-3"><span class="header-section-number">13.13.1</span> Reference state</a></li>
<li><a class="nav-link" href="#reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values-7"><span class="header-section-number">13.13.2</span> Reference values, thresholds for defining good ecological condition, minimum and/or maximum values</a></li>
</ul>
</li>
<li><a class="nav-link" href="#uncertainties-7"><span class="header-section-number">13.14</span> Uncertainties</a></li>
<li><a class="nav-link" href="#references-8"><span class="header-section-number">13.15</span> References</a></li>
<li>
<a class="nav-link" href="#analyses-10"><span class="header-section-number">13.16</span> Analyses</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-sets-4"><span class="header-section-number">13.16.1</span> Data sets</a></li>
<li><a class="nav-link" href="#explore-data-coverages"><span class="header-section-number">13.16.2</span> Explore data coverages</a></li>
<li><a class="nav-link" href="#bioclimatic-zone-and-elevation-strata-for-regional-reference-values"><span class="header-section-number">13.16.3</span> Bioclimatic zone and elevation strata for regional reference values</a></li>
<li><a class="nav-link" href="#scaled-indicator-values-at-polygon-level-circa-120-min-runtime"><span class="header-section-number">13.16.4</span> Scaled indicator values at polygon level (circa 120 min runtime)</a></li>
<li><a class="nav-link" href="#scaled-indicator-values-at-50km-grid-level-circa-45-min-runtime"><span class="header-section-number">13.16.5</span> Scaled indicator values at 50km grid level (circa 45 min runtime)</a></li>
<li><a class="nav-link" href="#scaled-indicator-values-at-regional-level-circa-120-min-runtime"><span class="header-section-number">13.16.6</span> Scaled indicator values at regional level (circa 120 min runtime)</a></li>
<li><a class="nav-link" href="#uncertainty-and-validation"><span class="header-section-number">13.16.7</span> Uncertainty and validation</a></li>
<li><a class="nav-link" href="#eksport-file-final-product-3"><span class="header-section-number">13.16.8</span> Eksport file (final product)</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/NINAnor/ecosystemCondition/blob/master/climate_indicators_explained.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/NINAnor/ecosystemCondition/edit/master/climate_indicators_explained.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Vegetation regrowth/encroachment (gjengroing)</strong>" was written by Anders L. Kolstad. It was last built on 2023-08-30.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
