<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 21 Climate indicators explained | Indicators for Ecosystem Condition in Norway</title>
<meta name="author" content="Anders L. Kolstad">
<meta name="description" content="Author and date: Anders L. Kolstad March 2023  Ecosystem Økologisk.egenskap ECT.class All Abiotiske egenskaper Physical state characteristics   21.1 Introduction This chapters describes the...">
<meta name="generator" content="bookdown 0.33 with bs4_book()">
<meta property="og:title" content="Chapter 21 Climate indicators explained | Indicators for Ecosystem Condition in Norway">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ninanor.github.io/ecosystemCondition/index.html/climate-indicators-explained.html">
<meta property="og:image" content="https://ninanor.github.io/ecosystemCondition/index.html/images/Picture1.png">
<meta property="og:description" content="Author and date: Anders L. Kolstad March 2023  Ecosystem Økologisk.egenskap ECT.class All Abiotiske egenskaper Physical state characteristics   21.1 Introduction This chapters describes the...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 21 Climate indicators explained | Indicators for Ecosystem Condition in Norway">
<meta name="twitter:description" content="Author and date: Anders L. Kolstad March 2023  Ecosystem Økologisk.egenskap ECT.class All Abiotiske egenskaper Physical state characteristics   21.1 Introduction This chapters describes the...">
<meta name="twitter:image" content="https://ninanor.github.io/ecosystemCondition/index.html/images/Picture1.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.6.1/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.27/datatables.js"></script><link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Indicators for Ecosystem Condition in Norway</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About </a></li>
<li class="book-part">INDICATORS</li>
<li><a class="" href="gjengroing.html"><span class="header-section-number">1</span> Enchroachment</a></li>
<li><a class="" href="nature-index-product.html"><span class="header-section-number">2</span> Nature index product</a></li>
<li><a class="" href="slitasje.html"><span class="header-section-number">3</span> Anthropogenic disturbance to soils and vegetation (ADSV)</a></li>
<li><a class="" href="median-summer-temp.html"><span class="header-section-number">4</span> Median Summer Temperature</a></li>
<li><a class="" href="alien-species.html"><span class="header-section-number">5</span> Alien species</a></li>
<li><a class="" href="functional-plant-indicators-wetland.html"><span class="header-section-number">6</span> Functional Plant Indicators - Wetlands</a></li>
<li><a class="" href="functional-plant-indicators-seminat.html"><span class="header-section-number">7</span> Functional Plant Indicators - Semi-Natural Ecosystems</a></li>
<li><a class="" href="functional-plant-indicators-open.html"><span class="header-section-number">8</span> Functional Plant Indicators - Naturally Open Ecosystems</a></li>
<li><a class="" href="trophic-level-biomass-ratios.html"><span class="header-section-number">9</span> Trophic level biomass ratios</a></li>
<li><a class="" href="insect-indicators.html"><span class="header-section-number">10</span> Insect indicators</a></li>
<li><a class="" href="flood-frequency.html"><span class="header-section-number">11</span> Flood frequency</a></li>
<li class="book-part">R &amp; D</li>
<li><a class="" href="NDVI-indicator-natopen.html"><span class="header-section-number">12</span> NDVI - Naturally Open Ecosystems</a></li>
<li><a class="" href="NDVI-indicator-seminat.html"><span class="header-section-number">13</span> NDVI - Semi-natural Ecosystems</a></li>
<li><a class="" href="NDVI-indicator-wetland.html"><span class="header-section-number">14</span> NDVI - wetland ecosystems</a></li>
<li class="book-part">INDICATORS FROM THE ALPINE ASSESSMENT</li>
<li><a class="" href="areal-av-isbreer.html"><span class="header-section-number">15</span> Areal av isbreer</a></li>
<li class="book-part">DEPRECATED</li>
<li><a class="" href="areal-uten-d%C3%B8d-eller-skadet-r%C3%B8sslyng-i-kystlynghei.html"><span class="header-section-number">16</span> Areal uten død eller skadet røsslyng i kystlynghei</a></li>
<li class="book-part">GENERAL TOPICS</li>
<li><a class="" href="naturtype.html"><span class="header-section-number">17</span> Nature types</a></li>
<li><a class="" href="scaling-functions.html"><span class="header-section-number">18</span> Scaling functions</a></li>
<li><a class="" href="homogeneous-impact-areas.html"><span class="header-section-number">19</span> Homogeneous Impact Areas</a></li>
<li><a class="" href="master-grid.html"><span class="header-section-number">20</span> Master grid</a></li>
<li><a class="active" href="climate-indicators-explained.html"><span class="header-section-number">21</span> Climate indicators explained</a></li>
<li><a class="" href="oversikt-over-indikatorforslag.html"><span class="header-section-number">22</span> Oversikt over indikatorforslag</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/NINAnor/ecosystemCondition">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="climate-indicators-explained" class="section level1" number="21">
<h1>
<span class="header-section-number">21</span> Climate indicators explained<a class="anchor" aria-label="anchor" href="#climate-indicators-explained"><i class="fas fa-link"></i></a>
</h1>
<p><br></p>
<p><em>Author and date:</em></p>
<p>Anders L. Kolstad</p>
<p>March 2023</p>
<p><br></p>
<!-- Load all you dependencies here -->
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">Ecosystem</th>
<th align="left">Økologisk.egenskap</th>
<th align="left">ECT.class</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">All</td>
<td align="left">Abiotiske egenskaper</td>
<td align="left">Physical state characteristics</td>
</tr></tbody>
</table></div>
<p><br><br></p>
<hr>
<div id="intro-cli" class="section level2" number="21.1">
<h2>
<span class="header-section-number">21.1</span> Introduction<a class="anchor" aria-label="anchor" href="#intro-cli"><i class="fas fa-link"></i></a>
</h2>
<p>This chapters describes the development of a workflow for generating or preparing indicators based on interpolated climate data from <a href="https://senorge.no/">SeNorge</a>. I describe the process using dummy data and also discuss alternate approaches and dead ends that occured in the development process. For a succinct workflow example for a specific indicator, see <a href="median-summer-temp.html#median-summer-temp">Median summer temperature</a>.</p>
</div>
<div id="about-the-underlying-data-8" class="section level2" number="21.2">
<h2>
<span class="header-section-number">21.2</span> About the underlying data<a class="anchor" aria-label="anchor" href="#about-the-underlying-data-8"><i class="fas fa-link"></i></a>
</h2>
<p>The data is in a raster format and extends back to 1957 in the form of multiple interpolated climate variables. The spatial resolution is 1 x 1 km.</p>
<div id="representativity-in-time-and-space-8" class="section level3" number="21.2.1">
<h3>
<span class="header-section-number">21.2.1</span> Representativity in time and space<a class="anchor" aria-label="anchor" href="#representativity-in-time-and-space-8"><i class="fas fa-link"></i></a>
</h3>
<p>The data includes the last normal period (1961-1990) which defines the reference condition for climate variables. Therefore the temporal resolution is very good. Also considering the daily resolution of the data.</p>
<p>Spatially, a 1x1 km resolution is sufficient for most climate variables, esp. in homogeneous terrain, but this needs to be evaluation for each variable and scenario specifically.</p>
</div>
<div id="original-units-7" class="section level3" number="21.2.2">
<h3>
<span class="header-section-number">21.2.2</span> Original units<a class="anchor" aria-label="anchor" href="#original-units-7"><i class="fas fa-link"></i></a>
</h3>
<p>Varied. Specified below for each parameter.</p>
</div>
<div id="temporal-coverage-8" class="section level3" number="21.2.3">
<h3>
<span class="header-section-number">21.2.3</span> Temporal coverage<a class="anchor" aria-label="anchor" href="#temporal-coverage-8"><i class="fas fa-link"></i></a>
</h3>
<p>1957 - present</p>
</div>
<div id="additional-comments-about-the-data-set-1" class="section level3" number="21.2.4">
<h3>
<span class="header-section-number">21.2.4</span> Additional comments about the data set<a class="anchor" aria-label="anchor" href="#additional-comments-about-the-data-set-1"><i class="fas fa-link"></i></a>
</h3>
<p>The data format has recently changed from .BIL to .nc (netcdf) and now a single file contains all the rasters for one year (365 days), and sometimes for multiple variables also.</p>
</div>
</div>
<div id="ecosystem-characteristic-8" class="section level2" number="21.3">
<h2>
<span class="header-section-number">21.3</span> Ecosystem characteristic<a class="anchor" aria-label="anchor" href="#ecosystem-characteristic-8"><i class="fas fa-link"></i></a>
</h2>
<div id="norwegian-standard-5" class="section level3" number="21.3.1">
<h3>
<span class="header-section-number">21.3.1</span> Norwegian standard<a class="anchor" aria-label="anchor" href="#norwegian-standard-5"><i class="fas fa-link"></i></a>
</h3>
<p>These variables typically will fall under the <em>abiotiske egenskaper</em> class.</p>
</div>
<div id="seea-ea-1" class="section level3" number="21.3.2">
<h3>
<span class="header-section-number">21.3.2</span> SEEA EA<a class="anchor" aria-label="anchor" href="#seea-ea-1"><i class="fas fa-link"></i></a>
</h3>
<p>In SEEA EA, these variables will typically fall under A1 - Physical state characteristics.</p>
</div>
</div>
<div id="collinearities-with-other-indicators-11" class="section level2" number="21.4">
<h2>
<span class="header-section-number">21.4</span> Collinearities with other indicators<a class="anchor" aria-label="anchor" href="#collinearities-with-other-indicators-11"><i class="fas fa-link"></i></a>
</h2>
<p>Climate variables are most likely to be correlated with each other (e.g. temperature and snow). Also, some climate variables are better classed as pressure indicators, and these might have a causal association with several condition indicators.</p>
</div>
<div id="reference-condition-and-values-6" class="section level2" number="21.5">
<h2>
<span class="header-section-number">21.5</span> Reference condition and values<a class="anchor" aria-label="anchor" href="#reference-condition-and-values-6"><i class="fas fa-link"></i></a>
</h2>
<div id="reference-condition-6" class="section level3" number="21.5.1">
<h3>
<span class="header-section-number">21.5.1</span> Reference condition<a class="anchor" aria-label="anchor" href="#reference-condition-6"><i class="fas fa-link"></i></a>
</h3>
<p>The reference condition for climate variables is defined as the normal period 1961-1990.</p>
</div>
<div id="ref-vals-cli" class="section level3" number="21.5.2">
<h3>
<span class="header-section-number">21.5.2</span> Reference values, thresholds for defining <em>good ecological condition</em>, minimum and/or maximum values<a class="anchor" aria-label="anchor" href="#ref-vals-cli"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Un-scaled indicator value = median value over 5 year periods (5 years being a pragmatic choice. It is long enough to smooth out a lot of inter-annual variation, and it’s long enough to enable estimating errors)</p></li>
<li><p>Upper reference level (best possible condition) = median value from the reference period</p></li>
<li><p>Thresholds for good ecosystem condition = 2 standard deviation units away from the upper reference level for the climate variable during the reference period.</p></li>
<li><p>Lower reference values (two-directional) = 5 standard deviation units for the climate variable during the reference period (implies linear scaling).</p></li>
</ul>
<p>The choice to use 2 SD units as the threshold values is a subjective choice in many ways, and not founded in any empirical or known relationship between the indicators and ecosystem integrity. The value comes from the common practice of calling something <em>extreme weather</em> when it is outside 2 SD units of the current running average. So, if the indicator value today is &lt;0.6 it implies that the mean for that variable over the last year would have been referred to as <em>extreme</em> if it had occurred between 1961 and 1990. This is I think a conservative threshold, since one would/could call it <em>extreme</em> if only one year is outside the 2SD range, and having the mean of 5 years being outside this range is <em>really</em> extreme.</p>
</div>
</div>
<div id="uncertainties-8" class="section level2" number="21.6">
<h2>
<span class="header-section-number">21.6</span> Uncertainties<a class="anchor" aria-label="anchor" href="#uncertainties-8"><i class="fas fa-link"></i></a>
</h2>
<p>For the indicator map (1 x 1 km raster) there is no uncertainty associated with the indicator values. For aggregated indicator values (e.g. for regions), the uncertainty in the indicator value is calculated from the spatial variation in the indicator values via bootstrapping. This might, however, be changed later to the temporal variation between the five years of each period.</p>
</div>
<div id="references-13" class="section level2" number="21.7">
<h2>
<span class="header-section-number">21.7</span> References<a class="anchor" aria-label="anchor" href="#references-13"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://senorge.no/" class="uri">https://senorge.no/</a></p>
<p><em>rr and tm are being download from:</em> <a href="https://thredds.met.no/thredds/catalog/senorge/seNorge_2018/Archive/catalog.html" class="uri">https://thredds.met.no/thredds/catalog/senorge/seNorge_2018/Archive/catalog.html</a></p>
<div id="additional-resources-1" class="section level3" number="21.7.1">
<h3>
<span class="header-section-number">21.7.1</span> Additional resources<a class="anchor" aria-label="anchor" href="#additional-resources-1"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://r-spatial.github.io/stars/">Stars package</a></p>
<p><a href="https://tmieno2.github.io/R-as-GIS-for-Economists/stars-basics.html">R as a GIS for economists</a> chapter 7</p>
<p><hl></hl></p>
</div>
</div>
<div id="analyses-cli" class="section level2" number="21.8">
<h2>
<span class="header-section-number">21.8</span> Analyses<a class="anchor" aria-label="anchor" href="#analyses-cli"><i class="fas fa-link"></i></a>
</h2>
<div id="data-set-1" class="section level3" number="21.8.1">
<h3>
<span class="header-section-number">21.8.1</span> Data set<a class="anchor" aria-label="anchor" href="#data-set-1"><i class="fas fa-link"></i></a>
</h3>
<p>The data is downloaded to a local NINA server, and updated regularly.</p>
<div class="sourceCode" id="cb750"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>, </span>
<span>      <span class="st">"R:/GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original"</span>,</span>
<span>      <span class="st">"/data/R/GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original"</span><span class="op">)</span></span></code></pre></div>
<p>This folder contains folder for the different parameters</p>
<div class="sourceCode" id="cb751"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "age"        "fsw"        "gwb_eva"    "gwb_gwtcl" </span></span>
<span><span class="co">#&gt;  [5] "gwb_q"      "gwb_sssdev" "gwb_sssrel" "lwc"       </span></span>
<span><span class="co">#&gt;  [9] "qsw"        "rr_tm"      "sd"         "sdfsw"     </span></span>
<span><span class="co">#&gt; [13] "swe"</span></span></code></pre></div>
<p>This table explains them in more detail</p>
<div class="sourceCode" id="cb752"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">senorgelayers</span> <span class="op">&lt;-</span> <span class="fu">read_delim</span><span class="op">(</span><span class="st">"data/senorgelayers.txt"</span>, </span>
<span>    delim <span class="op">=</span> <span class="st">"\t"</span>, escape_double <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    trim_ws <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">senorgelayers</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-5"></span>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-6b6eba5c95b6091bd194" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-6b6eba5c95b6091bd194">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["sdfsw","fsw","sd","age","swe","#swepr","#swepr","qsw","lwc","gwb_q","gwb_eva","gwb_gwtcl","gwb_sssdev","gwb_sssrel","tm","rr"],["16","8","16","8","16","no longer included","16","8","8","16","8","8","16","16","16","16"],[65535,255,65535,255,65535,null,65535,255,255,65535,255,255,32767,65535,65535,65535],[65534,254,null,254,null,null,null,254,254,null,null,null,null,null,null,null],["fresh snow depth","fresh snow","snow depth","snow age","snow water equivalent",null,"snow water equivalent percentage","snow melt","free water content in snow","runoff","evapotranspiration","ground water condition","water capacity of the soil","current water saturation of the soil","temperature","precipitation"],["mm","mm (water equivalent)","mm","number of days since last snowfall","1/10 mm (water equivalent)",null,"1/10 %","mm (water equivalent)","1/10 % free water in the snow layer","1/10 mm","1/10 mm","24h percentile of the normal period","mm in relation to maximum value of the normal period","% of the maximum value of the normal period","celsius","mm"],["Nysnødybde","Nysnø","Snødybde","Snøens alder","Snømengde",null,"Prosentandel swe","Snøsmelting","Snøtilstand","Avrenning","Fordamping","Grunnvannstilstand","Jordas vannkapasitet","Vannmetting i jord","Temperatur","Nedbør"],["Verdier i fil i 16bit integer verdier som angir mm snødybde.","Verdier angir mm vannekvivalent.","Verdier angir mm snødybde.","Verdiene angir antall dager siden siste snøfall.","Verdiene angir 1/10mm vannekvivalent. Altså en verdi på 102 er 10.2 mm vann.",null,"Veldig uklar beskrivelse gitt av NVE. Må sjekkes!","Verdiene angir mm vannekvivalent.","Verdien angir i prosent hvor mye fritt vann det er i snøpakka. Oppgitt i 1/10 %. En verdi på 45 er altså 4.5%.","Angir avrenning i 1/10mm vann. En verdi på 34 er altså 3.4 mm.","Angir fordampning i 1/10 mm vann.","Verdien angir hvilken døgnpercentilene i normalperioden som verdien tilhører. Verdiene er her 5, 25, 50, 75 og 95.","Verdien angir lagerkapasiteten (i mm) i forhold til maxverdien registrert i 30 årsperioden (1981-2010). Negativ verdi betyr altså at dagens vannlager verdi er over maxverdien.","Dagens vannlager verdi i prosent av den samme maksimale verdien som brukes i gwb_ssdev. En verdi over 100 angir altså at maksverdien er overskredet.","Verdien angir grader i Celsius (re-skalert fra tiendels Kelvin, der en verdi på 2811 er (2811-2731)/10 = 8.0 C.","Verdien angir nedbør i mm (re-skalert fra tiendels mm)."],["gt_Meteorology_Norway_seNorge_FreshSnowDepth_days","gt_Meteorology_Norway_seNorge_FreshSnow_days","gt_Meteorology_Norway_seNorge_SnowDepth_days","gt_Meteorology_Norway_seNorge_SnowAge_days","gt_Meteorology_Norway_seNorge_SnowAmount_days",null,"gt_Meteorology_Norway_seNorge_SnowAmountPercentage_days","gt_Meteorology_Norway_seNorge_SnowMelt_days","gt_Meteorology_Norway_seNorge_SnowFreeWaterContent_days","gt_Meteorology_Norway_seNorge_Runoff_days","gt_Meteorology_Norway_seNorge_Evapotranspiration_days","gt_Meteorology_Norway_seNorge_GroundWaterCondition_days","gt_Meteorology_Norway_seNorge_WaterCapacitySoil_days","gt_Meteorology_Norway_seNorge_WaterSaturationSoil_days","gt_Meteorology_Norway_seNorge_Temperature_days","gt_Meteorology_Norway_seNorge_Precipitation_days"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,"celsius","precipitation_daily"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>abbrev<\/th>\n      <th>bit<\/th>\n      <th>nodata<\/th>\n      <th>bare_ground<\/th>\n      <th>name<\/th>\n      <th>unit<\/th>\n      <th>navn<\/th>\n      <th>beskrivelse<\/th>\n      <th>grass_mapset<\/th>\n      <th>color_table<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p class="caption">
Figure 16.1: Table explaining the available climate parameters in the data set.
</p>
</div>
<p>Here is the content of one of these folders (first 10 entries)</p>
<div class="sourceCode" id="cb753"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">files_tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/rr_tm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1] "seNorge2018_1957.nc" "seNorge2018_1958.nc"</span></span>
<span><span class="co">#&gt;  [3] "seNorge2018_1959.nc" "seNorge2018_1960.nc"</span></span>
<span><span class="co">#&gt;  [5] "seNorge2018_1961.nc" "seNorge2018_1962.nc"</span></span>
<span><span class="co">#&gt;  [7] "seNorge2018_1963.nc" "seNorge2018_1964.nc"</span></span>
<span><span class="co">#&gt;  [9] "seNorge2018_1965.nc" "seNorge2018_1966.nc"</span></span></code></pre></div>
<p>There are 67 files, i.e. 67 years of data, one file per year.</p>
<p>Importing (proxy) file:</p>
<div class="sourceCode" id="cb754"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tg_1957</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/rr_tm/seNorge2018_1957.nc"</span><span class="op">)</span>,</span>
<span>                            var<span class="op">=</span><span class="st">"tg"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Large netcdf source found, returning proxy object.</span></span></code></pre></div>
<p>I know the CRS, so setting it manually. Although I cannot rule out 32633, I don’t think it matters.</p>
<div class="sourceCode" id="cb755"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">tg_1957</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">25833</span></span></code></pre></div>
<p>The data has three dimension</p>
<div class="sourceCode" id="cb756"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">tg_1957</span><span class="op">)</span></span>
<span><span class="co">#&gt;    X    Y time </span></span>
<span><span class="co">#&gt; 1195 1550  365</span></span></code></pre></div>
<p>Initially the data had four attributes, but I subsettet to only include <em>tg</em>.</p>
<div class="sourceCode" id="cb757"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tg_1957</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tg"</span></span></code></pre></div>
<p><code>tg_1957</code> is a stars proxy object and <a href="https://r-spatial.github.io/stars/articles/stars8.html">most commands</a> will not initiate any change until later, typically I write to file and all the lazy operations are done in squeal. Therefore, I will prepare a test data set, which is smaller and which I can import to memory. Then I can perform the operations on that data set and we can see the results.</p>
<div id="dummy-data" class="section level4" number="21.8.1.1">
<h4>
<span class="header-section-number">21.8.1.1</span> Dummy data<a class="anchor" aria-label="anchor" href="#dummy-data"><i class="fas fa-link"></i></a>
</h4>
<p>This test data is included in the {stars} package</p>
<div class="sourceCode" id="cb758"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="va">t1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"1970-05-31"</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu">read_stars</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">tif</span>, <span class="va">tif</span>, <span class="va">tif</span>, <span class="va">tif</span><span class="op">)</span>, along <span class="op">=</span> </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t1</span><span class="op">+</span><span class="fl">1</span>, <span class="va">t1</span><span class="op">+</span><span class="fl">50</span>, <span class="va">t1</span><span class="op">+</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               RasterIO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nXOff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>                               nYOff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>                               nXSize <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                               nYSize <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                               bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A single attribute</p>
<div class="sourceCode" id="cb759"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "L7_ETMs.tif"</span></span></code></pre></div>
<p>I can rename it like this</p>
<div class="sourceCode" id="cb760"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"Attribute_A"</span><span class="op">)</span></span></code></pre></div>
<p>And I can add another dummy attribute.</p>
<div class="sourceCode" id="cb761"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="st">"Attribute_B"</span> <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The dummy data also has four dimensions</p>
<div class="sourceCode" id="cb762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;    x    y band time </span></span>
<span><span class="co">#&gt;   50   50    6    4</span></span></code></pre></div>
<p>X and y area the coordinates. Band is an integer:</p>
<div class="sourceCode" id="cb763"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"band"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 6</span></span></code></pre></div>
<p>I will remove the <em>band</em> dimension.</p>
<div class="sourceCode" id="cb764"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">band</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Time is four dates covering four months in 1970:</p>
<div class="sourceCode" id="cb765"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">oldTime</span> <span class="op">&lt;-</span> <span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1970-05-31" "1970-06-01" "1970-07-20" "1970-09-08"</span></span></code></pre></div>
<p>I’ll add some extra seasonal variation between to the mix</p>
<div class="sourceCode" id="cb766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fl">1.2</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fl">1.4</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">Attribute_A</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fl">1.1</span></span></code></pre></div>
<p>Now I create another four copies of this data, adding some random noise and a continuous decreasing trend.</p>
<div class="sourceCode" id="cb767"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to add random noise</span></span>
<span><span class="va">myRandom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">.05</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span><span class="va">y2</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="va">y3</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.90</span><span class="op">)</span></span>
<span><span class="va">y4</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.85</span><span class="op">)</span></span>
<span><span class="va">y5</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">myRandom</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"time"</span>, values <span class="op">=</span> <span class="va">oldTime</span> <span class="op">%m+%</span> <span class="fu">years</span><span class="op">(</span><span class="op">-</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Attribute_A <span class="op">=</span> <span class="va">Attribute_A</span><span class="op">*</span><span class="fl">0.80</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb769"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We combine the data into one cube for plotting:</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">y2</span>, <span class="va">y3</span>, <span class="va">y4</span>, <span class="va">y5</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">temp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">time</span>, ncol<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="climate_indicators_explained_files/figure-html/unnamed-chunk-22-1.png" width="672"></div>
<p>Saving these to file.</p>
<div class="sourceCode" id="cb770"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="st">"P:/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y1</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y1.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y2</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y2.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y3</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y3.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y4</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y4.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y5</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"/y5.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="dummy-regions-and-et-map" class="section level5" number="21.8.1.1.1">
<h5>
<span class="header-section-number">21.8.1.1.1</span> Dummy regions and ET map<a class="anchor" aria-label="anchor" href="#dummy-regions-and-et-map"><i class="fas fa-link"></i></a>
</h5>
<p>Here is some dummy data for accounting areas (regions) and ecosystem occurrences as well, in case I need them later.</p>
<div class="sourceCode" id="cb771"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy_aa</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="va">oldTime</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accountingAreas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">accountingAreas</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">dummy_aa</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span>style<span class="op">=</span><span class="st">"cat"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-24"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-24-1.png" alt="Showing the example account area delineation (raster format)" width="672"><p class="caption">
Figure 17.7: Showing the example account area delineation (raster format)
</p>
</div>
<div class="sourceCode" id="cb772"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy_et</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="va">oldTime</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ecosystemType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="cn">NA</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ecosystemType</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">dummy_et</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span>style<span class="op">=</span><span class="st">"cat"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-25"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-25-1.png" alt="Showing the example Ecosystem type delineation data." width="672"><p class="caption">
Figure 21.1: Showing the example Ecosystem type delineation data.
</p>
</div>
</div>
</div>
<div id="regions-cli" class="section level4" number="21.8.1.2">
<h4>
<span class="header-section-number">21.8.1.2</span> Regions<a class="anchor" aria-label="anchor" href="#regions-cli"><i class="fas fa-link"></i></a>
</h4>
<p>Importing a shape file with the regional delineation.</p>
<div class="sourceCode" id="cb773"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/regions.shp"</span>, options <span class="op">=</span> <span class="st">"ENCODING=UTF8"</span><span class="op">)</span></span>
<span><span class="co">#&gt; options:        ENCODING=UTF8 </span></span>
<span><span class="co">#&gt; Reading layer `regions' from data source </span></span>
<span><span class="co">#&gt;   `/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/github/ecosystemCondition/data/regions.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#st_crs(reg)</span></span></code></pre></div>
<p>Outline of Norway</p>
<div class="sourceCode" id="cb774"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nor</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/outlineOfNorway_EPSG25833.shp"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `outlineOfNorway_EPSG25833' from data source </span></span>
<span><span class="co">#&gt;   `/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/github/ecosystemCondition/data/outlineOfNorway_EPSG25833.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -113472.7 ymin: 6448359 xmax: 1114618 ymax: 7939917</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Remove marine areas from regions</p>
<div class="sourceCode" id="cb775"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span><span class="va">reg</span>, <span class="va">nor</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: attribute variables are assumed to be spatially</span></span>
<span><span class="co">#&gt; constant throughout all geometries</span></span></code></pre></div>
<div class="sourceCode" id="cb776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">reg</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col<span class="op">=</span><span class="st">"region"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-29"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-29-1.png" alt="Five accounting areas (regions) in Norway." width="672"><p class="caption">
Figure 5.8: Five accounting areas (regions) in Norway.
</p>
</div>
</div>
<div id="ecosystem-map-2" class="section level4" number="21.8.1.3">
<h4>
<span class="header-section-number">21.8.1.3</span> Ecosystem map<a class="anchor" aria-label="anchor" href="#ecosystem-map-2"><i class="fas fa-link"></i></a>
</h4>
<p>Coming soon ….</p>
<p>The climate indicators need to be masked with ecosystem type maps. This step is part of this chapter.</p>
</div>
</div>
<div id="conceptual-workflow-1" class="section level3" number="21.8.2">
<h3>
<span class="header-section-number">21.8.2</span> Conceptual workflow<a class="anchor" aria-label="anchor" href="#conceptual-workflow-1"><i class="fas fa-link"></i></a>
</h3>
<p>The general, the conceptual workflow is like this:</p>
<ol style="list-style-type: decimal">
<li>
<p>Collate variable data series</p>
<ul>
<li><p>Import .nc files (loop though year 1961-1990) and subset to the correct attribute</p></li>
<li><p>Filter data by dates (optional) (<code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code>). <em>This means reading all 365 rasters into memory, and it is much quicker to filter out the correct rasters in the importing step above (see examples later in this chapter)</em></p></li>
<li><p>Aggregate across time within a year (<code><a href="https://r-spatial.github.io/stars/reference/st_apply.html">stars::st_apply</a></code>). <em>This is the most time consuming operation in the workflow.</em></p></li>
<li><p>Join all data into one data cube (<code>stars:c</code>)</p></li>
</ul>
</li>
<li>
<p>Calculate reference values</p>
<ul>
<li><p>Aggregate (<code>st_apply)</code> across reference years (<code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code>) to get median and sd values</p></li>
<li><p>Join with existing data cube (<code>stars:c</code>)</p></li>
</ul>
</li>
<li>
<p>Calculate indicator values</p>
<ul>
<li>Normalize climate variable at the individual grid cell level using the three reference values (<code>mutate(across()))</code>
</li>
</ul>
</li>
<li><p>Mask by ecosystem type (<em>This could also be done in step one, but it doesn’t speed things up to set some cells to NA</em>)</p></li>
<li>
<p>Aggregate in space (to accounting areas) (<em>zonal statistics</em>)</p>
<ul>
<li><p>Aggregate across 5 year time steps to smooth out random inter-annual variation and leave climate signal</p></li>
<li><p>Intersect with accounting area polygons <code>exactextrar::exact_extract</code> and get mean/median and (spatial) sd. (<em>Alternatively, get temporal sd at the grid cell level in the step above.</em>)</p></li>
</ul>
</li>
<li><p>Make trend figure and spatially aggregated maps,</p></li>
</ol>
</div>
<div id="collate-variable-data-series" class="section level3" number="21.8.3">
<h3>
<span class="header-section-number">21.8.3</span> Collate variable data series<a class="anchor" aria-label="anchor" href="#collate-variable-data-series"><i class="fas fa-link"></i></a>
</h3>
<p>I include a for loop for importing the .nc files at the end.</p>
</div>
<div id="filter-data-by-dates" class="section level3" number="21.8.4">
<h3>
<span class="header-section-number">21.8.4</span> Filter data by dates<a class="anchor" aria-label="anchor" href="#filter-data-by-dates"><i class="fas fa-link"></i></a>
</h3>
<p>Say we want to calculate the mean summer temperature. We then want to exclude the data for the times that is not withing our definition of summer.</p>
<p>Let’s try it on the dummy data. Remember this data had four time steps.</p>
<div class="sourceCode" id="cb777"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1970-05-31" "1970-06-01" "1970-07-20" "1970-09-08"</span></span></code></pre></div>
<p>Our real data has 365 time steps for each year.</p>
<p>First I define my start and end dates. I want to keep only the summer data, defined as jun - aug.</p>
<div class="sourceCode" id="cb778"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_month</span> <span class="op">&lt;-</span>  <span class="st">"06"</span></span>
<span><span class="va">end_month</span> <span class="op">&lt;-</span> <span class="st">"08"</span></span></code></pre></div>
<p>Then for each iteration I need to get the year as well</p>
<div class="sourceCode" id="cb779"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">year_temp</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1970</span></span></code></pre></div>
<p>Then I can create a time interval object</p>
<div class="sourceCode" id="cb780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">start_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">end</span> <span class="op">&lt;-</span>  <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">end_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">myInterval</span> <span class="op">&lt;-</span> <span class="fu">interval</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1970-06-01 UTC--1970-08-01 UTC</span></span></code></pre></div>
<p>Then I filter</p>
<div class="sourceCode" id="cb781"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_aug</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">adrop</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">%within%</span> <span class="va">myInterval</span><span class="op">)</span></span>
<span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x_aug</span>, <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1970-06-01" "1970-07-20"</span></span></code></pre></div>
<p><em>Later I discover that `dplyr::filter` work after reading the whole object to file, and therefor it is too slow for our use. I therefore filter data a different way further down.</em></p>
</div>
<div id="aggregate-across-time-within-a-year" class="section level3" number="21.8.5">
<h3>
<span class="header-section-number">21.8.5</span> Aggregate across time within a year<a class="anchor" aria-label="anchor" href="#aggregate-across-time-within-a-year"><i class="fas fa-link"></i></a>
</h3>
<p>For this example I want to calculate the mean temperature over the summer. I therefore need to aggregate over time. Many climate indicators will need this functionality. There are two ways, either using <code>st_apply</code> or using <code>aggregate</code>.</p>
<div class="sourceCode" id="cb782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_names</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">x_aug</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">microOut</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>st_apply <span class="op">=</span>  <span class="va">x_aug</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>,<span class="va">temp_names</span><span class="op">)</span><span class="op">)</span>,</span>
<span>aggregate <span class="op">=</span> <span class="va">x_aug</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"year"</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>times<span class="op">=</span><span class="fl">30</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The time dimension is now gone as we have aggregated across it.</p>
<div class="sourceCode" id="cb783"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">autoplot</span><span class="op">(</span><span class="va">microOut</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate system already present. Adding new coordinate</span></span>
<span><span class="co">#&gt; system, which will replace the existing one.</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-36"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-36-1.png" alt="Comparing computation tome for two spatial aggregation functions." width="672"><p class="caption">
Figure 21.2: Comparing computation tome for two spatial aggregation functions.
</p>
</div>
<p><code>st_apply</code> is slightly faster, but <code>aggregate</code> has the advantage of that it retains the time dimension, whereas for <code>st_apply</code> I need to set the attribute name to be the year. I will try to use <code>st_apply</code>.</p>
<p>But let me see if I can save time by masking to ET before doing this operation.</p>
<div class="sourceCode" id="cb784"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_masked</span> <span class="op">&lt;-</span> <span class="va">x_aug</span></span>
<span><span class="va">x_masked</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dummy_et</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x_masked</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-37"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-37-1.png" alt="Demonstrating the effect of maskig the dummy data using a perfectly aligne raster ET map." width="672"><p class="caption">
Figure 21.3: Demonstrating the effect of maskig the dummy data using a perfectly aligne raster ET map.
</p>
</div>
<div class="sourceCode" id="cb785"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">autoplot</span><span class="op">(</span></span>
<span>  <span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>No_masking <span class="op">=</span>  <span class="va">x_aug</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>,<span class="va">temp_names</span><span class="op">)</span><span class="op">)</span>,</span>
<span>Masking <span class="op">=</span>  <span class="va">x_masked</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>,<span class="va">temp_names</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="op">)</span>, times<span class="op">=</span><span class="fl">30</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate system already present. Adding new coordinate</span></span>
<span><span class="co">#&gt; system, which will replace the existing one.</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:withMasking"></span>
<img src="climate_indicators_explained_files/figure-html/withMasking-1.png" alt="Comparing computation time before and after masking of raster data. There is no performance increase by masking before aggregating." width="672"><p class="caption">
Figure 21.4: Comparing computation time before and after masking of raster data. There is no performance increase by masking before aggregating.
</p>
</div>
<p>Since there is no increase in performance from masking, as we see in Fig. @ref(fig: withMasking) then it basically means we it is slower to mask beforehand, since the masking was not past of the benchmark assessment.</p>
<p>So, this is my solution:</p>
<div class="sourceCode" id="cb786"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setNames dont work on stars proxy obejct, so I use rename instead</span></span>
<span><span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="va">temp_names</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x_summerMean</span> <span class="op">&lt;-</span>   <span class="va">x_aug</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <em>v_</em> follows the naming convention we have developed for ourselves.</p>
<div class="sourceCode" id="cb787"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_aug</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">time</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,  </span>
<span>  </span>
<span>  </span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_summerMean</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#facet_wrap(~time) +</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-39"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-39-1.png" alt="Plotting the dummy data showing Attribute_A for the two dates as small maps, and a larger map showing the mean for year 2018" width="672"><p class="caption">
Figure 21.5: Plotting the dummy data showing Attribute_A for the two dates as small maps, and a larger map showing the mean for year 2018
</p>
</div>
<p>Here’s the whole first step of the conceptual workflow in action, on the dummy data.</p>
<div class="sourceCode" id="cb788"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Setting up the parameters</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>,</span>
<span>       <span class="st">"P:/"</span>, </span>
<span>       <span class="st">"/data/P-Prosjekter2/"</span><span class="op">)</span></span>
<span><span class="va">path2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, </span>
<span>                <span class="st">"41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data"</span><span class="op">)</span></span>
<span><span class="va">start_month</span> <span class="op">&lt;-</span>  <span class="st">"06"</span></span>
<span><span class="va">end_month</span> <span class="op">&lt;-</span> <span class="st">"08"</span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path2</span>, pattern<span class="op">=</span><span class="st">".rds"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">summerTemp_fullSeries</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># Looping though the files in the directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">year_temp</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">start_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">end</span> <span class="op">&lt;-</span>  <span class="fu">ym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year_temp</span>, <span class="va">end_month</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">myInterval</span> <span class="op">&lt;-</span> <span class="fu">interval</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span></span>
<span>  <span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="va">year_temp</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">%within%</span> <span class="va">myInterval</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">summerTemp_fullSeries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">summerTemp_fullSeries</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span> <span class="co"># same computation time with and without this function, but more tidy this way</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Turn the attributes into a dimension and rename the new attribute</span></span>
<span><span class="va">summerTemp_fullSeries</span> <span class="op">&lt;-</span> <span class="va">summerTemp_fullSeries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"Year"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"Attribute_A"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.167   0.028   0.202</span></span></code></pre></div>
<p>And this is the result.</p>
<div class="sourceCode" id="cb789"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">summerTemp_fullSeries</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-41"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-41-1.png" alt="Temporal aggregation on the dummy data set." width="672"><p class="caption">
Figure 21.6: Temporal aggregation on the dummy data set.
</p>
</div>
<p>Now let’s try it on the real data.</p>
<p><em>I initially tried to read stars proxy object and add steps to the call_list and execute these with <code>st_as_stars</code>, but this still returned proxy objects. Therefore I read the whole file in without proxy. To save time I can subset based on Julian dates.</em></p>
<p>I will use <a href="https://tmieno2.github.io/R-as-GIS-for-Economists/EE.html">parallelization</a> to speed things up.</p>
<div class="sourceCode" id="cb790"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>, </span>
<span>      <span class="st">"R:/"</span>,</span>
<span>      <span class="st">"/data/R/"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">path2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original/rr_tm/"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path2</span>, pattern<span class="op">=</span><span class="st">".nc$"</span>,full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co"># The last file (the last year) is incomplete and don't include all julian dates that we select below, so I will not include it:</span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="va">myFiles</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">real_temp_summer</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># set up parallel cluster using 10 cores</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get julian days after defining months</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, var<span class="op">=</span><span class="st">"tg"</span><span class="op">)</span></span>
<span><span class="va">start_month_num</span> <span class="op">&lt;-</span>  <span class="fl">6</span></span>
<span><span class="va">end_month_num</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="va">julian_start</span> <span class="op">&lt;-</span> <span class="fu">yday</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">%m+%</span></span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="op">+</span><span class="va">start_month_num</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">julian_end</span> <span class="op">&lt;-</span> <span class="fu">yday</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">%m+%</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="op">+</span><span class="va">end_month_num</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">step</span> <span class="op">&lt;-</span> <span class="va">julian_end</span><span class="op">-</span><span class="va">julian_start</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu">tic</span><span class="op">(</span><span class="st">"init"</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, var<span class="op">=</span><span class="st">"tg"</span>, proxy<span class="op">=</span><span class="cn">F</span>,</span>
<span>                           ncsub <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">julian_start</span><span class="op">)</span>, </span>
<span>                              count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="va">step</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">year_temp</span> <span class="op">&lt;-</span> <span class="fu">year</span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">temp</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">year_temp</span><span class="op">)</span></span>
<span>  <span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="va">year_temp</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="co"># Perhaps leave out the v_ to get a numeric vector instead, </span></span>
<span>    <span class="co"># which is easier to subset</span></span>
<span>  <span class="fu">st_crs</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">25833</span></span>
<span>  <span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">tic</span><span class="op">(</span><span class="st">"filter and st_apply"</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">tic</span><span class="op">(</span><span class="st">"c()"</span><span class="op">)</span></span>
<span>  <span class="va">real_temp_summer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">real_temp_summer</span><span class="op">)</span></span>
<span>  <span class="co">#rm(temp)</span></span>
<span>  <span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Merge"</span><span class="op">)</span></span>
<span><span class="va">real_temp_summer</span> <span class="op">&lt;-</span> <span class="va">real_temp_summer</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"climate_variable"</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>This takes about 20 sec per file/year, or 22 min on total. That is not too bad. About 6000 raster are read into memory. Here’s a test for the effect of splitting over more cores.</p>
<div class="sourceCode" id="cb791"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span>
<span><span class="va">cl2</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">6L</span><span class="op">)</span></span>
<span><span class="va">cl3</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"No cluster"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Two clusters"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Six clusters"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl2</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"Ten clusters"</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span>    <span class="fu">st_apply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">mean</span>, CLUSTER <span class="op">=</span> <span class="va">cl3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl3</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span></code></pre></div>
<ul>
<li><p>No cluster: 21.401 sec elapsed</p></li>
<li><p>Two clusters: 21.546 sec elapsed</p></li>
<li><p>Six clusters: 14.548 sec elapsed</p></li>
<li><p>Ten clusters: 15.29 sec elapsed</p></li>
<li><p>Ten clusters (second run): 13.617 sec elapsed</p></li>
</ul>
<p>The RStudio server has 48 cores. More parallel cores is probably on average faster. The NINA guidelines is to use max 10 cores, and to remember to close parallel cluster when done.</p>
<div class="sourceCode" id="cb792"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#saveRDS(real_temp_summer, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/real_temp_summer.rds")</span></span>
<span><span class="co">#write_stars(real_temp_summer, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/real_temp_summer.tiff")</span></span></code></pre></div>
<p>These files are about 500 MB, but the tiff file reads in a lot quicker then the rds file, so from now on I’ll just export as tiff. <em>(This could perhaps have been solved with a <code><a href="https://rdrr.io/r/base/gc.html">gc()</a></code>. Later I tried saving as RData with no speed issues problems, but then I had a problem with RData files seemingly becoming corrupted over time - stars objects saved as RData files would not bind together using <code>c.stars()</code> with other matching stars object and I think this could be related to a time stamp in the RData format. So, stick to tiff).</em></p>
<div class="sourceCode" id="cb793"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp</span> <span class="op">&lt;-</span> <span class="fu">read_stars</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">pData</span>, <span class="st">"climate_indicators/aggregated_climate_time_series/real_temp_summer.tiff"</span><span class="op">)</span>,</span>
<span>                                 proxy<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb794"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">summer_median_temp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "real_temp_summer.tiff"</span></span></code></pre></div>
<div class="sourceCode" id="cb795"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">summer_median_temp</span><span class="op">)</span></span>
<span><span class="co">#&gt;    x    y band </span></span>
<span><span class="co">#&gt; 1195 1550   66</span></span></code></pre></div>
<div class="sourceCode" id="cb796"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp</span>, <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>Note that GTiff automatically renames the third dimension <em>band</em> and also renames the attribute.</p>
<div class="sourceCode" id="cb797"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp</span>, <span class="st">"band"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "v_2022" "v_2021" "v_2020" "v_2019" "v_2018" "v_2017"</span></span>
<span><span class="co">#&gt;  [7] "v_2016" "v_2015" "v_2014" "v_2013" "v_2012" "v_2011"</span></span>
<span><span class="co">#&gt; [13] "v_2010" "v_2009" "v_2008" "v_2007" "v_2006" "v_2005"</span></span>
<span><span class="co">#&gt; [19] "v_2004" "v_2003" "v_2002" "v_2001" "v_2000" "v_1999"</span></span>
<span><span class="co">#&gt; [25] "v_1998" "v_1997" "v_1996" "v_1995" "v_1994" "v_1993"</span></span>
<span><span class="co">#&gt; [31] "v_1992" "v_1991" "v_1990" "v_1989" "v_1988" "v_1987"</span></span>
<span><span class="co">#&gt; [37] "v_1986" "v_1985" "v_1984" "v_1983" "v_1982" "v_1981"</span></span>
<span><span class="co">#&gt; [43] "v_1980" "v_1979" "v_1978" "v_1977" "v_1976" "v_1975"</span></span>
<span><span class="co">#&gt; [49] "v_1974" "v_1973" "v_1972" "v_1971" "v_1970" "v_1969"</span></span>
<span><span class="co">#&gt; [55] "v_1968" "v_1967" "v_1966" "v_1965" "v_1964" "v_1963"</span></span>
<span><span class="co">#&gt; [61] "v_1962" "v_1961" "v_1960" "v_1959" "v_1958" "v_1957"</span></span></code></pre></div>
<p>I can rename them.</p>
<div class="sourceCode" id="cb798"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">st_set_dimensions</span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"v_YEAR"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"temperature"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">summer_median_temp</span><span class="op">)</span></span>
<span><span class="co">#&gt;      x      y v_YEAR </span></span>
<span><span class="co">#&gt;   1195   1550     66</span></span></code></pre></div>
<div class="sourceCode" id="cb799"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">summer_median_temp</span><span class="op">[</span>,,,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">22</span><span class="op">)</span><span class="op">]</span>, downsample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">v_YEAR</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-51"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-51-1.png" alt="Showing three random slices of the year dimension." width="672"><p class="caption">
Figure 5.13: Showing three random slices of the year dimension.
</p>
</div>
</div>
<div id="calculate-reference-values" class="section level3" number="21.8.6">
<h3>
<span class="header-section-number">21.8.6</span> Calculate reference values<a class="anchor" aria-label="anchor" href="#calculate-reference-values"><i class="fas fa-link"></i></a>
</h3>
<div id="aggregate-across-reference-years" class="section level4" number="21.8.6.1">
<h4>
<span class="header-section-number">21.8.6.1</span> Aggregate across reference years<a class="anchor" aria-label="anchor" href="#aggregate-across-reference-years"><i class="fas fa-link"></i></a>
</h4>
<p>We need to first to define a reference period and then to subset our data <code>summer_median_temp</code>. We can practice on the dummy data <code>y</code>.</p>
<div class="sourceCode" id="cb800"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">==</span> <span class="st">"C:"</span>,</span>
<span>       <span class="st">"P:/"</span>, </span>
<span>       <span class="st">"/data/P-Prosjekter2/"</span><span class="op">)</span></span>
<span><span class="va">path2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">path</span>, </span>
<span>                <span class="st">"41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data"</span><span class="op">)</span></span>
<span><span class="va">myFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path2</span>, pattern<span class="op">=</span><span class="st">".rds"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># Looping though the files in the directory</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">myFiles</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb801"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">y</span>, <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "1966-05-31" "1966-06-01" "1966-07-20" "1966-09-08"</span></span>
<span><span class="co">#&gt;  [5] "1967-05-31" "1967-06-01" "1967-07-20" "1967-09-08"</span></span>
<span><span class="co">#&gt;  [9] "1968-05-31" "1968-06-01" "1968-07-20" "1968-09-08"</span></span>
<span><span class="co">#&gt; [13] "1969-05-31" "1969-06-01" "1969-07-20" "1969-09-08"</span></span>
<span><span class="co">#&gt; [17] "1970-05-31" "1970-06-01" "1970-07-20" "1970-09-08"</span></span></code></pre></div>
<div class="sourceCode" id="cb802"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_filtered</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Attribute_A</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">%within%</span> <span class="fu">interval</span><span class="op">(</span><span class="st">"1961-01-01"</span>, <span class="st">"1990-12-31"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we aggregate across years, again using st_apply.</p>
<div class="sourceCode" id="cb803"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">median_sd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb804"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_ref</span> <span class="op">&lt;-</span> <span class="va">y_filtered</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, FUN <span class="op">=</span>  <span class="va">median_sd</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb805"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">y_ref</span><span class="op">)</span></span>
<span><span class="co">#&gt; median_sd         x         y </span></span>
<span><span class="co">#&gt;         2        50        50</span></span></code></pre></div>
<div class="sourceCode" id="cb806"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">y_ref</span>, <span class="st">"median_sd"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "median" "sd"</span></span></code></pre></div>
<p>It’s perhaps easier if median and sd are unique attributes, rather than levels of a dimension.</p>
<div class="sourceCode" id="cb807"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_ref</span> <span class="op">&lt;-</span> <span class="va">y_ref</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="st">"median_sd"</span><span class="op">)</span></span></code></pre></div>
<p>The attribute name <em>mean</em> we can change this to something more meaningful.</p>
<div class="sourceCode" id="cb808"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">y_ref</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>, <span class="st">"sd"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb809"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tmap_arrange</span><span class="op">(</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">y_ref</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"reference_upper"</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">y_ref</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"sd"</span>,</span>
<span>            palette <span class="op">=</span> <span class="st">"-viridis"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-61"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-61-1.png" alt="Showing the upper reference levels and the standard deviation from the dummy data set." width="672"><p class="caption">
Figure 3.21: Showing the upper reference levels and the standard deviation from the dummy data set.
</p>
</div>
<p>Let’s transfer this over to the real data. First we need to rename our dimension values and turn them back into dates.</p>
<div class="sourceCode" id="cb810"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp</span>, <span class="st">"v_YEAR"</span><span class="op">)</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">summer_median_temp_ref</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"v_YEAR"</span>, values <span class="op">=</span> <span class="va">new_dims</span><span class="op">)</span></span></code></pre></div>
<p>Then I can filter to leave only the reference period.</p>
<div class="sourceCode" id="cb811"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp_ref</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp_ref</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">v_YEAR</span> <span class="op">%within%</span> <span class="fu">interval</span><span class="op">(</span><span class="st">"1961-01-01"</span>, <span class="st">"1990-12-31"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">summer_median_temp_ref</span>, <span class="st">"v_YEAR"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "1990-01-01" "1989-01-01" "1988-01-01" "1987-01-01"</span></span>
<span><span class="co">#&gt;  [5] "1986-01-01" "1985-01-01" "1984-01-01" "1983-01-01"</span></span>
<span><span class="co">#&gt;  [9] "1982-01-01" "1981-01-01" "1980-01-01" "1979-01-01"</span></span>
<span><span class="co">#&gt; [13] "1978-01-01" "1977-01-01" "1976-01-01" "1975-01-01"</span></span>
<span><span class="co">#&gt; [17] "1974-01-01" "1973-01-01" "1972-01-01" "1971-01-01"</span></span>
<span><span class="co">#&gt; [21] "1970-01-01" "1969-01-01" "1968-01-01" "1967-01-01"</span></span>
<span><span class="co">#&gt; [25] "1966-01-01" "1965-01-01" "1964-01-01" "1963-01-01"</span></span>
<span><span class="co">#&gt; [29] "1962-01-01" "1961-01-01"</span></span></code></pre></div>
<p>And then we calculate the median and sd like above</p>
<div class="sourceCode" id="cb812"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span><span class="va">summer_median_temp_ref</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp_ref</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_apply</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, </span>
<span>           FUN <span class="op">=</span>  <span class="va">median_sd</span>,</span>
<span>           CLUSTER <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>user</th>
<th>system</th>
<th>elapsed</th>
</tr></thead>
<tbody><tr class="odd">
<td>9.624</td>
<td>6.069</td>
<td>20.903</td>
</tr></tbody>
</table></div>
<p>This is also something I can export.</p>
<div class="sourceCode" id="cb813"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note that write_stars can only export a single attribute, but we have put the 'attributes' as dimensions, and these will be read in as 'band' when importing tiff.</span></span>
<span><span class="fu">write_stars</span><span class="op">(</span><span class="va">summer_median_temp_ref</span>, <span class="st">"/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_ref.tiff"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># I initially saved as RData, like this, but ran into problems later when trying to bind stars objects using c.stars(). It appears RData becomes corrutpt in a sense, over time, perhaps due to some time stamp. If I recreated the object in the global environment and saved as RDatam I could read it in and work with it, but the next day it would not work again.</span></span>
<span><span class="co">#saveRDS(summer_median_temp_ref, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_ref.RData")</span></span></code></pre></div>
<p>Pivot and turn dimension into attributes:</p>
<div class="sourceCode" id="cb814"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp_ref_long</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp_ref</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="st">"band"</span><span class="op">)</span></span></code></pre></div>
<p>The attribute name is <em>mean</em>. We can change this to something more meaningful.</p>
<div class="sourceCode" id="cb815"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summer_median_temp_ref_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>, <span class="st">"sd"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb816"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tmap_arrange</span><span class="op">(</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu">st_downsample</span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"reference_upper"</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu">st_downsample</span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="st">"sd"</span>,</span>
<span>            palette <span class="op">=</span> <span class="st">"-viridis"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-69"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-69-1.png" alt="Showing the upper reference levels and the standard deviation from actual data of median summer temperatures." width="672"><p class="caption">
Figure 21.7: Showing the upper reference levels and the standard deviation from actual data of median summer temperatures.
</p>
</div>
</div>
<div id="combine" class="section level4" number="21.8.6.2">
<h4>
<span class="header-section-number">21.8.6.2</span> Combine<a class="anchor" aria-label="anchor" href="#combine"><i class="fas fa-link"></i></a>
</h4>
<p>I need to combine the variables and the ref values in one data cube</p>
<div class="sourceCode" id="cb817"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="va">summer_median_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">summer_median_temp_ref_long</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="normalise-variable" class="section level3" number="21.8.7">
<h3>
<span class="header-section-number">21.8.7</span> Normalise variable<a class="anchor" aria-label="anchor" href="#normalise-variable"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb818"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># select the columns to normalise</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>, <span class="st">"sd"</span><span class="op">)</span> <span class="op">]</span></span>
<span><span class="va">cols_new</span> <span class="op">&lt;-</span> <span class="va">cols</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cols_new</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"v_"</span>, <span class="st">"i_"</span>, <span class="va">cols</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb819"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mutate</span></span>
<span></span>
<span><span class="co"># The break point scaling is actually not needed here, since </span></span>
<span><span class="co"># having the lower ref value to be 5 sd implies that the threshold is</span></span>
<span><span class="co"># 2 sd in a linear scaling.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span><span class="va">y_var_norm</span> <span class="op">&lt;-</span> <span class="va">y_var</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>reference_low <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>reference_low2 <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">+</span> <span class="fl">5</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>threshold_low <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>threshold_high <span class="op">=</span> <span class="va">reference_upper</span> <span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="va">sd</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, <span class="op">~</span> </span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="va">reference_upper</span>,</span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="va">threshold_low</span>, </span>
<span>                                        <span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">reference_low</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">threshold_low</span> <span class="op">-</span> <span class="va">reference_low</span><span class="op">)</span>,</span>
<span>                                        <span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">threshold_low</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">reference_upper</span> <span class="op">-</span> <span class="va">threshold_low</span><span class="op">)</span>,</span>
<span>                                        <span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&gt;</span> <span class="va">threshold_high</span>, </span>
<span>                                        <span class="op">(</span><span class="va">reference_low2</span> <span class="op">-</span> <span class="va">.x</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">reference_low2</span> <span class="op">-</span> <span class="va">threshold_high</span><span class="op">)</span>,</span>
<span>                                        <span class="op">(</span><span class="va">threshold_high</span> <span class="op">-</span> <span class="va">.x</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">threshold_high</span> <span class="op">-</span> <span class="va">reference_upper</span><span class="op">)</span>,</span>
<span>                                        <span class="op">)</span></span>
<span>                <span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">cols_new</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">y_var</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>user</th>
<th>system</th>
<th>elapsed</th>
</tr></thead>
<tbody><tr class="odd">
<td>14.803</td>
<td>2.717</td>
<td>17.512</td>
</tr></tbody>
</table></div>
<p>Writing to file, this time as RData (could use rds) because tiff don’t allow multiple attributes, and because we don’t need to use <code>c.stars()</code> in this object.</p>
<div class="sourceCode" id="cb820"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">y_var_norm</span>, <span class="st">"/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_normalised.RData"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb821"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">lims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">22</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"v_1970"</span><span class="op">]</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"reference_upper"</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"reference_low"</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"reference_low2"</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="va">lims</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>,</span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_downsample</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">[</span><span class="st">"i_1970"</span><span class="op">]</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_discrete</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>, ncol<span class="op">=</span><span class="fl">2</span>, nrow<span class="op">=</span><span class="fl">3</span>, align <span class="op">=</span> <span class="st">"hv"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-75"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-75-1.png" alt="Example showing median summer tempretur in 1970, the upper and lwoer reference temperture, i.e. median and 5 SD units of the temperature between  1961-1990, and finally, the scaled indicator values." width="672"><p class="caption">
Figure 21.8: Example showing median summer tempretur in 1970, the upper and lwoer reference temperture, i.e. median and 5 SD units of the temperature between 1961-1990, and finally, the scaled indicator values.
</p>
</div>
<p>The <em>real</em> indicator values should be means over 5 year periods. Calculating a running mean for all time steps is too time consuming. Therefore, the scaled, regional indicator values will be calculated for distinct time steps. The time series can perhaps best be presented with yearly resolution.</p>
</div>
<div id="plot-time-series-as-line-graphs" class="section level3" number="21.8.8">
<h3>
<span class="header-section-number">21.8.8</span> Plot time series as line graphs<a class="anchor" aria-label="anchor" href="#plot-time-series-as-line-graphs"><i class="fas fa-link"></i></a>
</h3>
<p>We could also plot a time series as a series of maps, but then we need to average over these 5 year time periods first. We can get to that later.</p>
<p>To plot time series I first need to do a spatial aggregation. One option is to spatially aggregate the stars object directly, using the <code>reg</code> data set:</p>
<div class="sourceCode" id="cb822"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">y_var_norm</span><span class="op">[</span><span class="fl">1</span>,,<span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">reg</span>, <span class="va">mean</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span><span class="va">temp2</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="co"># too slow</span></span></code></pre></div>
<p>However, this does no preserve the region name, and a subsequent <code>st_intersection</code> taks a little while and gives some boundary problems.</p>
<p>I can also convert pixels to points and then do the intersection.</p>
<div class="sourceCode" id="cb823"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb823-1"><a href="climate-indicators-explained.html#cb823-1" aria-hidden="true" tabindex="-1"></a>temp_points <span class="ot">&lt;-</span> y_var_norm[<span class="dv">1</span>,,] <span class="sc">%&gt;%</span></span>
<span id="cb823-2"><a href="climate-indicators-explained.html#cb823-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">as_points =</span> <span class="cn">TRUE</span>, <span class="at">merge =</span> <span class="cn">FALSE</span>)</span>
<span id="cb823-3"><a href="climate-indicators-explained.html#cb823-3" aria-hidden="true" tabindex="-1"></a>temp_points2 <span class="ot">&lt;-</span> temp_points <span class="sc">%&gt;%</span></span>
<span id="cb823-4"><a href="climate-indicators-explained.html#cb823-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(reg) <span class="st">" too slow"</span></span></code></pre></div>
<p>But this also took too long.</p>
<p>I can perhaps aggregate, and then turn to points and intersect, but that did not work perfect either.</p>
<p>I can rasterize the regions data set, turn it into a coded dimension and use st_apply, but that is tedious.</p>
<p>Let me try using <code>exact_extract</code>, as an alternative to <code>aggregate</code>. This requires us to turn to the <code>terra</code> package for a bit.</p>
<div class="sourceCode" id="cb824"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span><span class="va">regional_means</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">exact_extract</span><span class="op">(</span><span class="va">reg</span>, fun <span class="op">=</span> <span class="st">'mean'</span>, append_cols <span class="op">=</span> <span class="st">"region"</span>, progress<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"region"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>user; system; elapsed: 7.603; 3.071; 10.697</p>
<p>That was fast!</p>
<p>I should also get the sd:</p>
<div class="sourceCode" id="cb825"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span><span class="va">regional_sd</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">exact_extract</span><span class="op">(</span><span class="va">reg</span>, fun <span class="op">=</span> <span class="st">'stdev'</span>, append_cols <span class="op">=</span> <span class="st">"region"</span>, progress<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"region"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y_var_norm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>user; system; elapsed: 7.420; 2.921; 10.355</p>
<div class="sourceCode" id="cb826"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">regional_means</span>, <span class="st">"temp/regional_means.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">regional_sd</span>, <span class="st">"temp/regional_sd.rds"</span><span class="op">)</span></span></code></pre></div>
<p>Reshape and plot</p>
<div class="sourceCode" id="cb827"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">div</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reference_upper"</span>,</span>
<span>         <span class="st">"reference_low"</span>,</span>
<span>         <span class="st">"reference_low2"</span>,</span>
<span>         <span class="st">"threshold_low"</span>,</span>
<span>         <span class="st">"threshold_high"</span>,</span>
<span>         <span class="st">"sd"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">regional_means</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">div</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">regional_means_long</span> <span class="op">&lt;-</span> <span class="va">regional_means</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">div</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">name</span>, into<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span><span class="co">#id_cols = region,</span></span>
<span>              names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">temp</span>, by<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">v</span><span class="op">-</span><span class="va">reference_upper</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>threshold_low_centered <span class="op">=</span> <span class="va">threshold_low</span><span class="op">-</span><span class="va">reference_upper</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>threshold_high_centered <span class="op">=</span> <span class="va">threshold_high</span><span class="op">-</span><span class="va">reference_upper</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Adding the spatial sd</span></span>
<span><span class="op">(</span></span>
<span><span class="va">regional_means_long</span> <span class="op">&lt;-</span> <span class="va">regional_sd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">div</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">name</span>, into<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>i_sd <span class="op">=</span> <span class="va">i</span>,</span>
<span>         v_sd <span class="op">=</span> <span class="va">v</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">regional_means_long</span>, by<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 330 × 15</span></span>
<span><span class="co">#&gt;    region     year   i_sd  v_sd     i     v refere…¹ refer…²</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 Nord-Norge 2022  0.246  1.90 0.523  11.5     10.2    4.21</span></span>
<span><span class="co">#&gt;  2 Nord-Norge 2021  0.255  1.65 0.672  10.8     10.2    4.21</span></span>
<span><span class="co">#&gt;  3 Nord-Norge 2020  0.143  1.82 0.784  10.3     10.2    4.21</span></span>
<span><span class="co">#&gt;  4 Nord-Norge 2019  0.290  1.77 0.623  10.8     10.2    4.21</span></span>
<span><span class="co">#&gt;  5 Nord-Norge 2018  0.344  1.64 0.523  12.5     10.2    4.21</span></span>
<span><span class="co">#&gt;  6 Nord-Norge 2017  0.145  1.79 0.794  10.1     10.2    4.21</span></span>
<span><span class="co">#&gt;  7 Nord-Norge 2016  0.175  1.74 0.705  10.8     10.2    4.21</span></span>
<span><span class="co">#&gt;  8 Nord-Norge 2015  0.198  1.61 0.682  10.6     10.2    4.21</span></span>
<span><span class="co">#&gt;  9 Nord-Norge 2014  0.297  1.65 0.545  13.1     10.2    4.21</span></span>
<span><span class="co">#&gt; 10 Nord-Norge 2013  0.202  1.65 0.479  11.4     10.2    4.21</span></span>
<span><span class="co">#&gt; # … with 320 more rows, 7 more variables:</span></span>
<span><span class="co">#&gt; #   reference_low2 &lt;dbl&gt;, threshold_low &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   threshold_high &lt;dbl&gt;, sd &lt;dbl&gt;, diff &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   threshold_low_centered &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   threshold_high_centered &lt;dbl&gt;, and abbreviated variable</span></span>
<span><span class="co">#&gt; #   names ¹​reference_upper, ²​reference_low</span></span></code></pre></div>
<div class="sourceCode" id="cb828"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regOrder</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Østlandet"</span>,<span class="st">"Sørlandet"</span>,<span class="st">"Vestlandet"</span>,<span class="st">"Midt-Norge"</span>,<span class="st">"Nord-Norge"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regional_means_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">diff</span><span class="op">&gt;</span><span class="fl">0</span>, <span class="st">"1"</span>, <span class="st">"2"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, </span>
<span>           y <span class="op">=</span> <span class="va">diff</span>, fill <span class="op">=</span> <span class="va">col</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">threshold_low_centered</span><span class="op">)</span>,</span>
<span>        linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">threshold_high_centered</span><span class="op">)</span>,</span>
<span>        linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_segment</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1961</span>, xend<span class="op">=</span><span class="fl">1990</span>,</span>
<span>               y <span class="op">=</span> <span class="fl">0</span>, yend <span class="op">=</span> <span class="fl">0</span>,</span>
<span>               linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_hue</span><span class="op">(</span>l<span class="op">=</span><span class="fl">70</span>, c<span class="op">=</span><span class="fl">60</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Sommertempratur\navvik fra 1961-1990"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span> <span class="va">.</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span>, levels <span class="op">=</span> <span class="va">regOrder</span><span class="op">)</span>,</span>
<span>              ncol<span class="op">=</span><span class="fl">3</span>,</span>
<span>              scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-83"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-83-1.png" alt="Times series for median summer temperature centered on the median value during the reference period. The reference period is indicated with a thick horizontal line. Dottet horisontal lines are 2 sd units for the reference period." width="672"><p class="caption">
Figure 21.9: Times series for median summer temperature centered on the median value during the reference period. The reference period is indicated with a thick horizontal line. Dottet horisontal lines are 2 sd units for the reference period.
</p>
</div>
<p>Then we can take the mean over the last 5 years and add to a spatial representation.</p>
<div class="sourceCode" id="cb829"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">i_aggregatedToPeriods</span> <span class="op">&lt;-</span> <span class="va">regional_means_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2018</span>, <span class="fl">2022</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2018-2022"</span>,</span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2013</span>, <span class="fl">2017</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2013-2017"</span>,</span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2008</span>, <span class="fl">2012</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2008-2012"</span>,</span>
<span>    <span class="va">year</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2003</span>, <span class="fl">2007</span><span class="op">)</span> <span class="op">~</span> <span class="st">"2003-2007"</span>,</span>
<span>    .default <span class="op">=</span> <span class="st">"pre 2003"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period_rank <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2018-2022"</span> <span class="op">~</span> <span class="fl">5</span>,</span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2013-2017"</span> <span class="op">~</span> <span class="fl">4</span>,</span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2008-2012"</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>   <span class="va">period</span> <span class="op">==</span> <span class="st">"2003-2007"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>    .default <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">period</span>, <span class="va">period_rank</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>indicator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>            spatial_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">i_sd</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">i_sd</span><span class="op">)</span></span>
<span>            <span class="co">#,</span></span>
<span>            <span class="co">#spatial_sd_mean = mean(i_sd),</span></span>
<span>            <span class="co">#spatial_sd2_max = max(i_sd),</span></span>
<span>            <span class="co">#spatial_sd2_length = length(i_sd)</span></span>
<span>            <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'region', 'period'. You</span></span>
<span><span class="co">#&gt; can override using the `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 25 × 5</span></span>
<span><span class="co">#&gt; # Groups:   region, period [25]</span></span>
<span><span class="co">#&gt;    region     period    period_rank indicator spatial_sd</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 Midt-Norge 2003-2007           2     0.427     0.101 </span></span>
<span><span class="co">#&gt;  2 Midt-Norge 2008-2012           3     0.573     0.143 </span></span>
<span><span class="co">#&gt;  3 Midt-Norge 2013-2017           4     0.536     0.0986</span></span>
<span><span class="co">#&gt;  4 Midt-Norge 2018-2022           5     0.607     0.130 </span></span>
<span><span class="co">#&gt;  5 Midt-Norge pre 2003            1     0.642     0.0277</span></span>
<span><span class="co">#&gt;  6 Nord-Norge 2003-2007           2     0.460     0.122 </span></span>
<span><span class="co">#&gt;  7 Nord-Norge 2008-2012           3     0.675     0.109 </span></span>
<span><span class="co">#&gt;  8 Nord-Norge 2013-2017           4     0.641     0.0937</span></span>
<span><span class="co">#&gt;  9 Nord-Norge 2018-2022           5     0.625     0.118 </span></span>
<span><span class="co">#&gt; 10 Nord-Norge pre 2003            1     0.625     0.0266</span></span>
<span><span class="co">#&gt; # … with 15 more rows</span></span></code></pre></div>
<div class="sourceCode" id="cb830"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">i_aggregatedToPeriods</span><span class="op">$</span><span class="va">period</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">i_aggregatedToPeriods</span><span class="op">$</span><span class="va">period_rank</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">i_aggregatedToPeriods</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">period_rank</span>, </span>
<span>             y <span class="op">=</span> <span class="va">indicator</span>,</span>
<span>             colour<span class="op">=</span><span class="va">region</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin<span class="op">=</span><span class="va">indicator</span><span class="op">-</span><span class="va">spatial_sd</span>, </span>
<span>                    ymax<span class="op">=</span><span class="va">indicator</span><span class="op">+</span><span class="va">spatial_sd</span><span class="op">)</span>, </span>
<span>                    width<span class="op">=</span><span class="fl">.2</span>,</span>
<span>                 position<span class="op">=</span><span class="fu">position_dodge</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>                     labels <span class="op">=</span> <span class="va">labs</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"indikatorverdi"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-85"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-85-1.png" alt="Scaled indicator values, aggregated over 5 year intervals. Errors represent spatial variation within regions and across years." width="672"><p class="caption">
Figure 21.10: Scaled indicator values, aggregated over 5 year intervals. Errors represent spatial variation within regions and across years.
</p>
</div>
<p>Finally, I can add these values to the sp object.</p>
<div class="sourceCode" id="cb831"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg2</span> <span class="op">&lt;-</span> <span class="va">reg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">i_aggregatedToPeriods</span><span class="op">[</span><span class="va">i_aggregatedToPeriods</span><span class="op">$</span><span class="va">period_rank</span><span class="op">==</span><span class="fl">5</span>,<span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">reg2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "id"          "region"      "GID_0"       "NAME_0"     </span></span>
<span><span class="co">#&gt; [5] "period"      "period_rank" "indicator"   "spatial_sd" </span></span>
<span><span class="co">#&gt; [9] "geometry"</span></span></code></pre></div>
<div class="sourceCode" id="cb832"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myCol</span> <span class="op">&lt;-</span> <span class="st">"RdYlGn"</span></span>
<span><span class="va">myCol2</span> <span class="op">&lt;-</span> <span class="st">"-RdYlGn"</span></span>
<span></span>
<span><span class="va">tm_main</span> <span class="op">&lt;-</span> <span class="fu">tm_shape</span><span class="op">(</span><span class="va">reg2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col<span class="op">=</span><span class="st">"indicator"</span>,</span>
<span>              title<span class="op">=</span><span class="st">"Indikator:\nsommertemperatur"</span>,</span>
<span>    palette <span class="op">=</span> <span class="va">myCol</span>,</span>
<span>    style<span class="op">=</span><span class="st">"fixed"</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">.2</span><span class="op">)</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="va">tm_inset</span> <span class="op">&lt;-</span> <span class="fu">tm_shape</span><span class="op">(</span><span class="va">reg2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col<span class="op">=</span><span class="st">"spatial_sd"</span>,</span>
<span>              title<span class="op">=</span><span class="st">"SD"</span>,</span>
<span>              palette <span class="op">=</span> <span class="va">myCol2</span>,</span>
<span>              style<span class="op">=</span><span class="st">"cont"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>legend.format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tmap_arrange</span><span class="op">(</span><span class="va">tm_main</span>, </span>
<span>             <span class="va">tm_inset</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-87"></span>
<img src="climate_indicators_explained_files/figure-html/unnamed-chunk-87-1.png" alt="Summer tempreature indicator values for five accounting areas in Norway. SD is the spatial variation." width="672"><p class="caption">
Figure 21.11: Summer tempreature indicator values for five accounting areas in Norway. SD is the spatial variation.
</p>
</div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="master-grid.html"><span class="header-section-number">20</span> Master grid</a></div>
<div class="next"><a href="oversikt-over-indikatorforslag.html"><span class="header-section-number">22</span> Oversikt over indikatorforslag</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#climate-indicators-explained"><span class="header-section-number">21</span> Climate indicators explained</a></li>
<li><a class="nav-link" href="#intro-cli"><span class="header-section-number">21.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#about-the-underlying-data-8"><span class="header-section-number">21.2</span> About the underlying data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#representativity-in-time-and-space-8"><span class="header-section-number">21.2.1</span> Representativity in time and space</a></li>
<li><a class="nav-link" href="#original-units-7"><span class="header-section-number">21.2.2</span> Original units</a></li>
<li><a class="nav-link" href="#temporal-coverage-8"><span class="header-section-number">21.2.3</span> Temporal coverage</a></li>
<li><a class="nav-link" href="#additional-comments-about-the-data-set-1"><span class="header-section-number">21.2.4</span> Additional comments about the data set</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ecosystem-characteristic-8"><span class="header-section-number">21.3</span> Ecosystem characteristic</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#norwegian-standard-5"><span class="header-section-number">21.3.1</span> Norwegian standard</a></li>
<li><a class="nav-link" href="#seea-ea-1"><span class="header-section-number">21.3.2</span> SEEA EA</a></li>
</ul>
</li>
<li><a class="nav-link" href="#collinearities-with-other-indicators-11"><span class="header-section-number">21.4</span> Collinearities with other indicators</a></li>
<li>
<a class="nav-link" href="#reference-condition-and-values-6"><span class="header-section-number">21.5</span> Reference condition and values</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#reference-condition-6"><span class="header-section-number">21.5.1</span> Reference condition</a></li>
<li><a class="nav-link" href="#ref-vals-cli"><span class="header-section-number">21.5.2</span> Reference values, thresholds for defining good ecological condition, minimum and/or maximum values</a></li>
</ul>
</li>
<li><a class="nav-link" href="#uncertainties-8"><span class="header-section-number">21.6</span> Uncertainties</a></li>
<li>
<a class="nav-link" href="#references-13"><span class="header-section-number">21.7</span> References</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#additional-resources-1"><span class="header-section-number">21.7.1</span> Additional resources</a></li></ul>
</li>
<li>
<a class="nav-link" href="#analyses-cli"><span class="header-section-number">21.8</span> Analyses</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-set-1"><span class="header-section-number">21.8.1</span> Data set</a></li>
<li><a class="nav-link" href="#conceptual-workflow-1"><span class="header-section-number">21.8.2</span> Conceptual workflow</a></li>
<li><a class="nav-link" href="#collate-variable-data-series"><span class="header-section-number">21.8.3</span> Collate variable data series</a></li>
<li><a class="nav-link" href="#filter-data-by-dates"><span class="header-section-number">21.8.4</span> Filter data by dates</a></li>
<li><a class="nav-link" href="#aggregate-across-time-within-a-year"><span class="header-section-number">21.8.5</span> Aggregate across time within a year</a></li>
<li><a class="nav-link" href="#calculate-reference-values"><span class="header-section-number">21.8.6</span> Calculate reference values</a></li>
<li><a class="nav-link" href="#normalise-variable"><span class="header-section-number">21.8.7</span> Normalise variable</a></li>
<li><a class="nav-link" href="#plot-time-series-as-line-graphs"><span class="header-section-number">21.8.8</span> Plot time series as line graphs</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/NINAnor/ecosystemCondition/blob/master/climate_indicators_explained.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/NINAnor/ecosystemCondition/edit/master/climate_indicators_explained.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Indicators for Ecosystem Condition in Norway</strong>" was written by Anders L. Kolstad. It was last built on 2023-10-23.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
