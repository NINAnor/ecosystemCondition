<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 1 Vegetation regrowth/encroachment (gjengroing) | Indicators for Ecosystem Condition in Norway</title>
<meta name="author" content="Anders L. Kolstad">
<meta name="description" content="Author and date: Zander Venter September 2023  Ecosystem Økologisk.egenskap ECT.class Våtmark og Semi-/Naturlig-åpne Gjengroing Structural state characteristic   1.1 Introduction The Norwegian...">
<meta name="generator" content="bookdown 0.34 with bs4_book()">
<meta property="og:title" content="Chapter 1 Vegetation regrowth/encroachment (gjengroing) | Indicators for Ecosystem Condition in Norway">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ninanor.github.io/ecosystemCondition/index.html/gjengroing.html">
<meta property="og:image" content="https://ninanor.github.io/ecosystemCondition/index.html/images/Picture1.png">
<meta property="og:description" content="Author and date: Zander Venter September 2023  Ecosystem Økologisk.egenskap ECT.class Våtmark og Semi-/Naturlig-åpne Gjengroing Structural state characteristic   1.1 Introduction The Norwegian...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 1 Vegetation regrowth/encroachment (gjengroing) | Indicators for Ecosystem Condition in Norway">
<meta name="twitter:description" content="Author and date: Zander Venter September 2023  Ecosystem Økologisk.egenskap ECT.class Våtmark og Semi-/Naturlig-åpne Gjengroing Structural state characteristic   1.1 Introduction The Norwegian...">
<meta name="twitter:image" content="https://ninanor.github.io/ecosystemCondition/index.html/images/Picture1.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.28/datatables.js"></script><link href="libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Indicators for Ecosystem Condition in Norway</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About </a></li>
<li><a class="" href="overview-of-indicators.html">Overview of indicators</a></li>
<li class="book-part">INDICATORS</li>
<li><a class="active" href="gjengroing.html"><span class="header-section-number">1</span> Vegetation regrowth/encroachment (gjengroing)</a></li>
<li><a class="" href="slitasje.html"><span class="header-section-number">2</span> Slitasje og kjørespor</a></li>
<li><a class="" href="median-summer-temp.html"><span class="header-section-number">3</span> Median Summer Temperature</a></li>
<li><a class="" href="alien-species.html"><span class="header-section-number">4</span> Alien species</a></li>
<li><a class="" href="Functional-plant-indicators-wetland.html"><span class="header-section-number">5</span> Functional plant indicators (Moisture, Light, pH, Nitrogen)</a></li>
<li><a class="" href="Functional-plant-indicators-seminat.html"><span class="header-section-number">6</span> Functional plant indicators, semi-natural ecosystems (Light, Moisture, pH, Nitrogen, Phosphorus, Grazing_mowing, Soil disturbance)</a></li>
<li><a class="" href="Functional-plant-indicators-open.html"><span class="header-section-number">7</span> Functional plant indicators, naturally open ecosystems below the tree line (Grime’s CSR values, Light, Nitrogen, Soil disturbance)</a></li>
<li><a class="" href="trophic-level-biomass-ratios.html"><span class="header-section-number">8</span> Trophic level biomass ratios</a></li>
<li class="book-part">INDICATORS FROM THE ALPINE ASSESSMENT</li>
<li><a class="" href="areal-av-isbreer.html"><span class="header-section-number">9</span> Areal av isbreer</a></li>
<li class="book-part">DEPRECATED</li>
<li><a class="" href="areal-uten-d%C3%B8d-eller-skadet-r%C3%B8sslyng-i-kystlynghei.html"><span class="header-section-number">10</span> Areal uten død eller skadet røsslyng i kystlynghei</a></li>
<li class="book-part">GENERAL TOPICS</li>
<li><a class="" href="naturtype.html"><span class="header-section-number">11</span> Nature types</a></li>
<li><a class="" href="scaling-functions.html"><span class="header-section-number">12</span> Scaling functions</a></li>
<li><a class="" href="homogeneous-impact-areas.html"><span class="header-section-number">13</span> Homogeneous Impact Areas</a></li>
<li><a class="" href="master-grid.html"><span class="header-section-number">14</span> Master grid</a></li>
<li><a class="" href="climate-indicators-explained.html"><span class="header-section-number">15</span> Climate indicators explained</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/NINAnor/ecosystemCondition">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="gjengroing" class="section level1" number="1">
<h1>
<span class="header-section-number">1</span> Vegetation regrowth/encroachment (gjengroing)<a class="anchor" aria-label="anchor" href="#gjengroing"><i class="fas fa-link"></i></a>
</h1>
<p><br></p>
<p><em>Author and date:</em></p>
<p>Zander Venter</p>
<p>September 2023</p>
<p><br></p>
<!-- Load all you dependencies here -->
<!-- Fill in which ecosystem the indicator belongs to, as well as the ecosystem characteristic it should be linked to. It's OK to use some Norwegian here -->
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="37%">
<col width="23%">
<col width="39%">
</colgroup>
<thead><tr class="header">
<th align="left">Ecosystem</th>
<th align="left">Økologisk.egenskap</th>
<th align="left">ECT.class</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">Våtmark og Semi-/Naturlig-åpne</td>
<td align="left">Gjengroing</td>
<td align="left">Structural state characteristic</td>
</tr></tbody>
</table></div>
<!-- Don't remove these three html lines --><p><br><br></p>
<hr>
<!-- Document you work below. Try not to change  the headers too much. Data can be stored on NINA server. Since the book is rendered on the R Server this works fine, but note that directory paths are different on the server compared to you local machine. If it is not too big you may store under /data/ on this repository --><div id="introduction" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"><i class="fas fa-link"></i></a>
</h2>
<p>The Norwegian word “gjengroing” is directly translated to “regrowing” in English. The gjengroing indicator describes the regrowth of woody vegetation (trees and bushes) in open ecosystems (wetland, semi- and naturally open areas) across Norway. We will use a spatial reference approach where reference areas define good or optimal vegetation regrowth heights.</p>
<p>The workflow spans two platforms including RStudio and Google Earth Engine (GEE). To reproduce this workflow you will need a GEE account and access to the NINA RStudio and R/GeoSpatialData servers.</p>
</div>
<div id="about-the-underlying-data" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> About the underlying data<a class="anchor" aria-label="anchor" href="#about-the-underlying-data"><i class="fas fa-link"></i></a>
</h2>
<p>We rely on the following datasets:</p>
<ul>
<li>
<a href="https://kartkatalog.miljodirektoratet.no/dataset/Details/2050">NiN polygons</a> are used to identify reference areas with good ecological condition.</li>
<li>NIBIO’s <a href="https://kartkatalog.geonorge.no/metadata/arealressurskart-fkb-ar5-arealtyper/280bbd7a-5ce9-4c83-9e15-ac162cabd8a6">AR5</a> is used as the population sample for each ecosystem type. The population sample are the areas used to determine ecological condition relative to the reference areas. We also use the AR5 data to identify forest surrounding the population polygons for defining the lower limit of ecological condition index (i.e.. poor condition),</li>
<li>LiDAR-derived digital elevation model from Kartverket’s <a href="https://hoydedata.no/LaserInnsyn/">høydedata</a>. This includes both a terrain (DTM) and surface mode (DSM). We calculate the canopy height model (DSM - DTM) to get the height of objects above the ground. From this we remove buildings, and what remains is vegetation - mostly trees but also some bushes or smaller woody plants.</li>
<li>Kartverket’s <a href="https://kartkatalog.geonorge.no/metadata/dtm-10-terrengmodell-utm32/fd851873-f363-46f9-9fc6-bb1b403575df">national 10m elevation model</a>. We use this to stratify reference (good condition) and forest (poor condition) heights by elevational band. This is done in combination with bioclimatic zones - see next point.</li>
<li>Moen’s <a href="https://artsdatabanken.no/Pages/181901/Bioklimatiske_soner">bioclimatic zones</a>. We use this to stratify reference (good condition) and forest (poor condition) heights by bioclimatic (also referred to as vegetation/climatic) zones.</li>
<li>
<a href="https://kartkatalog.geonorge.no/metadata/fkb-bygning/8b4304ea-4fb0-479c-a24d-fa225e2c6e97">FKB building footprints</a> are used to isolate vegetation in the LiDAR height data.</li>
<li>A <a href="https://www.nature.com/articles/s41893-020-00609-y">European satellite-based map</a> of forest clear cuts is used for identifying AR5 forest patches in near-climax successional stages.</li>
<li>The <a href="https://kartkatalog.geonorge.no/metadata/statistisk-rutenett-5000m/32ac0653-d95c-446c-8558-bf9b79f4934e">SSB 10km grid</a> is used for visualization purposes.</li>
<li>The regional delineation for Norway (five regions) are used for aggregating and reporting gjengroing condition values.</li>
</ul>
<div id="representativity-in-time-and-space" class="section level3" number="1.2.1">
<h3>
<span class="header-section-number">1.2.1</span> Representativity in time and space<a class="anchor" aria-label="anchor" href="#representativity-in-time-and-space"><i class="fas fa-link"></i></a>
</h3>
<p>The index will cover the mainland of Norway. The analysis will be stratified by (1) åpne and (2) våtmark ecosystems. The former includes both semi-naturlig mark and naturlig åpne områder under skoggrensa (due to the fact that AR5 does not differentiate these), and the latter includes våtmark only. The LiDAR data cover a range of years and therefore the indicator represents conditions for circa 2010 to 2021.</p>
</div>
<div id="original-units" class="section level3" number="1.2.2">
<h3>
<span class="header-section-number">1.2.2</span> Original units<a class="anchor" aria-label="anchor" href="#original-units"><i class="fas fa-link"></i></a>
</h3>
<p>The original units for ecological condition are meters. This is the height of the vegetation within referecne, polygon and forest areas.</p>
</div>
<div id="temporal-coverage" class="section level3" number="1.2.3">
<h3>
<span class="header-section-number">1.2.3</span> Temporal coverage<a class="anchor" aria-label="anchor" href="#temporal-coverage"><i class="fas fa-link"></i></a>
</h3>
<p>Circa 2010 to 2021. This is a single snapshot and not a change analysis. In the future, when LiDAR data has been repeated across the country, it may be possible to do a change assessment. In addition, the use of optical or radar satellite imagery may serve as a proxy for vegetation height using machine learning. This will allow for annual updates, depending on the uncertainty in the satellite-based maps of vegetation height.</p>
</div>
<div id="additional-comments-about-the-dataset" class="section level3" number="1.2.4">
<h3>
<span class="header-section-number">1.2.4</span> Additional comments about the dataset<a class="anchor" aria-label="anchor" href="#additional-comments-about-the-dataset"><i class="fas fa-link"></i></a>
</h3>
<p>None.</p>
</div>
</div>
<div id="ecosystem-characteristic" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Ecosystem characteristic<a class="anchor" aria-label="anchor" href="#ecosystem-characteristic"><i class="fas fa-link"></i></a>
</h2>
<div id="norwegian-standard" class="section level3" number="1.3.1">
<h3>
<span class="header-section-number">1.3.1</span> Norwegian standard<a class="anchor" aria-label="anchor" href="#norwegian-standard"><i class="fas fa-link"></i></a>
</h3>
<p>Not sure what this means??</p>
</div>
</div>
<div id="collinearities-with-other-indicators" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Collinearities with other indicators<a class="anchor" aria-label="anchor" href="#collinearities-with-other-indicators"><i class="fas fa-link"></i></a>
</h2>
<p>There is possibly a collinearity with the primary production indicator (primærproduksjon). The primary production indicator uses the normalized difference vegetation index (NDVI) as a proxy for vegetation production. NDVI can be correlated with vegetation height and consequently yield similar results to the LiDAR-based gjengroing indicator.</p>
</div>
<div id="reference-state-and-values" class="section level2" number="1.5">
<h2>
<span class="header-section-number">1.5</span> Reference state and values<a class="anchor" aria-label="anchor" href="#reference-state-and-values"><i class="fas fa-link"></i></a>
</h2>
<p>The methodology used to calculate the gjengroing indicator is outlined in the schematic below. The workflow in the schematic is conducted for all reference and population polygons in Norway and repeated for each ecosystem type (åpne and våtmark), respectively. The indicator values are aggregated to a 50km grid and regional level at the end. The individual steps are discussed in turn in the following subsections.</p>
<div class="inline-figure"><img src="images/gjengroing_schematic.jpg" style="width:70.0%"></div>
<div id="reference-state" class="section level3" number="1.5.1">
<h3>
<span class="header-section-number">1.5.1</span> Reference state<a class="anchor" aria-label="anchor" href="#reference-state"><i class="fas fa-link"></i></a>
</h3>
<p>The NiN polygons including “Naturlig åpne områder under skoggrensa”, “Semi-naturlig mark”, and “Våtmark” with good ecological condition are used to define a reference gjengroing state. We use the all-encompassing “Tilstand” variable assigned to each NiN polygon. The 50th percentile of LiDAR-derived vegetation heights within these polygons is used to define the upper limit (ie. 1) of the scaled indicator value. We cannot define local reference values based on proximity, because the NiN polygons are spatially biased and not close to all AR5 population polygons. Therefore we calculate regional reference values using elevation (300m bands) and bioclimatic zones as stratification. We calculate the mean reference value for each unique combination of elevation-bioclimatic zone. When calculating the index for each population polygon, the reference value is inherited from the elevation-bioclimatic zone it falls within.</p>
</div>
<div id="reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values" class="section level3" number="1.5.2">
<h3>
<span class="header-section-number">1.5.2</span> Reference values, thresholds for defining <em>good ecological condition</em>, minimum and/or maximum values<a class="anchor" aria-label="anchor" href="#reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values"><i class="fas fa-link"></i></a>
</h3>
<p>Once we have the reference vegetation height for a given ecosystem type and elevation-bioclimatic zone, we need to define the minimum (or worst/bad) condition. We use the 50th percentile of LiDAR-derived vegetation heights within AR5 skog polygons to define a climax vegetation successional stage where gjengroing is at its most extreme. In order not to include forest patches that have recently been harvested, we mask out any forest which has been clear-cut since 1986. Here, 1986 is a hard limit defined by the clear-cut dataset which was based on Landsat imagery. Therefore we can be assured that we are measuring forest that is at least 35 years old.</p>
<p>We use both local and regional “reference” approaches to defining poor ecological condition. To do this we calculate the forest heights in AR5 forest patches that fall within 200m of a population polygon (local reference). For population polygons that do not have forest within their proximity, we use the mean forest height within the unique elevation-bioblimatic zone the population falls within (regional reference).</p>
<p>To define the ecological condition of the population polygon, we measure 50th percentile of LiDAR-derived vegetation height. As a reminder, we use AR5 polygons that have types that are approximately compatible with the NiN ecosystem types. For våtmark we use the AR5 polygons defined as “Myr”. For åpne ecosystems we use the AR5 polygons defined as either “Åpent fastmark” or “Innmarksbeite”.</p>
<p>The vegetation height percentiles are then scaled to between 0 and 1 using a sigmoid transformation <a href="https://www.sciencedirect.com/science/article/pii/S1470160X21000066">Oliver at al. (2021)</a>.</p>
</div>
</div>
<div id="uncertainties" class="section level2" number="1.6">
<h2>
<span class="header-section-number">1.6</span> Uncertainties<a class="anchor" aria-label="anchor" href="#uncertainties"><i class="fas fa-link"></i></a>
</h2>
<p>For the indicator map at the polygon level there is no uncertainty associated with the indicator values. For aggregated indicator values (e.g. for 50km grid and regions), the uncertainty in the indicator value is calculated from the spatial variation in the polygon-level reference height values. We could use the alternative of calculating the spatial variation in the indicator values via bootstrapping using the EAtools package. However, given the extreme number of population polygons, the uncertainty values are extremely small and therefore we choose to use the standard deviation in reference vegetation heights, converted to the indicator scale.</p>
</div>
<div id="references" class="section level2" number="1.7">
<h2>
<span class="header-section-number">1.7</span> References<a class="anchor" aria-label="anchor" href="#references"><i class="fas fa-link"></i></a>
</h2>
<p>Links to data and resources are provided with hyperlinks in-line.</p>
</div>
<div id="analyses" class="section level2" number="1.8">
<h2>
<span class="header-section-number">1.8</span> Analyses<a class="anchor" aria-label="anchor" href="#analyses"><i class="fas fa-link"></i></a>
</h2>
<div id="data-sets" class="section level3" number="1.8.1">
<h3>
<span class="header-section-number">1.8.1</span> Data sets<a class="anchor" aria-label="anchor" href="#data-sets"><i class="fas fa-link"></i></a>
</h3>
<p>There are several datasets which are used in GEE which will not be imported into the R session here. These datasets have been obtained from the source and ingested into GEE by Zander Venter or Vegard Bakkestuen with the help of Miljædata section at NINA. They include</p>
<ul>
<li><a href="https://kartkatalog.geonorge.no/metadata/arealressurskart-fkb-ar5-arealtyper/280bbd7a-5ce9-4c83-9e15-ac162cabd8a6">AR5</a></li>
<li>
<a href="https://hoydedata.no/LaserInnsyn/">LiDAR-derived digital elevation model from høydedata</a>.</li>
<li><a href="https://kartkatalog.geonorge.no/metadata/dtm-10-terrengmodell-utm32/fd851873-f363-46f9-9fc6-bb1b403575df">Kartverket’s national 10m elevation model</a></li>
<li><a href="https://kartkatalog.geonorge.no/metadata/fkb-bygning/8b4304ea-4fb0-479c-a24d-fa225e2c6e97">FKB building footprints</a></li>
<li><a href="https://www.nature.com/articles/s41893-020-00609-y">European forest clear-cut map</a></li>
</ul>
<p>The remaining datasets will be imported into the R session.</p>
<div id="regions" class="section level4" number="1.8.1.1">
<h4>
<span class="header-section-number">1.8.1.1</span> Regions<a class="anchor" aria-label="anchor" href="#regions"><i class="fas fa-link"></i></a>
</h4>
<p>The regional delineation for Norway (five regions) are used for aggregating and reporting gjengroing condition values.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/regions.shp'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `regions' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/regions.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co"># Rename regions with correct Norwegian characters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">regions</span><span class="op">$</span><span class="va">region</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Østlandet"</span>, <span class="st">"Midt-Norge"</span>,<span class="st">"Nord-Norge"</span>,<span class="st">"Sørlandet"</span>,<span class="st">"Vestlandet"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="ssb-10-and-50km-grids" class="section level4" number="1.8.1.2">
<h4>
<span class="header-section-number">1.8.1.2</span> SSB 10 and 50km grids<a class="anchor" aria-label="anchor" href="#ssb-10-and-50km-grids"><i class="fas fa-link"></i></a>
</h4>
<p>The <a href="https://kartkatalog.geonorge.no/metadata/statistisk-rutenett-5000m/32ac0653-d95c-446c-8558-bf9b79f4934e">SSB 10km and 50km grids</a> are used for visualizing the distribution of available data and for aggregating gjengroing index scores.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ssb10km</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_10km/ssb10km.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="co"># mutate the id value so that it aligns with the data coming from GEE</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>SSBID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `ssb10km' from data source </span></span>
<span><span class="co">#&gt;   `/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_10km/ssb10km.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 4218 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -80000 ymin: 6440000 xmax: 1120000 ymax: 7940000</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 33N</span></span>
<span><span class="co"># Transform to the correct projection</span></span>
<span><span class="va">ssb10km</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">ssb10km</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ssb50km</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_50km/ssb50km.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="co"># mutate the id value so that it aligns with the data coming from GEE</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>SSBID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `ssb50km' from data source </span></span>
<span><span class="co">#&gt;   `/data/R/GeoSpatialData/Population_demography/Norway_SSB/Original/ssb_50km/ssb50km.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 273 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -150000 ymin: 6400000 xmax: 1150000 ymax: 8e+06</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 33N</span></span>
<span><span class="co"># Transform to the correct projection</span></span>
<span><span class="va">ssb50km</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">ssb50km</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="bioclimatic-regions" class="section level4" number="1.8.1.3">
<h4>
<span class="header-section-number">1.8.1.3</span> Bioclimatic regions<a class="anchor" aria-label="anchor" href="#bioclimatic-regions"><i class="fas fa-link"></i></a>
</h4>
<p>The Moen’s bioclimatic regions are imported from NINA R/GeoSpatialData/ server.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bioclim</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/BiogeographicalRegions/Norway_VegetationZones_Moen/Original/Vector/soner.shp'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>NAVN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">NAVN</span> <span class="op">==</span> <span class="st">'S°rboreal'</span>, <span class="st">'Sørboreal'</span>, <span class="va">NAVN</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `soner' from data source </span></span>
<span><span class="co">#&gt;   `/data/R/GeoSpatialData/BiogeographicalRegions/Norway_VegetationZones_Moen/Original/Vector/soner.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 3050 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -75844 ymin: 6449504 xmax: 1114610 ymax: 7939790</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 33N</span></span>
<span><span class="va">bioclim</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">bioclim</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="nin-polygons" class="section level4" number="1.8.1.4">
<h4>
<span class="header-section-number">1.8.1.4</span> NiN polygons<a class="anchor" aria-label="anchor" href="#nin-polygons"><i class="fas fa-link"></i></a>
</h4>
<p><a href="https://kartkatalog.miljodirektoratet.no/dataset/Details/2050">NiN polygons</a> are imported here from the NINA servers:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nin</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/R/GeoSpatialData/Habitats_biotopes/Norway_Miljodirektoratet_Naturtyper_nin/Original/versjon20221231/Natur_Naturtyper_NiN_norge_med_svalbard_25833/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="co"># Simplify ecosystem names</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>hovedøkosystem <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">hovedøkosystem</span>, </span>
<span>                                 <span class="st">"Våtmark"</span> <span class="op">=</span> <span class="st">'Våtmark'</span>,</span>
<span>                                 <span class="st">"Skog"</span> <span class="op">=</span> <span class="st">"Skog"</span>,</span>
<span>                                 <span class="st">"Ingen"</span> <span class="op">=</span> <span class="st">"Ingen"</span>,</span>
<span>                                 <span class="st">"Fjell"</span> <span class="op">=</span> <span class="st">"Fjell"</span>,</span>
<span>                                 <span class="st">"Semi-naturlig mark"</span> <span class="op">=</span> <span class="st">'Semi-naturlig'</span>,</span>
<span>                                 <span class="st">"Naturlig åpne områder i lavlandet"</span> <span class="op">=</span> <span class="st">'Naturlig åpne'</span>,</span>
<span>                                 <span class="st">"Naturlig åpne områder under skoggrensa"</span> <span class="op">=</span> <span class="st">'Naturlig åpne'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Fix any invalid geometries</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>validGeo <span class="op">=</span> <span class="fu">st_is_valid</span><span class="op">(</span><span class="va">SHAPE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">validGeo</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Filter out the ecosystems we are not interested in</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">hovedøkosystem</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Skog'</span>,<span class="st">'Ingen'</span>,<span class="st">'Fjell'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Get the main ecosystem codes in case we need them later</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>hovedtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">ninkartleggingsenheter</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>         hovedtype <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">hovedtype</span>, <span class="st">'-'</span><span class="op">)</span>,</span>
<span>         id <span class="op">=</span> <span class="va">identifikasjon_lokalid</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Drop polygons with no condition score</span></span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">tilstand</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">hovedøkosystem</span>, <span class="va">hovedtype</span>, <span class="va">naturtypekode</span>, <span class="va">tilstand</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `Naturtyper_NiN_norge_med_svalbard' from data source `/data/R/GeoSpatialData/Habitats_biotopes/Norway_Miljodirektoratet_Naturtyper_nin/Original/versjon20221231/Natur_Naturtyper_NiN_norge_med_svalbard_25833/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb' </span></span>
<span><span class="co">#&gt;   using driver `OpenFileGDB'</span></span>
<span><span class="co">#&gt; Simple feature collection with 95469 features and 35 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -74953.5 ymin: 6448986 xmax: 1075080 ymax: 7921283</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<ul>
<li><strong>Export the cleaned NiN data and upload to GEE before proceeding</strong></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Only run if you are repeating this workflow for the first time</span></span>
<span><span class="co"># nin %&gt;%</span></span>
<span><span class="co">#   dplyr::select(id, hovedøkosystem, tilstand) %&gt;%</span></span>
<span><span class="co">#   st_transform(st_crs(fylker_wgs84)) %&gt;%</span></span>
<span><span class="co">#   st_write('nin_cleaned.shp', append=FALSE)</span></span></code></pre></div>
<ul>
<li>
<strong>Now run the following GEE JavaScript code by clicking on the hyperlink:</strong> <a href="https://code.earthengine.google.com/b2d06ad72c515fbbb3024f157987eedc">GEE script</a> This script is also found in the SCR repository as “GEE_script.js”. When you run the script, then click the Tasks tab in the GEE code editor and run the export tasks. The export files will appear in your Google Drive. Download the files from your Google Drive to the /data/gjengroing/From_GEE directory. This script extracts three CSV files:
<ul>
<li>‘area_cover_grid.csv’ - this gives the area coverage of NiN, AR5 and LiDAR data for each 10x10km SSB grid cell.</li>
<li>‘elevation_stratified.shp’ - this is a 300m elevation band stratification that is simply used for visualizing the strata here in R.</li>
<li>‘vegHeights.zip’ - this is a folder with hundreds of CSV files. These files contain the vegetation heights for reference, population, and forest polygons over Norway. The exports were split by 50km grid to prevent hitting user memory limits in GEE. Unzip the folder before you upload to ./DATA/From_GEE/</li>
</ul>
</li>
</ul>
</div>
<div id="data-from-google-earth-engine" class="section level4" number="1.8.1.5">
<h4>
<span class="header-section-number">1.8.1.5</span> Data from Google Earth Engine<a class="anchor" aria-label="anchor" href="#data-from-google-earth-engine"><i class="fas fa-link"></i></a>
</h4>
<p>Once you have run the GEE script above, and downloaded the data to the /data/gjengroing/From_GEE directory, you can proceed with this R workflow.</p>
<p>Create functions to import vegetation height files and stratify data by elevation band and vegetation/climate zone</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to read in multiple files resulting from GEE exports</span></span>
<span><span class="va">readVegHeightFiles</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">uniqueString</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dir</span> <span class="op">&lt;-</span> <span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/vegHeights/'</span></span>
<span>  <span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">[</span><span class="fu">str_detect</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, <span class="va">uniqueString</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="co">#print(files)</span></span>
<span>  </span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">files</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>                  <span class="fu">mutate</span><span class="op">(</span>ssbid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu">str_split</span><span class="op">(</span><span class="va">i</span>, <span class="st">'_'</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">1</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Vegetation type lookup</span></span>
<span><span class="va">vegLookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  vegClimZone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span>, </span>
<span>  vegClimZoneLab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Nemoral'</span>,<span class="st">'Boreonemoral'</span>,<span class="st">'Sørboreal'</span>,<span class="st">'Mellomboreal'</span>,<span class="st">'Nordboreal'</span>,<span class="st">'Alpin'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Elevation stratification and vegetation type cleaning function</span></span>
<span><span class="va">cleanElevVegType</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">dataOut</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>e <span class="op">=</span> <span class="va">elevation</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>elevation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&lt;</span> <span class="fl">300</span>, <span class="st">'0-300'</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&gt;</span> <span class="fl">300</span> <span class="op">&amp;</span> <span class="va">e</span> <span class="op">&lt;</span> <span class="fl">600</span>, <span class="st">'300-600'</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&gt;</span> <span class="fl">600</span> <span class="op">&amp;</span> <span class="va">e</span> <span class="op">&lt;</span> <span class="fl">900</span>, <span class="st">'600-900'</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&gt;</span> <span class="fl">900</span> <span class="op">&amp;</span> <span class="va">e</span> <span class="op">&lt;</span> <span class="fl">1200</span>, <span class="st">'900-1200'</span>, <span class="st">'&gt;1200'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>vegClimZone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">vegClimZone</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vegLookup</span>, by <span class="op">=</span> <span class="st">'vegClimZone'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">e</span>, <span class="op">-</span><span class="va">vegClimZone</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">vegClimZoneLab</span>, <span class="va">elevation</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">dataOut</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>Import the CSV files generated in GEE related to area covers and elevation bands:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import data coverages per SSB 10km grid cell</span></span>
<span><span class="va">areaCovers</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/area_cover_grid.csv'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="st">'system:index'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate percentage cover relative to the land area in each cell</span></span>
<span><span class="va">areaCoversPerc</span> <span class="op">&lt;-</span> <span class="va">areaCovers</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">gather</span><span class="op">(</span><span class="va">key</span>, <span class="va">val</span>, <span class="va">aapne_ar5</span>, <span class="va">vaatmark_ar5</span>,<span class="va">aapne_nin</span>, <span class="va">vaatmark_nin</span>, <span class="va">lidarCover</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'ar5'</span><span class="op">)</span>, <span class="st">'ar5'</span>, </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'nin'</span><span class="op">)</span>, <span class="st">'nin'</span>, </span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="st">'lidarCover'</span>, <span class="st">'lidar'</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ecosystem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'aapne'</span><span class="op">)</span>, <span class="st">'Semi-/Naturlig åpne'</span>, </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">key</span>, <span class="st">'vaatmark'</span><span class="op">)</span>, <span class="st">'Våtmark'</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="va">val</span><span class="op">/</span><span class="va">land</span><span class="op">*</span><span class="fl">100</span>,</span>
<span>         areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">areaPerc</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">areaPerc</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">SSBID</span>, <span class="va">key</span>, <span class="va">type</span>,<span class="va">ecosystem</span>, <span class="va">areaPerc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">elevStrata</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/elevation_stratified.shp'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>elevBand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">'0-300'</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">2</span>, <span class="st">'300-600'</span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">3</span>, <span class="st">'600-900'</span>,</span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="fl">4</span>, <span class="st">'900-1200'</span>, <span class="st">'&gt;1200'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         elevBand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">elevBand</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'0-300'</span>,<span class="st">'300-600'</span>,<span class="st">'600-900'</span>,<span class="st">'900-1200'</span>,<span class="st">'&gt;1200'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `elevation_stratified' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/From_GEE/elevation_stratified.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 10293 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4.078351 ymin: 57.8515 xmax: 31.78239 ymax: 71.29928</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="va">elevStrata</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">elevStrata</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Import the CSV files generated in GEE of vegetation heights (circa 15 min runtime):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Import median LiDAR heights for NiN polygons</span></span>
<span>  <span class="va">refVaatmarkRaw</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'vaatmark_ref'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ref <span class="op">=</span> <span class="va">chm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="st">'system:index'</span>, <span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  <span class="va">refAapneRaw</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'aapne_ref'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ref <span class="op">=</span> <span class="va">chm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="st">'system:index'</span>, <span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add elevation and veg/clim zones and summarise per strata</span></span>
<span>    <span class="co"># this will form the upper limit of the ecological condition score (ie. good condition)</span></span>
<span>  <span class="va">refVaatmark</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">refVaatmarkRaw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">refAapne</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">refAapneRaw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Export to file for reference</span></span>
<span>  <span class="va">refVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refVaatmark.csv'</span><span class="op">)</span></span>
<span>  <span class="va">refAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refAapne.csv'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Import median LiDAR heights for AR5 polygons for population measurement</span></span>
<span>  <span class="va">popVaatmarkHt</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'vaatmark_pop'</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  <span class="va">popAapneHt</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'aapne_pop'</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Turn into spatial objects using the .geo column in the CSV</span></span>
<span>  <span class="va">popVaatmarkHt</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu">bind_cols</span><span class="op">(</span><span class="va">popVaatmarkHt</span>,<span class="fu">geojsonsf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span><span class="op">(</span><span class="va">popVaatmarkHt</span><span class="op">$</span><span class="va">.geo</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">popAapneHt</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu">bind_cols</span><span class="op">(</span><span class="va">popAapneHt</span>,<span class="fu">geojsonsf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span><span class="op">(</span><span class="va">popAapneHt</span><span class="op">$</span><span class="va">.geo</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Import median LiDAR heights for forest (skog) within 200m of population polygons</span></span>
<span>    <span class="co"># this will form the lower limit of the ecological condition score (ie. poor condition)</span></span>
<span>  <span class="va">popVaatmarkSkog</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'vaatmark_skog'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span>, <span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="va">ssbid</span><span class="op">)</span></span>
<span>  <span class="va">popAapneSkog</span> <span class="op">&lt;-</span> <span class="fu">readVegHeightFiles</span><span class="op">(</span><span class="st">'aapne_skog'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="va">chm</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">chm</span>, <span class="op">-</span><span class="st">'.geo'</span>, <span class="op">-</span><span class="va">ssbid</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Combine the population heights with the forest heights</span></span>
<span>  <span class="va">popVaatmark</span> <span class="op">&lt;-</span> <span class="va">popVaatmarkHt</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popVaatmarkSkog</span>, by <span class="op">=</span> <span class="st">'system:index'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span><span class="op">)</span></span>
<span>  <span class="va">popAapne</span> <span class="op">&lt;-</span> <span class="va">popAapneHt</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popAapneSkog</span>, by <span class="op">=</span> <span class="st">'system:index'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">'.geo'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add elevation and veg/clim zones to the combined population and forest heights</span></span>
<span>  <span class="va">popVaatmark</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">popVaatmark</span><span class="op">)</span></span>
<span>  <span class="va">popAapne</span> <span class="op">&lt;-</span> <span class="fu">cleanElevVegType</span><span class="op">(</span><span class="va">popAapne</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Get regional reference values for forest height</span></span>
<span>    <span class="co"># this is to fill in for population polygons which did not have any forest within 200m</span></span>
<span>  <span class="va">vaatmarkSkogRegionalRef</span> <span class="op">&lt;-</span> <span class="va">popVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>skogFill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">skogFill</span><span class="op">)</span></span>
<span>  <span class="va">aapneSkogRegionalRef</span> <span class="op">&lt;-</span> <span class="va">popAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>skogFill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">skogFill</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Combine all the above into one data frame</span></span>
<span>  <span class="co">#set.seed(123)</span></span>
<span>  <span class="va">vaatmarkHts</span> <span class="op">&lt;-</span> <span class="va">popVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#sample_n(100000) %&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">refVaatmark</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span>, <span class="va">elevation</span>, <span class="va">vegClimZoneLab</span>, <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>values_from <span class="op">=</span> <span class="va">height</span>, names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># If population height is less than the reference value, then it is automatically "good" condition - ie. it inherits the reference height so that the rescaled value will be 1</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">pop</span> <span class="op">&lt;</span> <span class="va">ref</span>, <span class="va">ref</span>, <span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkSkogRegionalRef</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>, <span class="va">skogFill</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">skogFill</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">skog</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="co">#colSums(is.na(vaatmarkHts))</span></span>
<span>  </span>
<span>  <span class="va">aapneHts</span> <span class="op">&lt;-</span> <span class="va">popAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#sample_n(100000) %&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">refAapne</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span>, <span class="va">elevation</span>, <span class="va">vegClimZoneLab</span>, <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>values_from <span class="op">=</span> <span class="va">height</span>, names_from <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># If population height is less than the reference value, then it is automatically "good" condition - ie. it inherits the reference height so that the rescaled index will be 1</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">pop</span> <span class="op">&lt;</span> <span class="va">ref</span>, <span class="va">ref</span>, <span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneSkogRegionalRef</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'vegClimZoneLab'</span>, <span class="st">'elevation'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>skog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>, <span class="va">skogFill</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">skogFill</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">skog</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="co">#colSums(is.na(aapneHts))</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">refVaatmark</span>  <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refVaatmark.csv'</span><span class="op">)</span></span>
<span>  <span class="va">refAapne</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/refAapne.csv'</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div id="explore-data-coverages" class="section level3" number="1.8.2">
<h3>
<span class="header-section-number">1.8.2</span> Explore data coverages<a class="anchor" aria-label="anchor" href="#explore-data-coverages"><i class="fas fa-link"></i></a>
</h3>
<p>Here we will make maps of NiN, AR5 and LiDAR coverage over Norway to get a feel for the data distributions. These areas were calculated in GEE and exported to CSV in the GEE script provided above. All we need to do now is join them with the SSB 10km grid and visualize.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">c1</span> <span class="op">&lt;-</span> <span class="va">ssb10km</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">areaCoversPerc</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'nin'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">group_by</span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">summarise</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">areaPerc</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">areaPerc</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#e6bf6b'</span>, <span class="st">'#91b5a2'</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'% cover'</span>,</span>
<span>                       limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                       oob<span class="op">=</span><span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'A) NiN polygons with good condition'</span><span class="op">)</span></span>
<span><span class="co">#c1</span></span>
<span><span class="va">c2</span> <span class="op">&lt;-</span> <span class="va">ssb10km</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">areaCoversPerc</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'ar5'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">group_by</span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">summarise</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">areaPerc</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">areaPerc</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#e6bf6b'</span>, <span class="st">'#91b5a2'</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'% cover'</span>,</span>
<span>                       limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>                       oob<span class="op">=</span><span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'B) AR5 polygons'</span><span class="op">)</span></span>
<span><span class="co">#c2</span></span>
<span><span class="va">c3</span> <span class="op">&lt;-</span> <span class="va">ssb10km</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">areaCoversPerc</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'lidar'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">group_by</span><span class="op">(</span><span class="va">SSBID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>              <span class="fu">summarise</span><span class="op">(</span>areaPerc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">areaPerc</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">areaPerc</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#e6bf6b'</span>, <span class="st">'#91b5a2'</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'% cover'</span>,</span>
<span>                       limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>                       oob<span class="op">=</span><span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'C) LiDAR canopy height model'</span><span class="op">)</span></span>
<span><span class="co">#c3</span></span>
<span></span>
<span><span class="va">coverageFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">c1</span>, <span class="va">c2</span>, <span class="va">c3</span>, ncol<span class="op">=</span><span class="fl">3</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-11-1.png" width="1440"></div>
</div>
<div id="bioclimatic-zone-and-elevation-strata-for-regional-reference-values" class="section level3" number="1.8.3">
<h3>
<span class="header-section-number">1.8.3</span> Bioclimatic zone and elevation strata for regional reference values<a class="anchor" aria-label="anchor" href="#bioclimatic-zone-and-elevation-strata-for-regional-reference-values"><i class="fas fa-link"></i></a>
</h3>
<p>We will visualize the elevation bands and bioclimatic zones that are used to define regional reference values for poor (forest vegetation height) and good (NiN vegetation height) ecological condition. For each unique spatial combination of these strata (n = 21), we calculate a mean reference value later on in the analysis. Note that poor ecological condition is preferably calculated using a local reference (forest height within 200m of population polygon), but a regional reference is used where there are no nearby forest patches.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">bioclimPlot</span> <span class="op">&lt;-</span> <span class="va">bioclim</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NAVN</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Paired'</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">'Zone'</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'A) Bioclimatic zones'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">elevPlot</span> <span class="op">&lt;-</span> <span class="va">elevStrata</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">elevBand</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.001</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">5</span>, <span class="st">'Pastel1'</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">'HASL (M)'</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'B) Elevation bands'</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">strataPlot</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">bioclimPlot</span>, <span class="va">elevPlot</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-12-1.png" width="672"></div>
<p>We can see that while AR5 polygons are well distributed across the country, the NiN polygons are clustered and biased toward low elevation regions of the country. The LiDAR data covers nearly the entire country with some exceptions in the north. Future iterations of this work will need to attempt to quantify the biases introduced by the relative distributions of reference and population polygons and by the datasets used to quantify gjengroing (in this case LiDAR).</p>
</div>
<div id="scaled-indicator-values-at-polygon-level-circa-120-min-runtime" class="section level3" number="1.8.4">
<h3>
<span class="header-section-number">1.8.4</span> Scaled indicator values at polygon level (circa 120 min runtime)<a class="anchor" aria-label="anchor" href="#scaled-indicator-values-at-polygon-level-circa-120-min-runtime"><i class="fas fa-link"></i></a>
</h3>
<p>We will calculate the gjengroing index for each population polygon over Norway using a Sigmoid scaling function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Define Sigmoid scaling function</span></span>
<span><span class="va">scaleSigmoid</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">refLow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span></span>
<span>  <span class="va">refHigh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span></span>
<span>  <span class="va">thr</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">refHigh</span><span class="op">-</span><span class="va">refLow</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="va">indicator_LowHigh</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">variable</span> <span class="op">-</span> <span class="va">refLow</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">refHigh</span> <span class="op">-</span> <span class="va">refLow</span><span class="op">)</span></span>
<span>  <span class="va">indicator_LowHigh</span><span class="op">[</span><span class="va">indicator_LowHigh</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">indicator_LowHigh</span><span class="op">[</span><span class="va">indicator_LowHigh</span><span class="op">[</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">indicator_sigmoid</span> <span class="op">&lt;-</span> <span class="fl">100.68</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span><span class="op">*</span><span class="op">(</span><span class="va">indicator_LowHigh</span><span class="op">)</span><span class="op">^</span><span class="fl">2.5</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">indicator_sigmoid</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Calcualte gjengroing index values</span></span>
<span>  <span class="va">vaatmarkIndexPoly</span> <span class="op">&lt;-</span> <span class="va">vaatmarkHts</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Gather into long format so taht we can mutate the scaleSigmoid() function</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fu">scaleSigmoid</span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Because short vegetation is good condition, we must invert the scaled indicator</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Get the indicator values for the population polygons only (ref and skog will be 1 and 0)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'pop'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">type</span>, <span class="op">-</span><span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Join with original data to get the actual median vegetaiton heights for each indicator score</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkHts</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popVaatmark</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">ssbid</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># do the same for åpne polygons - will not comment this because same as above</span></span>
<span>  <span class="va">aapneIndexPoly</span> <span class="op">&lt;-</span> <span class="va">aapneHts</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="va">type</span>, <span class="va">height</span>, <span class="va">ref</span>, <span class="va">pop</span>, <span class="va">skog</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">`system:index`</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fu">scaleSigmoid</span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'pop'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">type</span>, <span class="op">-</span><span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneHts</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">popAapne</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span>, <span class="va">ssbid</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Make into spatial objects</span></span>
<span>  <span class="va">vaatmarkIndexPolySpat</span> <span class="op">&lt;-</span> <span class="va">popVaatmark</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkIndexPoly</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">&lt;-</span> <span class="va">popAapne</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"system:index"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneIndexPoly</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Transform to correct projection</span></span>
<span>  <span class="va">vaatmarkIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">vaatmarkIndexPolySpat</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">aapneIndexPolySpat</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">regions</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>`system:index` <span class="op">=</span> <span class="va">id</span>,</span>
<span>           elevation <span class="op">=</span> <span class="va">elev</span>, </span>
<span>           vegClimZoneLab <span class="op">=</span> <span class="va">vegZn</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">elev</span>, <span class="op">-</span><span class="va">vegZn</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index.shp'</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>`system:index` <span class="op">=</span> <span class="va">id</span>,</span>
<span>           elevation <span class="op">=</span> <span class="va">elev</span>, </span>
<span>           vegClimZoneLab <span class="op">=</span> <span class="va">vegZn</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, <span class="op">-</span><span class="va">elev</span>, <span class="op">-</span><span class="va">vegZn</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Reading layer `vaatmark_index' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 1069897 features and 8 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -75794.71 ymin: 6449710 xmax: 1108262 ymax: 7939216</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#&gt; Reading layer `aapne_index' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 1763446 features and 8 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -76208.98 ymin: 6448886 xmax: 1108352 ymax: 7939986</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Here we will visualize the spatial variation in scaled gjengroind indicator values, as well as the vegetation heights for reference (good condition), indicator, and mature forest (poor condition) over the country. We could plot all the polygons, but it is computationally intensive and very difficult to visualize spatial variations over the entire country. Therefore we will calculate the area-weighted mean in values for each bioclimatic-elevation strata (n = 21) over the country.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Create intersection of the two strata layers</span></span>
<span><span class="co">#elevStrata &lt;- st_transform(elevStrata, st_crs(regions))</span></span>
<span><span class="va">bioClimElev</span> <span class="op">&lt;-</span> <span class="va">bioclim</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">elevStrata</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>elevation <span class="op">=</span> <span class="va">elevBand</span>,</span>
<span>         vegClimZoneLab <span class="op">=</span> <span class="va">NAVN</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">elevation</span>, <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rowid_to_column</span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Get area-weighted mean for reference, forest and population vegetation heights </span></span>
<span>  <span class="co"># for each unique bioclimatic-elevation zone combination</span></span>
<span>  <span class="va">vaatmarkIndexStrata</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="co">#sample_n(10000) %&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">vaatmarkIndexPolySpat</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">st_area</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> ,<span class="va">st_intersects</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise_at</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span>, <span class="va">index</span><span class="op">)</span>, <span class="fu">funs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">.</span>, w<span class="op">=</span><span class="va">area</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span> </span>
<span>                <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">aapneIndexStrata</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="co">#sample_n(10000) %&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">aapneIndexPolySpat</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">st_area</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> ,<span class="va">st_intersects</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise_at</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">pop</span>, <span class="va">ref</span>, <span class="va">skog</span>, <span class="va">index</span><span class="op">)</span>, <span class="fu">funs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">.</span>, w<span class="op">=</span><span class="va">area</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span> </span>
<span>                <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Write out for import later</span></span>
<span>  <span class="va">vaatmarkIndexStrata</span> <span class="op">%&gt;%</span> <span class="fu">write_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/vaatmarkIndexStrata.csv'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexStrata</span> <span class="op">%&gt;%</span> <span class="fu">write_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/aapneIndexStrata.csv'</span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexStrata</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/vaatmarkIndexStrata.csv'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexStrata</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/DATA/aapneIndexStrata.csv'</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Make plots of indicator heights and scaled condition values for each strata polygon</span></span>
<span></span>
<span><span class="va">theme_legend_1</span> <span class="op">&lt;-</span> <span class="fu">theme</span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>, <span class="co">#change legend key size</span></span>
<span>                        legend.key.height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>, <span class="co">#change legend key height</span></span>
<span>                        legend.key.width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>, <span class="co">#change legend key width</span></span>
<span>                        legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span><span class="op">)</span>, <span class="co">#change legend title font size</span></span>
<span>                        legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="co">#change legend text font size</span></span>
<span></span>
<span><span class="va">makeStrataHeightMap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span>, <span class="va">title</span>, <span class="va">limits</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ID'</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>response <span class="op">=</span> <span class="va">.</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">response</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                           limits <span class="op">=</span> <span class="va">limits</span>,</span>
<span>                           oob <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span>,</span>
<span>                           name <span class="op">=</span> <span class="st">'Veg ht (m)'</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">ggtitle</span><span class="op">(</span><span class="va">title</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">theme_legend_1</span></span>
<span>    </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">makeStrataIndicatorMap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">title</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">bioClimElev</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ID'</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">index</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                           limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                           name <span class="op">=</span> <span class="st">'Index'</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">ggtitle</span><span class="op">(</span><span class="va">title</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">theme_legend_1</span></span>
<span>    </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu">makeStrataIndicatorMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>,  <span class="st">'A) Semi-/Naturlig-åpne scaled indicator'</span><span class="op">)</span></span>
<span><span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>, <span class="st">"ref"</span>, <span class="st">'B) Semi-/Naturlig-åpne reference height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a3</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>, <span class="st">"pop"</span>, <span class="st">'C) Semi-/Naturlig-åpne indicator height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a4</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">aapneIndexStrata</span>, <span class="st">"skog"</span>, <span class="st">'D) Semi-/Naturlig-åpne forest height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">v1</span> <span class="op">&lt;-</span> <span class="fu">makeStrataIndicatorMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>,  <span class="st">'E) Våtmark scaled indicator'</span><span class="op">)</span></span>
<span><span class="va">v2</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>, <span class="st">"ref"</span>, <span class="st">'F) Våtmark reference height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">v3</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>, <span class="st">"pop"</span>, <span class="st">'G) Våtmark indicator height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">v4</span> <span class="op">&lt;-</span> <span class="fu">makeStrataHeightMap</span><span class="op">(</span><span class="va">vaatmarkIndexStrata</span>, <span class="st">"skog"</span>, <span class="st">'H) Mature forest height'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">strataHeightPlot</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">a1</span>,<span class="va">a2</span>,<span class="va">a3</span>,<span class="va">a4</span>, <span class="va">v1</span>,<span class="va">v2</span>,<span class="va">v3</span>,<span class="va">v4</span>, ncol<span class="op">=</span><span class="fl">4</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-14-1.png" width="960"></div>
<p>We can see that overall, the condition scores for both ecosystem types are poor along the coastal areas and lower-altitude zones of the country (A and E). At higher altitudes the gjengroing condition scores are higher.</p>
<p>When comparing våtmark to semi-/naturlig-åpne ecosystems, we can see that the reference heights for våtmark are generally higher in terms of good (B and F) and poor (D and H) ecological condition. This makes ecological sense because wetlands can and do naturally occur under forest and therefore våtmark in good condition can have tree cover without necessarily being gjengroing.</p>
</div>
<div id="scaled-indicator-values-at-50km-grid-level-circa-45-min-runtime" class="section level3" number="1.8.5">
<h3>
<span class="header-section-number">1.8.5</span> Scaled indicator values at 50km grid level (circa 45 min runtime)<a class="anchor" aria-label="anchor" href="#scaled-indicator-values-at-50km-grid-level-circa-45-min-runtime"><i class="fas fa-link"></i></a>
</h3>
<p>Using the polygon-level indicator scores, we will aggregate to 50km grid level to explore the spatial variation over Norway. We are doing this as an alternative way of visualizing the broad-scale patterns as presented in the section above where we used bioclimatic-elevation strata.</p>
<p>Here we will use a weighted average, but test out the eaTools::ea_spread function! It takes some time to run so best to do this overnight, or to parallelize in some way.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Aggregate polygon index scores to grid level using eaTools ea_spread function</span></span>
<span>  <span class="va">vaatmarkIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">vaatmarkIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">ssb50km</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">SSBID</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, ssbid <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ssbid</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">aapneIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">aapneIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">ssb50km</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">SSBID</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, ssbid <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ssbid</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">'Will import pre-exported data'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_grid.shp'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexGrid</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_grid.shp'</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Will import pre-exported data"</span></span>
<span><span class="co">#&gt; Reading layer `vaatmark_index_grid' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_grid.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 273 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -150000 ymin: 6400000 xmax: 1150000 ymax: 8e+06</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#&gt; Reading layer `aapne_index_grid' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_grid.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 273 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -150000 ymin: 6400000 xmax: 1150000 ymax: 8e+06</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Visualize the spatial distribution of gjengroing indicator scores at grid level.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">vGrid1</span> <span class="op">&lt;-</span> <span class="va">aapneIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">index</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'Index'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'A) Semi-/Naturlig gjengroing condition'</span><span class="op">)</span></span>
<span><span class="co">#vGrid1</span></span>
<span></span>
<span><span class="va">vGrid2</span> <span class="op">&lt;-</span> <span class="va">vaatmarkIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">index</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">regions</span>, fill<span class="op">=</span><span class="cn">NA</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                       name <span class="op">=</span> <span class="st">'Index'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'B) Våtmark gjengroing condition'</span><span class="op">)</span></span>
<span><span class="co">#vGrid2</span></span>
<span></span>
<span></span>
<span><span class="va">indexGridFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">vGrid1</span>, <span class="va">vGrid2</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-16-1.png" width="672"></div>
<p>These patterns mirror those in the previous section with higher condition scores at higher elevations and lower scores along the coastal zone and low-lying parts of the country.</p>
<p>We see some very low condition scores for a few coastal 50km grid cells - this may be an artifact of creating an average with very few population polygons and therefore vulnerable to skewed average indicator scores.</p>
</div>
<div id="scaled-indicator-values-at-regional-level-circa-120-min-runtime" class="section level3" number="1.8.6">
<h3>
<span class="header-section-number">1.8.6</span> Scaled indicator values at regional level (circa 120 min runtime)<a class="anchor" aria-label="anchor" href="#scaled-indicator-values-at-regional-level-circa-120-min-runtime"><i class="fas fa-link"></i></a>
</h3>
<p>Now we will aggregate up to the regional level for final reporting. We will use the same method as in the section above, except here we will use a different method to calculate the uncertainty value around the indicator values. The ea_spread function in eaTools uses a bootstrapping method to calculate the standard error in indicator values when aggregating from the polygon to regional level. Because we have hundreds of thousands of polygons per region, the resulting standard errors are extremely small. Therefore we will use the standard deviation in reference values per region. The standard deviation, as a percentage of the average reference value is used to calculate the uncertainty in the scaled indicator value.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Get the mean population, reference and forest heights per region for interpreting index values</span></span>
<span>  <span class="co"># The standard deviation is used later to define uncertainty around the indicator score</span></span>
<span>  <span class="va">vaatmarkHeightsRegion</span> <span class="op">&lt;-</span> <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">vaatmarkIndexPolySpat</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>pop_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>              skog_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>,</span>
<span>              ref_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span>,</span>
<span>              sd_ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">aapneHeightsRegion</span> <span class="op">&lt;-</span> <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_join</span><span class="op">(</span><span class="va">aapneIndexPolySpat</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">drop_na</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>pop_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>              skog_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">skog</span><span class="op">)</span>,</span>
<span>              ref_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span>,</span>
<span>              sd_ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">ref</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Aggregate polygon index scores to regional level using eaTools</span></span>
<span>  <span class="va">vaatmarkIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">vaatmarkIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">regions</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">region</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, region <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">vaatmarkHeightsRegion</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Only run on first iteration - takes a long time</span></span>
<span>  <span class="va">aapneIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">eaTools</span><span class="fu">::</span><span class="fu"><a href="https://ninanor.github.io/eaTools/reference/ea_spread.html">ea_spread</a></span><span class="op">(</span>indicator_data <span class="op">=</span> <span class="va">aapneIndexPolySpat</span>,</span>
<span>                                            indicator <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                            regions <span class="op">=</span> <span class="va">regions</span>,</span>
<span>                                            groups <span class="op">=</span> <span class="va">region</span>,</span>
<span>                                            threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>index <span class="op">=</span> <span class="va">w_mean</span>, region <span class="op">=</span> <span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">index</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">aapneHeightsRegion</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">'Will import pre-exported data'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">vaatmarkIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_region.shp'</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexRegion</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_region.shp'</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Will import pre-exported data"</span></span>
<span><span class="co">#&gt; Reading layer `vaatmark_index_region' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_region.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span>
<span><span class="co">#&gt; Reading layer `aapne_index_region' from data source </span></span>
<span><span class="co">#&gt;   `/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_region.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89 / UTM zone 33N</span></span></code></pre></div>
<p>Present the indicator values as table, plots, and maps:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Join into a table to present values</span></span>
<span><span class="va">aapentTable</span> <span class="op">&lt;-</span> <span class="va">aapneIndexRegion</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">vaatmarkTable</span> <span class="op">&lt;-</span> <span class="va">vaatmarkIndexRegion</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Join ecosystem types and calculate uncertainty</span></span>
<span><span class="va">indicatorTable</span> <span class="op">&lt;-</span> <span class="va">aapentTable</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Ecosystem <span class="op">=</span> <span class="st">'Semi-/Naturlig åpne'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">vaatmarkTable</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>Ecosystem <span class="op">=</span> <span class="st">'Våtmark'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Calculate the error based on the standard deviation in reference polygon heights</span></span>
<span>  <span class="co"># as a percentage of the reference height, and multiply by index score</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>sd <span class="op">=</span> <span class="op">(</span><span class="va">sd_ref</span><span class="op">/</span><span class="va">ref_mean</span><span class="op">)</span><span class="op">*</span><span class="va">index</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Format the table for presentation</span></span>
<span><span class="va">indicatorTable_formatted</span> <span class="op">&lt;-</span> <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">indicatorTable</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geometry</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span> <span class="va">region</span>, <span class="va">Ecosystem</span>, <span class="va">index</span>, <span class="va">sd</span>, <span class="va">pop_mean</span>, <span class="va">ref_mean</span>, <span class="va">skog_mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">indicatorTable_formatted</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"Region"</span>, <span class="st">"Ecosystem"</span>,</span>
<span>                                      <span class="st">"Scaled indicator"</span>,  <span class="st">"Scaled Std.dev"</span>,</span>
<span>                                      <span class="st">"Indicator height"</span>,<span class="st">"Reference height"</span>,</span>
<span>                                      <span class="st">"Mature forest height"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use knitr to visualize</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">indicatorTable_formatted</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="9%">
<col width="16%">
<col width="14%">
<col width="12%">
<col width="14%">
<col width="14%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th align="left">Region</th>
<th align="left">Ecosystem</th>
<th align="right">Scaled indicator</th>
<th align="right">Scaled Std.dev</th>
<th align="right">Indicator height</th>
<th align="right">Reference height</th>
<th align="right">Mature forest height</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Nord-Norge</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.80</td>
<td align="right">0.27</td>
<td align="right">1.42</td>
<td align="right">0.97</td>
<td align="right">2.79</td>
</tr>
<tr class="even">
<td align="left">Nord-Norge</td>
<td align="left">Våtmark</td>
<td align="right">0.80</td>
<td align="right">0.32</td>
<td align="right">0.98</td>
<td align="right">0.81</td>
<td align="right">2.17</td>
</tr>
<tr class="odd">
<td align="left">Midt-Norge</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.89</td>
<td align="right">0.32</td>
<td align="right">1.89</td>
<td align="right">1.23</td>
<td align="right">4.09</td>
</tr>
<tr class="even">
<td align="left">Midt-Norge</td>
<td align="left">Våtmark</td>
<td align="right">0.85</td>
<td align="right">0.44</td>
<td align="right">1.38</td>
<td align="right">1.09</td>
<td align="right">2.80</td>
</tr>
<tr class="odd">
<td align="left">Østlandet</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.96</td>
<td align="right">0.55</td>
<td align="right">2.32</td>
<td align="right">1.48</td>
<td align="right">5.25</td>
</tr>
<tr class="even">
<td align="left">Østlandet</td>
<td align="left">Våtmark</td>
<td align="right">0.87</td>
<td align="right">0.67</td>
<td align="right">1.86</td>
<td align="right">1.27</td>
<td align="right">3.63</td>
</tr>
<tr class="odd">
<td align="left">Vestlandet</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.86</td>
<td align="right">0.38</td>
<td align="right">2.63</td>
<td align="right">1.90</td>
<td align="right">4.88</td>
</tr>
<tr class="even">
<td align="left">Vestlandet</td>
<td align="left">Våtmark</td>
<td align="right">0.75</td>
<td align="right">0.42</td>
<td align="right">2.44</td>
<td align="right">2.09</td>
<td align="right">3.83</td>
</tr>
<tr class="odd">
<td align="left">Sørlandet</td>
<td align="left">Semi-/Naturlig åpne</td>
<td align="right">0.94</td>
<td align="right">0.40</td>
<td align="right">2.86</td>
<td align="right">2.03</td>
<td align="right">5.62</td>
</tr>
<tr class="even">
<td align="left">Sørlandet</td>
<td align="left">Våtmark</td>
<td align="right">0.78</td>
<td align="right">0.51</td>
<td align="right">2.55</td>
<td align="right">2.28</td>
<td align="right">3.83</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Make plots of regional index values</span></span>
<span><span class="va">getIndicatorPlot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">indicatorTable</span> <span class="op">%&gt;%</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Ecosystem</span> <span class="op">==</span> <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>lowError <span class="op">=</span> <span class="va">index</span><span class="op">-</span><span class="va">sd</span>, </span>
<span>           upError <span class="op">=</span> <span class="va">index</span><span class="op">+</span><span class="va">sd</span>,</span>
<span>           upError <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">upError</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="va">upError</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="va">region</span>, x<span class="op">=</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_segment</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yend<span class="op">=</span><span class="va">region</span>, x<span class="op">=</span><span class="va">lowError</span>, xend<span class="op">=</span><span class="va">upError</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_cartesian</span><span class="op">(</span>xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Tilstandsverdi'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>axis.title.y<span class="op">=</span><span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="va">label</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span><span class="va">i1</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorPlot</span><span class="op">(</span><span class="st">'Semi-/Naturlig åpne'</span><span class="op">)</span></span>
<span><span class="va">i2</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorPlot</span><span class="op">(</span><span class="st">'Våtmark'</span><span class="op">)</span></span>
<span><span class="va">indicatorGraphFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">i1</span>, <span class="va">i2</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-18-1.png" width="672"></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># Make maps of regional index values</span></span>
<span><span class="va">getIndicatorMap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">label</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">regions</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colors<span class="op">=</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">10</span>, <span class="st">'Spectral'</span><span class="op">)</span>,</span>
<span>                         limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorMap</span><span class="op">(</span><span class="va">aapentTable</span>, <span class="st">'A) Semi-/Naturlig åpne'</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">getIndicatorMap</span><span class="op">(</span><span class="va">vaatmarkTable</span>, <span class="st">'B) Våtmark'</span><span class="op">)</span></span>
<span><span class="va">indicatorGMapFig</span> <span class="op">&lt;-</span> <span class="fu">grid.arrange</span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, ncol<span class="op">=</span><span class="fl">2</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"line"</span><span class="op">)</span>, newpage <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="gjengroing_files/figure-html/unnamed-chunk-18-2.png" width="672"></div>
<p>From these tables, figures and maps we can see that the gjengroing condition indicator scores are on average above 0.8 and therefore indicate a good overall condition in Norway. Østlandet comes out best for våtmark and semi-naturlig åpne ecosystems. Nord-Norge has poorest condition for semi-naturlig åpne ecosystems, while vestlandet has the poorest scores for våtmark.</p>
</div>
<div id="uncertainty-and-validation" class="section level3" number="1.8.7">
<h3>
<span class="header-section-number">1.8.7</span> Uncertainty and validation<a class="anchor" aria-label="anchor" href="#uncertainty-and-validation"><i class="fas fa-link"></i></a>
</h3>
<p>The calculation of the indicator involves many small decisions which can have significant effects on the resulting conditions cores. Therefore in the future it would be good to perform sensitivity analyses with each decision to test the effect on the outcome. The decisions which would benefit from further exploration include:</p>
<ul>
<li><p><strong>Selection of the reference and population areas.</strong> Here we were limited to using NiN and AR5 because these are arguably the best datasets currently available for this exercise. However, both NiN and AR5 are spatially and thematically biased in some ways. Therefore, it may be worth exploring alternative datasets in the future. NiN polygons are biased towards low lying areas which are generally warmer and more productive. For a given bioclimatic-elevation strata, this could lead to higher reference values for vegetation height than one would expect with a representative reference sample. This could consequently result in high elevation population polygons appearing to have very good condition because they are being compared with (relatively) high productivity polygons in the same bioclimatic-elevation strata. This is a possible explanation for why the high elevation parts of Norway appear to be in very good ecological condition.</p></li>
<li><p><strong>Definition of good condition states in NiN data.</strong> Here we used the overall “tilstand” score for each NiN reference polygon. However, the overall score is a combination of several sub-scores that may or may not be relevant for ecological condition. For instance, ditches or wheel marks in wetlands is a common condition score in NiN, however it is debatable as to whether this should be considered a part of ecological condition. Therefore it may be beneficial to attempt repeating the indicator calculation using sub-categories of “tilstand” in the NiN data.</p></li>
<li><p><strong>Definition of climax successional stage for tree regrowth.</strong> Here we use the 50th percentile of LiDAR-derived tree heights in AR5 forest polygons that have not been harvested since 1986. This defines the zero on the scaled indicator score. The resulting indicator scores will vary widely depending on how you define this zero-point. Therefore, testing different definitions (i.e. tree height percentiles) may be important.</p></li>
<li><p><strong>Quantifying regional vs local references for poor and good condition.</strong> For good condition, we used NiN polygons and were restricted to these due to lack of better data. However, for poor condition we use climax successional stage for trees (as explained above) within 200m of each population polygon. For polygons with no surrounding forest, we impute with regional reference values (mean of forest height in elevation-bioclamic zone). The choice of 200m buffer zone was largely based on computational limitations. Calculating the average LiDAR vegetation height within 200m of nearly 2 million complex polygons takes time, even in GEE. It may make more ecological sense to define a larger buffer zone to use for defining reference for poor condition. However, longer processing times need to be expected.</p></li>
<li><p><strong>Quantification of uncertainty around indicator scores.</strong> Here we used the standard deviation in the vegetation heights for reference (NiN) polygons within each region to quantify the uncertainty around scaled indicator scores. We did this because the method used in eaTools::ea_spread() function is a bootstrapping approach which resulted in extremely small uncertainty estimates due to the large number of polygons included in our analysis. In the future, a better method for quantifying uncertainty is needed. Perhaps by running sensitivity analyses that test several variations of the points mentioned above can form the basis for quantifying an error margin around indicator values.</p></li>
</ul>
<div id="validation-of-random-polygons" class="section level4" number="1.8.7.1">
<h4>
<span class="header-section-number">1.8.7.1</span> Validation of random polygons<a class="anchor" aria-label="anchor" href="#validation-of-random-polygons"><i class="fas fa-link"></i></a>
</h4>
<p>After exporting the final polygon-level indicator scores, we imported to QGIS and explored how they look at the landscape scale. We chose random locations spread across the 5 regions in Norway. The figures below show våtmark and åpne (semi- and naturlig-åpne) ecosystem polygons from AR5. The polygons have jagged edges because we chose a low resolution geometry export from GEE to save computing time and minimize storage space. Each polygon is colored based on the final scaled gjengroing indicator score (0 to 1). The polygons are also labelled with the median LiDAR-derived forest height. An orthophoto from Norgeibilder is displayed in the background for reference.</p>
<p>In the first example from midt-norge, we see a våtmark polygon colored red (ie. in poor condition) due to the growth of a forest in the northern section. It looks like a plantation forest and possibly occurred after the wetland was drained. The height of the forest vegetation equates to a median of 2.4m which is higher than the reference value for this region (1.09m) and almost as high as the mature forest height reference of 2.8m. Therefore it gets a scaped indicator score of 0.1. In contrast the wetland polygon in the middle of the image is in good condition because it has a median vegetation height of 1.1m which is only fractionally higher than the regional reference for good ecological condition.</p>
<div class="inline-figure"><img src="images/val_1.jpg" style="width:50.0%"></div>
<p>The second example from Sørlandet shows three AR5 semi-naturlig åpne polygons with different indicator values. The lower polygon has poor ecological condition because its median vegetation height is 6.2m which is close to the local reference value for mature forest (7.9m). Although the central polygon appears to have greater coverage of forest in the orthophoto, the LiDAR data tells us that it is mostly covered by short trees and results in a median vegetation height of 2.8 - therefore good condition.</p>
<div class="inline-figure"><img src="images/val_2.jpg" style="width:50.0%"></div>
<p>The third example from Østlandet shows a range of indicator values for våtmark polygons. Although many of the polygons are partly covered by trees, their indicator values show good condition because the local reference for mature forest (zero on the indicator scale) is very high in this landscape of productive forest.</p>
<div class="inline-figure"><img src="images/val_3.jpg" style="width:50.0%"></div>
<p>The fourth example from Nord-norge shows AR5 semi-naturlig åpne polygons with low and high condition scores. The large polygon with poor condition score has a median vegetation height of 2.7 which is nearly as high as the local reference for mature forest (3.8m).</p>
<div class="inline-figure"><img src="images/val_4.jpg" style="width:50.0%"></div>
<p>The fifth and final example from further north in Nord-norge shows two våtmark polygons with contrasting condition scores, yet exactly the same median vegetation heights of 0.6m. The difference in the scaled indicator value is due to different local reference values for surrounding forest. The polygon on the left has surrounding forest (within 200m buffer zone) with median height 0.5m, while the polygon on the right has surrounding forest of 0.7m. This creates a contrast in the final indicator value and illustrates the effect that a local reference value can have on defining good and poor ecological condition.</p>
<div class="inline-figure"><img src="images/val_5.jpg" style="width:50.0%"></div>
</div>
</div>
<div id="eksport-file-final-product" class="section level3" number="1.8.8">
<h3>
<span class="header-section-number">1.8.8</span> Eksport file (final product)<a class="anchor" aria-label="anchor" href="#eksport-file-final-product"><i class="fas fa-link"></i></a>
</h3>
<p>We will export gjengroing indicator values at three levels: - polygon level - 50km grid level - regional level</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">runFromScratch</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Polygon level</span></span>
<span>  <span class="va">vaatmarkIndexPolySpat</span>  <span class="op">%&gt;%</span></span>
<span>    <span class="co">#mutate(area = as.numeric(st_area(geometry)))%&gt;% </span></span>
<span>    <span class="co">#filter(area &gt; 7500) %&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="va">`system:index`</span>,</span>
<span>           elev <span class="op">=</span> <span class="va">elevation</span>, </span>
<span>           vegZn <span class="op">=</span> <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">"system:index"</span>, <span class="op">-</span><span class="va">vegClimZoneLab</span>, <span class="op">-</span><span class="va">elevation</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index.shp'</span>, append<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">aapneIndexPolySpat</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="co">#mutate(area = as.numeric(st_area(geometry)))%&gt;% </span></span>
<span>    <span class="co">#filter(area &gt; 7500) %&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="va">`system:index`</span>,</span>
<span>           elev <span class="op">=</span> <span class="va">elevation</span>, </span>
<span>           vegZn <span class="op">=</span> <span class="va">vegClimZoneLab</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="st">"system:index"</span>, <span class="op">-</span><span class="va">vegClimZoneLab</span>, <span class="op">-</span><span class="va">elevation</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index.shp'</span>, append<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Grid level</span></span>
<span>  <span class="va">vaatmarkIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_grid.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexGrid</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_grid.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Region level</span></span>
<span>  <span class="va">vaatmarkIndexRegion</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/vaatmark_index_region.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">aapneIndexRegion</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_write</span><span class="op">(</span><span class="st">'/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/gjengroing/R_project/OUTPUT/aapne_index_region.shp'</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="overview-of-indicators.html">Overview of indicators</a></div>
<div class="next"><a href="slitasje.html"><span class="header-section-number">2</span> Slitasje og kjørespor</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#gjengroing"><span class="header-section-number">1</span> Vegetation regrowth/encroachment (gjengroing)</a></li>
<li><a class="nav-link" href="#introduction"><span class="header-section-number">1.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#about-the-underlying-data"><span class="header-section-number">1.2</span> About the underlying data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#representativity-in-time-and-space"><span class="header-section-number">1.2.1</span> Representativity in time and space</a></li>
<li><a class="nav-link" href="#original-units"><span class="header-section-number">1.2.2</span> Original units</a></li>
<li><a class="nav-link" href="#temporal-coverage"><span class="header-section-number">1.2.3</span> Temporal coverage</a></li>
<li><a class="nav-link" href="#additional-comments-about-the-dataset"><span class="header-section-number">1.2.4</span> Additional comments about the dataset</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ecosystem-characteristic"><span class="header-section-number">1.3</span> Ecosystem characteristic</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#norwegian-standard"><span class="header-section-number">1.3.1</span> Norwegian standard</a></li></ul>
</li>
<li><a class="nav-link" href="#collinearities-with-other-indicators"><span class="header-section-number">1.4</span> Collinearities with other indicators</a></li>
<li>
<a class="nav-link" href="#reference-state-and-values"><span class="header-section-number">1.5</span> Reference state and values</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#reference-state"><span class="header-section-number">1.5.1</span> Reference state</a></li>
<li><a class="nav-link" href="#reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values"><span class="header-section-number">1.5.2</span> Reference values, thresholds for defining good ecological condition, minimum and/or maximum values</a></li>
</ul>
</li>
<li><a class="nav-link" href="#uncertainties"><span class="header-section-number">1.6</span> Uncertainties</a></li>
<li><a class="nav-link" href="#references"><span class="header-section-number">1.7</span> References</a></li>
<li>
<a class="nav-link" href="#analyses"><span class="header-section-number">1.8</span> Analyses</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-sets"><span class="header-section-number">1.8.1</span> Data sets</a></li>
<li><a class="nav-link" href="#explore-data-coverages"><span class="header-section-number">1.8.2</span> Explore data coverages</a></li>
<li><a class="nav-link" href="#bioclimatic-zone-and-elevation-strata-for-regional-reference-values"><span class="header-section-number">1.8.3</span> Bioclimatic zone and elevation strata for regional reference values</a></li>
<li><a class="nav-link" href="#scaled-indicator-values-at-polygon-level-circa-120-min-runtime"><span class="header-section-number">1.8.4</span> Scaled indicator values at polygon level (circa 120 min runtime)</a></li>
<li><a class="nav-link" href="#scaled-indicator-values-at-50km-grid-level-circa-45-min-runtime"><span class="header-section-number">1.8.5</span> Scaled indicator values at 50km grid level (circa 45 min runtime)</a></li>
<li><a class="nav-link" href="#scaled-indicator-values-at-regional-level-circa-120-min-runtime"><span class="header-section-number">1.8.6</span> Scaled indicator values at regional level (circa 120 min runtime)</a></li>
<li><a class="nav-link" href="#uncertainty-and-validation"><span class="header-section-number">1.8.7</span> Uncertainty and validation</a></li>
<li><a class="nav-link" href="#eksport-file-final-product"><span class="header-section-number">1.8.8</span> Eksport file (final product)</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/NINAnor/ecosystemCondition/blob/master/gjengroing.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/NINAnor/ecosystemCondition/edit/master/gjengroing.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Indicators for Ecosystem Condition in Norway</strong>" was written by Anders L. Kolstad. It was last built on 2023-09-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
