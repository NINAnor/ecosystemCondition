# NDVI - Wetland ecosystems  {#NDVI-indicator-wetland}


<br /> Norwegian name: **Primærproduksjon** <br />


_Author and date:_

Joachim Töpper, Tessa Bargmann

September 2023

<br />

<!-- Load all you dependencies here -->
```{r setup, include=FALSE}
library(downloader)
library(data.table)
library(lubridate)
library(sf)
library(plyr)
library(stringr)
library(tidyverse)
library(RColorBrewer)
library(gridExtra)
library(ggridges)
library(tmap)
library(tmaptools)
library(betareg)
library(StepBeta)
library(glmmTMB)
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE}
Ecosystem <- "Våtmark"
Egenskap <- c("Primærproduksjon")
ECT <- "Structural state characteristics"
Contact <- "Joachim Töpper"
```

```{r, echo=FALSE}
metaData <- data.frame(Ecosystem,
  "Økologisk egenskap" = Egenskap,
  "ECT class" = ECT
)
knitr::kable(metaData)
```

<!-- Don't remove these three html lines -->
<br />
<br />
<hr />

## Introduction {#intro-ndviw}
The Normalized difference vegetation index (NDVI) can be used to describe the greenness of an area, 
and may thus represent a proxy for the amount of chlorophyll and plant productivity in the given area. 
Different ecosystem types naturally have greenness signals of different intensity but also with a certain variance. 
Deviations beyond the natural variation in either direction may indicate a reduction in ecological condition of a given ecosystem. 
E.g. lower than normal NDVI may indicate excessive disturbance, while higher than normal NDVI may indicate regrowth and transitions towards more densely vegetated systems. 
In recent assessments of ecological condition for forest and mountain ecosystems, two different NDVI-based indicators were developed and applied. 
For forests, NDVI-values across the country were compared to a spatial reference NDVI-signal from protected areas (Framstad et al. 2020). 
For mountains, the extent and consistence of the temporal change of NDVI-values over the last twenty years was assessed (Framstad et al 2021). 
In both cases, the NDVI-product from the MODIS satellite reflectance imagery was used based on available maps of spatial ecosystem extent in Norway (i.e. national maps for the forest and mountain ecosystems). 

Here, we explore the potential for developing an NDVI-indicator for ecological condition representing open wetland ecosystems (i.e. excluding forest swamps). 
For this task, three initial challenges can be identified early on:

1. We don't yet have a national wetland map, i.e. we don't know the exact locations of all wetlands in Norway, which is a prerequisite to extract satellite data for the right locations and ecosystems, and thus achieve a good and unbiased spatial representation for the assessment area.
2. The spatial extent of the single wetland ecosystem occurrences (hereafter 'polygons') includes many wetland areas which are way smaller than the pixel size in the MODIS imagery (250 x 250 m) which was used for forests and mountains and has a time series back to year 2000.
3. NDVI in wetland systems lacks the thorough ground-truthing known from globally large ecosystems as forests, tundra or Savannah. Normal variation, like stochastic rain events and moss moisture status may influence NDVI signals greatly (Valøen, 2019). Our current understanding of what NDVI and its changes in different wetland ecosystems mean is thus limited.

In this draft development for a wetland NDVI indicator for ecological condition we approach these challenges in the following ways:

1. We use ecosystem occurrence data from NiN-mapping to guide the extraction of satellite NDVI data for pixels representing the right ecosystem. However, the ecosystem occurrences in the NiN data are highly spatially biased and thus cannot provide a good and unbiased spatial representation for the assessment area. Our work therefore represents a concept and method development which may be applied in an assessment of ecological condition once spatially unbiased occurrence data or a national map of wetland ecosystems are available.
2. We include Sentinel-2 imagery for wetland ecosystems as the resolution for the bands underlying the NDVI product here is 10 x 10 m which is smaller than almost all wetland polygons in the NiN-data. However, since Sentinel-2 only goes back to 2015, we lose much of the time series aspect as compared to the MODIS data. In addition, we include Landsat imagery which goes back to 1984 and has a resolution of 30 x 30 m, but also has more variable data due to less frequent seasonal measurements. We also still explore NDVI data from MODIS (see more details below).


## About the underlying data {#underlying-data-ndviw}
In the NDVI project for wetlands, we use two kinds of data (coming as four datasets) for building indicators for ecological condition:

- NiN ecosystem data from 'Naturtypekartlegging etter Miljødirektoratets instruks' to guide extraction of NDVI data for the right locations and to provide information on the field-assessed ecological condition of mapped polygons
- remote sensed NDVI data
  - Sentinel-2 satellite NDVI data
  - MODIS satellite NDVI data
  - Landsat satellite NDVI data

1. NiN ecosystem data:
The NiN data in this study contain data about the ecosystem categories (cf. Halvorsen et al. 2020) present at mapped sites as wall as their spatial delimitation (in the form of polygons). Since we use NiN data that were collected following 'Miljødirektoratets instruks', these data also include information on the ecological condition and underlying condition variabels of the mapped sites (see the Miljødirektoratets mapping manual for details).
Polygon sizes in these NiN data may vary from <100 sqm to the dimension of sqkm's.

2. NDVI data:
The NDVI data used in the work at hand are pixel means for polygons in the NiN-data, i.e. each NiN polygon is represented by one NDVI value per measurement time (see below for more details on the temporal resolution of NDVI data). With respect to that, it does only make sense to use NDVI data for polygons that are at least of the same size as the resolution of the respective satellite, and thus we excluded any polygons smaller than each satellite's resolution.

(2a) Sentinel-2 satellite NDVI data:
The Sentinel data have a resolution of 10 x 10 m, and we thus excluded all NiN-polygons smaller than 100 sqm. Sentinel-2 has a revisit frequency of 10 days and should thus provide enough measurements during peak growing season to provide a robust measure of maximum greenness.

(2b) MODIS satellite NDVI data:
The MODIS data have a resolution of 250 x 250 m, and we thus excluded all NiN-polygons smaller than 62500 sqm. MODIS has a revisit frequency of 1-2 days and thus provides an extensive sample to provide a robust measure of maximum greenness.

(2c) Landsat satellite NDVI data:
The Landsat data have a resolution of 30 x 30 m, and we thus excluded all NiN-polygons smaller than 900 sqm. Landsat has a revisit frequency of 16 days and thus provides the poorest growing season sample among the available NDVI data for a robust measure of maximum greenness.


### Representativity in time and space {#representativity-ndviw}
For wetlands, the NiN data contain 6502 wetland polygons of known area size across mainland Norway. However, NiN-mapping is not planned and performed in a spatially representative way and thus both the ecosystem occurrences and their spatial extent have to be treated as spatially biased. The 6502 wetland polygons are distributed across regions and major ecosystem types in the following way:

|Region            |V1    |V3    |V4   |V6   | V9   |V10|
|------------------|------|------|-----|-----|------|---|
|Northern Norway   |638   |275   |55   |102  | 360  |315|
|Central Norway    |702   |1250  |34   |0    | 302  |116|
|Western Norway    |296   |111   |30   |0    | 460  |158|
|Eastern Norway    |251   |89    |103  |0    | 251  |223|
|Southern Norway   |58    |44    |5    |0    | 155  |102|

In addition, there is 3 V3s, 1 V4, 4 V9s, and 9 V10s that are not assigned to any region.


The NDVI data from either satellite follow the spatial distribution and bias status of the NiN-data. 
Due to the larger number of excluded polygons in the NDVI data from MODIS (because of the large pixel size in MODIS, see above), 
the MODIS NDVI data for the wetland occurrences in the NiN data are likely even more spatially biased than it is the case for the NDVI data from Sentinel-2 and Landsat. 

### Temporal coverage {#temp-cov-ndvis
The currently available NiN data on wetland ecosystems span a time period from 2018-2021 and thus represent a contemporary sample of ecosystem occurrences. 
Note that none of the polygons in the NiN-data has been visited more than once during that period.

- Available Sentinel-2 satellite NDVI data span the years 2015-2022.
- Available MODIS satellite NDVI data span the years 2000-2022.
- Available Landsat satellite NDVI data span the years 1984-2021.


## Collinearities with other indicators {#coll-ndvis}
The NDVI signal may likely be co-linear with [the re-growth indicator](https://ninanor.github.io/ecosystemCondition/gjengroing.html) based on LiDAR derived canopy height in drained wetland areas under shrub and tree encroachment.

## Reference state and values {#ref-state-ndviw}

### Reference state and scaling values {#ref-state2-ndviw}
This indicator project is mainly exploratory, mapping the possibilities of and lacking prerequisites for satellite derived NDVI data to inform ecological condition assessments. 
Therefore, we lack a concise strategy for how to define the reference state, especially prior to having access to an ecosystem map for wetland ecosystems (cf. Jakobsson et al. 2020, Töpper & Jakobsson 2021). 
In this exploratory work, we will use the condition classification in the NiN-data to explore 

1. how NDVI connects to wetland ecology and condition and 
2. its applicability for defining a reference state. 

We will use statistical models to test whether or not NDVI varies systematically with condition and across time.

## Uncertainties {#uncertainties-ndviw}
Given a condition index can be achieved, we can calculate a mean indicator value (after scaling) for every region 
(or any other delimited area of interest) as well as its corresponding standard error and standard deviation as a 
measure of spatial uncertainty for a geographical area (see Töpper & Jakobsson 2021).


## References

Framstad, E., Kolstad, A. L., Nybø, S., Töpper, J. & Vandvik, V. 2022. The condition of forest and mountain ecosystems in Norway. Assessment by the IBECA method. NINA Report 2100. Norwegian Institute for Nature Research.

Halvorsen, R., Skarpaas, O., Bryn, A., Bratli, H., Erikstad, L., Simensen, T., & Lieungh, E. (2020). Towards a systematics of ecodiversity: The EcoSyst framework. Global Ecology and Biogeography, 29(11), 1887-1906. doi:10.1111/geb.13164

Jakobsson, S., Töpper, J.P., Evju, M., Framstad, E., Lyngstad, A., Pedersen, B., Sickel, H., Sverdrup-Thygeson, A., Vandvik. V., Velle, L.G., Aarrestad, P.A. & Nybø, S. 2020. Setting reference levels and limits for good ecological condition in terrestrial ecosystems. Insights from a case study based on the IBECA approach. Ecological Indicators 116: 106492.

Miljødiretoratets mapping manual: https://www.miljodirektoratet.no/publikasjoner/2022/januar/kartleggingsinstruks-kartlegging-av-terrestriske-naturtyper-etter-nin/

Töpper, J. & Jakobsson, S. 2021. The Index-Based Ecological Condition Assessment (IBECA) - Technical protocol, version 1.0. NINA Report 1967. Norwegian Institute for Nature Research.

Valøen, K. 2019. Stochastic rain events increase NDVI through moss water content: a High-Arctic field experiment. Master Thesis NTNU.


## Analyses {#analyses-ndviw}

### Data sets {#datasets-ndviw}
The analyses in this document make use of the following data sets:

- NiN data (Naturtyper etter Miljødirektoratets instruks) 
- Sentinel-2 NDVI data 
- MODIS NDVI data 
- Landsat NDVI data

#### NiN data and geometry for Norway and the five regions {#nindata-ndviw}

```{r, echo = F}
# Add NiN data from cache
nin <- readRDS(paste0(here::here(), "/data/cache/nin.RDS"))
```

The NiN data can be directly downloaded from Miljødirektoratets kartkatalog (https://kartkatalog.miljodirektoratet.no/Dataset)

```{r, echo = T, eval = F}
url <- "https://nedlasting.miljodirektoratet.no/Miljodata//Naturtyper_nin/FILEGDB/4326/Naturtyper_nin_0000_norge_4326_FILEGDB.zip"
download(url, dest = "P:/41201785_okologisk_tilstand_2022_2023/data/Naturtyper_nin_0000_norge_4326_FILEGDB.zip", mode = "wb")
unzip("P:/41201785_okologisk_tilstand_2022_2023/data/Naturtyper_nin_0000_norge_4326_FILEGDB.zip",
  exdir = "P:/41201785_okologisk_tilstand_2022_2023/data/nin_data"
)
st_layers("P:/41201785_okologisk_tilstand_2022_2023/data/nin_data/Naturtyper_nin_0000_norge_4326_FILEGDB.gdb")
nin <- st_read("P:/41201785_okologisk_tilstand_2022_2023/data/nin_data/Naturtyper_nin_0000_norge_4326_FILEGDB.gdb",
  layer = "naturtyper_nin_omr"
)
```

And we upload maps for Norway and the five regions: Southern, Western, Eastern, Central, and Northern Norway

```{r, message=FALSE}
# Import region- og Norgeskart, make sure they have the same geometry as the nin data
nor <- st_read("data/outlineOfNorway_EPSG25833.shp") %>%
  st_as_sf() %>%
  st_transform(crs = st_crs(nin))

reg <- st_read("data/regions.shp") %>%
  st_as_sf() %>%
  st_transform(crs = st_crs(nin))

# change region names to something R-friendly
#reg$region
reg$region <- c("Northern Norway", "Central Norway", "Eastern Norway", "Western Norway", "Southern Norway")

# combine the Norway and the region maps
regnor <- st_intersection(reg, nor)
rm(reg)
rm(nor)
```

#### NDVI data {#ndvidata-ndviw}
All NDVI data are calculated mean NDVI values for each respective NiN polygon from each available Sentinel-2, MODIS, or Landsat image in Google Earth Engine (GEE). 

```{r, echo = F}
# downloading the unprocessed NDVI data from a data-cache et the NINA server
df.s <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/NDVI_åpenlavland/ndvi.Sentinel.raw.RDS")
df.m <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/NDVI_åpenlavland/ndvi.Modis.raw.RDS")
df.l <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/NDVI_åpenlavland/ndvi.Landsat.raw.RDS")
```

##### Sentinel-2 NDVI data {#sentinelldata-ndviw}
The GEE code can be seen here: https://code.earthengine.google.com/2ceb0c3e03adade9e6f6d0903184b8c4
The image collection contains Sentinel imagery from June, July and August 2015-2022
To not exceed GEE memory limits, the exported files had to be iterated over a grid which resulted in 42 separate csv files. 
This script merges them and then merges the dataframe to the NiN data.

```{r, echo = T, eval = F}
# Import Sentinel NDVI Data
df.s <- list.files("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/NDVI_åpenlavland/NDVI_data_Sentinel/", pattern = "*.csv", full.names = TRUE) %>%
  map_df(~ fread(.))
```

##### MODIS NDVI data {#modisdata-ndviw}
The GEE code can be seen here: https://code.earthengine.google.com/efb84013701f1d5f6e1e81345f389b84
The image collection contains MODIS imagery from June, July and August 2000-2022

```{r, echo = T, eval = F}
# Import MODIS NDVI Data
# MODIS NDVI is scaled by 0.0001. Mean must be divided by 10000.
df.m <- read.csv("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/NDVI_åpenlavland/NDVI_data_MODIS/modis_ndvi_ts_2000_2022.csv")
df.m$mean <- df.m$mean / 10000
```

##### Landsat NDVI data {#landsatdata-ndviw}
The GEE code can be seen here: https://code.earthengine.google.com/da8a9279238ef26d14be08a43788b6b7
The image collection contains Landsat imagery from June, July and August 1984-2022
To not exceed GEE memory limits, the exported files had to be iterated over a grid which resulted in 42 separate csv files. 
This script merges them and then merges the dataframe to the NiN data.

```{r, echo = T, eval = F}
# Import Landsat NDVI Data
# Set up conditional file paths
dir <- substr(getwd(), 1, 2)

path <- ifelse(dir == "C:",
  "R:/GeoSpatialData/Habitats_biotopes/Norway_Miljodirektoratet_Naturtyper_nin/Original/versjon20221231/Natur_Naturtyper_nin_norge_med_svalbard_25833/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb",
  "/data/R/GeoSpatialData/Habitats_biotopes/Norway_Miljodirektoratet_Naturtyper_nin/Original/versjon20221231/Natur_Naturtyper_nin_norge_med_svalbard_25833/Natur_Naturtyper_NiN_norge_med_svalbard_25833.gdb"
)

pData <- ifelse(dir == "C:",
  "P:/41201785_okologisk_tilstand_2022_2023/data/NDVI_åpenlavland/NDVI_data_Landsat",
  "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/NDVI_åpenlavland/NDVI_data_Landsat"
)


# Fread doesn't like the weird path to the server version of the P drive
# hence this horrendous work around
files <- list.files(pData, pattern = "*.csv", full.names = TRUE)

df_list <- list() # initialise a list of dataframes
# read in a dataframe in each slot of the df_list
for (i in files) {
  name <- gsub("-", ".", i)
  name <- gsub(".csv", "", name)
  i <- paste(i, sep = "")
  df_list[[i]] <- assign(name, read.csv(i, header = TRUE))
}

df.l <- bind_rows(df_list, .id = "column_label")
```

### Data handling {#data-handling-ndviw}
#### NiN data {#nin-data-handling-ndviw}
```{r, echo = T, eval = F}
# fixing variable- and ecosystem-names with special characters
colnames(nin)
colnames(nin)[c(3, 8, 17, 26, 31, 33, 34)] <- c(
  "hovedoekosystem", "kartleggingsaar", "noyaktighet",
  "omraadenavn", "uk_naertruet", "uk_sentraloekosystemfunksjon",
  "uk_spesieltdaarligkartlagt"
)
unique(nin$hovedoekosystem)

nin <- nin %>%
  mutate(hovedoekosystem = recode(hovedoekosystem,
    "Våtmark" = "Vaatmark",
    "Semi-naturlig mark" = "Semi_naturlig",
    "Naturlig åpne områder i lavlandet" = "Naturlig-aapent",
    "Naturlig åpne områder under skoggrensa" = "Naturlig_aapent"
  )) %>%
  mutate(validGeo = st_is_valid(SHAPE))

# checking how many polygons have multiple ecosystem types
unique(nin$ninkartleggingsenheter)

nrow(nin)
# 95469 polygons altogether
nrow(nin %>%
  filter(grepl(",", ninkartleggingsenheter)))
# 21094 polygons have more than 1 ecosystem type (they are separated by commas in the ninkartleggingsenheter-variable)

nrow(nin %>%
  filter(!grepl(",", ninkartleggingsenheter)))
# 74375 polygons should have only 1 ecosystem type

# there's no information on the proportion of ecosystem types in the polygons, so we got to omit all polygons with multiple ecosystem types :(
nin <- nin %>%
  filter(!grepl(",", ninkartleggingsenheter))

# fix the content in the ninkartleggingsenheter-variable
summary(as.factor(nin$ninkartleggingsenheter))
# get rid of the NA- in the beginning
nin <- nin %>% mutate(ninkartleggingsenheter = str_remove(ninkartleggingsenheter, "NA_"))
# making a main ecosystem type variable
nin <- nin %>% mutate(
  hovedtype = substr(ninkartleggingsenheter, 1, 3),
  hovedtype = str_remove(hovedtype, "-")
)
# checking mapping unit against main ecosystem type
nin[, c("hovedoekosystem", "hovedtype")]
summary(as.factor(nin$hovedtype[nin$hovedoekosystem == "Vaatmark"]))
summary(as.factor(nin$hovedtype[nin$hovedoekosystem == "Semi_naturlig"]))
summary(as.factor(nin$hovedtype[nin$hovedoekosystem == "Naturlig_aapne"]))
summary(as.factor(nin$hovedtype[nin$hovedoekosystem == "Skog"]))
summary(as.factor(nin$hovedtype[nin$hovedoekosystem == "Fjell"]))
# making a new variable for the overarching ecosystem types based on the main ecosystem types
nin$hovedoekosystem.orig <- nin$hovedoekosystem

nin <- nin %>%
  mutate(hovedoekosystem = case_when(
    hovedtype %in% paste("V", c(1, 3:7, 9:10), sep = "") ~ "Vaatmark",
    hovedtype %in% paste("V", 11:13, sep = "") ~ "Vaatmark_sterkt_endret",
    hovedtype %in% paste("T", c(31:34, 40:41), sep = "") ~ "Semi_naturlig",
    hovedtype %in% paste("T", c(2, 12, 18, 20:21), sep = "") ~ "Naturlig_aapent",
    hovedtype %in% c(paste("T", c(4, 30, 38), sep = ""), paste("V", c(2, 8), sep = "")) ~ "Skog",
    hovedtype %in% c(paste("T", c(3, 7, 9, 10, 14, 22, 26), sep = ""), paste("V", c(6, 7), sep = "")) ~ "Fjell",
    TRUE ~ "NA"
  ))


summary(as.factor(nin$tilstand))

nin <- nin %>% mutate(tilstand = recode(tilstand,
  "Dårlig" = "Redusert",
  "Svært redusert" = "Svaert_redusert"
))
nin <- nin %>% mutate(tilstand_num = recode(tilstand,
  "God" = 0, "Moderat" = 1,
  "Redusert" = 2, "Svaert_redusert" = 3
))

summary(as.factor(nin$tilstand))
summary(as.numeric(nin$tilstand_num))


## filter out only wetland data
nin.wetland <- nin %>%
  filter(hovedoekosystem %in% c("Vaatmark")) %>%
  mutate(id = identifikasjon_lokalid) %>%
  filter(validGeo) %>%
  drop_na(tilstand) %>%
  dplyr::select(id, hovedoekosystem, hovedtype, ninkartleggingsenheter, lokalitetskvalitet, tilstand, tilstand_num, ninbeskrivelsesvariabler, kartleggingsaar)


# merge NiN-data with region
nin.wetland <- st_join(nin.wetland, regnor, left = TRUE)
nin.wetland

colnames(nin.wetland)[c(1, 10)] <- c("id", "region_id")

# check that every nin-polygon still occurs only once
summary(as.factor(nin.wetland$id))
nin.wetland[nin.wetland$id == "NINFP2110008060", ]
# this one was assigned to both Western and Central Norway, we drop the latter
nin.wetland <- nin.wetland[!row.names(nin.wetland) %in% "1144.1", ]

nin.wetland <- nin.wetland %>%
  mutate(area_meters_nin = st_area(nin.wetland))
# check and edit the order of regions
levels(nin.wetland$region)
nin.wetland$region <- as.factor(nin.wetland$region)
levels(nin.wetland$region)
nin.wetland$region <- factor(nin.wetland$region, levels = c("Northern Norway", "Central Norway", "Eastern Norway", "Western Norway", "Southern Norway"))
levels(nin.wetland$region)

# splitting content in the ninbeskrivelsesvariabler-column into separate rows per variable and then separating that column into two for the variable name and value
nin.wetland2 <- nin.wetland %>%
  separate_rows(ninbeskrivelsesvariabler, sep = ",") %>%
  separate(
    col = ninbeskrivelsesvariabler,
    into = c("NiN_variable_code", "NiN_variable_value"),
    sep = "_",
    remove = F
  ) %>%
  mutate(NiN_variable_value = as.numeric(NiN_variable_value)) %>%
  mutate(NiN_variable_code = as.factor(NiN_variable_code)) %>%
  subset(select = -ninbeskrivelsesvariabler)
nin.wetland2 <- as.data.frame(nin.wetland2)
```


```{r, include=F, eval=F}
saveRDS(nin.wetland, paste0(here::here(), "/data/cache/nin.wetland.RDS"))
saveRDS(nin.wetland2, paste0(here::here(), "/data/cache/nin.wetland2.RDS"))
```

```{r, echo = F}
# load processed NiN-data from cache
nin.wetland <- readRDS(paste0(here::here(), "/data/cache/nin.wetland.RDS"))
nin.wetland2 <- readRDS(paste0(here::here(), "/data/cache/nin.wetland2.RDS"))
```

#### NDVI data {#ndvi-data-ndviw}
```{r, results='hide'}
## Sentinel-2
# join nin.wetland & Sentinel NDVI data
SentinelNDVI.wetland <- full_join(nin.wetland, df.s, by = "id")
# summary(SentinelNDVI.wetland)
SentinelNDVI.wetland <- SentinelNDVI.wetland %>%
  mutate(
    hovedoekosystem = as.factor(hovedoekosystem),
    hovedtype = as.factor(hovedtype),
    ninkartleggingsenheter = as.factor(ninkartleggingsenheter),
    lokalitetskvalitet = as.factor(lokalitetskvalitet),
    tilstand = as.factor(tilstand),
    area_meters = st_area(SentinelNDVI.wetland)
  )
# summary(SentinelNDVI.wetland)
# get rid of NAs (i.e. NDVI cells that were not in wetland polygons)
SentinelNDVI.wetland <- SentinelNDVI.wetland %>% filter(!is.na(hovedtype))
SentinelNDVI.wetland <- SentinelNDVI.wetland %>% filter(!is.na(mean))
# summary(SentinelNDVI.wetland)
# get rid of any nin-polygons smaller than the Sentinel grid cell size (100 sqm)
  # dim(SentinelNDVI.wetland)
SentinelNDVI.wetland <- SentinelNDVI.wetland %>% filter(as.numeric(area_meters) >= 100)
  # dim(SentinelNDVI.wetland)
# split date into year, month & day
SentinelNDVI.wetland <- SentinelNDVI.wetland %>%
  dplyr::mutate(
    year = lubridate::year(date),
    month = lubridate::month(date),
    day = lubridate::day(date)
  )
# add column for sub-ecosystem types
SentinelNDVI.wetland <- SentinelNDVI.wetland %>% mutate(
  subtype = substring(ninkartleggingsenheter, 4),
  subtype = str_remove(subtype, "-"),
  subtype = str_remove(subtype, "-")
)
# we are using max NDVI per year in every NiN polygon
SentinelNDVI.wetland <- SentinelNDVI.wetland %>%
  group_by(id, year) %>%
  filter(mean == max(mean, na.rm = TRUE))

  # summary(SentinelNDVI.wetland)

## MODIS
# join nin.wetland and Modis NDVI data
ModisNDVI.wetland <- full_join(nin.wetland, df.m, by = "id")

# summary(ModisNDVI.wetland)
ModisNDVI.wetland <- ModisNDVI.wetland %>%
  mutate(
    hovedoekosystem = as.factor(hovedoekosystem),
    hovedtype = as.factor(hovedtype),
    ninkartleggingsenheter = as.factor(ninkartleggingsenheter),
    lokalitetskvalitet = as.factor(lokalitetskvalitet),
    tilstand = as.factor(tilstand),
    area_meters = st_area(ModisNDVI.wetland)
  )
# summary(ModisNDVI.wetland)
# get rid of NAs (i.e. NDVI cells that were not in wetland polygons)
ModisNDVI.wetland <- ModisNDVI.wetland %>% filter(!is.na(hovedtype))
ModisNDVI.wetland <- ModisNDVI.wetland %>% filter(!is.na(mean))
# summary(ModisNDVI.wetland)
# get rid of any nin-polygons smaller than the Modis grid cell size (62500 sqm)
  # dim(ModisNDVI.wetland)
ModisNDVI.wetland <- ModisNDVI.wetland %>% filter(as.numeric(area_meters) >= 62500)
  # dim(ModisNDVI.wetland)
# split date into year, month & day
ModisNDVI.wetland <- ModisNDVI.wetland %>%
  dplyr::mutate(
    year = lubridate::year(date),
    month = lubridate::month(date),
    day = lubridate::day(date)
  )
# we are using max NDVI per year in every NiN polygon
ModisNDVI.wetland <- ModisNDVI.wetland %>%
  group_by(id, year) %>%
  filter(mean == max(mean, na.rm = TRUE))
# summary(ModisNDVI.wetland)

## Landsat
# join nin.wetland & Landsat NDVI data
LandsatNDVI.wetland <- full_join(nin.wetland, df.l, by = "id")

# summary(LandsatNDVI.wetland)
LandsatNDVI.wetland <- LandsatNDVI.wetland %>%
  mutate(
    hovedoekosystem = as.factor(hovedoekosystem),
    hovedtype = as.factor(hovedtype),
    ninkartleggingsenheter = as.factor(ninkartleggingsenheter),
    lokalitetskvalitet = as.factor(lokalitetskvalitet),
    tilstand = as.factor(tilstand),
    area_meters = st_area(LandsatNDVI.wetland)
  )
# summary(LandsatNDVI.wetland)
# get rid of NAs (i.e. NDVI cells that were not in wetland polygons)
LandsatNDVI.wetland <- LandsatNDVI.wetland %>% filter(!is.na(hovedtype))
LandsatNDVI.wetland <- LandsatNDVI.wetland %>% filter(!is.na(mean))
# summary(LandsatNDVI.wetland)
# get rid of any nin-polygons smaller than the Landsat grid cell size (900 sqm)
  # dim(LandsatNDVI.wetland)
LandsatNDVI.wetland <- LandsatNDVI.wetland %>% filter(as.numeric(area_meters) >= 900)
  # dim(LandsatNDVI.wetland)
# split date into year, month & day
LandsatNDVI.wetland <- LandsatNDVI.wetland %>%
  dplyr::mutate(
    year = lubridate::year(date),
    month = lubridate::month(date),
    day = lubridate::day(date)
  )
# we are using max NDVI per year in every NiN polygon
LandsatNDVI.wetland <- LandsatNDVI.wetland %>%
  group_by(id, year) %>%
  filter(mean == max(mean, na.rm = TRUE))

# summary(LandsatNDVI.wetland)
```


### Exploratory analyses, Sentinel-2 {#exploratory-ndviw}

**Where are the wetland sites?**
```{r  where-are-wetland-sites, fig.cap="A map of Norway showing the location of the wetland ecosystem sites. V1 = minerotrophic mires, V3 = ombrotrophic bogs, V4 = cold springs, V6 = wet snowbeds, V9 = semi-natural mires, V10 = semi-natural wet meadows."}
tm_shape(regnor) +
  tm_fill("GID_0", labels = "", title = "", legend.show = FALSE) +
  tm_borders() +
  tm_shape(SentinelNDVI.wetland) +
  tm_dots("hovedtype", midpoint = NA, palette = tmaptools::get_brewer_pal("YlOrRd", 6, plot = FALSE), scale = 2.5, legend.show = FALSE) +
  tm_add_legend(
    type = "symbol",
    col = tmaptools::get_brewer_pal("YlOrRd", 6, plot = FALSE),
    labels = c(
      "V1",
      "V3",
      "V4",
      "V6",
      "V9",
      "V10"
    ),
    title = "Major ecosystem type",
    size = 3
  ) +
  tm_layout(
    main.title = "Wetland ecosystems (NiN, Miljødirektoratets instruks)",
    main.title.size = 1.2, legend.position = c("right", "bottom"),
    legend.text.size = 1.3, legend.title.size = 1.4
  )
```

# How are polygon sizes distributed?
```{r histogram-sentinall-ndviw, fig.cap="Histogram of wetland ecosystem polygon sizes in Norway."}
summary(SentinelNDVI.wetland$area_meters)
hist(SentinelNDVI.wetland$area_meters, xlim = c(0, 20000), breaks = 50000)
abline(v = 100, lty = 2)
```

Wetland polygons stretch a large number of sizes from just above 100 sqm to more than 4 million sqm. 75% of all polygons are below 14264 sqm.

**How does NDVI vary over the years**
```{r NDVI-values-over-time-ndviw, fig.cap="A figure showing NDVI values for wetland ecosystem over time for six different main nature types in varying degrees of condition. V1 = minerotrophic mires, V3 = ombrotrophic bogs, V4 = cold springs, V9 = semi-natural mires, V10 = semi-natural wet meadows."}
SentinelNDVI.wetland %>%
  ggplot(aes(x = year, y = mean)) +
  geom_point() +
  facet_grid(tilstand ~ hovedtype)
```

2022 stands out with the highest NDVI values missing.
WE omit 2022 for this analysis
```{r}
SentinelNDVI.wetland <- SentinelNDVI.wetland %>% filter(year != "2022")
```

**How do NDVI values vary between major and basic ecosystem types for sites in good condition? (using only NDVI data matching NiN-mapping years)**
```{r NDVI-major-ndviw, warning=FALSE, fig.cap="NDVI values in major wetland ecosystem types in good condition. V1 = minerotrophic mires, V3 = ombrotrophic bogs, V4 = cold springs, V9 = semi-natural mires, V10 = semi-natural wet meadows"}
SentinelNDVI.wetland %>%
  filter(tilstand == "God") %>%
  filter(year == kartleggingsaar) %>%
  ggplot(aes(x = hovedtype, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey")
```
```{r NDVI-basic-ndviw, warning=FALSE, fig.cap="NDVI values in basic wetland ecosystem types in good condition. V1 = minerotrophic mires, V3 = ombrotrophic bogs, V4 = cold springs, V9 = semi-natural mires, V10 = semi-natural wet meadows."}
SentinelNDVI.wetland %>%
  filter(tilstand == "God") %>%
  filter(year == kartleggingsaar) %>%
  ggplot(aes(x = subtype, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  facet_wrap(~hovedtype) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0.2))
```

NDVI varies between major ecosystem types with the highest values in semi-natural wet-meadows (V10), and lowest values in ombrotrophic bogs (V3). The overlaps between the ecosystem types are considerable.
With respect to basic ecosystem types within the major types, NDVI appears to increase with increasing limestone level (C1-C4, C5-C8, and E1-E3 in V1, C1-C3 in the other major types), and also here the overlap is large. 

**How does NDVI vary across regions in wetlands (major types) in good condition? (using only NDVI data matching NiN-mapping years)**
```{r ndvi-regions-ndviw, warning=FALSE, fig.cap="DVI variation across regions in wetland ecosystems (major types) in good condition. V1 = minerotrophic mires, V3 = ombrotrophic bogs, V4 = cold springs, V9 = semi-natural mires, V10 = semi-natural wet meadows."}
SentinelNDVI.wetland %>%
  filter(tilstand == "God") %>%
  filter(year == kartleggingsaar) %>%
  filter(!is.na(region)) %>%
  ggplot(aes(x = region, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  facet_wrap(~hovedtype) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0.2))
```

There is no obvious trends in geography.

**How does NDVI vary across condition classes (for major types and NDVI data matching NiN-mapping years)**
```{r ndvi-condition-ndviw, warning=FALSE, fig.cap="NDVI values across wetland sites in different ecological condition. V1 = minerotrophic mires, V3 = ombrotrophic bogs, V4 = cold springs, V9 = semi-natural mires, V10 = semi-natural wet meadows."}
SentinelNDVI.wetland %>%
  filter(year == kartleggingsaar) %>%
  ggplot(aes(x = tilstand, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0.2))+
  facet_wrap(~hovedtype)
```

In semi-natural types (V9,V10), kaldkilde (V4), and ombrotrophic bogs (V3) NDVI seems to increase as condition deteriorates, 
but in minertrophic fens (V1) there is not much of a pattern. 
Overlaps between condition classes are generally very large.

**Which ecological relevant variable(s) is the condition measure in the NiN data related to?**
```{r important-variables-ndviwv9, warning=FALSE, fig.cap="Which ecological relevant variable(s) is the condition measure in the NiN data related to?"}
nin.wetland2 %>%
  filter(hovedtype == "V9") %>%
  filter(NiN_variable_code %in% c("1AG-B", "7GR-GI", "1AG-A-G", "1AR-C-L", "7TK", "PRSL")) %>%
  mutate(NiN_variable_des = recode(NiN_variable_code,
    "1AG-B" = "Shrub cover",
    "7GR-GI" = "Abundance of ditches",
    "1AG-A-G" = "Tree cover",
    "1AR-C-L" = "Woody plants in field layer",
    "7TK" = "Heavy vehicles",
    "PRSL" = "Wear/tear"
  )) %>%
  ggplot(aes(x = NiN_variable_value, y = tilstand_num)) +
  geom_point(size = 2) +
  geom_jitter(width = 0.25, height = 0.25) +
  facet_wrap(~NiN_variable_des, nrow = 2, ncol = 3) +
  theme(legend.position = "none") +
  ggtitle("Condition variables in semi-natural mires (V9)") +
  labs(y = "Condition level (0-3='good' to 'very reduced')", x = "Condition variable score")
```
```{r important-variables-ndviwv10, warning=FALSE, fig.cap="Which ecological relevant variable(s) is the condition measure in the NiN data related to?"}
nin.wetland2 %>%
  filter(hovedtype == "V10") %>%
  filter(NiN_variable_code %in% c("7JB-BA", "7RA-SJ", "7FA", "7JB-GJ")) %>%
  mutate(NiN_variable_des = recode(NiN_variable_code,
    "7JB-BA" = "Land use intensity",
    "7RA-SJ" = "Succession",
    "7FA" = "Alien species",
    "7JB-GJ" = "Fertilization"
  )) %>%
  ggplot(aes(x = NiN_variable_value, y = tilstand_num)) +
  geom_point(size = 2) +
  geom_jitter(width = 0.25, height = 0.25) +
  facet_wrap(~NiN_variable_des, nrow = 2, ncol = 2) +
  theme(legend.position = "none") +
  ggtitle("Condition variables in semi-natural wet-meadows (V10)") +
  labs(y = "Condition level (0-3='good' to 'very reduced')", x = "Condition variable score")
```

```{r important-variables-ndviwv1, warning=FALSE, fig.cap="Which ecological relevant variable(s) is the condition measure in the NiN data related to?"}
nin.wetland2 %>%
  filter(hovedtype == "V1") %>%
  filter(NiN_variable_code %in% c("7GR-GI", "PRTK", "7FA", "7TK", "7SE", "PRSL")) %>%
  mutate(NiN_variable_des = recode(NiN_variable_code,
    "7GR-GI" = "Abundance of ditches",
    "PRTK" = "Heavy vehicles",
    "7FA" = "Alien species",
    "7TK" = "Heavy vehicles2",
    "7SE" = "Wear/tear",
    "PRSL" = "Wear/tear2"
  )) %>%
  ggplot(aes(x = NiN_variable_value, y = tilstand_num)) +
  geom_point(size = 2) +
  geom_jitter(width = 0.25, height = 0.25) +
  facet_wrap(~NiN_variable_des, nrow = 2, ncol = 3) +
  theme(legend.position = "none") +
  ggtitle("Condition variables in minerotrophic fens (V1)") +
  labs(y = "Condition level (0-3='good' to 'very reduced')", x = "Condition variable score")
```


In these plots, the panels for V1, V9 and V10 differ because Miljødirektoratets mapping manual (see reference list above) uses different variables in these major ecosystem types to define condition.

In V9, semi-natural mires, reduced condition is mainly related to increasing cover of shrubs and trees. 
In V10, semi-natural wet-meadows, reduced condition is related to insufficient land-use intensity and succession. 
In both cases, we'd expect an increase in the greenness signal. 
Thus, NDVI can, in principle, be indicative of ecological condition in semi-natural wetlands due to a direct connection to the main pressures on the ecosystems.
In V1 (minerotrophic fens), reduced condition is mainly related to the abundance of ditches, but also increased use of heavy vehicles and high alien species abundance are related to very reduce condition. 
Under these drivers, greenness would not directly be affected, although drainage due to ditches may lead to succession and woody plant encroachment, and thus greening, in the longer run. 
**Currently, NDVI seems poorly linked to ecological condition in, and the major pressures on, minerotrophic fens.**

### Regression analyses Sentinel-2, NDVI as a function of condition {#regression-ndviw}
We can investigate further how NDVI and condition are connected using regression analyses.

First, we take a look at how balanced the data are across major ecosystem types, regions and condition classes
```{r balanced-data-ndviw, warning=FALSE, message=FALSE, fig.cap="NDVI values across a condition gradient, faceted by five wetland ecosystem types in five regions in Norway. ", fig.height=12}
# NDVI across hovedtyper, regions and condition classes (only for NDVI years data matching NiN-mapping years)
SentinelNDVI.wetland %>%
  group_by(id, year) %>%
  filter(year == kartleggingsaar) %>%
  ggplot(aes(x = tilstand, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0.2))+
  facet_grid(region ~ hovedtype)
```

V4 has sparse data and is lacking in some combinations of region and condition level, so we drop it.

NDVI data are bounded between -1 and 1, and thus require modelling with an appropriate method that can handle bounded data. We can transform the variable to be bounded between 0 and 1 and use beta-regression models:
```{r, message=F}
SentinelNDVI.wetland$mean_beta <- (SentinelNDVI.wetland$mean + 1) / 2
# NDVI data from the year of NiN-mapping (and thus with condition assessment) to train the condition models
# we drop V4 for the analysis as it lacks data for most combinations of condition and region, and thus would cause convergence issues
SentinelNDVI.wetland.train <- SentinelNDVI.wetland %>%
  filter(year == kartleggingsaar) %>%
  filter(hovedtype != "V4")

# We run a stepwise-function on the full model including condition, ecosystem type, and region to find the most parsimonious model
model.wetland.cond.Sent <- betareg(mean_beta ~ tilstand_num * region * hovedtype, data = SentinelNDVI.wetland.train)
model.wetland.cond.Sent <- StepBeta(model.wetland.cond.Sent)
summary(model.wetland.cond.Sent)
```

NDVI values do vary between:

- Regions
- Ecosystem types
- Condition classes

It is evident that there are differences between regions. But since we are not interested in the statistics for region differences, we run separate models for every region for ease of interpretation.
```{r, include = F}
rm(model.wetland.cond.Sent)
```

```{r message=FALSE, warning=FALSE}
model.wetland.cond.Sent.N <- betareg(mean_beta ~ tilstand_num * hovedtype, data = SentinelNDVI.wetland.train[SentinelNDVI.wetland.train$region == "Northern Norway", ])
model.wetland.cond.Sent.C <- betareg(mean_beta ~ tilstand_num * hovedtype, data = SentinelNDVI.wetland.train[SentinelNDVI.wetland.train$region == "Central Norway", ])
model.wetland.cond.Sent.W <- betareg(mean_beta ~ tilstand_num * hovedtype, data = SentinelNDVI.wetland.train[SentinelNDVI.wetland.train$region == "Western Norway", ])
model.wetland.cond.Sent.E <- betareg(mean_beta ~ tilstand_num * hovedtype, data = SentinelNDVI.wetland.train[SentinelNDVI.wetland.train$region == "Eastern Norway", ])
model.wetland.cond.Sent.S <- betareg(mean_beta ~ tilstand_num * hovedtype, data = SentinelNDVI.wetland.train[SentinelNDVI.wetland.train$region == "Southern Norway", ])
```

**Northern Norway**
```{r north-nvdi-vs-tilstand-ndviw, message=FALSE, warning=FALSE, fig.cap="NDVI against ecosystem condition for four wetland ecosystems in Northern Norway."}
SentinelNDVI.wetland.train %>%
  filter(region == "Northern Norway") %>%
  ggplot(aes(x = tilstand, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  facet_wrap(~hovedtype)
```
```{r}
summary(model.wetland.cond.Sent.N)$coefficients
```

NDVI in good condition: V10 > V1 > V9 > V3

V1: NDVI decreases as condition deteriorates

V3: NDVI does not change as condition deteriorates

V9 & V10: NDVI increases as condition deteriorates

**Central Norway**
```{r central-nvdi-vs-tilstand-ndviw, message=FALSE, warning=FALSE, fig.cap="NDVI against ecosystem condition for four wetland ecosystems in Central Norway."}
SentinelNDVI.wetland.train %>%
  filter(region == "Central Norway") %>%
  ggplot(aes(x = tilstand, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  facet_wrap(~hovedtype)
```

```{r}
summary(model.wetland.cond.Sent.C)$coefficients
```

NDVI in good condition: V10 > V1 & V9 > V3

V1: NDVI decreases as condition deteriorates

V3, V9 & V10: NDVI increases as condition deteriorates

**Western Norway**
```{r west-nvdi-vs-tilstand-ndviw, message=FALSE, warning=FALSE, fig.cap="NDVI against ecosystem condition for four wetland ecosystems in W-Norway."}
SentinelNDVI.wetland.train %>%
  filter(region == "Western Norway") %>%
  ggplot(aes(x = tilstand, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  facet_wrap(~hovedtype)
```
```{r}
summary(model.wetland.cond.Sent.W)$coefficients

```

NDVI in good condition: V10 > V9 & V3 > V1

V1 & V10: NDVI increases as condition deteriorates

V3: NDVI decreases as condition deteriorates (but really insufficient data)

V9: NDVI does not change as condition deteriorates

**Eastern Norway**
```{r east-nvdi-vs-tilstand-ndviw, message=FALSE, warning=FALSE, fig.cap="NDVI against ecosystem condition for four wetland ecosystems in E-Norway."}
SentinelNDVI.wetland.train %>%
  filter(region == "Eastern Norway") %>%
  ggplot(aes(x = tilstand, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  facet_wrap(~hovedtype)
```
```{r}
summary(model.wetland.cond.Sent.E)$coefficients
```

NDVI in good condition: V10 > V1 > V3 & V9

V1 & V3: NDVI does not change as condition deteriorates

V9 & V10: NDVI increases as condition deteriorates

**Southern Norway**
```{r south-nvdi-vs-tilstand-ndviw, message=FALSE, warning=FALSE, fig.cap="NDVI against ecosystem condition for four wetland ecosystems in S-Norway."}
SentinelNDVI.wetland.train %>%
  filter(region == "Southern Norway") %>%
  ggplot(aes(x = tilstand, y = mean)) +
  geom_violin() +
  geom_point(size = 0.7, shape = 16, color = "grey") +
  facet_wrap(~hovedtype)
```
```{r}
summary(model.wetland.cond.Sent.S)$coefficients
```


NDVI in good condition: V10 > V9 > V1 & V3

V1, V9 & V10: NDVI increases as condition deteriorates

V3: NDVI does not change as condition deteriorates (but also insuffcient data)

<br />
<br />
<hr />

>Overall take home messages:
>
>In semi-natural wetland ecosystems (V9, V10) NDVI increases as ecosystem condition deteriorates, and this is consistent for the entire country. This supports the conclusion from the exploratory analyses that NDVI is indicative of ecological condition in semi-natural wetland ecosystems.
In natural minerotrophic fens (V1) NDVI increases in the South but decreases in the North as ecosystem condition deteriorates. A factor with potential for affecting vegetation composition and productivity, and thus NDVI, is Nitrogen deposition. Nitrogen deposition is higher in Southern parts of Norway than further north, and could thus be responsible for increased NDVI with reduced condition in the South, but it is not clear how Nitrogen deposition and the variables underlying the condition assessment in V1 (Ditches, Alien species, Heavy vehicles, Wear/tear) are connected. Furthermore we are to date lacking documented empirical ground-truthed information about the connection between NDVI and Nitrogen effects in wetlands. In bogs (V3) there is no consistent pattern.

<hr />

### NDVI across time - Sentinel, MODIS & LandSat {#across-time-ndviw}
As a last step, we can investigate how NDVI has changed over time. For this we include data from both MODIS and Landsat in addition to Sentinel-2.

First, there's again some data handling to do. We merge the Sentinel, MODIS, and Landsat data to show the full picture across time. Then we model the time series for each Satellite separately.
```{r results='hide'}
## data handling for time series analysis
# Sentinel time series checked in exploratory analysis script

# checking time series for MODIS
   # ModisNDVI.wetland %>%
   #   group_by(id, year) %>%
   #   filter(mean == max(mean, na.rm = TRUE)) %>%
   #   ggplot(aes(x = year, y = mean)) +
   #   geom_point() +
   #   facet_wrap(~hovedtype)
# 2022 does not stand out as in the Sentinel data, so we keep it
ModisNDVI.wetland <- ModisNDVI.wetland %>%
  group_by(id, year) %>%
  filter(mean == max(mean, na.rm = TRUE))

# checking time series for Landsat
   # LandsatNDVI.wetland %>%
   #   group_by(id, year) %>%
   #   filter(mean == max(mean, na.rm = TRUE)) %>%
   #   ggplot(aes(x = year, y = mean)) +
   #   geom_point() +
   #   facet_wrap(~hovedtype)
# nothing worrying to see here either
LandsatNDVI.wetland <- LandsatNDVI.wetland %>%
  group_by(id, year) %>%
  filter(mean == max(mean, na.rm = TRUE))

# transformation of NDVI scale to beta scale
# SentinelNDVI.wetland$mean_beta <- (SentinelNDVI.wetland$mean + 1) / 2
ModisNDVI.wetland$mean_beta <- (ModisNDVI.wetland$mean + 1) / 2
LandsatNDVI.wetland$mean_beta <- (LandsatNDVI.wetland$mean + 1) / 2

# check if there's any 0s or 1s (which beta cannot handle)
   # summary(SentinelNDVI.wetland$mean_beta)
   # summary(ModisNDVI.wetland$mean_beta)
   # summary(LandsatNDVI.wetland$mean_beta)
# replace 1s in Landsat data with 0.9999
LandsatNDVI.wetland <- LandsatNDVI.wetland %>%
  mutate(mean_beta = replace(mean_beta, mean_beta == 1, 0.9999))

# check if the three Satellite objects have the same structure (for concatenating them)
   # names(SentinelNDVI.wetland)
   # names(ModisNDVI.wetland)
   # names(LandsatNDVI.wetland)
# Sentinel and Landsat have each an extra column -> omit them when concatenating further below
# one column is named slightly differently in the Sentinel data -> rename it
SentinelNDVI.wetland <- SentinelNDVI.wetland %>%
  dplyr::rename("system.index" = "system:index")

# check if they have the same geometry
   # st_crs(SentinelNDVI.wetland)
   # st_crs(ModisNDVI.wetland)
   # st_crs(LandsatNDVI.wetland)
# all good

# add an increment to the year variable to avoid overlapping data being hidden in figures
SentinelNDVI.wetland$year_jit <- SentinelNDVI.wetland$year + 0.3
ModisNDVI.wetland$year_jit <- ModisNDVI.wetland$year - 0.3
LandsatNDVI.wetland$year_jit <- LandsatNDVI.wetland$year

# concatenate the three Satellite objects
allSatNDVI.wetland <- rbind(
  SentinelNDVI.wetland[, !names(SentinelNDVI.wetland) %in% "subtype"],
  ModisNDVI.wetland,
  LandsatNDVI.wetland[, !names(LandsatNDVI.wetland) %in% "column_label"]
)
# add variable for Satellite identity
allSatNDVI.wetland$Sat <- c(
  rep("Sentinel", nrow(SentinelNDVI.wetland)),
  rep("Modis", nrow(ModisNDVI.wetland)),
  rep("Landsat", nrow(LandsatNDVI.wetland))
)
allSatNDVI.wetland$Sat <- factor(allSatNDVI.wetland$Sat, levels = c("Sentinel", "Modis", "Landsat"))
  # levels(allSatNDVI.wetland$Sat)
```


Now we can plot the time series for each main ecosystem type, showing each satellite time series separately:
```{r ndvi-time-series-comparison-ndviw, fig.cap="Comparing the NDVI time series in the three data sets.", fig.height=10}
# plot
allSatNDVI.wetland %>%
  ggplot(aes(x = year_jit, y = mean, color = Sat)) +
  geom_point() +
  facet_wrap(~hovedtype, ncol = 1)
```

It is quite obvious that the NDVI values from the three satellites are not quantitatively comparable. 
They vary both in their placement along the y-axis and in their variance. 
Modis data are absent from the V4-ecosystem type because of a too large pixel size compared to the NiN-polygon sizes. 
In V10, Modis is poorly represented for the same reason.

We can test if there are consistent temporal changes in NDVI by running regressions including year as a covariate.

We first investigate a model testing NDVI as a function of year and main ecosystem type for polygons in good condition, and we do so separately for each satellite.

<!-- RUNTIME approx. 15 min -->
```{r, warning=FALSE, eval=F}
model.wetland.time.GodTilst.Sent <- glmmTMB(mean_beta ~ year * hovedtype + (1 | id), family = beta_family(), data = SentinelNDVI.wetland[SentinelNDVI.wetland$tilstand == "God", ])
model.wetland.time.GodTilst.Modi <- glmmTMB(mean_beta ~ year * hovedtype + (1 | id), family = beta_family(), data = ModisNDVI.wetland[ModisNDVI.wetland$tilstand == "God", ])
model.wetland.time.GodTilst.Land <- glmmTMB(mean_beta ~ year * hovedtype + (1 | id), family = beta_family(), data = LandsatNDVI.wetland[LandsatNDVI.wetland$tilstand == "God", ])
```

```{r, include=FALSE, eval=F}
saveRDS(model.wetland.time.GodTilst.Sent, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.GodTilst.Sent.rds")
saveRDS(model.wetland.time.GodTilst.Modi, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.GodTilst.Modi.rds")
saveRDS(model.wetland.time.GodTilst.Land, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.GodTilst.Land.rds")
```

```{r, include=F}
model.wetland.time.GodTilst.Sent <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.GodTilst.Sent.rds")
model.wetland.time.GodTilst.Modi <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.GodTilst.Modi.rds")
model.wetland.time.GodTilst.Land <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.GodTilst.Land.rds")
```


```{r}
summary(model.wetland.time.GodTilst.Sent)$coefficients$cond
```

```{r}
summary(model.wetland.time.GodTilst.Modi)$coefficients$cond
```

```{r}
summary(model.wetland.time.GodTilst.Land)$coefficients$cond
```

There's an increase in NDVI over time in all three satellite time series in essentially all major wetland ecosystem types in good condition. 
It is worth pointing out though that the model on the MODIS data shows 1/10 of the effect size for the time slope and has way less statistical power compared to Sentinel and Landsat.

Given the systematically higher NDVI-values with decreasing condition in semi-natural wetlands, we may ask the question if the temporal NDVI increase might be stronger with reduced condition?
```{r, warning=FALSE, eval=F}
model.wetland.time.tilst.V9V10.Sent <- glmmTMB(mean_beta ~ year * tilstand + (1 | id), family = beta_family(), data = SentinelNDVI.wetland[SentinelNDVI.wetland$hovedtype %in% c("V9", "V10"), ])
model.wetland.time.tilst.V9V10.Modi <- glmmTMB(mean_beta ~ year * tilstand + (1 | id), family = beta_family(), data = ModisNDVI.wetland[ModisNDVI.wetland$hovedtype %in% c("V9", "V10"), ])
model.wetland.time.tilst.V9V10.Land <- glmmTMB(mean_beta ~ year * tilstand + (1 | id), family = beta_family(), data = LandsatNDVI.wetland[LandsatNDVI.wetland$hovedtype %in% c("V9", "V10"), ])
```

```{r, include=FALSE, eval=F}
saveRDS(model.wetland.time.tilst.V9V10.Sent, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.tilst.V9V10.Sent.rds")
saveRDS(model.wetland.time.tilst.V9V10.Modi, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.tilst.V9V10.Modi.rds")
saveRDS(model.wetland.time.tilst.V9V10.Land, "/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.tilst.V9V10.Land.rds")
```

```{r, include=F}
model.wetland.time.tilst.V9V10.Sent <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.tilst.V9V10.Sent.rds")
model.wetland.time.tilst.V9V10.Modi <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.tilst.V9V10.Modi.rds")
model.wetland.time.tilst.V9V10.Land <- readRDS("/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/cache/model.wetland.time.tilst.V9V10.Land.rds")
```

```{r}
summary(model.wetland.time.tilst.V9V10.Sent)$coefficients$cond
```
```{r}
summary(model.wetland.time.tilst.V9V10.Modi)$coefficients$cond
```
```{r}
summary(model.wetland.time.tilst.V9V10.Land)$coefficients$cond
```

Indeed, the temporal NDVI increase has been stronger in semi-natural wetlands with reduced ecological condition, in both Sentinel and Landsat. 
For MODIS, the time slope is again 1/10 of the slopes in the other two satellite time series, and it is not significant.

## Overall conclusion

NDVI in wetland ecosystem does vary with condition and also with ecosystem type but the variance and thus overlap between condition classes and ecosystem types is large. Especially the semi-natural wetland ecosystems show a very consistent pattern of higher NDVI and larger temporal NDVI increase in sites in reduced ecological condition, which also links well to the registered condition variables behind the lower condition scores (shrub/tree encroachment, low land-use intensity, succession) and thus reduced land-use as the main pressure identified for these systems.
The large variance and thus overlap between condition classes and ecosystem types makes it generally difficult to define useful scaling values for absolute NDVI values.
Since ecological condition also relates to the temporal development of NDVI values in the analyses above, an alternative approach can be to define scaling values for time slopes as for instance has been done for the NDVI indicator in the ecological condition assessment for Norwegian mountains (Framstad et al. 2022 in references above, see coded example at https://ninanor.github.io/IBECA/ndvi-trend_fjell.html).

Beyond these considerations, there are two general issues which limit a more comprehensive and robust application of satellite based NDVI-data in an ecological condition context:

1. We are lacking ecosystem maps for wetland ecosystems
The analysis at hand clearly shows that different wetland ecosystem types display different greenness levels and thus need to be evaluated separately. Thus, we need ecosystem maps, that allow us to treat NDVI values, and temporal changes of these, for at least the different major ecosystem types within wetlands separately.
2. We are lacking a good ecological understanding and ground-truthing for NDVI in wetland ecosystems
Unlike for ecosystems like forests, tundra, savannah and similar, there is little empirical work and ground-truthing data documented that link NDVI values to ecological phenomena in wetlands. 

Here, we need field studies investigating:

- The connection between NDVI and ecological drivers like for example potential effects of Nitrogen deposition. This includes a need for understanding temporal increases in NDVI in ecosystems in good condition.
- How reflectance in different wetland types is affected by how moist the moss layer is at the time of measuring.

The literature suggests a high variability in NDVI measurements from mosses in particular, in part due to moisture content (REF). Minerotrophic wetlands (V1) are more dominated by graminoids than V3, and the moss-layer is generally more visible from above. At the same time, wetlands are generally drier in the western parts of Norway than in the East (REF), so NDVI patterns may, at least in part, be determined by moisture.

In addition, further investigations should test how NDVI-condition pattern vary across biogeographic regions in addition to administrative regions (which are ecologically irrelevant), in order to better understand the results for the administrative regions.



### Eksport {#export-ndviw}
<!-- Export final file. Ideally a georeferenced shape or raster wit indicators values (raw and normalised), reference values and errors. -->
