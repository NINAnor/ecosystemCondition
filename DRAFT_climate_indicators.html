<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Climate indicators</title>

  
   
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="Climate indicators" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Climate indicators" />
  
  
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.4.2/transition.js"></script>
    <script src="libs/bs3compat-0.4.2/tabs.js"></script>
    <script src="libs/bs3compat-0.4.2/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
    <link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
    <script src="libs/datatables-binding-0.27/datatables.js"></script>
    <link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet" />
    <script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script>
    <link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  <style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
      <link rel="stylesheet" href="style.css" />
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<!--bookdown:title:start-->
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Climate indicators</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="climate-indicators" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Climate indicators</h1>
<p><br /></p>
<p><em>Author and date:</em></p>
<p>Anders L. Kolstad</p>
<p>March 2023</p>
<p><br /></p>
<!-- Load all you dependencies here -->
<table>
<thead>
<tr class="header">
<th align="left">Ecosystem</th>
<th align="left">Økologisk.egenskap</th>
<th align="left">ECT.class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">All</td>
<td align="left">Abiotiske egenskaper</td>
<td align="left">Physical state characteristics</td>
</tr>
</tbody>
</table>
<p><br /> <br /></p>
<hr />
<div id="introduction" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Introduction</h2>
<p>This chapters describes the development of a workflow for generating or preparing indicators based on interpolated climate data from <a href="https://senorge.no/">SeNorge</a>.</p>
</div>
<div id="about-the-underlying-data" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> About the underlying data</h2>
<p>The data is in a raster format and extends back to 1957 in the form of multiple interpolated climate variables. The spatial resolution is 1 x 1 km.</p>
<div id="representativity-in-time-and-space" class="section level3" number="1.2.1">
<h3><span class="header-section-number">1.2.1</span> Representativity in time and space</h3>
<p>The data includes the last normal period (1961-1990) which defines the reference condition for climate variables. Therefore the temporal resolution is very good. Also considering the daily resolution of the data.</p>
<p>Spatially, a 1x1 km resolution is sufficient for most climate variables, esp. in homogeneous terrain, but this needs to be evaluation for each variable and scenario specifically.</p>
</div>
<div id="original-units" class="section level3" number="1.2.2">
<h3><span class="header-section-number">1.2.2</span> Original units</h3>
<p>Varied. Specified below for each parameter.</p>
</div>
<div id="temporal-coverage" class="section level3" number="1.2.3">
<h3><span class="header-section-number">1.2.3</span> Temporal coverage</h3>
<p>1957 - present</p>
</div>
<div id="additional-comments-about-the-data-set" class="section level3" number="1.2.4">
<h3><span class="header-section-number">1.2.4</span> Additional comments about the data set</h3>
<p>The data format has recently changed from .BIL to .nc (netcdf) and now a single file contains all the rasters for one year (365 days), and sometimes for multiple variables also.</p>
</div>
</div>
<div id="ecosystem-characteristic" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Ecosystem characteristic</h2>
<div id="norwegian-standard" class="section level3" number="1.3.1">
<h3><span class="header-section-number">1.3.1</span> Norwegian standard</h3>
<p>These variables typically will fall under the <em>abiotiske egenskaper</em> class.</p>
</div>
<div id="seea-ea" class="section level3" number="1.3.2">
<h3><span class="header-section-number">1.3.2</span> SEEA EA</h3>
<p>In SEEA EA, these variables will typically fall under A1 - Physical state characteristics.</p>
</div>
</div>
<div id="collinearities-with-other-indicators" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Collinearities with other indicators</h2>
<p>Climate variables are most likely to be correlated with each other (e.g. temperature and snow). Also, some climate variables are better classed as pressure indicators, and these might have a causal association with several condition indicators.</p>
</div>
<div id="reference-condition-and-values" class="section level2" number="1.5">
<h2><span class="header-section-number">1.5</span> Reference condition and values</h2>
<div id="reference-condition" class="section level3" number="1.5.1">
<h3><span class="header-section-number">1.5.1</span> Reference condition</h3>
<p>The reference condition for climate variables is defined as the last normal period 1961-1990.</p>
</div>
<div id="reference-values-thresholds-for-defining-good-ecological-condition-minimum-andor-maximum-values" class="section level3" number="1.5.2">
<h3><span class="header-section-number">1.5.2</span> Reference values, thresholds for defining <em>good ecological condition</em>, minimum and/or maximum values</h3>
<ul>
<li><p>Un-scaled indicator value = median value over 5 year periods</p></li>
<li><p>Upper reference level (best possible condition) = median value from the reference period</p></li>
<li><p>Thresholds for good ecosystem condition = 2 standard deviation units away from the upper reference level for the climate variable during the reference period.</p></li>
<li><p>Lower reference values (two-directional) = 5 standard deviation units for the climate variable during the reference period (implies linear scaling).</p></li>
</ul>
</div>
</div>
<div id="uncertainties" class="section level2" number="1.6">
<h2><span class="header-section-number">1.6</span> Uncertainties</h2>
<p>For the indicator map (1 x 1 km raster) there is no uncertainty associated with the indicator values. For aggregated indicator values (e.g. for regions), the uncertainty in the indicator value is calculated from the spatial variation in the indicator values via bootstrapping. This might, however, be changed later to the temporal variation between the five years of each period.</p>
</div>
<div id="references" class="section level2" number="1.7">
<h2><span class="header-section-number">1.7</span> References</h2>
<p><a href="https://senorge.no/" class="uri">https://senorge.no/</a></p>
<p><em>rr and tm are being download from:</em> <a href="https://thredds.met.no/thredds/catalog/senorge/seNorge_2018/Archive/catalog.html" class="uri">https://thredds.met.no/thredds/catalog/senorge/seNorge_2018/Archive/catalog.html</a></p>
<div id="additional-resources" class="section level3" number="1.7.1">
<h3><span class="header-section-number">1.7.1</span> Additional resources</h3>
<p><a href="https://r-spatial.github.io/stars/">Stars package</a></p>
<p><a href="https://tmieno2.github.io/R-as-GIS-for-Economists/stars-basics.html">R as a GIS for economists</a> chapter 7</p>
<p><hl/></p>
</div>
</div>
<div id="analyses" class="section level2" number="1.8">
<h2><span class="header-section-number">1.8</span> Analyses</h2>
<div id="data-set" class="section level3" number="1.8.1">
<h3><span class="header-section-number">1.8.1</span> Data set</h3>
<p>The data is downloaded to a local NINA server, and updated regularly.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dir <span class="sc">==</span> <span class="st">&quot;C:&quot;</span>, </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;R:/GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original&quot;</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;/data/R/GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original&quot;</span>)</span></code></pre></div>
<p>This folder contains folder for the different parameters</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(path))</span></code></pre></div>
<pre><code>##  [1] &quot;age&quot;        &quot;fsw&quot;        &quot;gwb_eva&quot;    &quot;gwb_gwtcl&quot;  &quot;gwb_q&quot;     
##  [6] &quot;gwb_sssdev&quot; &quot;gwb_sssrel&quot; &quot;lwc&quot;        &quot;qsw&quot;        &quot;rr_tm&quot;     
## [11] &quot;sd&quot;         &quot;sdfsw&quot;      &quot;swe&quot;</code></pre>
<p>This table explains them in more detail</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>senorgelayers <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">&quot;data/senorgelayers.txt&quot;</span>, </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">delim =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">escape_double =</span> <span class="cn">FALSE</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">trim_ws =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(senorgelayers)</span></code></pre></div>
<div class="figure">
<div id="htmlwidget-90dc9afbde4c14ddfc1f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-90dc9afbde4c14ddfc1f">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],["sdfsw","fsw","sd","age","swe","#swepr","#swepr","qsw","lwc","gwb_q","gwb_eva","gwb_gwtcl","gwb_sssdev","gwb_sssrel","tm","rr"],["16","8","16","8","16","no longer included","16","8","8","16","8","8","16","16","16","16"],[65535,255,65535,255,65535,null,65535,255,255,65535,255,255,32767,65535,65535,65535],[65534,254,null,254,null,null,null,254,254,null,null,null,null,null,null,null],["fresh snow depth","fresh snow","snow depth","snow age","snow water equivalent",null,"snow water equivalent percentage","snow melt","free water content in snow","runoff","evapotranspiration","ground water condition","water capacity of the soil","current water saturation of the soil","temperature","precipitation"],["mm","mm (water equivalent)","mm","number of days since last snowfall","1/10 mm (water equivalent)",null,"1/10 %","mm (water equivalent)","1/10 % free water in the snow layer","1/10 mm","1/10 mm","24h percentile of the normal period","mm in relation to maximum value of the normal period","% of the maximum value of the normal period","celsius","mm"],["Nysnødybde","Nysnø","Snødybde","Snøens alder","Snømengde",null,"Prosentandel swe","Snøsmelting","Snøtilstand","Avrenning","Fordamping","Grunnvannstilstand","Jordas vannkapasitet","Vannmetting i jord","Temperatur","Nedbør"],["Verdier i fil i 16bit integer verdier som angir mm snødybde.","Verdier angir mm vannekvivalent.","Verdier angir mm snødybde.","Verdiene angir antall dager siden siste snøfall.","Verdiene angir 1/10mm vannekvivalent. Altså en verdi på 102 er 10.2 mm vann.",null,"Veldig uklar beskrivelse gitt av NVE. Må sjekkes!","Verdiene angir mm vannekvivalent.","Verdien angir i prosent hvor mye fritt vann det er i snøpakka. Oppgitt i 1/10 %. En verdi på 45 er altså 4.5%.","Angir avrenning i 1/10mm vann. En verdi på 34 er altså 3.4 mm.","Angir fordampning i 1/10 mm vann.","Verdien angir hvilken døgnpercentilene i normalperioden som verdien tilhører. Verdiene er her 5, 25, 50, 75 og 95.","Verdien angir lagerkapasiteten (i mm) i forhold til maxverdien registrert i 30 årsperioden (1981-2010). Negativ verdi betyr altså at dagens vannlager verdi er over maxverdien.","Dagens vannlager verdi i prosent av den samme maksimale verdien som brukes i gwb_ssdev. En verdi over 100 angir altså at maksverdien er overskredet.","Verdien angir grader i Celsius (re-skalert fra tiendels Kelvin, der en verdi på 2811 er (2811-2731)/10 = 8.0 C.","Verdien angir nedbør i mm (re-skalert fra tiendels mm)."],["gt_Meteorology_Norway_seNorge_FreshSnowDepth_days","gt_Meteorology_Norway_seNorge_FreshSnow_days","gt_Meteorology_Norway_seNorge_SnowDepth_days","gt_Meteorology_Norway_seNorge_SnowAge_days","gt_Meteorology_Norway_seNorge_SnowAmount_days",null,"gt_Meteorology_Norway_seNorge_SnowAmountPercentage_days","gt_Meteorology_Norway_seNorge_SnowMelt_days","gt_Meteorology_Norway_seNorge_SnowFreeWaterContent_days","gt_Meteorology_Norway_seNorge_Runoff_days","gt_Meteorology_Norway_seNorge_Evapotranspiration_days","gt_Meteorology_Norway_seNorge_GroundWaterCondition_days","gt_Meteorology_Norway_seNorge_WaterCapacitySoil_days","gt_Meteorology_Norway_seNorge_WaterSaturationSoil_days","gt_Meteorology_Norway_seNorge_Temperature_days","gt_Meteorology_Norway_seNorge_Precipitation_days"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,"celsius","precipitation_daily"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>abbrev<\/th>\n      <th>bit<\/th>\n      <th>nodata<\/th>\n      <th>bare_ground<\/th>\n      <th>name<\/th>\n      <th>unit<\/th>\n      <th>navn<\/th>\n      <th>beskrivelse<\/th>\n      <th>grass_mapset<\/th>\n      <th>color_table<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p class="caption">
(#fig:unnamed-chunk-5)Table explaining the available climate parameters in the data set.
</p>
</div>
<p>Here is the content of one of these folders (first 10 entries)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(files_tm <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">paste0</span>(path, <span class="st">&quot;/rr_tm&quot;</span>)))[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1] &quot;seNorge2018_1957.nc&quot; &quot;seNorge2018_1958.nc&quot; &quot;seNorge2018_1959.nc&quot;
##  [4] &quot;seNorge2018_1960.nc&quot; &quot;seNorge2018_1961.nc&quot; &quot;seNorge2018_1962.nc&quot;
##  [7] &quot;seNorge2018_1963.nc&quot; &quot;seNorge2018_1964.nc&quot; &quot;seNorge2018_1965.nc&quot;
## [10] &quot;seNorge2018_1966.nc&quot;</code></pre>
<p>There are 67 files, i.e. 67 years of data, one file per year.</p>
<p>Importing (proxy) file:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tg_1957 <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">read_ncdf</span>(<span class="fu">paste0</span>(path, <span class="st">&quot;/rr_tm/seNorge2018_1957.nc&quot;</span>),</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">var=</span><span class="st">&quot;tg&quot;</span>)</span></code></pre></div>
<pre><code>## Large netcdf source found, returning proxy object.</code></pre>
<p>I know the CRS, so setting it manually. Although I cannot rule out 32633, I don’t think it matters.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(tg_1957) <span class="ot">&lt;-</span> <span class="dv">25833</span></span></code></pre></div>
<p>The data has three dimension</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(tg_1957)</span></code></pre></div>
<pre><code>##    X    Y time 
## 1195 1550  365</code></pre>
<p>Initially the data had four attributes, but I subsettet to only include <em>tg</em>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tg_1957)</span></code></pre></div>
<pre><code>## [1] &quot;tg&quot;</code></pre>
<p><code>tg_1957</code> is a stars proxy object and <a href="https://r-spatial.github.io/stars/articles/stars8.html">most commands</a> will not initiate any change until later, typically I write to file and all the lazy operations are done in squeal. Therefore, I will prepare a test data set, which is smaller and which I can import to memory. Then I can perform the operations on that data set and we can see the results.</p>
<div id="dummy-data" class="section level4" number="1.8.1.1">
<h4><span class="header-section-number">1.8.1.1</span> Dummy data</h4>
<p>This test data is included in the {stars} package</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>tif <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="at">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="st">&quot;1970-05-31&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">read_stars</span>(<span class="fu">c</span>(tif, tif, tif, tif), <span class="at">along =</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">list</span>(<span class="at">time =</span> <span class="fu">c</span>(t1, t1<span class="sc">+</span><span class="dv">1</span>, t1<span class="sc">+</span><span class="dv">50</span>, t1<span class="sc">+</span><span class="dv">100</span>)), </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">RasterIO =</span> <span class="fu">list</span>(<span class="at">nXOff =</span> <span class="fu">c</span>(<span class="dv">1</span>), </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nYOff =</span> <span class="fu">c</span>(<span class="dv">1</span>), </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nXSize =</span> <span class="dv">50</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nYSize =</span> <span class="dv">50</span>, </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bands =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)))</span></code></pre></div>
<p>A single attribute</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;L7_ETMs.tif&quot;</code></pre>
<p>I can rename it like this</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">setNames</span>(x, <span class="st">&quot;Attribute_A&quot;</span>)</span></code></pre></div>
<p>And I can add another dummy attribute.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">&quot;Attribute_B&quot;</span> <span class="ot">=</span> Attribute_A<span class="sc">/</span><span class="dv">2</span>)</span></code></pre></div>
<p>The dummy data also has four dimensions</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(x)</span></code></pre></div>
<pre><code>##    x    y band time 
##   50   50    6    4</code></pre>
<p>X and y area the coordinates. Band is an integer:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(x, <span class="st">&quot;band&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 1 2 3 4 5 6</code></pre>
<p>I will remove the <em>band</em> dimension.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">filter</span>(band<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">adrop</span>()</span></code></pre></div>
<p>Time is four dates covering four months in 1970:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(oldTime <span class="ot">&lt;-</span> <span class="fu">st_get_dimension_values</span>(x, <span class="st">&quot;time&quot;</span>))</span></code></pre></div>
<pre><code>## [1] &quot;1970-05-31&quot; &quot;1970-06-01&quot; &quot;1970-07-20&quot; &quot;1970-09-08&quot;</code></pre>
<p>I’ll add some extra seasonal variation between to the mix</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>Attribute_A[,,<span class="dv">2</span>] <span class="ot">&lt;-</span> x<span class="sc">$</span>Attribute_A[,,<span class="dv">1</span>]<span class="sc">*</span><span class="fl">1.2</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>Attribute_A[,,<span class="dv">3</span>] <span class="ot">&lt;-</span> x<span class="sc">$</span>Attribute_A[,,<span class="dv">1</span>]<span class="sc">*</span><span class="fl">1.4</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>Attribute_A[,,<span class="dv">4</span>] <span class="ot">&lt;-</span> x<span class="sc">$</span>Attribute_A[,,<span class="dv">1</span>]<span class="sc">*</span><span class="fl">1.1</span></span></code></pre></div>
<p>Now I create another four copies of this data, adding some random noise and a continuous decreasing trend.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to add random noise</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>myRandom <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x<span class="sc">*</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">1</span>,.<span class="dv">05</span>)</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> x</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>y2 <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, myRandom) <span class="sc">%&gt;%</span> <span class="fu">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, <span class="at">values =</span> oldTime <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="sc">-</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Attribute_A =</span> Attribute_A<span class="sc">*</span><span class="fl">0.95</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>y3 <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, myRandom) <span class="sc">%&gt;%</span> <span class="fu">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, <span class="at">values =</span> oldTime <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="sc">-</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Attribute_A =</span> Attribute_A<span class="sc">*</span><span class="fl">0.90</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>y4 <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, myRandom) <span class="sc">%&gt;%</span> <span class="fu">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, <span class="at">values =</span> oldTime <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="sc">-</span><span class="dv">3</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Attribute_A =</span> Attribute_A<span class="sc">*</span><span class="fl">0.85</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>y5 <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, myRandom) <span class="sc">%&gt;%</span> <span class="fu">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, <span class="at">values =</span> oldTime <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="sc">-</span><span class="dv">4</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Attribute_A =</span> Attribute_A<span class="sc">*</span><span class="fl">0.80</span>)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We combine the data into one cube for plotting:</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">c</span>(y1, y2, y3, y4, y5) </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> temp) <span class="sc">+</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>) <span class="sc">+</span>  </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>time, <span class="at">ncol=</span><span class="dv">4</span>)</span></code></pre></div>
<p><img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>Saving these to file.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="st">&quot;P:/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data&quot;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(y1, <span class="fu">paste0</span>(path, <span class="st">&quot;/y1.rds&quot;</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(y2, <span class="fu">paste0</span>(path, <span class="st">&quot;/y2.rds&quot;</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(y3, <span class="fu">paste0</span>(path, <span class="st">&quot;/y3.rds&quot;</span>))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(y4, <span class="fu">paste0</span>(path, <span class="st">&quot;/y4.rds&quot;</span>))</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(y5, <span class="fu">paste0</span>(path, <span class="st">&quot;/y5.rds&quot;</span>))</span></code></pre></div>
<div id="dummy-regions-and-et-map" class="section level5" number="1.8.1.1.1">
<h5><span class="header-section-number">1.8.1.1.1</span> Dummy regions and ET map</h5>
<p>Here is some dummy data for accounting areas (regions) and ecosystem occurrences as well, in case I need them later.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>dummy_aa <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">==</span> oldTime[<span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adrop</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">accountingAreas =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">each=</span><span class="fu">length</span>(Attribute_A)<span class="sc">/</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(accountingAreas)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(dummy_aa) <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="at">style=</span><span class="st">&quot;cat&quot;</span>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-24-1.png" alt="Showing the example account area delineation (raster format)" width="672" />
<p class="caption">
(#fig:unnamed-chunk-24)Showing the example account area delineation (raster format)
</p>
</div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dummy_et <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">==</span> oldTime[<span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adrop</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ecosystemType =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="cn">NA</span>), <span class="at">length.out =</span> <span class="fu">length</span>(Attribute_A))) <span class="sc">%&gt;%</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ecosystemType)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(dummy_et) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="at">style=</span><span class="st">&quot;cat&quot;</span>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-25-1.png" alt="Showing the example Ecosystem type delineation data." width="672" />
<p class="caption">
(#fig:unnamed-chunk-25)Showing the example Ecosystem type delineation data.
</p>
</div>
</div>
</div>
<div id="regions" class="section level4" number="1.8.1.2">
<h4><span class="header-section-number">1.8.1.2</span> Regions</h4>
<p>Importing a shape file with the regional delineation.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;data/regions.shp&quot;</span>, <span class="at">options =</span> <span class="st">&quot;ENCODING=UTF8&quot;</span>)</span></code></pre></div>
<pre><code>## options:        ENCODING=UTF8 
## Reading layer `regions&#39; from data source 
##   `/data/scratch/Matt_bookdown__debug/ecosystemCondition/data/regions.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 5 features and 2 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: -99551.21 ymin: 6426048 xmax: 1121941 ymax: 7962744
## Projected CRS: ETRS89 / UTM zone 33N</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#st_crs(reg)</span></span></code></pre></div>
<p>Outline of Norway</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>nor <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;data/outlineOfNorway_EPSG25833.shp&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `outlineOfNorway_EPSG25833&#39; from data source 
##   `/data/scratch/Matt_bookdown__debug/ecosystemCondition/data/outlineOfNorway_EPSG25833.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 1 feature and 2 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -113472.7 ymin: 6448359 xmax: 1114618 ymax: 7939917
## Projected CRS: ETRS89 / UTM zone 33N</code></pre>
<p>Remove marine areas from regions</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(reg, nor)</span></code></pre></div>
<pre><code>## Warning: attribute variables are assumed to be spatially constant throughout
## all geometries</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(reg) <span class="sc">+</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="st">&quot;region&quot;</span>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-29-1.png" alt="Five accounting areas (regions) in Norway." width="672" />
<p class="caption">
(#fig:unnamed-chunk-29)Five accounting areas (regions) in Norway.
</p>
</div>
</div>
<div id="ecosystem-map" class="section level4" number="1.8.1.3">
<h4><span class="header-section-number">1.8.1.3</span> Ecosystem map</h4>
<p>Coming soon ….</p>
<p>The climate indicators need to be masked with ecosystem type maps. This step is part of this chapter.</p>
</div>
</div>
</div>
<div id="section" class="section level2" number="1.9">
<h2><span class="header-section-number">1.9</span> ————————————————–</h2>
<div id="conceptual-workflow" class="section level3" number="1.9.1">
<h3><span class="header-section-number">1.9.1</span> Conceptual workflow</h3>
<p>The general, the conceptual workflow is like this:</p>
<ol style="list-style-type: decimal">
<li><p>Collate variable data series</p>
<ul>
<li><p>Import .nc files (loop though year 1961-1990) and subset to the correct attribute</p></li>
<li><p>Filter data by dates (optional) (<code>dplyr::filter</code>). <em>This means reading all 365 rasters into memory, and it is much quicker to filter out the correct rasters in the importing step above (see examples later in this chapter)</em></p></li>
<li><p>Aggregate across time within a year (<code>stars::st_apply</code>). <em>This is the most time consuming operation in the workflow.</em></p></li>
<li><p>Join all data into one data cube (<code>stars:c</code>)</p></li>
</ul></li>
<li><p>Calculate reference values</p>
<ul>
<li><p>Aggregate (<code>st_apply)</code> across reference years (<code>dplyr::filter</code>) to get median and sd values</p></li>
<li><p>Join with existing data cube (<code>stars:c</code>)</p></li>
</ul></li>
<li><p>Calculate indicator values</p>
<ul>
<li>Normalize climate variable at the individual grid cell level using the three reference values (<code>mutate(across()))</code></li>
</ul></li>
<li><p>Mask by ecosystem type (<em>This could also be done in step one, but it doesn’t speed things up to set some cells to NA</em>)</p></li>
<li><p>Aggregate in space (to accounting areas) (<em>zonal statistics</em>)</p>
<ul>
<li><p>Aggregate across 5 year time steps to smooth out random inter-annual variation and leave climate signal</p></li>
<li><p>Intersect with accounting area polygons <code>exactextrar::exact_extract</code> and get mean/median and (spatial) sd. (<em>Alternatively, get temporal sd at the grid cell level in the step above.</em>)</p></li>
</ul></li>
<li><p>Make trend figure and spatially aggregated maps,</p></li>
</ol>
</div>
<div id="collate-variable-data-series" class="section level3" number="1.9.2">
<h3><span class="header-section-number">1.9.2</span> 1. Collate variable data series</h3>
<p>I include a for loop for importing the .nc files at the end.</p>
<div id="filter-data-by-dates" class="section level4" number="1.9.2.1">
<h4><span class="header-section-number">1.9.2.1</span> Filter data by dates</h4>
<p>Say we want to calculate the mean summer temperature. We then want to exclude the data for the times that is not withing our definition of summer.</p>
<p>Let’s try it on the dummy data. Remember this data had four time steps.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(x, <span class="st">&quot;time&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;1970-05-31&quot; &quot;1970-06-01&quot; &quot;1970-07-20&quot; &quot;1970-09-08&quot;</code></pre>
<p>Our real data has 365 time steps for each year.</p>
<p>First I define my start and end dates. I want to keep only the summer data, defined as jun - aug.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>start_month <span class="ot">&lt;-</span>  <span class="st">&quot;06&quot;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>end_month <span class="ot">&lt;-</span> <span class="st">&quot;08&quot;</span></span></code></pre></div>
<p>Then for each iteration I need to get the year as well</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(year_temp <span class="ot">&lt;-</span> <span class="fu">year</span>(<span class="fu">st_get_dimension_values</span>(x, <span class="st">&quot;time&quot;</span>)[<span class="dv">1</span>]))</span></code></pre></div>
<pre><code>## [1] 1970</code></pre>
<p>Then I can create a time interval object</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">ym</span>(<span class="fu">paste</span>(year_temp, start_month, <span class="at">sep=</span><span class="st">&quot;-&quot;</span>))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span>  <span class="fu">ym</span>(<span class="fu">paste</span>(year_temp, end_month, <span class="at">sep=</span><span class="st">&quot;-&quot;</span>))</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>(myInterval <span class="ot">&lt;-</span> <span class="fu">interval</span>(start, end))</span></code></pre></div>
<pre><code>## [1] 1970-06-01 UTC--1970-08-01 UTC</code></pre>
<p>Then I filter</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>x_aug <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Attribute_A) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adrop</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">%within%</span> myInterval)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(x_aug, <span class="st">&quot;time&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;1970-06-01&quot; &quot;1970-07-20&quot;</code></pre>
<p><em>Later I discover that `dplyr::filter` work after reading the whole object to file, and therefor it is too slow for our use. I therefore filter data a different way further down.</em></p>
</div>
<div id="aggregate-across-time-within-a-year" class="section level4" number="1.9.2.2">
<h4><span class="header-section-number">1.9.2.2</span> Aggregate across time within a year</h4>
<p>For this example I want to calculate the mean temperature over the summer. I therefore need to aggregate over time. Many climate indicators will need this functionality. There are two ways, either using <code>st_apply</code> or using <code>aggregate</code>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>temp_names <span class="ot">&lt;-</span> <span class="fu">year</span>(<span class="fu">st_get_dimension_values</span>(x_aug, <span class="st">&quot;time&quot;</span>)[<span class="dv">1</span>])</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>microOut <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="at">st_apply =</span>  x_aug <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean) <span class="sc">%&gt;%</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="st">&quot;v_&quot;</span>,temp_names)),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="at">aggregate =</span> x_aug <span class="sc">%&gt;%</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate</span>(<span class="at">by =</span> <span class="st">&quot;year&quot;</span>, mean),</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="at">times=</span><span class="dv">30</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The time dimension is now gone as we have aggregated across it.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(microOut)</span></code></pre></div>
<pre><code>## Coordinate system already present. Adding new coordinate system, which will
## replace the existing one.</code></pre>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-36-1.png" alt="Comparing computation tome for two spatial aggregation functions." width="672" />
<p class="caption">
(#fig:unnamed-chunk-36)Comparing computation tome for two spatial aggregation functions.
</p>
</div>
<p><code>st_apply</code> is slightly faster, but <code>aggregate</code> has the advantage of that it retains the time dimension, whereas for <code>st_apply</code> I need to set the attribute name to be the year. I will try to use <code>st_apply</code>.</p>
<p>But let me see if I can save time by masking to ET before doing this operation.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>x_masked <span class="ot">&lt;-</span> x_aug</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>x_masked[<span class="fu">is.na</span>(dummy_et)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x_masked[,,,<span class="dv">1</span>])</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-37-1.png" alt="Demonstrating the effect of maskig the dummy data using a perfectly aligne raster ET map." width="672" />
<p class="caption">
(#fig:unnamed-chunk-37)Demonstrating the effect of maskig the dummy data using a perfectly aligne raster ET map.
</p>
</div>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">microbenchmark</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="at">No_masking =</span>  x_aug <span class="sc">%&gt;%</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean) <span class="sc">%&gt;%</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="st">&quot;v_&quot;</span>,temp_names)),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="at">Masking =</span>  x_masked <span class="sc">%&gt;%</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean) <span class="sc">%&gt;%</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="st">&quot;v_&quot;</span>,temp_names))</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a> ), <span class="at">times=</span><span class="dv">30</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Coordinate system already present. Adding new coordinate system, which will
## replace the existing one.</code></pre>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/withMasking-1.png" alt="Comparing computation time before and after masking of raster data. There is no performance increase by masking before aggregating." width="672" />
<p class="caption">
(#fig:withMasking)Comparing computation time before and after masking of raster data. There is no performance increase by masking before aggregating.
</p>
</div>
<p>Since there is no increase in performance from masking, as we see in Fig. @ref(fig: withMasking) then it basically means we it is slower to mask beforehand, since the masking was not past of the benchmark assessment.</p>
<p>So, this is my solution:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># setNames dont work on stars proxy obejct, so I use rename instead</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>lookup <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="st">&quot;mean&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;v_&quot;</span>, temp_names))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>x_summerMean <span class="ot">&lt;-</span>   x_aug <span class="sc">%&gt;%</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean) <span class="sc">%&gt;%</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="fu">all_of</span>(lookup))</span></code></pre></div>
<p>The <em>v_</em> follows the naming convention we have developed for ourselves.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> x_aug) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>time) <span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>) <span class="sc">+</span>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)),  </span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> x_summerMean) <span class="sc">+</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#facet_wrap(~time) +</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>) <span class="sc">+</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-39-1.png" alt="Plotting the dummy data showing Attribute_A for the two dates as small maps, and a larger map showing the mean for year 2018" width="672" />
<p class="caption">
(#fig:unnamed-chunk-39)Plotting the dummy data showing Attribute_A for the two dates as small maps, and a larger map showing the mean for year 2018
</p>
</div>
<p>Here’s the whole first step of the conceptual workflow in action, on the dummy data.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up the parameters</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>dir <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">getwd</span>(), <span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dir <span class="sc">==</span> <span class="st">&quot;C:&quot;</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;P:/&quot;</span>, </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;/data/P-Prosjekter2/&quot;</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(path, </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data&quot;</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>start_month <span class="ot">&lt;-</span>  <span class="st">&quot;06&quot;</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>end_month <span class="ot">&lt;-</span> <span class="st">&quot;08&quot;</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>myFiles <span class="ot">&lt;-</span> <span class="fu">list.files</span>(path2, <span class="at">pattern=</span><span class="st">&quot;.rds&quot;</span>, <span class="at">full.names =</span> T)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>summerTemp_fullSeries <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Looping though the files in the directory</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(myFiles)){</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(myFiles[i]) <span class="sc">%&gt;%</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Attribute_A)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  year_temp <span class="ot">&lt;-</span> <span class="fu">year</span>(<span class="fu">st_get_dimension_values</span>(temp, <span class="st">&quot;time&quot;</span>)[<span class="dv">1</span>])</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">ym</span>(<span class="fu">paste</span>(year_temp, start_month, <span class="at">sep=</span><span class="st">&quot;-&quot;</span>))</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span>  <span class="fu">ym</span>(<span class="fu">paste</span>(year_temp, end_month, <span class="at">sep=</span><span class="st">&quot;-&quot;</span>))</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>  myInterval <span class="ot">&lt;-</span> <span class="fu">interval</span>(start, end)</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>  lookup <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="st">&quot;mean&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;v_&quot;</span>, year_temp))</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> temp <span class="sc">%&gt;%</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(time <span class="sc">%within%</span> myInterval) <span class="sc">%&gt;%</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean) <span class="sc">%&gt;%</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="fu">all_of</span>(lookup))</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>  summerTemp_fullSeries <span class="ot">&lt;-</span> <span class="fu">c</span>(temp, summerTemp_fullSeries)</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(temp) <span class="co"># same computation time with and without this function, but more tidy this way</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn the attributes into a dimension and rename the new attribute</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>summerTemp_fullSeries <span class="ot">&lt;-</span> summerTemp_fullSeries <span class="sc">%&gt;%</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">name=</span><span class="st">&quot;Year&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;Attribute_A&quot;</span>)</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.110   0.020   0.157</code></pre>
<p>And this is the result.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> summerTemp_fullSeries) <span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>) <span class="sc">+</span>  </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Year)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-41-1.png" alt="Temporal aggregation on the dummy data set." width="672" />
<p class="caption">
(#fig:unnamed-chunk-41)Temporal aggregation on the dummy data set.
</p>
</div>
<p>Now let’s try it on the real data.</p>
<p><em>I initially tried to read stars proxy object and add steps to the call_list and execute these with <code>st_as_stars</code>, but this still returned proxy objects. Therefore I read the whole file in without proxy. To save time I can subset based on Julian dates.</em></p>
<p>I will use <a href="https://tmieno2.github.io/R-as-GIS-for-Economists/EE.html">parallelization</a> to speed things up.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> path <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dir <span class="sc">==</span> <span class="st">&quot;C:&quot;</span>, </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;R:/&quot;</span>,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;/data/R/&quot;</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(path, <span class="st">&quot;GeoSpatialData/Meteorology/Norway_SeNorge2018_v22.09/Original/rr_tm/&quot;</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>myFiles <span class="ot">&lt;-</span> <span class="fu">list.files</span>(path2, <span class="at">pattern=</span><span class="st">&quot;.nc$&quot;</span>,<span class="at">full.names =</span> T)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># The last file (the last year) is incomplete and don&#39;t include all julian dates that we select below, so I will not include it:</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>myFiles <span class="ot">&lt;-</span> myFiles[<span class="sc">-</span><span class="fu">length</span>(myFiles)]</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>real_temp_summer <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co"># set up parallel cluster using 10 cores</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(10L)</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Get julian days after defining months</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">read_ncdf</span>(<span class="fu">paste</span>(myFiles[<span class="dv">1</span>]), <span class="at">var=</span><span class="st">&quot;tg&quot;</span>)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>start_month_num <span class="ot">&lt;-</span>  <span class="dv">6</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>end_month_num <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>julian_start <span class="ot">&lt;-</span> <span class="fu">yday</span>(<span class="fu">st_get_dimension_values</span>(temp, <span class="st">&quot;time&quot;</span>)[<span class="dv">1</span>] <span class="sc">%m+%</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">months</span>(<span class="sc">+</span>start_month_num))</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>julian_end <span class="ot">&lt;-</span> <span class="fu">yday</span>(<span class="fu">st_get_dimension_values</span>(temp, <span class="st">&quot;time&quot;</span>)[<span class="dv">1</span>] <span class="sc">%m+%</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">months</span>(<span class="sc">+</span>end_month_num))</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>step <span class="ot">&lt;-</span> julian_end<span class="sc">-</span>julian_start</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(myFiles)){</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>(<span class="st">&quot;init&quot;</span>)</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">read_ncdf</span>(<span class="fu">paste</span>(myFiles[i]), <span class="at">var=</span><span class="st">&quot;tg&quot;</span>, <span class="at">proxy=</span>F,</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncsub =</span> <span class="fu">cbind</span>(<span class="at">start =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, julian_start), </span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>                              <span class="at">count =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, step)))</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>  year_temp <span class="ot">&lt;-</span> <span class="fu">year</span>(<span class="fu">st_get_dimension_values</span>(temp, <span class="st">&quot;time&quot;</span>)[<span class="dv">1</span>])</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(year_temp)</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>  lookup <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="st">&quot;mean&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;v_&quot;</span>, year_temp)) </span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perhaps leave out the v_ to get a numeric vector instead, </span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># which is easier to subset</span></span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_crs</span>(temp) <span class="ot">&lt;-</span> <span class="dv">25833</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toc</span>()</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>(<span class="st">&quot;filter and st_apply&quot;</span>)</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> temp <span class="sc">%&gt;%</span></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean, <span class="at">CLUSTER =</span> cl) <span class="sc">%&gt;%</span></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="fu">all_of</span>(lookup)) </span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toc</span>()</span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>(<span class="st">&quot;c()&quot;</span>)</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>  real_temp_summer <span class="ot">&lt;-</span> <span class="fu">c</span>(temp, real_temp_summer)</span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rm(temp)</span></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toc</span>()</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="st">&quot;Merge&quot;</span>)</span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>real_temp_summer <span class="ot">&lt;-</span> real_temp_summer <span class="sc">%&gt;%</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(<span class="at">name =</span> <span class="st">&quot;Year&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;climate_variable&quot;</span>)</span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code></pre></div>
<p>This takes about 20 sec per file/year, or 22 min on total. That is not too bad. About 6000 raster are read into memory. Here’s a test for the effect of splitting over more cores.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(2L)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>cl2 <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(6L)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>cl3 <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(10L)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="st">&quot;No cluster&quot;</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>temp <span class="sc">%&gt;%</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean) <span class="sc">%&gt;%</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="fu">all_of</span>(lookup)) </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="st">&quot;Two clusters&quot;</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>temp <span class="sc">%&gt;%</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean, <span class="at">CLUSTER =</span> cl) <span class="sc">%&gt;%</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="fu">all_of</span>(lookup)) </span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="st">&quot;Six clusters&quot;</span>)</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>temp <span class="sc">%&gt;%</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean, <span class="at">CLUSTER =</span> cl2) <span class="sc">%&gt;%</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="fu">all_of</span>(lookup)) </span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl2)</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="st">&quot;Ten clusters&quot;</span>)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>temp <span class="sc">%&gt;%</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#filter(time %within% myInterval) %&gt;%</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_apply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, mean, <span class="at">CLUSTER =</span> cl3) <span class="sc">%&gt;%</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="fu">all_of</span>(lookup)) </span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl3)</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<ul>
<li><p>No cluster: 21.401 sec elapsed</p></li>
<li><p>Two clusters: 21.546 sec elapsed</p></li>
<li><p>Six clusters: 14.548 sec elapsed</p></li>
<li><p>Ten clusters: 15.29 sec elapsed</p></li>
<li><p>Ten clusters (second run): 13.617 sec elapsed</p></li>
</ul>
<p>The RStudio server has 48 cores. More parallel cores is probably on average faster. The NINA guidelines is to use max 10 cores, and to remember to close parallel cluster when done.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(real_temp_summer, <span class="st">&quot;/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp.rds&quot;</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stars</span>(real_temp_summer, <span class="st">&quot;/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp.tiff&quot;</span>)</span></code></pre></div>
<p>These files are about 500 MB, but the tiff file reads in a lot quicker then the rds file, so from now on I’ll just export as tiff. <em>(This could perhaps have been solved with a <code>gc()</code>,. Later I save as RData with no problems).</em></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>summer_median_temp <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(<span class="st">&quot;/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/temp_median_summer.tiff&quot;</span>,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">proxy=</span>F)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This is too slow:</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># readRDS(&quot;/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data/summer_median_temp.rds&quot;)</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># but it could be that RData works better </span></span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(summer_median_temp)</span></code></pre></div>
<pre><code>## [1] &quot;temp_median_summer.tiff&quot;</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(summer_median_temp)</span></code></pre></div>
<pre><code>##    x    y band 
## 1195 1550   66</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(summer_median_temp, <span class="st">&quot;Year&quot;</span>)</span></code></pre></div>
<pre><code>## NULL</code></pre>
<p>Note that GTiff automatically renames the third dimension <em>band</em> and also renames the attribute.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(summer_median_temp, <span class="st">&quot;band&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;v_2022&quot; &quot;v_2021&quot; &quot;v_2020&quot; &quot;v_2019&quot; &quot;v_2018&quot; &quot;v_2017&quot; &quot;v_2016&quot; &quot;v_2015&quot;
##  [9] &quot;v_2014&quot; &quot;v_2013&quot; &quot;v_2012&quot; &quot;v_2011&quot; &quot;v_2010&quot; &quot;v_2009&quot; &quot;v_2008&quot; &quot;v_2007&quot;
## [17] &quot;v_2006&quot; &quot;v_2005&quot; &quot;v_2004&quot; &quot;v_2003&quot; &quot;v_2002&quot; &quot;v_2001&quot; &quot;v_2000&quot; &quot;v_1999&quot;
## [25] &quot;v_1998&quot; &quot;v_1997&quot; &quot;v_1996&quot; &quot;v_1995&quot; &quot;v_1994&quot; &quot;v_1993&quot; &quot;v_1992&quot; &quot;v_1991&quot;
## [33] &quot;v_1990&quot; &quot;v_1989&quot; &quot;v_1988&quot; &quot;v_1987&quot; &quot;v_1986&quot; &quot;v_1985&quot; &quot;v_1984&quot; &quot;v_1983&quot;
## [41] &quot;v_1982&quot; &quot;v_1981&quot; &quot;v_1980&quot; &quot;v_1979&quot; &quot;v_1978&quot; &quot;v_1977&quot; &quot;v_1976&quot; &quot;v_1975&quot;
## [49] &quot;v_1974&quot; &quot;v_1973&quot; &quot;v_1972&quot; &quot;v_1971&quot; &quot;v_1970&quot; &quot;v_1969&quot; &quot;v_1968&quot; &quot;v_1967&quot;
## [57] &quot;v_1966&quot; &quot;v_1965&quot; &quot;v_1964&quot; &quot;v_1963&quot; &quot;v_1962&quot; &quot;v_1961&quot; &quot;v_1960&quot; &quot;v_1959&quot;
## [65] &quot;v_1958&quot; &quot;v_1957&quot;</code></pre>
<p>I can rename them.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>summer_median_temp <span class="ot">&lt;-</span> summer_median_temp <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_dimensions</span>(<span class="at">names =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;v_YEAR&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;temperature&quot;</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(summer_median_temp)</span></code></pre></div>
<pre><code>##      x      y v_YEAR 
##   1195   1550     66</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> summer_median_temp[,,,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">11</span>,<span class="dv">22</span>)], <span class="at">downsample =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>) <span class="sc">+</span>  </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>v_YEAR)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-51-1.png" alt="Showing three random slices of the year dimension." width="672" />
<p class="caption">
(#fig:unnamed-chunk-51)Showing three random slices of the year dimension.
</p>
</div>
</div>
</div>
<div id="calculate-reference-values" class="section level3" number="1.9.3">
<h3><span class="header-section-number">1.9.3</span> 2. Calculate reference values</h3>
<div id="aggregate-across-reference-years" class="section level4" number="1.9.3.1">
<h4><span class="header-section-number">1.9.3.1</span> Aggregate across reference years</h4>
<p>We need to first to define a reference period and then to subset our data <code>summer_median_temp</code>. We can practice on the dummy data <code>y</code>.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>dir <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">getwd</span>(), <span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dir <span class="sc">==</span> <span class="st">&quot;C:&quot;</span>,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;P:/&quot;</span>, </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;/data/P-Prosjekter2/&quot;</span>)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(path, </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;41201785_okologisk_tilstand_2022_2023/data/climate_indicators/dummy_data&quot;</span>)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>myFiles <span class="ot">&lt;-</span> <span class="fu">list.files</span>(path2, <span class="at">pattern=</span><span class="st">&quot;.rds&quot;</span>, <span class="at">full.names =</span> T)</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Looping though the files in the directory</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(myFiles)){</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(myFiles[i])</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">c</span>(temp, y)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(y, <span class="st">&quot;time&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;1966-05-31&quot; &quot;1966-06-01&quot; &quot;1966-07-20&quot; &quot;1966-09-08&quot; &quot;1967-05-31&quot;
##  [6] &quot;1967-06-01&quot; &quot;1967-07-20&quot; &quot;1967-09-08&quot; &quot;1968-05-31&quot; &quot;1968-06-01&quot;
## [11] &quot;1968-07-20&quot; &quot;1968-09-08&quot; &quot;1969-05-31&quot; &quot;1969-06-01&quot; &quot;1969-07-20&quot;
## [16] &quot;1969-09-08&quot; &quot;1970-05-31&quot; &quot;1970-06-01&quot; &quot;1970-07-20&quot; &quot;1970-09-08&quot;</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>y_filtered <span class="ot">&lt;-</span> y <span class="sc">%&gt;%</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Attribute_A) <span class="sc">%&gt;%</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">%within%</span> <span class="fu">interval</span>(<span class="st">&quot;1961-01-01&quot;</span>, <span class="st">&quot;1990-12-31&quot;</span>))</span></code></pre></div>
<p>Now we aggregate across years, again using st_apply.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>median_sd <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { <span class="fu">c</span>(<span class="at">median =</span> <span class="fu">median</span>(x), <span class="at">sd =</span> <span class="fu">sd</span>(x))}</span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>y_ref <span class="ot">&lt;-</span> y_filtered <span class="sc">%&gt;%</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_apply</span>(<span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">FUN =</span>  median_sd)</span></code></pre></div>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(y_ref)</span></code></pre></div>
<pre><code>## median_sd         x         y 
##         2        50        50</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(y_ref, <span class="st">&quot;median_sd&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;median&quot; &quot;sd&quot;</code></pre>
<p>It’s perhaps easier if median and sd are unique attributes, rather than levels of a dimension.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>y_ref <span class="ot">&lt;-</span> y_ref <span class="sc">%&gt;%</span> <span class="fu">split</span>(<span class="st">&quot;median_sd&quot;</span>)</span></code></pre></div>
<p>The attribute name <em>mean</em> we can change this to something more meaningful.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>y_ref <span class="ot">&lt;-</span> <span class="fu">setNames</span>(y_ref, <span class="fu">c</span>(<span class="st">&quot;reference_upper&quot;</span>, <span class="st">&quot;sd&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(y_ref)<span class="sc">+</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="st">&quot;reference_upper&quot;</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>,</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(y_ref)<span class="sc">+</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="st">&quot;sd&quot;</span>,</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">palette =</span> <span class="st">&quot;-viridis&quot;</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-61-1.png" alt="Showing the upper reference levels and the standard deviation from the dummy data set." width="672" />
<p class="caption">
(#fig:unnamed-chunk-61)Showing the upper reference levels and the standard deviation from the dummy data set.
</p>
</div>
<p>Let’s transfer this over to the real data. First we need to rename our dimension values and turn them back into dates.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>new_dims <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">substr</span>(<span class="fu">st_get_dimension_values</span>(summer_median_temp, <span class="st">&quot;v_YEAR&quot;</span>), <span class="dv">3</span>, <span class="dv">6</span>), <span class="st">&quot;-01-01&quot;</span>))</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>summer_median_temp_ref <span class="ot">&lt;-</span> summer_median_temp <span class="sc">%&gt;%</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_dimensions</span>(<span class="st">&quot;v_YEAR&quot;</span>, <span class="at">values =</span> new_dims)</span></code></pre></div>
<p>Then I can filter to leave only the reference period.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>summer_median_temp_ref <span class="ot">&lt;-</span> summer_median_temp_ref <span class="sc">%&gt;%</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(v_YEAR <span class="sc">%within%</span> <span class="fu">interval</span>(<span class="st">&quot;1961-01-01&quot;</span>, <span class="st">&quot;1990-12-31&quot;</span>))</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_get_dimension_values</span>(summer_median_temp_ref, <span class="st">&quot;v_YEAR&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;1990-01-01&quot; &quot;1989-01-01&quot; &quot;1988-01-01&quot; &quot;1987-01-01&quot; &quot;1986-01-01&quot;
##  [6] &quot;1985-01-01&quot; &quot;1984-01-01&quot; &quot;1983-01-01&quot; &quot;1982-01-01&quot; &quot;1981-01-01&quot;
## [11] &quot;1980-01-01&quot; &quot;1979-01-01&quot; &quot;1978-01-01&quot; &quot;1977-01-01&quot; &quot;1976-01-01&quot;
## [16] &quot;1975-01-01&quot; &quot;1974-01-01&quot; &quot;1973-01-01&quot; &quot;1972-01-01&quot; &quot;1971-01-01&quot;
## [21] &quot;1970-01-01&quot; &quot;1969-01-01&quot; &quot;1968-01-01&quot; &quot;1967-01-01&quot; &quot;1966-01-01&quot;
## [26] &quot;1965-01-01&quot; &quot;1964-01-01&quot; &quot;1963-01-01&quot; &quot;1962-01-01&quot; &quot;1961-01-01&quot;</code></pre>
<p>And then we calculate the median and sd like above</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(10L)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>summer_median_temp_ref <span class="ot">&lt;-</span> summer_median_temp_ref <span class="sc">%&gt;%</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_apply</span>(<span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">FUN =</span>  median_sd,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">CLUSTER =</span> cl)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th>user</th>
<th>system</th>
<th>elapsed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>9.624</td>
<td>6.069</td>
<td>20.903</td>
</tr>
</tbody>
</table>
<p>This is also something I can export.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write_stars can only export a single attribute </span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="co">#write_stars(summer_median_temp_ref, &quot;/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_ref.tiff&quot;)</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(summer_median_temp_ref, <span class="st">&quot;/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_ref.RData&quot;</span>)</span></code></pre></div>
<p>Pivot and turn dimension into attributes:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>summer_median_temp_ref_long <span class="ot">&lt;-</span> summer_median_temp_ref <span class="sc">%&gt;%</span> <span class="fu">split</span>(<span class="st">&quot;median_sd&quot;</span>)</span></code></pre></div>
<p>The attribute name is <em>mean</em>. We can change this to something more meaningful.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>summer_median_temp_ref_long <span class="ot">&lt;-</span> <span class="fu">setNames</span>(summer_median_temp_ref_long, <span class="fu">c</span>(<span class="st">&quot;reference_upper&quot;</span>, <span class="st">&quot;sd&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(<span class="fu">st_downsample</span>(summer_median_temp_ref_long, <span class="dv">10</span>))<span class="sc">+</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="st">&quot;reference_upper&quot;</span>)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>,</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(<span class="fu">st_downsample</span>(summer_median_temp_ref_long, <span class="dv">10</span>))<span class="sc">+</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="st">&quot;sd&quot;</span>,</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">palette =</span> <span class="st">&quot;-viridis&quot;</span>)</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-69-1.png" alt="Showing the upper reference levels and the standard deviation from actual data of median summer temperatures." width="672" />
<p class="caption">
(#fig:unnamed-chunk-69)Showing the upper reference levels and the standard deviation from actual data of median summer temperatures.
</p>
</div>
</div>
<div id="combine" class="section level4" number="1.9.3.2">
<h4><span class="header-section-number">1.9.3.2</span> Combine</h4>
<p>I need to combine the variables and the ref values in one data cube</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>y_var <span class="ot">&lt;-</span> summer_median_temp <span class="sc">%&gt;%</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(summer_median_temp_ref_long)</span></code></pre></div>
</div>
<div id="normalise-variable" class="section level4" number="1.9.3.3">
<h4><span class="header-section-number">1.9.3.3</span> Normalise variable</h4>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select the columns to normalise</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">names</span>(y_var)[<span class="sc">!</span><span class="fu">names</span>(y_var) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;reference_upper&quot;</span>, <span class="st">&quot;sd&quot;</span>) ]</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>cols_new <span class="ot">&lt;-</span> cols</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cols_new) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;v_&quot;</span>, <span class="st">&quot;i_&quot;</span>, cols)</span></code></pre></div>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mutate</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The break point scaling is actually not needed here, since </span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># having the lower ref value to be 5 sd implies that the threshold is</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 sd in a linear scaling.</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>y_var_norm <span class="ot">&lt;-</span> y_var <span class="sc">%&gt;%</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">reference_low =</span> reference_upper <span class="sc">-</span> <span class="dv">5</span><span class="sc">*</span>sd ) <span class="sc">%&gt;%</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">reference_low2 =</span> reference_upper <span class="sc">+</span> <span class="dv">5</span><span class="sc">*</span>sd ) <span class="sc">%&gt;%</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">threshold_low =</span> reference_upper <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>sd ) <span class="sc">%&gt;%</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">threshold_high =</span> reference_upper <span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>sd ) <span class="sc">%&gt;%</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(cols), <span class="sc">~</span> </span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">if_else</span>(.x <span class="sc">&lt;</span> reference_upper,</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">if_else</span>(.x <span class="sc">&lt;</span> threshold_low, </span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>                                        (.x <span class="sc">-</span> reference_low) <span class="sc">/</span> (threshold_low <span class="sc">-</span> reference_low),</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>                                        (.x <span class="sc">-</span> threshold_low) <span class="sc">/</span> (reference_upper <span class="sc">-</span> threshold_low),</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>                                        ),</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">if_else</span>(.x <span class="sc">&gt;</span> threshold_high, </span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>                                        (reference_low2 <span class="sc">-</span> .x) <span class="sc">/</span> (reference_low2 <span class="sc">-</span> threshold_high),</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>                                        (threshold_high <span class="sc">-</span> .x) <span class="sc">/</span> (threshold_high <span class="sc">-</span> reference_upper),</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>                                        )</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>                ))) <span class="sc">%&gt;%</span></span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(cols), <span class="sc">~</span> <span class="fu">if_else</span>(.x <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="dv">1</span>, .x))) <span class="sc">%&gt;%</span></span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(cols), <span class="sc">~</span> <span class="fu">if_else</span>(.x <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="dv">0</span>, .x))) <span class="sc">%&gt;%</span></span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="fu">all_of</span>(cols_new)) <span class="sc">%&gt;%</span></span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fu">select</span>(y_var, <span class="fu">all_of</span>(cols)))</span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th>user</th>
<th>system</th>
<th>elapsed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>14.803</td>
<td>2.717</td>
<td>17.512</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(y_var_norm, <span class="st">&quot;/data/P-Prosjekter2/41201785_okologisk_tilstand_2022_2023/data/climate_indicators/aggregated_climate_time_series/summer_median_temp_normalised.RData&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>lims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">22</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> <span class="fu">st_downsample</span>(y_var_norm[<span class="st">&quot;v_1970&quot;</span>],<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>,</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> lims) <span class="sc">+</span>  </span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>,</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> <span class="fu">st_downsample</span>(y_var_norm[<span class="st">&quot;reference_upper&quot;</span>], <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>,</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> lims) <span class="sc">+</span>  </span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>,</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> <span class="fu">st_downsample</span>(y_var_norm[<span class="st">&quot;reference_low&quot;</span>], <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>,</span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> lims) <span class="sc">+</span>  </span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>,</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> <span class="fu">st_downsample</span>(y_var_norm[<span class="st">&quot;reference_low2&quot;</span>], <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;D&quot;</span>,</span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> lims) <span class="sc">+</span>  </span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>,</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> <span class="fu">st_downsample</span>(y_var_norm[<span class="st">&quot;i_1970&quot;</span>],<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;A&quot;</span>,</span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span>  </span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a>, <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;hv&quot;</span></span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-75-1.png" alt="Example showing median summer tempretur in 1970, the upper and lwoer reference temperture, i.e. median and 5 SD units of the temperature between  1961-1990, and finally, the scaled indicator values." width="672" />
<p class="caption">
(#fig:unnamed-chunk-75)Example showing median summer tempretur in 1970, the upper and lwoer reference temperture, i.e. median and 5 SD units of the temperature between 1961-1990, and finally, the scaled indicator values.
</p>
</div>
<p>The <em>real</em> indicator values should be means over 5 year periods. Calculating a running mean for all time steps is too time consuming. Therefore, the scaled, regional indicator values will be calculated for distinct time steps. The time series can perhaps best be presented with yearly resolution.</p>
</div>
<div id="plot-time-series-as-line-graphs" class="section level4" number="1.9.3.4">
<h4><span class="header-section-number">1.9.3.4</span> Plot time series as line graphs</h4>
<p>We could also plot a time series as a series of maps, but then we need to average over these 5 year time periods first. We can get to that later.</p>
<p>To plot time series I first need to do a spatial aggregation. One option is to spatially aggregate the stars object directly, using the <code>reg</code> data set:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> y_var_norm[<span class="dv">1</span>,,] <span class="sc">%&gt;%</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate</span>(reg, mean, <span class="at">na.rm=</span>T)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">&lt;-</span> temp <span class="sc">%&gt;%</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="co"># too slow</span></span></code></pre></div>
<p>However, this does no preserve the region name, and a subsequent <code>st_intersection</code> taks a little while and gives some boundary problems.</p>
<p>I can also convert pixels to points and then do the intersection.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>temp_points <span class="ot">&lt;-</span> y_var_norm[<span class="dv">1</span>,,] <span class="sc">%&gt;%</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">as_points =</span> <span class="cn">TRUE</span>, <span class="at">merge =</span> <span class="cn">FALSE</span>)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>temp_points2 <span class="ot">&lt;-</span> temp_points <span class="sc">%&gt;%</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(reg) <span class="st">&quot; too slow&quot;</span></span></code></pre></div>
<p>But this also took too long.</p>
<p>I can perhaps aggregate, and then turn to points and intersect, but that did not work perfect either.</p>
<p>I can rasterize the regions data set, turn it into a coded dimension and use st_apply, but that is tedious.</p>
<p>Let me try using <code>exact_extract</code>, as an alternative to <code>aggregate</code>. This requires us to turn to the <code>terra</code> package for a bit.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>regional_means <span class="ot">&lt;-</span> <span class="fu">rast</span>(y_var_norm) <span class="sc">%&gt;%</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exact_extract</span>(reg, <span class="at">fun =</span> <span class="st">&#39;mean&#39;</span>, <span class="at">append_cols =</span> <span class="st">&quot;region&quot;</span>, <span class="at">progress=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;region&quot;</span>, <span class="fu">names</span>(y_var_norm)))</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>user; system; elapsed: 7.603; 3.071; 10.697</p>
<p>That was fast!</p>
<p>I should also get the sd:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>regional_sd <span class="ot">&lt;-</span> <span class="fu">rast</span>(y_var_norm) <span class="sc">%&gt;%</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exact_extract</span>(reg, <span class="at">fun =</span> <span class="st">&#39;stdev&#39;</span>, <span class="at">append_cols =</span> <span class="st">&quot;region&quot;</span>, <span class="at">progress=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;region&quot;</span>, <span class="fu">names</span>(y_var_norm)))</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>user; system; elapsed: 7.420; 2.921; 10.355</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(regional_means, <span class="st">&quot;temp/regional_means.rds&quot;</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(regional_sd, <span class="st">&quot;temp/regional_sd.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>regional_means</span></code></pre></div>
<pre><code>##       region    i_2022    i_2021    i_2020    i_2019    i_2018    i_2017
## 1 Nord-Norge 0.5229552 0.6716406 0.7835605 0.6226401 0.5227449 0.7942117
## 2 Midt-Norge 0.6508591 0.3961345 0.8177248 0.4506563 0.7193527 0.7887136
## 3  Østlandet 0.2970150 0.4709298 0.7725265 0.4728527 0.6296709 0.8758541
## 4 Vestlandet 0.5952790 0.7191494 0.7271156 0.6927361 0.6551608 0.8229095
## 5  Sørlandet 0.2777331 0.6812166 0.7431651 0.4880635 0.6785626 0.9088330
##      i_2016    i_2015    i_2014    i_2013    i_2012    i_2011    i_2010
## 1 0.7049652 0.6819711 0.5448973 0.4791541 0.7115630 0.6755856 0.7387764
## 2 0.7350852 0.4565621 0.3333671 0.3671178 0.6973696 0.5719436 0.5212519
## 3 0.7326592 0.6375170 0.7247531 0.2822664 0.7152273 0.2995812 0.2580168
## 4 0.8396783 0.6895101 0.6254652 0.3122623 0.6561900 0.4270597 0.3609691
## 5 0.8011160 0.7374437 0.7270579 0.3359345 0.6977301 0.3959087 0.3351336
##      i_2009    i_2008    i_2007    i_2006    i_2005    i_2004    i_2003
## 1 0.5800490 0.6667631 0.5258295 0.5016121 0.4000925 0.2392276 0.6330016
## 2 0.6347505 0.4411661 0.4817808 0.4262855 0.2566617 0.3453341 0.6227703
## 3 0.3897706 0.3622946 0.5422150 0.5500001 0.3197277 0.4576293 0.7461898
## 4 0.4123544 0.5555096 0.6890606 0.3445384 0.3185382 0.3182803 0.6700044
## 5 0.4337867 0.4044366 0.7675685 0.6220122 0.3398916 0.5439504 0.7996283
##      i_2002    i_2001    i_2000    i_1999    i_1998    i_1997    i_1996
## 1 0.4172826 0.7808664 0.6090959 0.7464326 0.5984202 0.3844000 0.5369101
## 2 0.3989019 0.5355261 0.8580784 0.8039626 0.7470424 0.4041788 0.3354300
## 3 0.6526535 0.5149614 0.8516858 0.6386104 0.5802689 0.5327700 0.5444841
## 4 0.5025382 0.4740168 0.6991027 0.5018582 0.5491226 0.4127755 0.5588785
## 5 0.7500667 0.4123388 0.7464539 0.4366535 0.6269892 0.5347923 0.6209334
##      i_1995    i_1994    i_1993    i_1992    i_1991    i_1990    i_1989
## 1 0.6676539 0.5728222 0.7442054 0.4091425 0.6598504 0.6029654 0.8676373
## 2 0.7934184 0.6244155 0.6774056 0.5156545 0.4667809 0.7179124 0.8240014
## 3 0.5614104 0.7136125 0.3683829 0.6407267 0.5102854 0.7922601 0.8782864
## 4 0.5937695 0.3991600 0.3702273 0.4826857 0.5075535 0.8814430 0.6503626
## 5 0.2922743 0.7111487 0.2261260 0.7003245 0.3721875 0.7128139 0.8043666
##      i_1988    i_1987    i_1986    i_1985    i_1984    i_1983    i_1982
## 1 0.4259270 0.2342881 0.7490959 0.5308425 0.5436442 0.6018486 0.9372202
## 2 0.3893873 0.4544994 0.6705144 0.6166885 0.8402103 0.8470688 0.4669001
## 3 0.6953285 0.5593340 0.6224316 0.9089990 0.7882350 0.4880454 0.3888000
## 4 0.6749738 0.7035981 0.5585621 0.9153535 0.6844985 0.8045424 0.4376886
## 5 0.9426684 0.6019688 0.6316550 0.8374816 0.4402200 0.3417349 0.4348597
##      i_1981    i_1980    i_1979    i_1978    i_1977    i_1976    i_1975
## 1 0.8247747 0.6777628 0.5431305 0.7410339 0.9130686 0.8913515 0.2851543
## 2 0.7805676 0.5743871 0.6705245 0.8255711 0.9195431 0.7036115 0.5972666
## 3 0.9038219 0.6991070 0.4560839 0.7893589 0.8454825 0.3599951 0.7461765
## 4 0.7048092 0.4179829 0.3810064 0.8779133 0.7801663 0.2968234 0.7799006
## 5 0.8638538 0.8025582 0.4965041 0.7790532 0.8748140 0.4690604 0.7757059
##      i_1974    i_1973    i_1972    i_1971    i_1970    i_1969    i_1968
## 1 0.7167825 0.5242200 0.4599770 0.8438740 0.4523815 0.5716048 0.2388063
## 2 0.6322228 0.7411774 0.3530549 0.9491820 0.8164071 0.7650437 0.7577429
## 3 0.5866656 0.6241542 0.3993337 0.9397188 0.8219679 0.2522545 0.8237599
## 4 0.3875915 0.7800473 0.5545146 0.9554895 0.8960299 0.5472180 0.5583544
## 5 0.5658972 0.5921305 0.5146197 0.8479800 0.8475103 0.2567945 0.6309136
##      i_1967    i_1966    i_1965    i_1964    i_1963    i_1962    i_1961
## 1 0.8693439 0.8926262 0.2974982 0.8553112 0.8688120 0.5265165 0.4691291
## 2 0.8853405 0.8176376 0.3385790 0.4210841 0.6391031 0.3806877 0.7834820
## 3 0.8980778 0.9330618 0.2926910 0.3153551 0.8941880 0.1494415 0.6001533
## 4 0.7296135 0.8245894 0.5293191 0.2589520 0.8288842 0.3031488 0.6413146
## 5 0.9192096 0.9214683 0.3581550 0.4509242 0.8869653 0.1289513 0.6416339
##      i_1960    i_1959    i_1958    i_1957 reference_upper        sd
## 1 0.7889899 0.6563627 0.8029888 0.4260504        10.18232 1.1940082
## 2 0.5065613 0.3199203 0.7942046 0.5488227        10.76565 0.9234962
## 3 0.8150576 0.3334485 0.9033076 0.8194198        10.79093 1.0181496
## 4 0.6376152 0.2353686 0.7969683 0.7989066        10.23690 0.9021525
## 5 0.8390841 0.2389458 0.9170361 0.7973263        11.76200 1.0309212
##   reference_low reference_low2 threshold_low threshold_high   v_2022   v_2021
## 1      4.212276       16.15236      7.794301       12.57033 11.49576 10.80160
## 2      6.148171       15.38313      8.918659       12.61264 11.37494 12.46988
## 3      5.700177       15.88167      8.754626       12.82722 12.31048 12.84862
## 4      5.726138       14.74766      8.432596       12.04121 10.92281 12.49451
## 5      6.607399       16.91661      9.700163       13.82385 13.44766 14.07319
##     v_2020   v_2019   v_2018   v_2017   v_2016   v_2015   v_2014   v_2013
## 1 10.31442 10.81111 12.49647 10.06603 10.80198 10.61916 13.05659 11.43750
## 2 10.96783 12.54688 12.91496 10.82244 11.22066 11.95642 14.44920 12.03304
## 3 11.20726 12.73784 13.92235 10.80569 11.32613 11.51387 13.42124 12.45105
## 4 10.56610 12.33204 12.36407 10.15861 10.39534 10.53209 13.00033 11.52469
## 5 12.28026 13.59887 14.78826 11.76143 12.17136 12.23652 13.97244 13.61046
##      v_2012   v_2011   v_2010   v_2009   v_2008   v_2007   v_2006   v_2005
## 1  9.725863 11.41673 10.59595 11.64044 10.38462 11.49894 12.10530 12.00313
## 2 11.320860 12.63057 12.64634 12.74502 12.37930 12.35347 14.18750 12.23033
## 3 11.367309 12.36098 12.36414 12.03356 12.09204 11.71870 14.19204 12.36131
## 4 10.848437 11.92048 11.87055 11.94930 11.99926 10.78251 13.78926 11.50300
## 5 12.382796 13.05598 13.13701 12.94132 13.01276 12.24224 14.98534 13.12392
##     v_2004   v_2003   v_2002   v_2001   v_2000    v_1999    v_1998   v_1997
## 1 12.10781 12.99768 12.56796 10.68307 11.08212  9.574008 11.111520 12.57673
## 2 12.15044 13.63359 14.26920 11.62450 10.85286 10.978428 10.491316 14.25030
## 3 11.89421 13.13435 13.87537 11.78219 11.02508 11.527411  9.935435 14.24321
## 4 11.53953 12.89744 13.35598 11.20258 10.74566 11.138221  9.425931 13.59621
## 5 12.70149 14.41223 14.58506 12.97206 12.27971 12.951164 10.995094 15.25102
##     v_1996    v_1995   v_1994    v_1993    v_1992   v_1991   v_1990    v_1989
## 1 11.24216  9.384683 11.20072 10.750869  8.742553 11.05720 11.11784 10.045619
## 2 11.99152 10.605959 12.78488 10.195220  9.867982 12.51140 11.27879 10.446850
## 3 11.71481 11.687245 13.09388  9.503597 10.075000 12.77311 11.20974 10.707437
## 4 11.03055 11.013618 11.92408  8.543216  9.294283 12.01819 10.35436  9.609445
## 5 12.54379 13.437359 13.94922 10.154110 11.154216 13.68962 12.28803 11.784321
##     v_1988    v_1987    v_1986   v_1985   v_1984    v_1983   v_1982    v_1981
## 1 11.66064  8.327039  9.576174 11.29246  9.08866  9.250187 10.16970  9.772290
## 2 12.31545  9.739641 10.147119 11.45674 10.51246 10.680722 11.74850 10.376070
## 3 11.39684  9.893107 10.022251 10.70214 11.21562 11.827525 12.03460 10.607471
## 4 10.81195  9.690071  9.440565 10.16374 10.81356 10.533232 11.24850  9.712049
## 5 11.82369 10.944833 11.009808 11.42688 12.91533 13.282372 12.92503 11.484279
##     v_1980    v_1979   v_1978   v_1977    v_1976    v_1975    v_1974   v_1973
## 1 11.50241 11.279046 10.24673 10.20647  9.935094  8.429459 10.858856 11.32926
## 2 12.34994 10.184852 11.04834 10.65403 11.285233 11.595827 10.098783 11.24913
## 3 11.39915  9.685908 10.38925 10.64308 12.319158 13.110865  9.955868 11.55745
## 4 11.26947  9.129119 10.40676 10.57277 11.510338 12.178302  9.135345 10.64148
## 5 12.16323 10.730603 11.30338 11.98966 13.582006 14.121005 10.878303 12.60629
##     v_1972    v_1971   v_1970   v_1969   v_1968   v_1967    v_1966    v_1965
## 1 12.38153  9.806882 11.50535 11.55087  8.35559 10.39706  9.957542  8.491211
## 2 11.96473 10.720003 11.04165 13.05346 10.41532 10.80305 10.430664  9.505727
## 3 12.00871 10.826982 10.42573 12.61157 11.11984 10.76921 10.690258  9.349582
## 4 11.06925 10.228153 10.06457 12.02119 11.05170  9.78488  9.955516  9.390384
## 5 12.76221 12.078062 11.44716 13.29670 12.51905 11.68162 11.724425 10.435689
##      v_1964   v_1963   v_1962    v_1961   v_1960   v_1959   v_1958   v_1957
## 1  9.950803 10.42645 9.039712 11.470453 13.01163 10.97476 10.59839 11.55422
## 2  9.689445 11.42024 9.616042 10.452970 11.77905 12.05592 11.06128 11.60137
## 3  9.398091 10.91376 9.053277  9.975613 10.53910 12.47745 10.72622 11.14570
## 4  8.903700 10.52207 8.959744  9.579954 10.86312 11.74921 10.39408 10.59085
## 5 10.633060 11.58505 9.955679 11.023759 11.48092 13.64020 11.83925 12.18110</code></pre>
<p>Reshape and plot</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>div <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;reference_upper&quot;</span>,</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;reference_low&quot;</span>,</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;reference_low2&quot;</span>,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;threshold_low&quot;</span>,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;threshold_high&quot;</span>,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;sd&quot;</span>)</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> regional_means <span class="sc">%&gt;%</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(region, div)</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>regional_means_long <span class="ot">&lt;-</span> regional_means <span class="sc">%&gt;%</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">all_of</span>(div)) <span class="sc">%&gt;%</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">!</span>region) <span class="sc">%&gt;%</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;type&quot;</span>, <span class="st">&quot;year&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="co">#id_cols = region,</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> type)  <span class="sc">%&gt;%</span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(temp, <span class="at">by=</span><span class="fu">join_by</span>(region)) <span class="sc">%&gt;%</span> </span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> v<span class="sc">-</span>reference_upper) <span class="sc">%&gt;%</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">threshold_low_centered =</span> threshold_low<span class="sc">-</span>reference_upper) <span class="sc">%&gt;%</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">threshold_high_centered =</span> threshold_high<span class="sc">-</span>reference_upper)</span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding the spatial sd</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>regional_means_long <span class="ot">&lt;-</span> regional_sd <span class="sc">%&gt;%</span></span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">all_of</span>(div)) <span class="sc">%&gt;%</span></span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">!</span>region) <span class="sc">%&gt;%</span></span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;type&quot;</span>, <span class="st">&quot;year&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> type) <span class="sc">%&gt;%</span></span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">i_sd =</span> i,</span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">v_sd =</span> v) <span class="sc">%&gt;%</span></span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(regional_means_long, <span class="at">by=</span><span class="fu">join_by</span>(region, year))</span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## # A tibble: 330 × 15
##    region     year   i_sd  v_sd     i     v reference_upper reference_low
##    &lt;chr&gt;      &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;         &lt;dbl&gt;
##  1 Nord-Norge 2022  0.246  1.90 0.523  11.5            10.2          4.21
##  2 Nord-Norge 2021  0.255  1.65 0.672  10.8            10.2          4.21
##  3 Nord-Norge 2020  0.143  1.82 0.784  10.3            10.2          4.21
##  4 Nord-Norge 2019  0.290  1.77 0.623  10.8            10.2          4.21
##  5 Nord-Norge 2018  0.344  1.64 0.523  12.5            10.2          4.21
##  6 Nord-Norge 2017  0.145  1.79 0.794  10.1            10.2          4.21
##  7 Nord-Norge 2016  0.175  1.74 0.705  10.8            10.2          4.21
##  8 Nord-Norge 2015  0.198  1.61 0.682  10.6            10.2          4.21
##  9 Nord-Norge 2014  0.297  1.65 0.545  13.1            10.2          4.21
## 10 Nord-Norge 2013  0.202  1.65 0.479  11.4            10.2          4.21
## # … with 320 more rows, and 7 more variables: reference_low2 &lt;dbl&gt;,
## #   threshold_low &lt;dbl&gt;, threshold_high &lt;dbl&gt;, sd &lt;dbl&gt;, diff &lt;dbl&gt;,
## #   threshold_low_centered &lt;dbl&gt;, threshold_high_centered &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>regOrder <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Østlandet&quot;</span>,<span class="st">&quot;Sørlandet&quot;</span>,<span class="st">&quot;Vestlandet&quot;</span>,<span class="st">&quot;Midt-Norge&quot;</span>,<span class="st">&quot;Nord-Norge&quot;</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>regional_means_long <span class="sc">%&gt;%</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">col =</span> <span class="fu">if_else</span>(diff<span class="sc">&gt;</span><span class="dv">0</span>, <span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.numeric</span>(year), </span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> diff, <span class="at">fill =</span> col))<span class="sc">+</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>)<span class="sc">+</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> threshold_low_centered),</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> threshold_high_centered),</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">x =</span> <span class="dv">1961</span>, <span class="at">xend=</span><span class="dv">1990</span>,</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> <span class="dv">0</span>,</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_hue</span>(<span class="at">l=</span><span class="dv">70</span>, <span class="at">c=</span><span class="dv">60</span>)<span class="sc">+</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)<span class="sc">+</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Sommertempratur</span><span class="sc">\n</span><span class="st">avvik fra 1961-1990&quot;</span>)<span class="sc">+</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>)<span class="sc">+</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill=</span><span class="st">&quot;none&quot;</span>)<span class="sc">+</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( .<span class="sc">~</span> <span class="fu">factor</span>(region, <span class="at">levels =</span> regOrder),</span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncol=</span><span class="dv">3</span>,</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-84-1.png" alt="Times series for median summer temperature centered on the median value during the reference period. The reference period is indicated with a thick horizontal line. Dottet horisontal lines are 2 sd units for the reference period." width="672" />
<p class="caption">
(#fig:unnamed-chunk-84)Times series for median summer temperature centered on the median value during the reference period. The reference period is indicated with a thick horizontal line. Dottet horisontal lines are 2 sd units for the reference period.
</p>
</div>
<p>Then we can take the mean over the last 5 years and add to a spatial representation.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>i_aggregatedToPeriods <span class="ot">&lt;-</span> regional_means_long <span class="sc">%&gt;%</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year)) <span class="sc">%&gt;%</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">case_when</span>(</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">%between%</span> <span class="fu">c</span>(<span class="dv">2018</span>, <span class="dv">2022</span>) <span class="sc">~</span> <span class="st">&quot;2018-2022&quot;</span>,</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">%between%</span> <span class="fu">c</span>(<span class="dv">2013</span>, <span class="dv">2017</span>) <span class="sc">~</span> <span class="st">&quot;2013-2017&quot;</span>,</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">%between%</span> <span class="fu">c</span>(<span class="dv">2008</span>, <span class="dv">2012</span>) <span class="sc">~</span> <span class="st">&quot;2008-2012&quot;</span>,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">%between%</span> <span class="fu">c</span>(<span class="dv">2003</span>, <span class="dv">2007</span>) <span class="sc">~</span> <span class="st">&quot;2003-2007&quot;</span>,</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="st">&quot;pre 2003&quot;</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">period_rank =</span> <span class="fu">case_when</span>(</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>   period <span class="sc">==</span> <span class="st">&quot;2018-2022&quot;</span> <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>   period <span class="sc">==</span> <span class="st">&quot;2013-2017&quot;</span> <span class="sc">~</span> <span class="dv">4</span>,</span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>   period <span class="sc">==</span> <span class="st">&quot;2008-2012&quot;</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>   period <span class="sc">==</span> <span class="st">&quot;2003-2007&quot;</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="dv">1</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, period, period_rank) <span class="sc">%&gt;%</span></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">indicator =</span> <span class="fu">mean</span>(i),</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">spatial_sd =</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(i_sd<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span><span class="fu">length</span>(i_sd)</span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">#,</span></span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">#spatial_sd_mean = mean(i_sd),</span></span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">#spatial_sd2_max = max(i_sd),</span></span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">#spatial_sd2_length = length(i_sd)</span></span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;region&#39;, &#39;period&#39;. You can override using
## the `.groups` argument.</code></pre>
<pre><code>## # A tibble: 25 × 5
## # Groups:   region, period [25]
##    region     period    period_rank indicator spatial_sd
##    &lt;chr&gt;      &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
##  1 Midt-Norge 2003-2007           2     0.427     0.101 
##  2 Midt-Norge 2008-2012           3     0.573     0.143 
##  3 Midt-Norge 2013-2017           4     0.536     0.0986
##  4 Midt-Norge 2018-2022           5     0.607     0.130 
##  5 Midt-Norge pre 2003            1     0.642     0.0277
##  6 Nord-Norge 2003-2007           2     0.460     0.122 
##  7 Nord-Norge 2008-2012           3     0.675     0.109 
##  8 Nord-Norge 2013-2017           4     0.641     0.0937
##  9 Nord-Norge 2018-2022           5     0.625     0.118 
## 10 Nord-Norge pre 2003            1     0.625     0.0266
## # … with 15 more rows</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>labs <span class="ot">&lt;-</span> <span class="fu">unique</span>(i_aggregatedToPeriods<span class="sc">$</span>period[<span class="fu">order</span>(i_aggregatedToPeriods<span class="sc">$</span>period_rank)])</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>i_aggregatedToPeriods <span class="sc">%&gt;%</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> period_rank, </span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> indicator,</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour=</span>region))<span class="sc">+</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>indicator<span class="sc">-</span>spatial_sd, </span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax=</span>indicator<span class="sc">+</span>spatial_sd), </span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width=</span>.<span class="dv">2</span>,</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)<span class="sc">+</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> labs)<span class="sc">+</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;indikatorverdi&quot;</span>)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-86-1.png" alt="Scaled indicator values, aggregated over 5 year intervals. Errors represent spatial variation within regions and across years." width="672" />
<p class="caption">
(#fig:unnamed-chunk-86)Scaled indicator values, aggregated over 5 year intervals. Errors represent spatial variation within regions and across years.
</p>
</div>
<p>Finally, I can add these values to the sp object.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>reg2 <span class="ot">&lt;-</span> reg <span class="sc">%&gt;%</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(i_aggregatedToPeriods[i_aggregatedToPeriods<span class="sc">$</span>period_rank<span class="sc">==</span><span class="dv">5</span>,], <span class="at">by=</span><span class="fu">join_by</span>(region))</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(reg2)</span></code></pre></div>
<pre><code>## [1] &quot;id&quot;          &quot;region&quot;      &quot;GID_0&quot;       &quot;NAME_0&quot;      &quot;period&quot;     
## [6] &quot;period_rank&quot; &quot;indicator&quot;   &quot;spatial_sd&quot;  &quot;geometry&quot;</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>myCol <span class="ot">&lt;-</span> <span class="st">&quot;RdYlGn&quot;</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>myCol2 <span class="ot">&lt;-</span> <span class="st">&quot;-RdYlGn&quot;</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>tm_main <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(reg2)<span class="sc">+</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="st">&quot;indicator&quot;</span>,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">title=</span><span class="st">&quot;Indikator:</span><span class="sc">\n</span><span class="st">sommertemperatur&quot;</span>,</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> myCol,</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">style=</span><span class="st">&quot;fixed&quot;</span>,</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">2</span>)) </span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>tm_inset <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(reg2)<span class="sc">+</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="st">&quot;spatial_sd&quot;</span>,</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">title=</span><span class="st">&quot;SD&quot;</span>,</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">palette =</span> myCol2,</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">style=</span><span class="st">&quot;cont&quot;</span>)<span class="sc">+</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.format =</span> <span class="fu">list</span>(<span class="at">digits=</span><span class="dv">2</span>))</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(tm_main, </span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>             tm_inset)</span></code></pre></div>
<div class="figure">
<img src="DRAFT_climate_indicators_files/figure-html/unnamed-chunk-88-1.png" alt="Summer tempreature indicator values for five accounting areas in Norway. SD is the spatial variation." width="672" />
<p class="caption">
(#fig:unnamed-chunk-88)Summer tempreature indicator values for five accounting areas in Norway. SD is the spatial variation.
</p>
</div>
</div>
</div>
</div>
</div>
<!--bookdown:body:end-->
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Climate indicators</strong>" was written by . </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


</body>

</html>
